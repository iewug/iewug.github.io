<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
h1, h2, h3, h4, h5 { white-space: pre-wrap; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; border-color: transparent !important; padding-top: 0px !important; padding-bottom: 0px !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  #write > p:nth-child(1) { margin-top: 0px; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
  figure { overflow-x: visible; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; overflow-wrap: anywhere; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }
mjx-container { break-inside: avoid; }


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    pre {
        page-break-inside: avoid;
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}



mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG2"] path[data-c], mjx-container[jax="SVG2"] use[data-c] {
  stroke-width: 3;
}

g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

.MathJax g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}
mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
							stroke-width: 0;
						}
</style><title>笔记_计网自顶向下</title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='计算机网络自顶向下方法笔记'><span>《计算机网络自顶向下方法》笔记</span></h1><p style="text-align:right;">
    Wei Gu 2022年9月
</p><p><span>书看的是第七版、英文版、机械工业出版社，原名是《Computer Networking A Top-Down Approach》。这是我第一次正式接触计网的话题。本书是我的入门书。花了大二暑假以及大三上开学第一周看掉了前七章的，也就是从应用层一直看到链路层，以及最后的无线网络和移动网络。</span></p><hr /><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n0"><a class="md-toc-inner" href="#计算机网络自顶向下方法笔记">《计算机网络自顶向下方法》笔记</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n6"><a class="md-toc-inner" href="#一计算机网络和因特网">一、计算机网络和因特网</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n8"><a class="md-toc-inner" href="#11-什么是因特网">1.1 什么是因特网</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n15"><a class="md-toc-inner" href="#111-组成描述">1.1.1 组成描述</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n47"><a class="md-toc-inner" href="#112-服务描述">1.1.2 服务描述</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n52"><a class="md-toc-inner" href="#12-网络边缘">1.2 网络边缘</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n54"><a class="md-toc-inner" href="#121-接入网">1.2.1 接入网</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n90"><a class="md-toc-inner" href="#122-物理媒介">1.2.2 物理媒介</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n110"><a class="md-toc-inner" href="#13-网络核心">1.3 网络核心</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n113"><a class="md-toc-inner" href="#131-分组交换">1.3.1 分组交换</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n122"><a class="md-toc-inner" href="#132-电路交换">1.3.2 电路交换</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n152"><a class="md-toc-inner" href="#133-网络的网络">1.3.3 网络的网络</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n156"><a class="md-toc-inner" href="#14-分组交换中的时延丢包吞吐量">1.4 分组交换中的时延、丢包、吞吐量</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n157"><a class="md-toc-inner" href="#141-时延">1.4.1 时延</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n173"><a class="md-toc-inner" href="#142-排队时延和丢包">1.4.2 排队时延和丢包</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n175"><a class="md-toc-inner" href="#143-吞吐量">1.4.3 吞吐量</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n177"><a class="md-toc-inner" href="#15-协议层次及其服务模型">1.5 协议层次及其服务模型</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n203"><a class="md-toc-inner" href="#16-网络攻击">1.6 网络攻击</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n231"><a class="md-toc-inner" href="#二应用层">二、应用层</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n233"><a class="md-toc-inner" href="#21-应用层协议原理">2.1 应用层协议原理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n235"><a class="md-toc-inner" href="#211-网络应用程序体系结构">2.1.1 网络应用程序体系结构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n259"><a class="md-toc-inner" href="#212-进程通信">2.1.2 进程通信</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n283"><a class="md-toc-inner" href="#213-运输服务">2.1.3 运输服务</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n319"><a class="md-toc-inner" href="#214-应用层协议">2.1.4 应用层协议</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n332"><a class="md-toc-inner" href="#22-web和http">2.2 Web和HTTP</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n333"><a class="md-toc-inner" href="#221-http概况">2.2.1 HTTP概况</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n346"><a class="md-toc-inner" href="#222-非持续连接和持续连接">2.2.2 非持续连接和持续连接</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n356"><a class="md-toc-inner" href="#223-http报文格式">2.2.3 HTTP报文格式</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n414"><a class="md-toc-inner" href="#224-用户与服务器的交互cookie">2.2.4 用户与服务器的交互：cookie</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n428"><a class="md-toc-inner" href="#225-web缓存与条件get">2.2.5 Web缓存与条件GET</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n465"><a class="md-toc-inner" href="#23-因特网中的电子邮件">2.3 因特网中的电子邮件</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n478"><a class="md-toc-inner" href="#231-smtp">2.3.1 SMTP</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n491"><a class="md-toc-inner" href="#232-与http的对比">2.3.2 与HTTP的对比</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n499"><a class="md-toc-inner" href="#233-邮件报文格式">2.3.3 邮件报文格式</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n503"><a class="md-toc-inner" href="#234-邮件访问协议">2.3.4 邮件访问协议</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n543"><a class="md-toc-inner" href="#24-dns因特网的目录服务">2.4 DNS：因特网的目录服务</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n545"><a class="md-toc-inner" href="#241-dns提供的服务">2.4.1 DNS提供的服务</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n562"><a class="md-toc-inner" href="#242-dns工作机理概述">2.4.2 DNS工作机理概述</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n578"><a class="md-toc-inner" href="#243-dns记录和报文">2.4.3 DNS记录和报文</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n614"><a class="md-toc-inner" href="#25-p2p文件分发">2.5 P2P文件分发</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n623"><a class="md-toc-inner" href="#26-视频流和内容分发网">2.6 视频流和内容分发网</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n624"><a class="md-toc-inner" href="#261-因特网视频">2.6.1 因特网视频</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n633"><a class="md-toc-inner" href="#262-http流和dash">2.6.2 HTTP流和DASH</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n650"><a class="md-toc-inner" href="#263-内容分发网">2.6.3 内容分发网</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n694"><a class="md-toc-inner" href="#264-案例学习">2.6.4 案例学习</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n727"><a class="md-toc-inner" href="#27-套接字编程">2.7 套接字编程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n729"><a class="md-toc-inner" href="#271-udp">2.7.1 UDP</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n735"><a class="md-toc-inner" href="#272-tcp">2.7.2 TCP</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n744"><a class="md-toc-inner" href="#三运输层">三、运输层</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n746"><a class="md-toc-inner" href="#31-概述和运输层服务">3.1 概述和运输层服务</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n750"><a class="md-toc-inner" href="#311-运输层和网络层关系">3.1.1 运输层和网络层关系</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n773"><a class="md-toc-inner" href="#312-因特网运输层概述">3.1.2 因特网运输层概述</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n794"><a class="md-toc-inner" href="#32-多路复用与多路分解">3.2 多路复用与多路分解</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n802"><a class="md-toc-inner" href="#321-无连接的多路复用与分解">3.2.1 无连接的多路复用与分解</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n806"><a class="md-toc-inner" href="#322-面向连接的多路复用与分解">3.2.2 面向连接的多路复用与分解</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n809"><a class="md-toc-inner" href="#33-无连接运输udp">3.3 无连接运输：UDP</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n822"><a class="md-toc-inner" href="#331-udp报文段结构">3.3.1 UDP报文段结构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n825"><a class="md-toc-inner" href="#332-udp检验和">3.3.2 UDP检验和</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n830"><a class="md-toc-inner" href="#34-可靠数据传输原理">3.4 可靠数据传输原理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n837"><a class="md-toc-inner" href="#341-构建可靠数据传输协议">3.4.1 构建可靠数据传输协议</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n870"><a class="md-toc-inner" href="#342-流水线可靠数据传输协议">3.4.2 流水线可靠数据传输协议</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n884"><a class="md-toc-inner" href="#343-回退n步">3.4.3 回退N步</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n903"><a class="md-toc-inner" href="#344-选择重传">3.4.4 选择重传</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n938"><a class="md-toc-inner" href="#35-面向连接的运输tcp">3.5 面向连接的运输：TCP</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n939"><a class="md-toc-inner" href="#351-tcp连接">3.5.1 TCP连接</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n954"><a class="md-toc-inner" href="#352-tcp报文段结构">3.5.2 TCP报文段结构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n991"><a class="md-toc-inner" href="#353-往返时间的估计与超时">3.5.3 往返时间的估计与超时</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1006"><a class="md-toc-inner" href="#354-可靠数据传输">3.5.4 可靠数据传输</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1034"><a class="md-toc-inner" href="#355-流量控制">3.5.5 流量控制</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1060"><a class="md-toc-inner" href="#356-tcp连接管理">3.5.6 TCP连接管理</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1082"><a class="md-toc-inner" href="#36-阻塞控制原理">3.6 阻塞控制原理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1083"><a class="md-toc-inner" href="#361-阻塞原因和代价">3.6.1 阻塞原因和代价</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1093"><a class="md-toc-inner" href="#362-阻塞控制方法">3.6.2 阻塞控制方法</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1101"><a class="md-toc-inner" href="#37-tcp阻塞控制">3.7 TCP阻塞控制</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1147"><a class="md-toc-inner" href="#四网络层数据平面">四、网络层：数据平面</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1149"><a class="md-toc-inner" href="#41-网络层概述">4.1 网络层概述</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1150"><a class="md-toc-inner" href="#411-转发和路由选择数据平面和控制平面">4.1.1 转发和路由选择：数据平面和控制平面</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1177"><a class="md-toc-inner" href="#412-网络服务模型">4.1.2 网络服务模型</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1198"><a class="md-toc-inner" href="#42-路由器工作原理">4.2 路由器工作原理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1210"><a class="md-toc-inner" href="#421-输入端口处理和基于目的地转发">4.2.1 输入端口处理和基于目的地转发</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1218"><a class="md-toc-inner" href="#422-交换">4.2.2 交换</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1229"><a class="md-toc-inner" href="#423-输出端口处理">4.2.3 输出端口处理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1232"><a class="md-toc-inner" href="#424-何处出现排队">4.2.4 何处出现排队</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1243"><a class="md-toc-inner" href="#425-分组调度">4.2.5 分组调度</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1254"><a class="md-toc-inner" href="#43-网际协议ipv4寻址ipv6及其他">4.3 网际协议：IPv4、寻址、IPv6及其他</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1256"><a class="md-toc-inner" href="#431-ipv4数据报格式">4.3.1 IPv4数据报格式</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1283"><a class="md-toc-inner" href="#432-ipv4数据报分片">4.3.2 IPv4数据报分片</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1293"><a class="md-toc-inner" href="#433-ipv4编址">4.3.3 IPv4编址</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1328"><a class="md-toc-inner" href="#434-网络地址转换nat）">4.3.4 网络地址转换（NAT）</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1335"><a class="md-toc-inner" href="#435-ipv6">4.3.5 IPv6</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1365"><a class="md-toc-inner" href="#44-通用转发和sdn">4.4 通用转发和SDN</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1387"><a class="md-toc-inner" href="#五网络层控制平面">五、网络层：控制平面</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1389"><a class="md-toc-inner" href="#51-概述">5.1 概述</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1398"><a class="md-toc-inner" href="#52-路由选择算法">5.2 路由选择算法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1419"><a class="md-toc-inner" href="#521-the-link-state-ls-routing-algorithm">5.2.1 The Link-State (LS) Routing Algorithm</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1424"><a class="md-toc-inner" href="#522-the-distance-vector-dv-routing-algorithm">5.2.2 The Distance-Vector (DV) Routing Algorithm</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1488"><a class="md-toc-inner" href="#53-intra-as-routing-in-the-internet-ospf">5.3 Intra-AS Routing in the Internet: OSPF</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1510"><a class="md-toc-inner" href="#54-routing-among-the-isps-bgp">5.4 Routing Among the ISPs: BGP</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1512"><a class="md-toc-inner" href="#541-bgp作用">5.4.1 BGP作用</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1520"><a class="md-toc-inner" href="#542-通告advertise）bgp路由信息">5.4.2 通告（advertise）BGP路由信息</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1528"><a class="md-toc-inner" href="#543-确定最好的路由">5.4.3 确定最好的路由</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1547"><a class="md-toc-inner" href="#544-ip任播">5.4.4 IP任播</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1556"><a class="md-toc-inner" href="#545-路由选择策略">5.4.5 路由选择策略</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1562"><a class="md-toc-inner" href="#55-sdn控制平面">5.5 SDN控制平面</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1564"><a class="md-toc-inner" href="#551-结构">5.5.1 结构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1574"><a class="md-toc-inner" href="#552-openflow协议">5.5.2 OpenFlow协议</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1594"><a class="md-toc-inner" href="#553-例子">5.5.3 例子</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1611"><a class="md-toc-inner" href="#56-icmp-the-internet-control-message-protocol">5.6 ICMP: The Internet Control Message Protocol</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1616"><a class="md-toc-inner" href="#57-网络管理和snmp">5.7 网络管理和SNMP</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1621"><a class="md-toc-inner" href="#571-网络管理框架">5.7.1 网络管理框架</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1634"><a class="md-toc-inner" href="#572-the-simple-network-management-protocol-snmp">5.7.2 The Simple Network Management Protocol (SNMP)</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1641"><a class="md-toc-inner" href="#六链路层和局域网">六、链路层和局域网</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1650"><a class="md-toc-inner" href="#61-链路层概述">6.1 链路层概述</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1659"><a class="md-toc-inner" href="#611-链路层提供的服务">6.1.1 链路层提供的服务</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1670"><a class="md-toc-inner" href="#612-链路层在何处实现">6.1.2 链路层在何处实现</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1673"><a class="md-toc-inner" href="#62-差错检测和纠正技术">6.2 差错检测和纠正技术</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1675"><a class="md-toc-inner" href="#621-奇偶校验">6.2.1 奇偶校验</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1687"><a class="md-toc-inner" href="#622-检验和方法">6.2.2 检验和方法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1690"><a class="md-toc-inner" href="#623-循环冗余检测">6.2.3 循环冗余检测</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1702"><a class="md-toc-inner" href="#63-多路访问链路和协议">6.3 多路访问链路和协议</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1716"><a class="md-toc-inner" href="#631-信道划分协议">6.3.1 信道划分协议</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1727"><a class="md-toc-inner" href="#632-随机接入协议">6.3.2 随机接入协议</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1790"><a class="md-toc-inner" href="#633-轮流协议">6.3.3 轮流协议</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1811"><a class="md-toc-inner" href="#634-案例docsis">6.3.4 案例：DOCSIS</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1828"><a class="md-toc-inner" href="#64-交换局域网">6.4 交换局域网</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1831"><a class="md-toc-inner" href="#641-链路层寻址和arp">6.4.1 链路层寻址和ARP</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1884"><a class="md-toc-inner" href="#642-以太网">6.4.2 以太网</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1908"><a class="md-toc-inner" href="#643-链路层交换机">6.4.3 链路层交换机</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1969"><a class="md-toc-inner" href="#644-虚拟局域网">6.4.4 虚拟局域网</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1983"><a class="md-toc-inner" href="#65-link-virtualization-a-network-as-a-link-layer">6.5 Link Virtualization: A Network as a Link Layer</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1985"><a class="md-toc-inner" href="#66-数据中心网络">6.6 数据中心网络</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1991"><a class="md-toc-inner" href="#67-web页面请求的历程">6.7 Web页面请求的历程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1994"><a class="md-toc-inner" href="#671-准备dhcpudpip和以太网">6.7.1 准备：DHCP、UDP、IP和以太网</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2037"><a class="md-toc-inner" href="#672-仍在准备dns和arp">6.7.2 仍在准备：DNS和ARP</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2051"><a class="md-toc-inner" href="#673-仍在准备域内路由选择到dns服务器">6.7.3 仍在准备：域内路由选择到DNS服务器</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2061"><a class="md-toc-inner" href="#674-web客户-服务器交互tcp和http">6.7.4 Web客户-服务器交互：TCP和HTTP</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n2079"><a class="md-toc-inner" href="#七无线网络和移动网络">七、无线网络和移动网络</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2089"><a class="md-toc-inner" href="#71-概述">7.1 概述</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2111"><a class="md-toc-inner" href="#72-无线链路和网络特征">7.2 无线链路和网络特征</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2131"><a class="md-toc-inner" href="#73-wifi80211无线lan">7.3 WiFi：802.11无线LAN</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2159"><a class="md-toc-inner" href="#731-80211体系结构">7.3.1 802.11体系结构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2178"><a class="md-toc-inner" href="#732-80211mac协议">7.3.2 802.11MAC协议</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2204"><a class="md-toc-inner" href="#733-ieee-80211帧">7.3.3 IEEE 802.11帧</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2247"><a class="md-toc-inner" href="#734-在相同ip子网中的移动性">7.3.4 在相同IP子网中的移动性</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2255"><a class="md-toc-inner" href="#735-80211中的高级特色">7.3.5 802.11中的高级特色</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2262"><a class="md-toc-inner" href="#736-个人域网络蓝牙和zigbee">7.3.6 个人域网络：蓝牙和ZigBee</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2283"><a class="md-toc-inner" href="#74-蜂窝因特网接入">7.4 蜂窝因特网接入</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2285"><a class="md-toc-inner" href="#741-2g">7.4.1 2G</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2299"><a class="md-toc-inner" href="#742-3g">7.4.2 3G</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2315"><a class="md-toc-inner" href="#743-4g">7.4.3 4G</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2325"><a class="md-toc-inner" href="#75-移动管理">7.5 移动管理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2347"><a class="md-toc-inner" href="#751-寻址">7.5.1 寻址</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2354"><a class="md-toc-inner" href="#752-路由选择到移动节点">7.5.2 路由选择到移动节点</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2364"><a class="md-toc-inner" href="#76-移动ip">7.6 移动IP</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2374"><a class="md-toc-inner" href="#77-管理蜂窝网中的移动性">7.7 管理蜂窝网中的移动性</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2376"><a class="md-toc-inner" href="#78-无线和移动性对高层协议的影响">7.8 无线和移动性：对高层协议的影响</a></span></p></div><h1 id='一计算机网络和因特网'><span>一、计算机网络和因特网</span></h1><p><span>本章相当于计网的绪论，讲述了一些基础术语和想法，意在展现计网的big picture。</span></p><h2 id='11-什么是因特网'><span>1.1 什么是因特网</span></h2><p><span>我们将从两个角度回答这个问题：</span></p><ul><li><p><strong><span>组成的角度</span></strong><span>：描述组成它的软硬件</span></p></li><li><p><strong><span>功能的角度</span></strong><span>：将其视为为分布式应用提供基础服务的联网设施</span></p></li></ul><h3 id='111-组成描述'><span>1.1.1 组成描述</span></h3><p><img src="./img/networkstructure.jpg" style="zoom:50%;" /></p><p><span>首先看一些术语：</span></p><ul><li><p><strong><span>主机（host）/ 端系统（end system）</span></strong><span>: 所有接入因特网的设备。除了常见的联网手机电脑等，还包括联网的汽车、冰箱、空调等等。主机又可以进一步分成</span><strong><span>客户端（client）</span></strong><span>和</span><strong><span>服务器（server）</span></strong><span>。</span></p></li><li><p><strong><span>通信链路（communication link）</span></strong><span>：或者简称</span><strong><span>链路（link）</span></strong><span>。即将端系统连接在一起的物理媒介。如双绞线、同轴电缆等。链路的</span><strong><span>传输速率（transmission rate）</span></strong><span>以</span><strong><span>比特/秒（bit/s，或bps）</span></strong><span>度量。</span></p></li><li><p><strong><span>包/分组（packet）</span></strong><span>：端系统之间交换的数据是分段的，一段数据称为一个包（或者称为分组）。</span></p></li><li><p><strong><span>包交换机/分组交换机（packet switch）</span></strong><span>：从它的一条入链路接收分组，并且选择一条出链路将分组</span><strong><span>转发（forward）</span></strong><span>出去，包括：</span></p><ul><li><p><strong><span>路由（router）</span></strong><span>：主要用于</span><strong><span>网络核心（network core）</span></strong></p></li><li><p><strong><span>链路层交换机（link-layer switch）</span></strong><span>：主要用于</span><strong><span>接入网（access network）</span></strong></p></li></ul><p><em><span>网络核心和接入网在1.2和1.3讨论</span></em></p></li><li><p><strong><span>路径（route, or path）</span></strong><span>：包从一个端系统到另一个端系统所遍历的链路和分组交换机序列。</span></p></li></ul><p><span>知道以上术语后，我们可以概括到：</span></p><blockquote><p><span>在组成的角度下，因特网是一个由大量端系统通过链路和分组交换机连接而成的网络。</span></p></blockquote><p><span>此外，还有：</span></p><ul><li><p><strong><span>因特网服务提供商（Internet Service Provider, ISP）</span></strong><span>：提供接入因特网的服务。ISP自身也是一个由包交换机和通信链路组成的网络。</span></p></li><li><p><strong><span>协议（protocol）</span></strong><span>：因特网的各种组件都要遵守各式各样的协议，才能保证信息的正常接收和发送。最重要的两个协议是</span><strong><span>TCP（Transmission Control Protocol）</span></strong><span>和</span><strong><span>IP（Internet Protocol）</span></strong><span>协议。作者如下定义协议：</span></p><blockquote><p><span>A </span><strong><span>protocol</span></strong><span> defines the format and the order of messages exchanged between two or more communicating entities, as well as the actions taken on the transmission and/or receipt of a message or other event.</span></p></blockquote><p><span>譬如：硬件实现的控制协议控制了两块网卡之间的比特流；在端系统中，拥塞控制协议控制了发送方和接收方之间传输数据的速率；路由器中的协议决定了包的路径。</span></p></li></ul><h3 id='112-服务描述'><span>1.1.2 服务描述</span></h3><p><span>作者概括到：</span></p><blockquote><p><span>在服务的角度下，因特网是给应用提供服务的基础设施。</span></p></blockquote><p><span>互联网应用程序通常是</span><strong><span>分布式应用程序（distributed application）</span></strong><span>。这些应用程序运行在多个端系统上，并通过互联网交换数据。端系统和因特网的接口被称作</span><strong><span>套接字接口（socket interface）</span></strong><span>，该接口规定了在一个端系统运行的程序如何请求因特网基础设施，从而将数据传播到另一个端系统上运行的特定程序。</span></p><h2 id='12-网络边缘'><span>1.2 网络边缘</span></h2><p><span>所谓的</span><strong><span>网络边缘（network edge）</span></strong><span>通常就是指网络的</span><strong><span>接入层（access layer）</span></strong><span>，也就是网络中直接面向用户连接或访问的部分</span><em><span>（定义来自百度百科）</span></em><span>。与之对应的是</span><strong><span>网络核心（network core）</span></strong><span>，网络核心我们将会讨论交换等话题，是下一节的内容。本节中我们将讨论</span><strong><span>接入网（access network）</span></strong><span>和</span><strong><span>物理传输介质（physical meida）</span></strong><span>。</span></p><h3 id='121-接入网'><span>1.2.1 接入网</span></h3><p><img src="./img/accessnetwork.jpg" style="zoom:50%;" /></p><p><span>接入网是指物理上连接端系统到第一个路由器的网络，这个路由器也称为</span><strong><span>边缘路由器（edge router）</span></strong><span>。根据接入方式的不同，可以分为：</span></p><p><strong><span>1. 家庭接入</span></strong></p><p><strong><span>1）DSL（digital subscriber line，数字用户线路）</span></strong></p><p><span>DSL是一种以电话线（双绞线）为传输介质的通信技术。它的ISP就是本地电话公司。由于PC发出的是数字信号，而电话线传播的是模拟信号，所以我们需要使用</span><strong><span>调制解调器（modem，猫）</span></strong><span>，其中发送端将数字信号变成模拟信号称为</span><strong><span>调制（modulation）</span></strong><span>、接收端将模拟信号变回数字信号称为</span><strong><span>解调（demodulation）</span></strong><span>。</span></p><p><span>电话线采用</span><strong><span>频分复用技术（frequency-division multiplexing）</span></strong><span>分成了电话、上行和下行三个相对独立的信道，使得用户可以在上网的同时打电话。可以看到下行速率是大于上行速率的（下载速度大于上传速度），于是也称为</span><strong><span>非对称数字用户线路（ADSL，Asymmetric Digital Subscriber Line）</span></strong><span>。</span></p><p><span>电话线的另一头是</span><strong><span>数字用户线接入复用器（DSLAM，digital subscriber line access multiplexer）</span></strong><span>，DSLAM坐落在电话公司的本地</span><strong><span>中心局（central office，CO）</span></strong><span>中。DSLAM会把电话线的模拟信号重新转为数字信号。</span></p><p><img src="./img/DSL.jpg" style="zoom:67%;" /></p><p><strong><span>2）Cable Internet Access 电缆因特网接入</span></strong></p><p><span>DSL使用了电话公司现有的电话基础设施，而电缆因特网接入则使用了有线电视现有的基础设施。通信链路同时使用了光纤和同轴电缆，因此该系统也被称为</span><strong><span>混合光纤同轴（Hybrid Fiber Coax, HFC）</span></strong><span>系统。用户使用</span><strong><span>电缆调制解调器（cable modem）</span></strong><span>通过同轴电缆与</span><strong><span>光纤节点（fiber node）</span></strong><span>相连，光纤节点通过光缆与</span><strong><span>电缆头端（cable head end）</span></strong><span>相连。在电缆头端，</span><strong><span>电缆调制解调器端接系统（Cable Modem Termination System）</span></strong><span>起到DSLAM的作用，即把下行家庭中电缆调制解调器发送的模拟信号转换回数字信号。电缆调制解调器将HFC网络划分为上行和下行两个信道，通常下行速率高于上行速率。</span></p><p><img src="./img/cable.jpg" style="zoom: 67%;" /></p><p><span>电缆因特网接入的一个重要特点是</span><strong><span>共享广播媒介（shared broadcast medium）</span></strong><span>。也就是说：由头端向下行发送的每个包会广播到所有家庭；每个家庭发送的包也是通过共享的上行信道向头端传输。这就会产生多人同时使用网络导致网速变慢的情况。而DSL下，每户人家到中心局的接入是专线。</span></p><p><strong><span>3）光纤到户（Fiber To The Home, FTTH）</span></strong></p><p><span>就是提供了一根光纤直接从本地中心局到每个家庭中。具体有以下方案：</span></p><ul><li><p><strong><span>直接光纤（direct fiber）</span></strong><span>：每户人家独享一根光纤到中心局，成本太高。</span></p></li><li><p><strong><span>optical-distribution network architecture</span></strong><span>: 从中心局出来的每根光纤由许多家庭共享，直到相对接近这些家庭的位置时，才分成每户一根光纤。这里“分成”有两个竞争方案：</span></p><ul><li><p><strong><span>AON（active optical network，主动光纤网络）</span></strong><span>：本质上是</span><strong><span>交换以太网（switched Ethernet）</span></strong><span>，第六章再讨论。</span></p></li><li><p><strong><span>PON（passive optical network，被动光纤网络）</span></strong><span>：每个家庭有</span><strong><span>光纤网络端接器（optical network terminator, ONT）</span></strong><span>。中心局有</span><strong><span>光纤线路端接器（optical line terminator，OLT）</span></strong><span>。OLT将光信号转变为电信号。和电缆因特网接入类似，光纤分配器将把所有OLT发来的包广播给所有下游家庭。通常家庭里会用一台无线路由器与ONT相连，并用这台路由器接入因特网。</span></p></li></ul></li></ul><p><img src="./img/FTTH.jpg" style="zoom: 67%;" /></p><p><strong><span>4）其他</span></strong></p><p><span>在偏远地区有</span><strong><span>卫星链路</span></strong><span>可以上网。还可以用电话线</span><strong><span>拨号上网（dial-up access）</span></strong><span>，注意到拨号上网时就不能打电话了。</span></p><p><strong><span>2. 企业（和家庭）接入</span></strong></p><p><strong><span>1）以太网（Ethernet）</span></strong></p><p><span>使用</span><strong><span>局域网（LAN，local area network）</span></strong><span>将端系统连接到边缘路由器。</span><strong><span>以太网（Ethernet）</span></strong><span>是最流行的局域网接入方式。用户使用双绞线与</span><strong><span>以太网交换机（Ethernet switch）</span></strong><span>相连，从而接入因特网。</span></p><p><img src="./img/ethernet.jpg" style="zoom: 80%;" /></p><p><strong><span>2）WiFi</span></strong></p><p><span>WiFi是一种无线局域网（wireless LAN）技术。企业中用户可以接入</span><strong><span>基站（base station）</span></strong><span>（或者称为</span><strong><span>接入点 access point</span></strong><span>），基站再和企业网（通常是有线以太网）相连，有线以太网再和有线因特网相连。家庭里我们可以接入基站，基站再和路由器相连，路由器通过猫接入因特网。</span></p><p><strong><span>3. 广域无线接入</span></strong></p><p><span>即3G、LTE等技术。通过</span><strong><span>蜂窝网络（cellular network）</span></strong><span>提供商运营的基站来发送和接收分组。基站信号比局域网覆盖更远。</span></p><h3 id='122-物理媒介'><span>1.2.2 物理媒介</span></h3><p><strong><span>物理媒介（physical media）</span></strong><span>可以分为：</span></p><ul><li><p><strong><span>guided media（导引型媒体）</span></strong><span>：电波沿着固体媒介传播</span></p></li><li><p><strong><span>unguided media（非导引型媒体）</span></strong><span>：电波在空气或外层空间传播</span></p></li></ul><p><span>成本不高，比人工便宜。</span></p><p><span>具体有：</span></p><ul><li><p><strong><span>双绞铜线（twisted-pair copper wire）</span></strong><span>：便宜。由两条相互螺旋缠绕的铜线组成。用于电话网和局域网。现代的双绞线技术速率（10Mbps</span><span>~</span><span>10Gbps）和传输距离（</span><span>~</span><span>100m）还可以。</span></p></li><li><p><strong><span>同轴电缆（coaxial cable）</span></strong><span>：也由两个铜导体构成，但是它们是同心的，而非并行的。借助特殊的结构和绝缘层，同轴电缆可得到较高的数据传输速率；在有线电视系统中应用广泛；同轴电缆可被用作引导型的共享媒体。</span></p></li><li><p><strong><span>光纤（fiber optic）</span></strong><span>：一种可以引导光脉冲的媒体。快（~100Gbps）、传播长、传播损失小。贵。</span></p></li><li><p><strong><span>陆地无线电信道</span></strong><span>：地面基站发送的电磁波。</span></p></li><li><p><strong><span>卫星无线电信道</span></strong><span>：卫星发送的电磁波。</span></p></li></ul><h2 id='13-网络核心'><span>1.3 网络核心</span></h2><p><strong><span>网络核心（network core）</span></strong><span>即：the mesh of packet switches and links that interconnects the Internet&#39;s end system. 本节我们将探讨</span><strong><span>分组交换（packet switch）</span></strong><span>，和对应的</span><strong><span>电路交换（circuit switch）</span></strong><span>，以及网络结构。</span></p><p><img src="./img/networkcore.jpg" style="zoom:50%;" /></p><h3 id='131-分组交换'><span>1.3.1 分组交换</span></h3><p><span>端系统彼此交换</span><strong><span>报文（message）</span></strong><span>，（应用层的数据称为报文）。报文包括了控制信息和数据信息。源端系统将报文划分为多个数据块，这个数据块称为</span><strong><span>包（packet）</span></strong><span>或者</span><strong><span>分组</span></strong><span>。我们已经再1.1.1节提及分组交换了，还有以下几点内容需要补充。</span></p><ul><li><p><strong><span>存储转发传输（store-and-forward transmission）</span></strong><span>：交换机在收到一个完成的分组后，才会向链路输出转发分组，否则就将收到的部分分组缓存起来。因等待一个分组的全部数据而导致的时间开销被称为</span><strong><span>存储转发时延（store-and-forward delay）</span></strong><span>。</span></p></li><li><p><strong><span>排队时延（queuing delay）和丢包（packet loss）</span></strong><span>：对每个输出链路，分组交换机都有一个</span><strong><span>输出缓存（output buffer）</span></strong><span>或者称为</span><strong><span>输出队列（output queue）</span></strong><span>。当一个输出链路被占用时，包需要在队列中等待，等待时间称为排队时延。当队列满时，新来的包会被丢弃，称为丢包。</span></p></li><li><p><strong><span>转发表（forwarding table）和路由选择协议（routing protocol）</span></strong><span>：分组交换机之所以能够知道往哪转发分组是因为其内部有一个</span><strong><span>转发表</span></strong><span>，这个表维护了一个IP地址和链路的对应关系。而转发表的设置是通过特殊的路由选择协议实现的。</span></p></li></ul><h3 id='132-电路交换'><span>1.3.2 电路交换</span></h3><p><strong><span>分组交换和电路交换区别</span></strong></p><p><span>In circuit-switched networks, the resources needed along a path (buffers, link transmission rate) to provide for communication between the end systems are </span><em><span>reserved</span></em><span> for the duration of the communication session between the end systems. 相当于预定餐馆的座位</span></p><p><span>In packet-switched networks, these resources are </span><em><span>not</span></em><span> reserved; a session&#39;s messages use the resources on demand and, as a consequence, may have to wait (i.e. queue) for access to a communication link. 相当于直接去餐馆吃饭，但是不一定有位置</span></p><p><strong><span>例子</span></strong></p><p><span>传统的电话网络就是一个电路交换网络。在发送方发送信息之前，该网络必须在发送方和接收方之间建立一条连接，此时路径上的交换机都将为这种连接维护连接状态。用电话的术语来说，该连接称为一条</span><strong><span>电路（circuit）</span></strong><span>。当网络创建这种电路时，它也在连接期间在该网络链路上预留了恒定的传输速率，使得发送方能以恒定速率向接收方传送数据。</span></p><p><strong><span>复用</span></strong></p><p><span>为了高效合理地利用资源，通常采用</span><strong><span>多路复用技术（multiplexing）</span></strong><span> ，使多路信号共享同一条链路进行传输。书上介绍了</span><strong><span>频分复用（frequency-division multiplexing, FDM）</span></strong><span>和</span><strong><span>时分复用（time-division multiplexing, TDM）</span></strong><span>。</span></p><ul><li><p><strong><span>FDM</span></strong><span>：将频率域划分为频段，然后将频段分配给连接；此频段被用来专门传输链接的数据。该频段的宽度称为</span><strong><span>带宽（bandwidth）</span></strong><span>。譬如无线广播AM或FM。</span></p></li><li><p><strong><span>TDM</span></strong><span>：是指将时间划分为固定时长的</span><strong><span>帧（frame）</span></strong><span>，每个帧则又被划分为固定数量的时间片段（</span><strong><span>slot，时隙</span></strong><span>）；当网络需要建立一条连接时，网络将在每个帧中为该连接指定一个时隙；在该时隙内，链路用来传输该连接的数据。</span></p></li></ul><p><img src="./img/FDMTDM.jpg" style="zoom:50%;" /></p><p><strong><span>分组交换和电路交换的对比</span></strong></p><ul><li><p><strong><span>分组交换</span></strong></p><ul><li><p><strong><span>优点</span></strong><span>：它提供了比电路交换更好的带宽共享；它比电路交换更简单、更有效、实现成本更低。允许更多用户</span></p></li><li><p><strong><span>缺点</span></strong><span>：分组交换不适合实时服务，因为端到端的时延是可变、不可预测的，这和整个网络的情况相关</span></p></li></ul></li><li><p><strong><span>电路交换</span></strong></p><ul><li><p><strong><span>优点</span></strong><span>：提供了端对端传输数据的速率保证；</span></p></li><li><p><strong><span>缺点</span></strong><span>：电路交换存在</span><strong><span>静默期（silent period）</span></strong><span>，这是指专用电路空闲时，其占用的资源并没有得到充分的利用；建立连接的过程比较复杂</span></p></li></ul></li></ul><h3 id='133-网络的网络'><span>1.3.3 网络的网络</span></h3><p><span>我们已经知道了端系统通过access ISP连接因特网。那这些access ISP怎么互相连接呢？这里直接给出最终的样子：</span></p><p><img src="./img/netofnet.jpg" style="zoom: 33%;" /></p><p><span>我们可以这么思考这个问题。首先如果接入网两两连接形成全连接图，那么会导致复杂度爆炸，肯定是不可行的。于是我们会想让接入网连到一个全球承载ISP（global transit ISP）上，全球ISP向用户收费。既然有钱可赚，那么会有多个全球ISP。注意到，这些全球ISP之间必须要相互连通。我们可以通过peer link（图中红线），也可以设置</span><strong><span>IXP（internet exchange point）</span></strong><span>专门给它们交换数据。全球ISP可能照顾不了角角落落，于是我们有regional net来负责区域的接入网。最后我们还有</span><strong><span>内容提供商网络（content provider network）</span></strong><span>，譬如谷歌等公司会运行自己的网络，来给用户提供服务和内容。</span></p><h2 id='14-分组交换中的时延丢包吞吐量'><span>1.4 分组交换中的时延、丢包、吞吐量</span></h2><h3 id='141-时延'><span>1.4.1 时延</span></h3><p><img src="./img/delay.jpg" style="zoom:50%;" /></p><p><span>时延包括：</span></p><ul><li><p><strong><span>处理时延（processing delay）</span></strong><span>：处理时延是因为节点需要解析分组的必要信息然后决定其出链路（索引转发表等操作）而产生的，通常在微秒或者更低数量级。</span></p></li><li><p><strong><span>排队时延（queuing delay）</span></strong><span>：分组在链路上等待传输而产生的时延，和队列的流量强度相关，通常在毫秒级到微秒级。</span></p></li><li><p><strong><span>传输时延（transmission delay）</span></strong><span>：传输时延是将所有分组的比特推向链路所有需要的时间，实际的传输时延通常在毫秒到微秒数量级。若用L表示分组的长度、R bits/sec表示从路由器A到B的链路传输速率，则传输时延是L/R。</span></p></li><li><p><strong><span>传播时延（propagation delay）</span></strong><span>：传播时延是指比特进入链路后，从该链路的起点到下一个结点所用的时间；广域网中，传播时延一般是毫秒级的。若d是路由器A到B的距离、s是链路的传播速率，则传播时延是d/s。</span></p></li></ul><p><strong><span>传输时延和传播时延的对比</span></strong></p><p><span>如果打个比方的话，传输时延就是大卡车经过收费站的时间而传播时延就是车在高速公路上行驶的时间。传输时延是分组长度和链路传输速率的函数。传播时延是两台路由器间距离和链路传播速率的函数</span></p><p><span>四个时延相加得到</span><strong><span>节点时延（nodal delay）</span></strong><span>:</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n172" cid="n172" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="36.04ex" height="2.22ex" role="img" focusable="false" viewBox="0 -694 15929.8 981.2" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.65ex;"><defs><path id="MJX-1-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-1-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-I-1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path><path id="MJX-1-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-1-TEX-I-1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path><path id="MJX-1-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-1-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-1-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-I-1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path><path id="MJX-1-TEX-N-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path id="MJX-1-TEX-I-1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-1-TEX-I-1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-1-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-1-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g><g data-mml-node="TeXAtom" transform="translate(553,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(600,0)"><use data-c="1D45C" xlink:href="#MJX-1-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(1085,0)"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(1605,0)"><use data-c="1D44E" xlink:href="#MJX-1-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(2134,0)"><use data-c="1D459" xlink:href="#MJX-1-TEX-I-1D459"></use></g></g></g><g data-mml-node="mo" transform="translate(2600.5,0)"><use data-c="3D" xlink:href="#MJX-1-TEX-N-3D"></use></g><g data-mml-node="msub" transform="translate(3656.2,0)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g><g data-mml-node="TeXAtom" transform="translate(553,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45D" xlink:href="#MJX-1-TEX-I-1D45D"></use></g><g data-mml-node="mi" transform="translate(503,0)"><use data-c="1D45F" xlink:href="#MJX-1-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(954,0)"><use data-c="1D45C" xlink:href="#MJX-1-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(1439,0)"><use data-c="1D450" xlink:href="#MJX-1-TEX-I-1D450"></use></g></g></g><g data-mml-node="mo" transform="translate(5805.2,0)"><use data-c="2B" xlink:href="#MJX-1-TEX-N-2B"></use></g><g data-mml-node="msub" transform="translate(6805.4,0)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g><g data-mml-node="TeXAtom" transform="translate(553,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45E" xlink:href="#MJX-1-TEX-I-1D45E"></use></g><g data-mml-node="mi" transform="translate(460,0)"><use data-c="1D462" xlink:href="#MJX-1-TEX-I-1D462"></use></g><g data-mml-node="mi" transform="translate(1032,0)"><use data-c="1D452" xlink:href="#MJX-1-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(1498,0)"><use data-c="1D462" xlink:href="#MJX-1-TEX-I-1D462"></use></g><g data-mml-node="mi" transform="translate(2070,0)"><use data-c="1D452" xlink:href="#MJX-1-TEX-I-1D452"></use></g></g></g><g data-mml-node="mo" transform="translate(9423.8,0)"><use data-c="2B" xlink:href="#MJX-1-TEX-N-2B"></use></g><g data-mml-node="msub" transform="translate(10424.1,0)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g><g data-mml-node="TeXAtom" transform="translate(553,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-1-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D45F" xlink:href="#MJX-1-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(812,0)"><use data-c="1D44E" xlink:href="#MJX-1-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(1341,0)"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(1941,0)"><use data-c="1D460" xlink:href="#MJX-1-TEX-I-1D460"></use></g></g></g><g data-mml-node="mo" transform="translate(12953.4,0)"><use data-c="2B" xlink:href="#MJX-1-TEX-N-2B"></use></g><g data-mml-node="msub" transform="translate(13953.6,0)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g><g data-mml-node="TeXAtom" transform="translate(553,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45D" xlink:href="#MJX-1-TEX-I-1D45D"></use></g><g data-mml-node="mi" transform="translate(503,0)"><use data-c="1D45F" xlink:href="#MJX-1-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(954,0)"><use data-c="1D45C" xlink:href="#MJX-1-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(1439,0)"><use data-c="1D45D" xlink:href="#MJX-1-TEX-I-1D45D"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>d</mi><mrow data-mjx-texclass="ORD"><mi>n</mi><mi>o</mi><mi>d</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>=</mo><msub><mi>d</mi><mrow data-mjx-texclass="ORD"><mi>p</mi><mi>r</mi><mi>o</mi><mi>c</mi></mrow></msub><mo>+</mo><msub><mi>d</mi><mrow data-mjx-texclass="ORD"><mi>q</mi><mi>u</mi><mi>e</mi><mi>u</mi><mi>e</mi></mrow></msub><mo>+</mo><msub><mi>d</mi><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>s</mi></mrow></msub><mo>+</mo><msub><mi>d</mi><mrow data-mjx-texclass="ORD"><mi>p</mi><mi>r</mi><mi>o</mi><mi>p</mi></mrow></msub></math></mjx-assistive-mml></mjx-container></div></div><h3 id='142-排队时延和丢包'><span>1.4.2 排队时延和丢包</span></h3><p><span>在1.3.1其实已经做了初步讨论了。若一个包有L位，每秒有a个包，链路传输速率是R，那么La/R被称为</span><strong><span>流量强度（traffic intensity）</span></strong><span>。当流量强度大于1时，等待队列里的数据将趋向无穷多，丢包不可避免。</span></p><h3 id='143-吞吐量'><span>1.4.3 吞吐量</span></h3><p><span>吞吐量可以近似为源和目的地之间路径的最小传输速率。最小传输速率的链路为</span><strong><span>瓶颈链路（bottleneck link）</span></strong><span>。在今天，因特网对吞吐率的限制因素通常是接入网。</span></p><h2 id='15-协议层次及其服务模型'><span>1.5 协议层次及其服务模型</span></h2><p><span>为了给网络协议的设计提供一个结构，网络设计者以</span><strong><span>分层（layer）</span></strong><span>的方式组织协议以及实现这些协议的软硬件。每个协议属于这些层次之一。每个协议通过以下方式提供服务：1. 在这层中执行了某些操作；2. 使用直接下层的服务。</span></p><p><span>协议分层具有概念化和结构化的优点。模块化使得更新系统组件更为容易。但是分层也有其缺点，如功能上的冗余，以及某层需要在其它层才出现的信息。</span></p><p><span>总体来说，将各层的所有协议组合起来，称为</span><strong><span>协议栈（protocol stack）</span></strong><span>。因特网的协议栈有5个层次组成：物理层、链路层、网络层、传输层、应用层。</span></p><ul><li><p><strong><span>应用层（application layer）</span></strong><span>：应用层协议分布在多个端系统，端系统中的应用程序使用该协议与另一个端系统中的应用程序通信。处于应用层的分组称为</span><strong><span>报文（message）</span></strong><span>。应用层协议包括HTTP、SMTP、FTP等。</span></p></li><li><p><strong><span>运输层（transport layer）</span></strong><span>：传输层在application endpoints之间传输应用层报文。因特网中有两个传输层协议：TCP和UDP。传输层的分组称为</span><strong><span>报文段（segment）</span></strong><span>。TCP提供确保传递、流量控制、拥塞控制机制。UDP提供无连接服务，即不提供不必要服务的服务。没有可靠性、没有流量和拥塞控制。</span></p></li><li><p><strong><span>网络层（network layer）</span></strong><span>：网络层将称为</span><strong><span>数据报（datagram）</span></strong><span>的网络层分组从一台主机移动到另一台主机。网络层协议包含IP协议以及其他一些路由选择协议。</span></p></li><li><p><strong><span>链路层（link layer）</span></strong><span>：链路层将称为</span><strong><span>帧（frame）</span></strong><span>的链路层分组从一个节点（host or router）移动到路径上的另一个节点。协议包括以太网、WiFi和电缆接入网的DOCSIS协议等。</span></p></li><li><p><strong><span>物理层（physical layer）</span></strong><span>：物理层的任务是将帧中的比特从一个节点移动到下一个节点。协议与链路的实际传输媒介相关。</span></p></li></ul><p><strong><span>OSI（open systems interconnection）模型</span></strong><span>是另一种协议栈，由国际标准化组织（ISO）提出。在因特网协议栈的基础上额外还有表示层和会话层。</span></p><ul><li><p><strong><span>表示层（presentation layer）</span></strong><span>：allow applications to interpret meaning of data. e.g., encryption, compression, machine-specific conventions</span></p></li><li><p><strong><span>会话层（session layer）</span></strong><span>：synchronization, checkpointing, recovery of data exchange</span></p></li></ul><p><span>因特网协议栈缺少了上面两层，将两层的功能留给了开发者自行实现。</span></p><p><img src="./img/protostack.jpg" style="zoom:50%;" /></p><p><span>具体来说整个通信过程如下图：（体现了</span><strong><span>封装encapsulation</span></strong><span>的思想，譬如说运输层报文段封装了应用层报文）</span></p><p><img src="./img/encapsulation.jpg" style="zoom: 50%;" /></p><p><span>注意到每一层的分组包括了：</span><strong><span>首部字段（header fields）</span></strong><span>和</span><strong><span>有效负载（payload field）</span></strong><span>。其中有效负载即为来自上一层的分组数据，而首部字段提供了额外信息使得数据能正确传送。</span></p><h2 id='16-网络攻击'><span>1.6 网络攻击</span></h2><p><span>包含：</span></p><ul><li><p><strong><span>恶意软件（malware）</span></strong><span>: 电脑中毒！此外，受害主机可能称为botnet（僵尸网络）中的一员，被操控实现DDoS攻击。</span></p><ul><li><p><strong><span>病毒（virus）</span></strong><span>：self-replicating infection by receiving/executing object。所谓自我复制是指：一旦感染一台主机，就会从那台主机寻求机会进入因特网上的其他主机，从而扩大感染。</span></p></li><li><p><strong><span>蠕虫（worm）</span></strong><span>: self-replicating infection by receiving object that gets itself executed。无明显用户交互，用户可能运行了一个攻击者能发送恶意软件的脆弱的网络应用程序。</span></p></li></ul></li><li><p><strong><span>DoS（Denial-of-Service）</span></strong><span>攻击：让受攻击的网络、端系统或其他基础设施不能被合法用户使用</span></p><ul><li><p><strong><span>Vulnerability attack</span></strong><span>：向目标主机发送一串有意设计的报文，使其奔溃</span></p></li><li><p><strong><span>Bandwidth flooding</span></strong><span>：向目标主机发送大量包，使接入链路拥挤，合法用户不能访问服务器</span></p></li><li><p><strong><span>Connection flooding</span></strong><span>：在目标主机中创建大量的半开或全开TCP连接（第3章讨论），使其停止接受合法的连接。</span></p></li></ul></li><li><p><strong><span>DDoS攻击</span></strong><span>：Dos攻击时大量数据从单一源发出，可能会被某路由器检测出该攻击，并在流量靠近路由器之前就将其阻挡下来，所以有了分布式Dos(Distributed DoS, DDos)攻击，也就是攻击者控制多个源进行DoS攻击。</span></p></li><li><p><strong><span>包嗅探（packet sniffing）</span></strong><span>：由于广播机制，可以获得分组的副本。</span></p></li><li><p><strong><span>IP哄骗（IP snoofing）</span></strong><span>：伪装成你信任的人。</span></p></li></ul><p><em><span>1.7 计算机网络和因特网历史没有整理</span></em></p><hr /><p>&nbsp;</p><h1 id='二应用层'><span>二、应用层</span></h1><p><span>本章我们先会进一步讨论一些基本概念，再仔细研究HTTP、SMTP、DNS等应用层协议，最后讨论P2P体系结构以及视频流的相关内容。</span></p><h2 id='21-应用层协议原理'><span>2.1 应用层协议原理</span></h2><p><span>网络应用开发的核心是：写出能够在不同端系统运行以及可以通过网络彼此通信的程序。值得注意的是，我们不需要写在网络核心设备如路由器或者链路层交换机上运行的软件，毕竟它们连应用层都没有。</span></p><h3 id='211-网络应用程序体系结构'><span>2.1.1 网络应用程序体系结构</span></h3><p><span>在网络应用程序开发者的角度下，有以下两种常见的网络应用程序体系结构：</span></p><ul><li><p><strong><span>客户-服务器体系结构（client-server architecture）</span></strong></p><ul><li><p><span>有一个总是打开的主机（服务器），它服务于来自许多其他主机（客户）的请求。</span><em><span>服务器和客户的定义见2.1.2节</span></em></p></li><li><p><span>服务器具有固定的、周知的地址（IP地址）</span></p></li><li><p><span>大量服务器组成</span><strong><span>数据中心（data center）</span></strong></p></li><li><p><span>客户之间不直接通信</span></p></li></ul></li><li><p><strong><span>P2P体系结构（peer-to-peer, P2P architecture）</span></strong></p><ul><li><p><span>对位于数据中心的专用服务器的依赖小，甚至没有依赖</span></p></li><li><p><span>应用程序在一对间断（intermittently）连接的主机之间直接通信。这些主机被称为</span><strong><span>对等方（peer）</span></strong><span>。</span></p></li><li><p><span>具有</span><strong><span>自扩展性（self-scalability）</span></strong><span>：在请求数据、增加系统工作负载的同时，我也在分发数据，从而增加系统的服务能力。不需要庞大的服务器基础设施和服务器带宽，但是面临安全性、性能和可靠性等挑战。</span></p></li></ul></li></ul><p><img src="./img/csVSp2p.jpg" style="zoom:50%;" /></p><h3 id='212-进程通信'><span>2.1.2 进程通信</span></h3><p><strong><span>客户和服务器进程</span></strong></p><p><span>书上如此定义：</span></p><blockquote><p><span>In the context of a communication between a pair of processes, the process that initiates the communication (that is, initially contacts the other process at the beginning of the session) is labeled as the </span><strong><span>client</span></strong><span>. The process that waits to be contacted to begin the session is the </span><strong><span>server</span></strong><span>.</span></p></blockquote><p><span>注意到无论是客户-服务器还是P2P体系结构，都可以存在客户和服务器进程。特别的，一个进程可以既是客户也是服务器。譬如在P2P文件共享系统中，进程既能请求文件也能发送文件。</span></p><p><em><span>注意到，严格来说是进程之间通信而不是程序之间通信。通信就是指交换报文。</span></em></p><p><strong><span>进程和计算机网络之间的接口</span></strong></p><p><span>1.1.2节已经指出：端系统和因特网的接口被称作</span><strong><span>套接字接口（socket interface）</span></strong><span>。进一步讲，套接字是同一台主机内应用层和运输层之间的接口，也就是应用程序和网络之间的API。</span></p><p><span>开发者可以控制套接字在应用层的一切内容，但是对于运输层端几乎没有控制权，仅限于：</span></p><ul><li><p><span>选择运输层协议</span></p></li><li><p><span>设定几个运输层参数，比如最大缓存和最长传输层报文长度等</span></p></li></ul><p><img src="./img/socket.jpg" style="zoom:50%;" /></p><p><strong><span>进程寻址</span></strong></p><p><span>我们需要定义：</span></p><ul><li><p><span>主机的地址</span></p></li><li><p><span>目的主机接收进程的标识符</span></p></li></ul><p><span>在因特网中，</span><strong><span>IP地址（IP address）</span></strong><span>标识主机，</span><strong><span>端口号（port number）</span></strong><span>标识接收进程。许多协议有自己的默认端口，譬如HTTP默认端口为80，SMTP默认端口为25。</span></p><h3 id='213-运输服务'><span>2.1.3 运输服务</span></h3><p><span>在继续介绍应用层之前，我们需要介绍一点运输层的知识。更多内容将在第三章介绍。</span></p><p><strong><span>应用程序的要求</span></strong></p><p><span>大体有如下四点要求：</span></p><ul><li><p><strong><span>可靠数据传输（reliable data transfer）</span></strong><span>：确保数据不会丢失。对于可以承受一定数据丢失的应用，我们称之为</span><strong><span>loss-tolerant application</span></strong><span>。</span></p></li><li><p><strong><span>吞吐量（throughput）</span></strong><span>：确保某个最低可用吞吐量。具有吞吐量要求的应用称之为</span><strong><span>bandwith-sensitive application</span></strong><span>，如多媒体应用。相反，</span><strong><span>elastic application</span></strong><span>无所谓带宽大小，如电子邮件、文件传输等。（当然还是越大越好）</span></p></li><li><p><strong><span>定时（timing）</span></strong><span>：保证时延上限。譬如像守望先锋等多人在线游戏需要低延迟。</span></p></li><li><p><strong><span>安全性（security）</span></strong><span>：可以加密传输的数据。</span></p></li></ul><p><strong><span>因特网提供的运输服务</span></strong><span>：</span><strong><span>TCP，UDP</span></strong></p><ul><li><p><strong><span>TCP（transmission control protocol，传输控制协议）</span></strong></p><ul><li><p><strong><span>面向连接</span></strong><span>：在应用层报文开始流动前，客户和服务器会先互相交换运输层控制信息，这个过程称为</span><strong><span>握手（handshaking）</span></strong><span>。握手阶段后将建立一个TCP连接。这条链接是</span><strong><span>全双工（full-duplex）</span></strong><span>的，即连接双方使用该条链接可以同时进行报文的收发。这条连接将在通讯结束后拆除。</span></p></li><li><p><strong><span>可靠的数据传输</span></strong><span>：确保无差错、正确顺序的传输。</span></p></li><li><p><strong><span>拥塞控制机制</span></strong><span>：当网络拥塞时，TCP将限制发送进程。不一定为某个通信进程带来好处，但是为网络整体带来好处。</span></p></li><li><p><strong><span>SSL（secure sockets layer, 安全套接字层）</span></strong><span>：TCP的加强版本，提供了加密等安全性服务。</span></p></li></ul></li><li><p><strong><span>UDP（user datagram protocol，用户数据报协议）</span></strong></p><ul><li><p><strong><span>connectionless</span></strong><span>：无握手过程</span></p></li><li><p><strong><span>不可靠数据传输</span></strong><span>：数据可能重复、遗漏、乱序到达</span></p></li><li><p><strong><span>无拥塞控制机制</span></strong></p></li></ul></li></ul><p><span>可以看到运输层无法对吞吐量和定时做出保证，但是可以对可靠数据传输和安全性做出保证。</span></p><h3 id='214-应用层协议'><span>2.1.4 应用层协议</span></h3><p><strong><span>应用层协议（application-layer protocol）</span></strong><span>定义了如何传递报文。具体包括：</span></p><ul><li><p><span>交换的报文类型（请求或者响应）</span></p></li><li><p><span>报文中包含哪些字段（field）</span></p></li><li><p><span>字段的语义</span></p></li><li><p><span>一个进程何时以及如何收发报文</span></p></li></ul><p><span>应用层协议有些位于公共域中的，譬如浏览器都应该遵守HTTP协议；而有些是专用的（proprietary），不为公共所知道和使用的，譬如Skype。</span></p><p><span>接下来，我们将逐一讨论Web、电子邮件、目录服务（DNS）、流式视频和P2P，一共五种网络应用程序，及其相关协议。</span></p><h2 id='22-web和http'><span>2.2 Web和HTTP</span></h2><h3 id='221-http概况'><span>2.2.1 HTTP概况</span></h3><p><span>Web使用了客户-服务器的应用程序体系结构。</span><strong><span>HTTP（HyperText Transfer Protocol，超文本传输协议）</span></strong><span>是Web的应用层协议，定义了客户端（浏览器）和服务器之间传输的报文的结构和方式。有关HTTP我们需要知道：</span></p><ul><li><p><span>HTTP使用TCP作为支撑运输协议，因而HTTP协议不用担心数据丢失，也不关注TCP从网络的数据丢失和乱序故障中恢复的细节。</span></p></li><li><p><span>HTTP是</span><strong><span>无状态协议（stateless protocol）</span></strong><span>，即HTTP服务器并不保存关于客户的任何信息。假如客户在短时间内两次请求同一对象，服务器会发送两次该对象。</span></p></li></ul><p><span>下面是一些Web术语：</span></p><ul><li><p><strong><span>对象（object）</span></strong><span>：一个</span><strong><span>Web页面（Web page）</span></strong><span>由多个对象组成。对象包括HTML文件、JPEG图片、Java小程序等。这些对象可以通过URL寻址。</span></p></li><li><p><strong><span>URL（Universal Resource Locator，统一资源定位符）</span></strong><span>：譬如</span><code>http://www.someSchool.edu/someDepartment/picture.gif</code><span>，其中</span><code>www.someSchool.edu</code><span>称做</span><strong><span>主机名（host name）</span></strong><span>、</span><code>/someDepartment/picture.gif</code><span>称为</span><strong><span>路径名（path name）</span></strong><span>。</span></p></li></ul><h3 id='222-非持续连接和持续连接'><span>2.2.2 非持续连接和持续连接</span></h3><p><span>在因特网应用程序中，客户端和服务器将在很长的时间范围里通信，其中客户发出一系列请求并且服务器对每个请求进行响应。具体来说可以细分为：</span></p><ul><li><p><strong><span>非持续连接（non-persistent connection）</span></strong><span>：每对请求/响应经一个单独的TCP连接发送</span></p></li><li><p><strong><span>持续连接（persistent connection）</span></strong><span>：所有的请求/响应式通过相同的TCP连接发送</span></p></li></ul><p><span>默认情况下，HTTP采用持续连接，当TCP连接在一定时间后未被使用，则关闭这个连接。</span></p><p><span>譬如一个Web页面包含一个HTML和10张图片，那么客户将发出11次（理想情况下）请求。如果是非持续连接的话，会建立11个TCP连接，给Web服务器造成负担，并且每次握手也需要额外的时间；相反持续连接只需要一次TCP连接。此外，非持续连接可以通过并行加速，持续连接可以通过流水线加速。</span></p><p><em><span>忽略了一些内容，更多内容将在第三章讲述</span></em></p><h3 id='223-http报文格式'><span>2.2.3 HTTP报文格式</span></h3><p><span>HTTP报文有两种：</span><strong><span>请求报文（request message）</span></strong><span>和</span><strong><span>响应报文（respond message）</span></strong><span>。下面分别讨论之。</span></p><p><strong><span>1）请求报文</span></strong></p><p><span>先看一个</span><strong><span>例子</span></strong><span>：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="http"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="http"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 35.9809px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27.9948px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">GET</span> <span class="cm-string-2">/somedir/page.html</span> <span class="cm-keyword">HTTP/1.1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">HOST:</span><span class="cm-string"> www.someschool.edu</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Connection:</span><span class="cm-string"> close</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">User-agent:</span><span class="cm-string"> Mozilla/5.0</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Accept-language:</span><span class="cm-string"> fr</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="height: 115px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><ul><li><p><span>第一行叫做</span><strong><span>请求行（request line）</span></strong><span>，包括方法字段（GET）、URL字段（请求对象的路径名）和HTTP版本字段</span></p></li><li><p><span>接下来四行都称为</span><strong><span>首部行（header lines）</span></strong><span>，依次指明了请求对象所在的主机、希望服务器发送完对象后关闭连接、浏览器类型、对象的语言版本。</span></p></li></ul><p><span>HTTP请求报文的</span><strong><span>通用格式</span></strong><span>如下：</span></p><p><img src="./img/httprequest.jpg" style="zoom:50%;" /></p><p><span>方法字段包括：</span></p><ul><li><p><strong><span>GET</span></strong><span>：此时</span><strong><span>实体体（entity body）</span></strong><span>为空</span></p></li><li><p><strong><span>POST</span></strong><span>：譬如在提交表单时、向搜索引擎提供关键词时，需要在实体体中写入相关数据。当然HTML表单也经常使用GET方法，此时数据会在URL中，譬如</span><code>www.somesite.com/animalsearch?monkeys&amp;bananas</code><span>。</span></p></li><li><p><strong><span>HEAD</span></strong><span>：类似于GET，但是服务器只用一个HTTP报文进行响应，不返回请求对象。可以被开发者用来调试跟踪。</span></p></li><li><p><strong><span>PUT</span></strong><span>：常与Web发行工具联合使用。允许用户上传对象到指定路径</span></p></li><li><p><strong><span>DELETE</span></strong><span>：允许用户删除服务器上的对象</span></p></li></ul><p><strong><span>telnet远程登录</span></strong></p><p><span>telnet协议也是应用层的一种协议，telnet程序允许用户远程登录服务器。譬如：（红色框部分为我输入的）</span></p><p><img src="./img/telnet.png" style="zoom: 33%;" /></p><p><strong><span>2）响应报文</span></strong></p><p><span>先看一个</span><strong><span>例子</span></strong><span>：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="http"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="http"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 35.9809px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27.9948px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">HTTP/1.1</span> <span class="cm-positive cm-success">200</span> OK</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Connection:</span><span class="cm-string"> close</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Data:</span><span class="cm-string"> Tue, 18 Aug 2015 15:44:04 GMT</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Server:</span><span class="cm-string"> Apache/2.2.3 (CentOS)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Last-Modified:</span><span class="cm-string"> Tue, 18 Aug 2015 15:11:03 GMT</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Content-Length:</span><span class="cm-string"> 6821</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Content-Type:</span><span class="cm-string"> text/html</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(data data data ...)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 207px;"></div><div class="CodeMirror-gutters" style="height: 207px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><ul><li><p><span>第一行是</span><strong><span>状态行（status line）</span></strong><span>，包括协议版本字段、状态码和相应状态信息</span></p></li><li><p><span>接下来六行是</span><strong><span>首部行（header lines）</span></strong><span>，其中</span></p><ul><li><p><code>connection: close</code><span>告诉客户，发送完报文后将关闭该TCP连接</span></p></li><li><p><code>Data</code><span>是服务器产生并发送该相应报文的时间</span></p></li><li><p><code>Last-Modified</code><span>是对象创建或最后修改的日期和时间</span></p></li></ul></li><li><p><span>最后是</span><strong><span>实体体（entity body）</span></strong><span>，也就是报文的主要部分，包含了请求的对象本身。</span></p></li></ul><p><span>HTTP响应报文的</span><strong><span>通用格式</span></strong><span>如下：</span></p><p><img src="./img/httprespond.jpg" style="zoom:50%;" /></p><p><span>常见的状态码和短语包括：</span></p><ul><li><p><strong><span>200 OK</span></strong><span>：请求成功，信息在返回的响应报文中</span></p></li><li><p><strong><span>301 Moved Permanently</span></strong><span>：请求的对象已经被永久转移了，新的URL在响应报文的</span><code>Location:</code><span>首部行中给出。客户软件将自动获取新的URL。</span></p></li><li><p><strong><span>400 Bad Request</span></strong><span>：通用error code，表明该请求无法被服务器理解</span></p></li><li><p><strong><span>404 Not Found</span></strong><span>：请求的文档不在服务器上</span></p></li><li><p><strong><span>505 HTTP Version Not Supported</span></strong><span>：服务器不支持请求报文使用的HTTP协议</span></p></li></ul><h3 id='224-用户与服务器的交互cookie'><span>2.2.4 用户与服务器的交互：cookie</span></h3><p><span>2.2.1节已提及HTTP是无状态的协议，然而一个Web站点通常希望能够识别用户，无论是想限制用户的访问，还是想定制提供给用户的内容。为此，Web站点可以使用cookie来标识用户。cookie技术包含以下四个部分：</span></p><ul><li><p><span>HTTP响应报文中的cookie首部行（i.e. Set-cookie: header）</span></p></li><li><p><span>HTTP请求报文中的cookie首部行（i.e. Cookie: header）</span></p></li><li><p><span>用户端系统中的cookie文件，由浏览器保存维护</span></p></li><li><p><span>Web站点的一个后端数据库，建立cookie和用户身份的关联</span></p></li></ul><p><span>用cookie追踪用户状态类似如图：</span></p><p><img src="./img/cookie.jpg" style="zoom: 50%;" /></p><p><span>此外，cookie带来的隐私问题仍有争议。</span></p><h3 id='225-web缓存与条件get'><span>2.2.5 Web缓存与条件GET</span></h3><p><strong><span>Web缓存</span></strong></p><p><strong><span>Web缓存器（Web cache）</span></strong><span>也叫做</span><strong><span>代理服务器（proxy server）</span></strong><span>，能代替初始服务器（origin server）来满足HTTP请求。若代理服务器有请求对象的缓存，则用HTTP响应返回该对象；否则向初始服务器发送HTTP请求。类似如图：</span></p><p><img src="./img/webcache.jpg" style="zoom: 50%;" /></p><p><span>Web缓存器</span><strong><span>优势</span></strong><span>有：</span></p><ul><li><p><span>减少对客户请求的响应时间，特别是当客户与初始服务器之间的瓶颈带宽远低于客户与Web缓存器之间的瓶颈带宽时。</span></p></li><li><p><span>减少机构的接入链路到因特网的通信量。于是机构不必着急于增加带宽，从而降低了费用。</span></p></li><li><p><span>减少因特网上的流量，改善整体因特网的性</span></p></li></ul><p><strong><span>条件GET</span></strong></p><p><span>但是代理服务器上缓存的数据可能是过时的，HTTP的</span><strong><span>条件GET（conditional GET）</span></strong><span>可以解决这个问题。</span></p><p><span>条件GET即：</span></p><ul><li><p><span>请求报文使用GET方法</span></p></li><li><p><span>请求报文中包含一个</span><code>If-Modified-Since:</code><span>首部行。</span></p></li></ul><p><strong><span>例子</span></strong><span>如下：</span></p><ol start='' ><li><p><span>Web缓存器向某Web服务器发送一个请求报文：</span></p></li></ol><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 35.9809px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27.9948px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">GET /fruit/kiwi.gif HTTP/1.1</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Host: www.exotiquecuisine.com</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="height: 46px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><ol start='2' ><li><p><span>该Web服务器向缓存器发送具有请求对象的响应报文。缓存器在存储该对象时也存储了最后修改日期（即</span><code>Last-Modified:</code><span>首部行内容）</span></p></li></ol><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 35.9809px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27.9948px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">HTTP/1.1 200 OK</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Data: Sat, 3 Oct 2015 15:39:29</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Server: Apache/1.3.0 (Unix)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Last-Modified: Wed, 9 Sep 2015 09:23:24</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Content-Type: image/gif</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(data data data ...)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="height: 161px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><ol start='3' ><li><p><span>一段时间后，用户经过该缓存器请求同一个对象。该缓存器通过发送一个条件GET执行最新检查。注意到</span><code>If-Modified-Since:</code><span>首部行的值就是当初</span><code>Last-Modified:</code><span>首部行的值。</span></p></li></ol><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 35.9809px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27.9948px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">GET /fruit/kiwi.gif HTTP/1.1</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Host: www.exotiquecuisine.com</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">If-modified-since: Wed, 9 Sep 2015 09:23:24</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="height: 69px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><ol start='4' ><li><p><span>Web服务器向该缓存器发送一个响应报文。若没有修改，返回的实体体内容为空。</span></p></li></ol><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 35.9809px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27.9948px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">HTTP/1.1 304 Not Modified</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Data: Sat, 10 Oct 2015 15:39:29</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Server: Apache/1.3.0 (Unix)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(empty entity body)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="height: 115px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h2 id='23-因特网中的电子邮件'><span>2.3 因特网中的电子邮件</span></h2><p><span>因特网电子邮件系统有</span><strong><span>三个主要组成部分</span></strong><span>：</span></p><ul><li><p><strong><span>用户代理（user agent）</span></strong><span>：允许用户阅读、回复、转发、保存和撰写报文。如Outlook和Apple Mail。</span></p></li><li><p><strong><span>邮件服务器（mail server）</span></strong><span>：一般发送者和接收者的邮件服务器是两个服务器，之间的通信使用SMTP协议。</span></p></li><li><p><strong><span>简单邮件传输协议（simple mail transfer protocol, SMTP）</span></strong><span>：因特网电子邮件中主要的应用层协议。使用TCP作为其运输层协议。</span></p></li></ul><p><strong><span>邮件发送过程</span></strong><span>：</span><em><span>（进一步的讨论在2.3.4节）</span></em></p><p><span>发送者的邮件代理向其邮件服务器发送邮件，邮件会放在该邮件服务器的外出</span><strong><span>报文队列</span></strong><span>（outgoing </span><strong><span>message queue</span></strong><span>）中；然后传输到接收者的邮件服务器中；再被分发到接受方的</span><strong><span>邮箱（mailbox）</span></strong><span>中；接收者的邮件代理在其邮件服务器的邮箱中获取该报文。</span></p><p><strong><span>图例</span></strong><span>如下：</span></p><p><img src="./img/emailoverview.jpg" style="zoom: 33%;" /></p><h3 id='231-smtp'><span>2.3.1 SMTP</span></h3><p><span>基本的邮件发送过程已经讨论过了，下面对SMTP进行一点补充。</span></p><ul><li><p><span>邮件报文的首部行和实体体</span><em><span>（邮件报文格式在2.3.3节讨论）</span></em><span>都使用7位的ASCII表示。于是在SMTP传送邮件之前，需要将二进制多媒体数据编码为ASCII码；传输后也要将相应的ASCII码解码还原回多媒体数据。</span></p></li><li><p><span>一般不使用中间邮件服务器，即便两个邮件服务器位于地球两端。</span></p></li><li><p><span>默认端口25、持续连接、TCP作为运输层协议</span></p></li><li><p><span>在完成TCP握手后，还需要进行SMTP握手，下面给出一个例子：</span></p></li></ul><p><strong><span>SMTP握手</span></strong><span>，假设客户（C）是crepes.fr，服务器（S）是hamburger.edu。</span><em><span>例子中C和S只是标识该信息是谁发送的，在真实情况下并不存在。&quot;//&quot;注释也是不存在的</span></em></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 43.9844px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>15</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -35.9983px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-number">220</span> <span class="cm-variable">hamburger</span>.<span class="cm-variable">edu</span> <span class="cm-comment">//服务器给出220响应，表示TCP连上了</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">HELO</span> <span class="cm-variable">crepes</span>.<span class="cm-variable">fr</span> <span class="cm-comment">//HELO命令表明自己身份，crepes.fr是服务器名字，类似163.com</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-number">250</span> <span class="cm-variable">Hello</span> <span class="cm-variable">crepes</span>.<span class="cm-variable">fr</span>, <span class="cm-variable">pleased</span> <span class="cm-variable">to</span> <span class="cm-variable">meet</span> <span class="cm-variable">you</span> <span class="cm-comment">//250表示收到，后面短语可自定义</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">MAIL</span> <span class="cm-variable">FROM</span>: <span class="cm-operator">&lt;</span><span class="cm-variable">alice@crepes</span>.<span class="cm-variable">fr</span><span class="cm-operator">&gt;</span> <span class="cm-comment">//MAIL FROM命令给出发送者的邮箱</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-number">250</span> <span class="cm-variable">alice@crepes</span>.<span class="cm-variable">fr</span> ... <span class="cm-variable">Sender</span> <span class="cm-variable">ok</span> <span class="cm-comment">//250表示收到，后面短语可自定义</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">RCPT</span> <span class="cm-variable">TO</span>: <span class="cm-operator">&lt;</span><span class="cm-variable">bob@hamburger</span>.<span class="cm-variable">edu</span><span class="cm-operator">&gt;</span> <span class="cm-comment">//RCPT TO命令给出收件者邮箱</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-number">250</span> <span class="cm-variable">bob@hamburger</span>.<span class="cm-variable">edu</span> ... <span class="cm-variable">Recipent</span> <span class="cm-variable">ok</span> <span class="cm-comment">//250表示收到，后面短语可自定义</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">DATA</span> <span class="cm-comment">//DATA命令表明我要告诉你邮件内容了</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-number">354</span> <span class="cm-variable">Enter</span> <span class="cm-variable">mail</span>, <span class="cm-variable">end</span> <span class="cm-variable">with</span> <span class="cm-string">"."</span> <span class="cm-variable">on</span> <span class="cm-variable">a</span> <span class="cm-variable">line</span> <span class="cm-variable">by</span> <span class="cm-variable">itself</span> <span class="cm-comment">//354表示你可以写邮件了，后面短语自定义</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">balabala</span> <span class="cm-comment">//说了一堆</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">balabala</span> <span class="cm-comment">//说了两堆</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: . <span class="cm-comment">//单独一个"."表示写完了</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-number">250</span> <span class="cm-variable">Message</span> <span class="cm-variable">accepted</span> <span class="cm-keyword">for</span> <span class="cm-variable">delivery</span> <span class="cm-comment">//250表示收到，后面短语可自定义</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">QUIT</span> <span class="cm-comment">//QUIT命令表示所有邮件发送完了</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-number">221</span> <span class="cm-variable">hamburger</span>.<span class="cm-variable">edu</span> <span class="cm-variable">closing</span> <span class="cm-variable">connection</span> <span class="cm-comment">//221表示TCP连接结束，后面短语可自定义</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 346px;"></div><div class="CodeMirror-gutters" style="height: 346px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><h3 id='232-与http的对比'><span>2.3.2 与HTTP的对比</span></h3><ul><li><p><span>HTTP是一个</span><strong><span>拉协议（pull protocol）</span></strong><span>，而SMTP是一个</span><strong><span>推协议（push protocol）</span></strong><span>。即用户通过HTTP主动向服务器请求内容，而SMTP则是客户将内容推向服务器端</span></p></li><li><p><span>SMTP只能使用7位ASCII码，而HTTP的实体体不受要求</span></p></li><li><p><span>HTTP将每个对象封装在它自己的响应报文里（一个报文一个对象），而SMTP则将所有的报文对象放到一个报文之中</span></p></li></ul><h3 id='233-邮件报文格式'><span>2.3.3 邮件报文格式</span></h3><p><span>在2.3.1节看到的SMTP握手过程其实忽略了邮件报文格式，也就是第10、11行的</span><code>balabala</code><span>具体内容。这里做一点补充。一个典型的报文结构如下：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 35.9809px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>6</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27.9948px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">From: alice@crepes.fr</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">To: bob@hamburger.edu</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Subject: Searching for the meaning of life.</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(正文)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">.</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 138px;"></div><div class="CodeMirror-gutters" style="height: 138px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>注意到上述的</span><code>From:</code><span>和</span><code>To:</code><span>首部行虽然看上去和2.3.1节</span><code>MAIL FROM:</code><span>和</span><code>RCPT TO:</code><span>类似，但是前者是邮件报文的首部行，后者是SMTP握手协议的命令。</span></p><h3 id='234-邮件访问协议'><span>2.3.4 邮件访问协议</span></h3><p><span>2.3节开头我们已经讨论过邮件发送过程了，如下图：</span></p><p><img src="./img/emaildetail.jpg" style="zoom:50%;" /></p><p><span>但是还有几个问题值得我们讨论：</span></p><ul><li><p><span>为什么需要Alice的邮件服务器，直接通过Alice的代理向Bob的邮件服务器发送不行吗？这是因为：Primarily because without relaying through Alice&#39;s mail server, Alice&#39;s user agent doesn&#39;t have any recourse to an unreachable destination mail server. Alice的邮件服务器可以不断尝试给Bob邮件服务器发送报文，直到Bob邮件服务器收到该报文。</span></p></li><li><p><span>为什么需要Bob的代理，Bob直接登录到服务器主机，并在上面运行客户端程序阅读电子邮件不行吗？一方面这是因为Bob可能希望在个人电脑或者手机等设备去阅读邮件，另一方面代理可以提供更丰富的功能。</span></p></li><li><p><span>Bob的代理是要从邮件服务器获取邮件，这是一个拉操作，然而2.3.2节已经提及SMTP是一个推协议。于是我们需要引入特殊的</span><strong><span>邮件访问协议（mail access protocol）</span></strong><span>，允许Bob的代理能够从邮箱里获取数据。而这便是本节讨论的话题。</span></p></li></ul><p><strong><span>1）POP3</span></strong></p><p><strong><span>POP3（post office protocol--Version 3, 第三版的邮局协议）</span></strong><span>特点如下：</span></p><ul><li><p><span>简单，功能有限</span></p></li><li><p><span>邮件服务器使用端口110来建立TCP连接</span></p></li><li><p><span>三个工作阶段</span></p><ol start='' ><li><p><strong><span>特许（authorization）</span></strong><span>：用户代理发送密码和用户名，进行身份鉴别</span></p></li><li><p><strong><span>事务处理（transaction）</span></strong><span>：用户代理取回报文，同时还可以做删除标记、取消删除标记、或者统计邮件信息</span></p></li><li><p><strong><span>更新（update）</span></strong><span>：在用户退出后，结束POP3会话，删除被标记的邮件</span></p></li></ol></li></ul><p><strong><span>例子</span></strong><span>：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 43.9844px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>17</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -35.9983px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">telnet</span> <span class="cm-operator">&lt;</span><span class="cm-variable">mailserver</span><span class="cm-operator">&gt;</span> <span class="cm-number">110</span> <span class="cm-comment">//mailserver类似pop.163.com</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-operator">+</span><span class="cm-variable">OK</span> <span class="cm-variable">POP3</span> <span class="cm-variable">server</span> <span class="cm-variable">ready</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">user</span> <span class="cm-operator">&lt;</span><span class="cm-variable">username</span><span class="cm-operator">&gt;</span> <span class="cm-comment">//user命令输入用户名</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-operator">+</span><span class="cm-variable">OK</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">pass</span> <span class="cm-operator">&lt;</span><span class="cm-variable">password</span><span class="cm-operator">&gt;</span> <span class="cm-comment">//pass命令输入密码，密码是明文</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-operator">+</span><span class="cm-variable">OK</span> <span class="cm-variable">user</span> <span class="cm-variable">successfully</span> <span class="cm-variable">logged</span> <span class="cm-variable">on</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">list</span> <span class="cm-comment">//list命令查看邮箱中所有报文</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-number">1</span> <span class="cm-number">498</span> <span class="cm-comment">//报文1 长度498字节</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-number">2</span> <span class="cm-number">912</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: .</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">retr</span> <span class="cm-number">1</span> <span class="cm-comment">//retr命令获取报文</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-variable">balabala</span> <span class="cm-comment">//邮件报文格式见2.3.3节</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-variable">balabala</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: .</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">dele</span> <span class="cm-number">1</span> <span class="cm-comment">//dele命令删去报文1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">C</span>: <span class="cm-variable">quit</span> <span class="cm-comment">//quit命令</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">S</span>: <span class="cm-operator">+</span><span class="cm-variable">OK</span> <span class="cm-variable">POP3</span> <span class="cm-variable">server</span> <span class="cm-variable">signing</span> <span class="cm-variable">off</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 392px;"></div><div class="CodeMirror-gutters" style="height: 392px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p><span>此外，POP3用户代理可以被用户配置为”</span><strong><span>download and delete</span></strong><span>“ or &quot;</span><strong><span>download and keep</span></strong><span>&quot;两种模式。POP3代理发出的命令和其工作模式相关。</span></p><p><strong><span>2）IMAP</span></strong></p><p><span>比起POP3，</span><strong><span>IMAP（internet mail access protocol 因特网邮件访问协议）</span></strong><span>复杂但提供更多功能。包括：</span></p><ul><li><p><span>将每个报文和一个文件夹联系起来。可以实现垃圾邮件文件夹、星标邮件文件夹、普通邮件文件夹等</span></p></li><li><p><span>允许用户代理获取报文特定部分。让低带宽的用户避免邮件中的音频视频等大文件。</span></p></li></ul><p><strong><span>3）HTTP</span></strong></p><p><span>这种方式主要是指，用户使用HTTP协议和邮件服务器通信。用户代理就是普通的浏览器。此时无论是Alice发送邮件到服务器还是Bob从服务器获取邮件都是通过HTTP协议。但是，邮件服务器之间还是使用SMTP协议的。</span></p><p><em><span>IMAP和HTTP相关内容书上讨论的也很简单，大体如上</span></em></p><h2 id='24-dns因特网的目录服务'><span>2.4 DNS：因特网的目录服务</span></h2><p><span>人更容易记住</span><strong><span>主机名（hostname）</span></strong><span>，譬如</span><code>www.facebook.com</code><span>。然而主机名几乎没有提供有关主机在因特网中位置的信息，而且不定长的主机名也难以处理。因此路由器更喜欢</span><strong><span>IP地址（IP地址）</span></strong><span>。于是我们需要一种能进行主机名到IP地址转换的目录服务，而这便是</span><strong><span>DNS（Domain Name System，DNS）</span></strong><span>的主要任务。</span></p><h3 id='241-dns提供的服务'><span>2.4.1 DNS提供的服务</span></h3><p><span>DNS</span><strong><span>是什么？</span></strong><span>这可以从两个角度回答：</span></p><ul><li><p><span>一个由分层的DNS服务器实现的分布式数据库</span></p></li><li><p><span>一个使主机能够查询分布式数据库的应用层协议。该协议运行在UDP之上，使用53号端口。</span></p></li></ul><p><span>DNS</span><strong><span>提供的服务</span></strong><span>包括：</span></p><ul><li><p><strong><span>主机名到IP地址转换</span></strong><span>：DNS客户将主机名发送到DNS服务器，DNS服务器返回该主机名的IP地址。客户再通过该IP地址建立TCP连接。</span></p></li><li><p><strong><span>主机别名（host aliasing）</span></strong><span>：有着复杂主机名的主机可能拥有一个或者多个相对简单的别名。原先的主机名称为</span><strong><span>规范主机名（canonical hostname）</span></strong><span>。</span></p></li><li><p><strong><span>邮件服务器别名（mail server aliasing）</span></strong><span>：给邮件服务器的复杂主机名起一个简单的别名。DNS还允许一个公司的邮件服务器和Web服务器使用相同的主机别名。</span></p></li><li><p><strong><span>负载分配（load distribution）</span></strong><span>：多个服务器可以使用相同的别名或者规范主机名，但是它们IP地址当然不同。当客户查询该主机名的IP地址时，DNS服务器将返回所有IP地址。有意思的是，每次查询后，DNS会循环返回IP地址的顺序。譬如说，第一次查询IP地址顺序是abc，第二次是bca，第三次是cab。而客户一般就选取第一个IP地址发送HTTP请求报文。这便实现了负载分配。</span></p></li></ul><h3 id='242-dns工作机理概述'><span>2.4.2 DNS工作机理概述</span></h3><p><span>这里主要讨论DNS服务器的分布式设计方案和DNS缓存。</span></p><p><strong><span>1）分布式、层次结构的数据库</span></strong></p><p><span>DNS服务器大致分为三类：</span></p><ul><li><p><strong><span>根DNS服务器（root DNS servers）</span></strong><span>：全世界有400多个根服务器，由13个组织管理。提供了TLD服务器的IP地址。</span></p></li><li><p><strong><span>顶级域（top-level domain, TLD）</span></strong><span>服务器：对于（com、org、cn、uk等）顶级域，都有TLD服务器。提供了权威DNS服务器的IP地址</span></p></li><li><p><strong><span>权威DNS服务器（authoritative DNS servers）</span></strong><span>：如facebook.com DNS服务器、umass.edu DNS服务器。</span></p></li></ul><p><span>此外在层次结构之外，还有一种</span><strong><span>本地DNS服务器（local DNS server）</span></strong><span>，起到代理的作用。下面是DNS查询方式的具体例子。该例中主机</span><code>cse.nyu.edu</code><span>想要知道</span><code>gaia.cs.umass.edu</code><span>的IP地址。一共由8份DNS报文。请求主机先发送DNS查询报文给本地DNS服务器（步骤1）。本地DNS服务器将该报文转发给根DNS服务器（步骤2）。根DNS服务器注意到</span><code>edu</code><span>前缀，并返回</span><code>edu</code><span>的TLD服务器的IP地址（步骤3）。本地服务器再发送查询报文给TLD服务器（步骤4）。TLD服务器注意到</span><code>umass.edu</code><span>前缀，并返回</span><code>dns.umass.edu</code><span>这个权威DNS服务器的IP地址（步骤5）。本地服务器再发送查询报文给权威DNS服务器（步骤6），权威DNS服务器返回最终的IP地址（步骤7）。最后本地服务器将最终的IP地址发送给请求主机（步骤8）.</span></p><p><img src="./img/dnsquery.jpg" style="zoom: 33%;" /></p><p><span>DNS查询有两种，上图中1称为</span><strong><span>递归查询（recursive query）</span></strong><span>，2、4、6称为</span><strong><span>迭代查询（iterative query）</span></strong><span>。这里递归指我把任务交给你了，你自己琢磨琢磨，等下告诉我答案就好了；迭代指你不要直接告诉我答案，你告诉我下一步我该怎么做，我继续琢磨琢磨。通常从请求主机到本地DNS服务器的查询是递归的，其余查询是迭代的。</span></p><p><strong><span>2）DNS缓存</span></strong></p><p><strong><span>DNS缓存（DNS caching）</span></strong><span>指：每当DNS服务器发出请求后收到回答时，就将回答的内容缓存在它自己的主机。因为主机名和IP地址之间的映射不是永久的，所以DNS服务器在经过一段时间（两天）后会丢弃缓存的信息。</span></p><h3 id='243-dns记录和报文'><span>2.4.3 DNS记录和报文</span></h3><p><strong><span>1）DNS记录</span></strong></p><p><span>DNS服务器存储了</span><strong><span>资源记录（resource record, RR）</span></strong><span>。RR提供了主机名到IP地址的映射。RR是一个4元组：</span><code>(Name, Value, Type, TTL)</code><span>。其中TTL是该记录已经存在的时间，用来决定是否要从缓存中删除。下面所有的讨论都忽略了TTL。</span></p><p><span>介绍四种Type：</span></p><ul><li><p><strong><span>type=A</span></strong><span>：name为主机名，value为对应的IP地址。如</span><code>(relay2.bar.foo.com, 145.37.93.126, A)</code></p></li><li><p><strong><span>type=NS</span></strong><span>：name为域名，value为知道如何获得该域下主机IP地址的权威DNS服务器的主机名。如</span><code>(foo.com, dns.foo.com, NS)</code></p></li><li><p><strong><span>type=CNAME</span></strong><span>：name是别名，value是规范主机名。如</span><code>(foo.com, relay1.bar.foo.com, CNAME)</code></p></li><li><p><strong><span>type=MX</span></strong><span>：value为name所对应的邮件服务器的规范主机名。如</span><code>(foo,com, mail.bar.foo.com, MX)</code><span>。通过使用MX记录，一个组织的邮件服务器和其他服务器（譬如Web服务器）可以使用相同的别名。</span></p></li></ul><p><strong><span>2）DNS报文</span></strong></p><p><span>DNS报文只有查询（query）和回答（reply）报文两种，且格式相同。DNS报文中各字段的语义如下：</span></p><p><img src="./img/dnsmessage.jpg" style="zoom:50%;" /></p><ul><li><p><strong><span>首部区域（header section）</span></strong><span>：前12字节。其中</span></p><ul><li><p><span>标识符是一个用来标记该查询的16比特数，该标识符会被复制到相应的回答报文里，以便匹配请求和回答</span></p></li><li><p><span>标志字段有若干标志：1-bit query/reply flag, 1-bit authoritative flag is set in a reply message when a DNS server is an authoritative server for a queried name, 1-bit recursion-desired flag, 1-bit recursion-available flag, 以及4个有关数量的字段，用来指示4类数据区域出现的数量</span></p></li></ul></li><li><p><strong><span>问题区域（question section）</span></strong><span>：包含了正在进行的查询信息。包括被查询的名字和类型</span></p></li><li><p><strong><span>回答区域（answer section）</span></strong><span>：包含了对最初请求的名字的资源记录，可以有多条</span></p></li><li><p><strong><span>权威区域（authority section）</span></strong><span>：包含了其他权威服务器的信息</span></p></li><li><p><strong><span>附加区域（additional section）</span></strong><span>：包含了其它有帮助的记录。比如在对于一个MX请求的回答报文，回答区域指出了邮件服务器的规范主机名，而附加区域里包含一个类型为A的关于该规范主机名的的IP地址</span></p></li></ul><p><em><span>还是有点不明就里，希望学校能有相关实验</span></em></p><p><strong><span>3）在DNS数据库插入记录</span></strong></p><p><span>当你注册一个域名时，需要向</span><strong><span>注册登记机构（registrar）</span></strong><span>提供你的primary和secondary权威DNS服务器的名字和IP地址，譬如是</span><code>dns1.networkutopia.com</code><span>和</span><code>dns2.networkutopia.com</code><span>及</span><code>212.212.212.1</code><span>和</span><code>212.212.212.2</code><span>. </span><em><span>（个人认为secondary authoritative DNS server只是提供了额外的保障，并不是必须的）</span></em><span>。注册登记机构就会在</span><code>networkutopia.com</code><span>的primary权威DNS服务器插入以下两条RR：（secondary权威DNS服务器也是类似的）</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 35.9809px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27.9948px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(networkutopia.com, dns1.networkutopia.com, NS)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(dns1.networkutopia.com, 212.212.212.1, A)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="height: 46px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h2 id='25-p2p文件分发'><span>2.5 P2P文件分发</span></h2><p><span>P2P的基本内容已经在2.1.1节介绍过了。这里主要介绍一个用于文件分发的P2P协议——</span><strong><span>BitTorrent</span></strong><span>. 我们所谓的BT下载就是使用了该协议。</span></p><p><img src="./img/bittorrent.jpg" style="zoom:33%;" /></p><p>&nbsp;</p><p><span>在BitTorrent中，所有参与下载和发送的</span><strong><span>对等方（peer）</span></strong><span>组成了一个</span><strong><span>洪流（torrent）</span></strong><span>。在一个洪流中的对等方彼此下载等长度的文件</span><strong><span>块（chunk）</span></strong><span>；对等方在下载的同时也在上传文件块；一旦某对等方获得了完整文件，就可以自私地离开洪流或者大公无私地留下来继续向其他对等方发送文件。</span></p><p><span>每个洪流有一个</span><strong><span>追踪器（tracker）</span></strong><span>。当一个对等方加入洪流时，他会在追踪器里注册，并且周期性告知追踪器它仍在洪流中。</span></p><p><span>现在Alice加入了洪流，追踪器随机挑选了一组对等方和Alice建立的TCP连接。这些对等方称为邻近对等方（neighboring peer）。邻近对等方的数目是动态变动的。</span></p><p><span>Alice周期询问每个邻近对等方他们有的文件块列表。然后请求她需要的且邻居们副本数量最少的块</span><strong><span>（rarest first）</span></strong><span>。</span></p><p><span>Alice给/给她发数据最快的前四名邻近对等方/发送数据。这四个对等方称为</span><strong><span>unchoked</span></strong><span>。每隔一段时间，Alice还会随机挑选一名对等方Bob发送数据，Bob称为</span><strong><span>optimistically unchoked</span></strong><span>。如果Alice发送数据挺快，那么Bob也会向Alice发送数据。如果Bob发送的也挺快，那么Alice的unchoked的对等方其中一个将会被Bob替换。这种机制称为</span><strong><span>tit-for-tat</span></strong><span>（以牙还牙？），你发的快，接收的也快。</span></p><h2 id='26-视频流和内容分发网'><span>2.6 视频流和内容分发网</span></h2><h3 id='261-因特网视频'><span>2.6.1 因特网视频</span></h3><p><span>要点有：</span></p><ul><li><p><span>高比特率，北美住宅ISP中的流量主体。比特率越高，视频更清晰。</span></p></li><li><p><span>可以压缩成多个版本，每个版本有不同的比特率，用户可以根据当前的带宽来决定观看哪个版本</span></p></li><li><p><span>对流式视频（视频数据的传输）最重要的性能度量是平均端到端吞吐量</span></p></li></ul><h3 id='262-http流和dash'><span>2.6.2 HTTP流和DASH</span></h3><p><strong><span>1）HTTP流</span></strong></p><ul><li><p><span>视频是存储在服务器中的一个普通文件</span></p></li><li><p><span>在客户一侧，字节被收集在客户应用的缓存中。当缓存的字节数超过预先设定的门槛，客户应用程序就开始播放</span></p></li><li><p><span>缺陷：客户接收到相同编码的视频，即便客户的可用带宽大小不同</span></p></li></ul><p><strong><span>2）DASH</span></strong></p><ul><li><p><span>全称为</span><strong><span>Dynamic Adaptive Streaming over HTTP</span></strong></p></li><li><p><span>视频编码为几个不同的版本，它们具有不同的比特率。根据可用带宽量，用户动态地请求来自不同版本且长度为几秒的视频段数据块</span></p></li><li><p><span>HTTP服务器有一个告示文件（manifest file），为每个版本提供了一个URL及其比特率。从而客户可以通过在HTTP GET请求报文中对每块指定一个URL和字节范围，选择贴合自己可用带宽量的视频版本。</span></p></li></ul><h3 id='263-内容分发网'><span>2.6.3 内容分发网</span></h3><p><strong><span>1）概述</span></strong></p><p><span>未来应对向分布于全世界的用户分发巨量视频数据的挑战，几乎所有主要的视频流公司都使用</span><strong><span>CDN (Content Distribution Network，内容分发网)</span></strong><span>。CDN管理分布在多个地理位置的服务器，在它的服务器中储存相关文件的副本，并试图将每个用户定向到一个提供最好用户体验的CDN位置。可以分成两类：</span></p><ul><li><p><strong><span>专用CDN</span></strong><span>：由内容提供商自己所拥有</span></p></li><li><p><strong><span>第三方CDN</span></strong><span>：代表多个内容提供商分发内容</span></p></li></ul><p><strong><span>2）两种不同的服务器安置原则</span></strong></p><ul><li><p><strong><span>Enter Deep</span></strong><span>：在遍及全球的接入ISP中建设服务器集群来深入到ISP的接入网中</span></p><ul><li><p><span>接近端用户，改善时延和吞吐量</span></p></li><li><p><span>因为高度分布式设计，维护、管理集群较为困难</span></p></li></ul></li><li><p><strong><span>Bring Home</span></strong><span>。在IXP建造大集群，</span><em><span>邀请ISP做客</span></em></p><ul><li><p><span>较低的维护和管理开销</span></p></li><li><p><span>较高的时延和较低的吞吐量</span></p></li></ul></li></ul><p><strong><span>3）CDN操作</span></strong></p><p><span>当用户主机中的一个浏览器检索一个特定的视频时，CDN会截获该请求，来确定此时适用于该客户的CDN服务器集群，并将客户的请求重定向到该集群的某台服务器。CDN通常利用DNS实现截获和重定向。</span></p><p><img src="./img/cdn.jpg" style="zoom:50%;" /></p><p><span>简单来说，就是NetCinema权威DNS服务器返回的是KingCDN权威服务器，KingCDN权威服务器再返回内容分发服务器的IP节点。最终用户主机域内容分发服务器建立TCP连接，获取数据。</span></p><p><strong><span>4）集群选择策略</span></strong></p><ul><li><p><span>地理上最为邻近</span></p><ul><li><p><span>但是就网络路径的长度而言，可能不是最近的</span></p></li><li><p><span>忽视了时延、带宽随时间的变化</span></p></li></ul></li><li><p><span>通过对集群与客户之间的时延、丢包率进行周期性的实时测量，为客户选择最好的集群</span></p><ul><li><p><span>实现：CDN让它的每个集群周期性地像位于全世界的本地DNS服务器发送探测分组</span></p></li><li><p><span>缺点：许多本地DNS服务器被配置为不会响应这些探测</span></p></li></ul></li></ul><h3 id='264-案例学习'><span>2.6.4 案例学习</span></h3><p><strong><span>奈飞</span></strong></p><p><span>奈飞（Netflix）视频分发具有两个主要部件：亚马逊云和它专用的CDN基础设施。</span></p><p><span>其中亚马逊云处理以下功能：</span></p><ul><li><p><span>管理Web网站，处理用户注册、登录、计费、搜索、电影推荐等诸多功能。</span></p></li><li><p><span>内容摄取：Netflix接受制片厂电影的母带，并将其上载到亚马逊云的主机上</span></p></li><li><p><span>内容处理：为每部电影生成不同的格式，以便于从不同设备访问。生成不同比特率版本，支持DASH</span></p></li><li><p><span>向其CDN上载版本：一旦某电影的所有版本均已生成，亚马逊云的主机就向CDN上载这些版本</span></p></li></ul><p><span>CDN相关内容如下：</span></p><ul><li><p><span>在IXP和住宅ISP都安装了服务器</span></p></li><li><p><span>不使用拉高速缓存，而是在非高峰时段将视频分发给它的CDN服务器（推高速缓存）。对于不能保存整个视频库的服务器，Netflix只推送最流行的视频</span></p></li><li><p><span>不使用2.6.3节介绍了DNS重定向。Netflix软件（运行在亚马逊云中）直接告诉客户一台特定的CDN服务器。</span></p></li></ul><p><strong><span>Youtube</span></strong></p><ul><li><p><span>在IXP和住宅ISP都安装了服务器</span></p></li><li><p><span>使用拉高速缓存和DNS重定向</span></p></li><li><p><span>大部分时间，将用户定向到某个集群，使客户与集群间时延最低；有时为了平衡集群的负载，将客户定向（经DNS）到一个更远的集群</span></p></li><li><p><span>没有使用DASH，要求用户人工选择一个版本</span></p></li></ul><p><strong><span>迅雷看看</span></strong></p><p><span>混合CDN-P2P流式系统。若P2P总流量够大，就仅从对等方获得流，否则要CDN帮助。可以降低CDN部署的费用。</span></p><h2 id='27-套接字编程'><span>2.7 套接字编程</span></h2><p><span>客户端发送一串英文给服务器，服务器将小写改成大写，再返回客户端。</span><em><span>配合3.2节理解</span></em></p><h3 id='271-udp'><span>2.7.1 UDP</span></h3><p><span>UDP想法很简单，指定一个目的IP地址和目的端口号，发送就行了。发送的分组的首部字段包含了源端口号和源IP。</span></p><p><strong><span>client</span></strong></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 43.9844px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>13</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -35.9983px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">socket</span> <span class="cm-keyword">import</span> <span class="cm-operator">*</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverName</span> <span class="cm-operator">=</span> <span class="cm-string">'abc.com'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverPort</span> <span class="cm-operator">=</span> <span class="cm-number">12000</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#创建客户端socket，端口号自动分配</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">clientSocket</span> <span class="cm-operator">=</span> <span class="cm-variable">socket</span>(<span class="cm-variable">AF_INET</span>,<span class="cm-variable">SOCK_DGRAM</span>) <span class="cm-comment">#IPv4，UDP</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#终端输出Input: 等待用户输入，存在message</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">message</span> <span class="cm-operator">=</span> <span class="cm-variable">raw_input</span>(<span class="cm-string">'Input:'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#encode()将string变成byte，(IP,port)唯一标识一个套接字</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">clientSocket</span>.<span class="cm-property">sendto</span>(<span class="cm-variable">message</span>.<span class="cm-property">encode</span>(),(<span class="cm-variable">serverName</span>,<span class="cm-variable">serverPort</span>))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#等待回复消息，2048是缓冲区大小，serverAddress即（服务器IP,端口）</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">modifiedMessage</span>,<span class="cm-variable">serverAddress</span> <span class="cm-operator">=</span> <span class="cm-variable">clientSocket</span>.<span class="cm-property">recvfrom</span>(<span class="cm-number">2048</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-variable">modifiedMessage</span>.<span class="cm-property">decode</span>()) <span class="cm-comment">#打印,decode()将byte变为string</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">clientSocket</span>.<span class="cm-property">close</span>() <span class="cm-comment">#关闭套接字</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 299px;"></div><div class="CodeMirror-gutters" style="height: 299px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p><strong><span>server</span></strong></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 35.9809px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27.9948px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">socket</span> <span class="cm-keyword">import</span> <span class="cm-operator">*</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverPort</span> <span class="cm-operator">=</span> <span class="cm-number">12000</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverSocket</span> <span class="cm-operator">=</span> <span class="cm-variable">socket</span>(<span class="cm-variable">AF_INET</span>,<span class="cm-variable">SOCK_DGRAM</span>) <span class="cm-comment">#IPv4，UDP</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverSocket</span>.<span class="cm-property">bind</span>((<span class="cm-string">''</span>,<span class="cm-variable">serverPort</span>)) <span class="cm-comment">#指定端口号为12000</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-string">'The server is ready to receive'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span> <span class="cm-keyword">True</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">message</span>,<span class="cm-variable">clientAddress</span> <span class="cm-operator">=</span> <span class="cm-variable">serverSocket</span>.<span class="cm-property">recvfrom</span>(<span class="cm-number">2048</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">modifiedMessage</span> <span class="cm-operator">=</span> <span class="cm-variable">message</span>.<span class="cm-property">decode</span>().<span class="cm-property">upper</span>() <span class="cm-comment">#改成大写</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">serverSocket</span>.<span class="cm-property">sendto</span>(<span class="cm-variable">modifiedMessage</span>.<span class="cm-property">encode</span>(),<span class="cm-variable">clientAddress</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 207px;"></div><div class="CodeMirror-gutters" style="height: 207px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h3 id='272-tcp'><span>2.7.2 TCP</span></h3><p><span>TCP相对UDP就复杂一点。TCP有一个</span><strong><span>监听套接字（listening socket）</span></strong><span> </span><em><span>（或者称为欢迎套接字welcoming socket）</span></em><span>用来</span><strong><span>监听（listen）</span></strong><span>有没有客户想要进行TCP连接。如果有的话，服务器和客户会进行三次握手，并且服务器会创建新的</span><strong><span>连接套接字（connection socket）</span></strong><span>来和客户进行后续的可靠通信。这个连接套接字唯一服务于该客户套接字。</span></p><p><img src="./img/welcomeSocket.jpg" style="zoom: 33%;" /></p><p><strong><span>client</span></strong></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 43.9844px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>14</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -35.9983px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">socket</span> <span class="cm-keyword">import</span> <span class="cm-operator">*</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverName</span> <span class="cm-operator">=</span> <span class="cm-string">'abc.com'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverPort</span> <span class="cm-operator">=</span> <span class="cm-number">12000</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#创建客户端socket，端口号自动分配</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">clientSocket</span> <span class="cm-operator">=</span> <span class="cm-variable">socket</span>(<span class="cm-variable">AF_INET</span>,<span class="cm-variable">SOCK_STREAM</span>) <span class="cm-comment">#IPv4，TCP</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#connect()会执行三次握手，创建TCP连接</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">clientSocket</span>.<span class="cm-property">connect</span>((<span class="cm-variable">serverName</span>,<span class="cm-variable">serverPort</span>))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">message</span> <span class="cm-operator">=</span> <span class="cm-variable">raw_input</span>(<span class="cm-string">'Input:'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#不必使用sendto函数指明地址</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">clientSocket</span>.<span class="cm-property">send</span>(<span class="cm-variable">message</span>.<span class="cm-property">encode</span>())</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#recv()不同于recvfrom()，不返回服务器地址</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">modifiedMessage</span> <span class="cm-operator">=</span> <span class="cm-variable">clientSocket</span>.<span class="cm-property">recv</span>(<span class="cm-number">2048</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-variable">modifiedMessage</span>.<span class="cm-property">decode</span>()) <span class="cm-comment">#打印</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">clientSocket</span>.<span class="cm-property">close</span>() <span class="cm-comment">#关闭套接字</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 323px;"></div><div class="CodeMirror-gutters" style="height: 323px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p><strong><span>server</span></strong></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 43.9844px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>13</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -35.9983px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">socket</span> <span class="cm-keyword">import</span> <span class="cm-operator">*</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverPort</span> <span class="cm-operator">=</span> <span class="cm-number">12000</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverSocket</span> <span class="cm-operator">=</span> <span class="cm-variable">socket</span>(<span class="cm-variable">AF_INET</span>,<span class="cm-variable">SOCK_STREAM</span>) <span class="cm-comment">#IPv4，TCP</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverSocket</span>.<span class="cm-property">bind</span>((<span class="cm-string">''</span>,<span class="cm-variable">serverPort</span>)) <span class="cm-comment">#指定端口号为12000</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverSocket</span>.<span class="cm-property">listen</span>(<span class="cm-number">1</span>) <span class="cm-comment">#监听有没有客户想连接，请求连接的最大数为一（至少为1）</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-string">'The server is ready to receive'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span> <span class="cm-keyword">True</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">#accept()创建了一个新套接字，由这个客户专用</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">connectionSocket</span>, <span class="cm-variable">addr</span> <span class="cm-operator">=</span> <span class="cm-variable">serverSocket</span>.<span class="cm-property">accept</span>()</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">message</span> <span class="cm-operator">=</span> <span class="cm-variable">serverSocket</span>.<span class="cm-property">recv</span>(<span class="cm-number">2048</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">modifiedMessage</span> <span class="cm-operator">=</span> <span class="cm-variable">message</span>.<span class="cm-property">decode</span>().<span class="cm-property">upper</span>() <span class="cm-comment">#改成大写</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">connectionSocket</span>.<span class="cm-property">send</span>(<span class="cm-variable">modifiedMessage</span>.<span class="cm-property">encode</span>())</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">connectionSocket</span>.<span class="cm-property">close</span>()</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 299px;"></div><div class="CodeMirror-gutters" style="height: 299px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><hr /><p>&nbsp;</p><h1 id='三运输层'><span>三、运输层</span></h1><p><span>本章先会介绍运输层的一些基本概念与要求，然后介绍UDP的实现，最后讨论可靠通信和阻塞控制的基本做法，以及TCP的具体实现。</span></p><h2 id='31-概述和运输层服务'><span>3.1 概述和运输层服务</span></h2><p><span>运输层协议为运行在不同主机上的应用进程之间提供了</span><strong><span>逻辑通信（logical communication）</span></strong><span>功能。在应用程序看来，通过逻辑通信，运行不同进程的主机好像直接相连一样，即便相隔天涯。也就是指物理上不相连，但是逻辑上相连。</span></p><p><span>回忆到，运输层分组称作</span><strong><span>报文段（segment）</span></strong><span>。运输层协议是在端系统中实现的，而不是在路由器中实现的。</span></p><p><span>TCP和UDP是最流行的两个运输层协议，它们提供了不同的服务。</span></p><h3 id='311-运输层和网络层关系'><span>3.1.1 运输层和网络层关系</span></h3><p><strong><span>1）区别</span></strong></p><ul><li><p><strong><span>运输层</span></strong><span>：提供了运行在不同主机上的应用进程之间的逻辑通信</span></p></li><li><p><strong><span>网络层</span></strong><span>：提供了主机之间的逻辑通信</span></p></li></ul><p><span>上述区别有一个形象的</span><strong><span>类比</span></strong><span>：</span></p><p><span>家庭A的每个成员与家庭B每个成员互相写信。每个家庭有个孩子负责收发所有信件（称他们是小A和小B），并把信件交给到家门口来的邮车里（或从邮车取信件）。这里便有：</span></p><ul><li><p><span>应用层报文 = 信封里的字符</span></p></li><li><p><span>进程 = 家庭成员</span></p></li><li><p><span>端系统 = 家庭</span></p></li><li><p><span>运输层协议 = 小A和小B</span></p></li><li><p><span>网络层协议 = 邮政服务</span></p></li></ul><p><strong><span>2）受限与发展</span></strong></p><p><span>我们知道协议栈中运输层在网络层之上，那运输层所能提供的服务不可避免地受限于网络层。譬如如果网络层协议无法为运输层报文段提供时延或带宽保证的话，运输层协议自然也无法为进程之间发送的应用程序报文提供时延或带宽保证。</span></p><p><span>但是运输层协议还是能新增某些服务，譬如可靠性和安全性。举例来说，因特网网络层的IP协议不保证报文段的完整、正确、按序交付。但是运输层的TCP协议可以保证数据交付的可靠性。</span></p><h3 id='312-因特网运输层概述'><span>3.1.2 因特网运输层概述</span></h3><p><span>UDP和TCP</span><strong><span>最基本的责任</span></strong><span>是，将两个端系统间IP的</span><strong><span>交付（delivery）</span></strong><span>服务扩展为两个进程之间的交付服务。这里强调TCP和UDP的区别：</span></p><ul><li><p><strong><span>UDP（user datagram protocol）</span></strong><span> </span><em><span>（注：因特网文献将TCP运输层分组称为报文段，UDP的称为数据报，而网络层分组也称为数据报。本书运输层分组统称报文段。这可以解释为什么UDP的全称有数据报）</span></em></p><ul><li><p><span>提供</span><strong><span>完整性检查（integrity checking）</span></strong><span>：可以检查差错（譬如01反转、收到的报文段不完整等），但是不能修复差错。</span></p></li><li><p><span>特点：</span><strong><span>unreliable，connectionless</span></strong></p></li></ul></li><li><p><strong><span>TCP（transmission control protocol）</span></strong></p><ul><li><p><span>提供完整性检查</span></p></li><li><p><span>提供</span><strong><span>可靠数据传输（reliable data transfer）</span></strong><span>：确保报文段们完整、正确、按序交付</span></p></li><li><p><span>提供</span><strong><span>阻塞控制（congestion control）</span></strong><span>：当网络阻塞时，调节TCP连接流量。</span></p></li><li><p><span>特点：</span><strong><span>reliable，connection-oriented</span></strong></p></li></ul></li></ul><h2 id='32-多路复用与多路分解'><span>3.2 多路复用与多路分解</span></h2><p><span>我们知道一个应用程序进程通过一个或多个套接字与运输层对话，其中：</span></p><ul><li><p><strong><span>多路复用（multiplexing）</span></strong><span>：在数据的发送端，运输层收集各个套接字中需要发送的数据，将它们封装上首部信息后，交给网络层</span></p></li><li><p><strong><span>多路分解（demultiplexing）</span></strong><span>：在数据的接收端，运输层接收到网络层的报文后，将它交付到正确的套接字上</span></p></li></ul><p><span>可见将主机之间的交付服务扩展到进程之间的服务就是多路复用和多路分解。下面来看报文段中的首部字段如何实现多路复用和多路分解。</span></p><h3 id='321-无连接的多路复用与分解'><span>3.2.1 无连接的多路复用与分解</span></h3><p><span>目的端口号表明了我要传给服务器哪个套接字；源端口号告知服务器你返回报文段时发给我哪个套接字。</span></p><p><span>需要强调的是，UDP套接字是由一个二元组（目的IP地址，目的端口号）标识的。也就是说只要两个UDP报文段有相同的目的IP地址和目的端口号的话，即便它们的源IP地址或源端口号不同，它们也会被发送到同一个UDP套接字。</span></p><p><img src="./img/udpplexing.jpg" style="zoom: 33%;" /></p><h3 id='322-面向连接的多路复用与分解'><span>3.2.2 面向连接的多路复用与分解</span></h3><p><span>不同于UDP套接字，TCP套接字是由一个四元组（源IP地址，源端口号，目的IP地址，目的端口号）来标识的。所以两个不同源的报文段会被定向到两个不同的套接字，即便目的IP地址和目的端口号相同。</span></p><p><img src="./img/tcpplexing.jpg" style="zoom: 33%;" /></p><h2 id='33-无连接运输udp'><span>3.3 无连接运输：UDP</span></h2><p><span>UDP在IP的基础上添加了多路复用和多路分解的功能，以及一些轻量的差错检测。UDP称作</span><strong><span>无连接（connectionless）</span></strong><span>，是因为在传送报文段前，不需要进行握手。</span></p><p><span>UDP的</span><strong><span>优点</span></strong></p><ul><li><p><span>关于发送什么数据、何时发送的应用层控制更加精细：只要应用将数据传送给UDP，UDP就会将此数据打包进报文段，并立刻传送给网络层。</span></p></li><li><p><span>无须建立连接：不会引入建立连接的时延。可能这就是DNS采用UDP的主要原因。</span></p></li><li><p><span>无连接状态：不用在端系统中维护连接状态（缓存、阻塞控制参数等）</span></p></li><li><p><span>分组首部开销小：TCP 20 字节，UDP 8 字节</span></p></li></ul><p><span>此外，UDP也可以实现可靠传输——通过应用程序的相关机制来实现（如Google的QUIC协议）。</span></p><h3 id='331-udp报文段结构'><span>3.3.1 UDP报文段结构</span></h3><p><span>UDP报文段首部只有四个字段，各2字节，总共8字节。源端口号和目的端口号已经在3.2.1节介绍过了。长度字段是首部加数据全部的字节数。</span><strong><span>检验和（checksum）</span></strong><span>用来检查报文段是用来检查报文段中是否出现了差错。差错检测的具体细节在6.2节介绍，3.3.2节简单介绍检验和的基本概念。</span></p><p><img src="./img/UDPstruc.jpg" style="zoom:50%;" /></p><h3 id='332-udp检验和'><span>3.3.2 UDP检验和</span></h3><p><span>发送方先对报文段中的所有16比特字求和，溢出将会被回卷（wrapped around，就是和加一）。譬如：（下面计算中最后一步有回卷）</span></p><p><img src="./img/checksum.jpg" style="zoom: 50%;" /></p><p><span>然后对结果取反（0变成1，1变成0），得到校验和。</span></p><p><span>接收方将全部的16比特字和校验和相加，结果为0xFFFF，则正确。</span></p><h2 id='34-可靠数据传输原理'><span>3.4 可靠数据传输原理</span></h2><p><span>所谓</span><strong><span>可靠（reliable）</span></strong><span>是指数据没有损坏（01翻转）、丢失（丢包）或乱序（后发的包先送给应用层）。模型如下：</span></p><p><img src="./img/reliableDataTransferServiceModel.jpg" style="zoom: 33%;" /></p><p><span>也就是利用不可靠的网络层信道，建立一个可靠的运输层信道。图中</span><code>rdt</code><span>是reliable data tranfer，</span><code>udt</code><span>是unreliable data transfer。</span></p><p><span>本章我们只考虑</span><strong><span>单向数据传送（unidirectional data transfer）</span></strong><span>，即数据传送是从发送端到接收端的。当然UDP/TCP都是</span><strong><span>双向数据传输（bidirectional data transfer）</span></strong><span>，也称为</span><strong><span>全双工（full-duplex）</span></strong><span>数据传输，即发送和接收数据可以同时进行。我们不讲全双工，因为嫌烦。</span></p><p><span>之所以把</span><code>udt_send()</code><span>、</span><code>rdt_rcv()</code><span>和网络层画成双箭头，是因为两个主机的运输层之间会互相发送信息，即便我们这里只讨论单向数据传送。</span></p><p><span>接下来我们将从</span><strong><span>停等（stop-and-wait）</span></strong><span>协议出发，不断改善我们的模型，然后讨论</span><strong><span>流水线（pipeline）</span></strong><span>，并介绍</span><strong><span>回退N步（Go-Back-N）</span></strong><span>和</span><strong><span>选择重传（Selective Repeat）</span></strong><span>两种设计方案。</span></p><h3 id='341-构建可靠数据传输协议'><span>3.4.1 构建可靠数据传输协议</span></h3><p><span>我们将使用</span><strong><span>有限状态机（finite-state-machine，FSM）</span></strong><span>来描述协议。所谓FSM指：有⼀个保存的状态，并存在⼀些事件可以改变状态。接下来让我们一步一步得到完美可靠的数据传送协议。</span></p><p><strong><span>1）Reliable Data Transfer over a Perfectly Reliable Channel: rdt1.0</span></strong></p><p><span>rdt1.0假设网络层的信道是可靠的。FSM如图：</span></p><p><img src="./img/rdt1.0.jpg" style="zoom:50%;" /></p><p><span>图中发送端和接收端各只有一个状态。虚线标识初始状态。实线标识一种状态改变成另一种状态。实线旁横线上面是引起状态改变的事件，下面是对该事件采取的动作。</span></p><p><span>由于下层信道是可靠的，所以rdt1.0几乎什么都不用做。发送端只要产生包含该数据的分组，并发送给下层；接收端只要将数据从分组取出，并传给上层。</span></p><p><strong><span>2）Reliable Data Transfer over a Channel with Bit Errors: rdt2.0</span></strong></p><p><span>现在网络层的信道可能产生比特差错，但是保证数据会及时按序到达。简单来说，接收方在发现比特差错后，告知发送方，发送发重传该分组即可。这个基于重传机制的可靠数据传输协议称为</span><strong><span>自动重传请求（Automatic Repeat reQuest，ARQ）</span></strong><span>。具体包含：</span></p><ul><li><p><strong><span>差错检测</span></strong><span>：接收方通过检验和可以实现，具体在第六章介绍</span></p></li><li><p><strong><span>接收方反馈</span></strong><span>：有差错，返回</span><strong><span>NAK (negative acknowledgment)</span></strong><span>分组；无差错，返回</span><strong><span>ACK (positive acknowledgment)</span></strong><span>分组</span></p></li><li><p><strong><span>重传</span></strong><span>：发送方重新传送有差错的分组</span></p></li></ul><p><span>rdt2.0的FSM如图：（图中</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="1.57ex" height="1.62ex" role="img" focusable="false" viewBox="0 -716 694 716" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: 0px;"><defs><path id="MJX-9-TEX-N-39B" d="M320 708Q326 716 340 716H348H355Q367 716 372 708Q374 706 423 547T523 226T575 62Q581 52 591 50T634 46H661V0H653Q644 3 532 3Q411 3 390 0H379V46H392Q464 46 464 65Q463 70 390 305T316 539L246 316Q177 95 177 84Q177 72 198 59T248 46H253V0H245Q230 3 130 3Q47 3 38 0H32V46H45Q112 51 127 91Q128 92 224 399T320 708Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="39B" xlink:href="#MJX-9-TEX-N-39B"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi mathvariant="normal">Λ</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">\Lambda</script><span>表示什么也不干）</span></p><p><img src="./img/rdt2.0.jpg" style="zoom:33%;" /></p><p><span>可以看到发送端每次传送一个分组就会等待接收端的ACK或者NAK反馈，然后才会发下一个分组。这样的行为确保了分组的按序到达。这种协议称为</span><strong><span>停等（stop-and-wait）</span></strong><span>协议。</span></p><p><span>然而rdt2.0有个致命的缺陷，就是ACK和NAK分组受损怎么办？解决的方法是给发送分组编</span><strong><span>序号（sequence number）</span></strong><span>。</span></p><p><span>rdt2.1的FSM如图：</span></p><p><img src="./img/rdt2.1.jpg" style="zoom:33%;" /></p><p><span>注意到发送方收到损坏分组或NAK分组就会把之前的数据分组重传。而接收方收到损坏分组会返回NAK；收到了并不想等到的分组序号，则说明之前返回的ACK损坏了，就重新返回ACK。</span></p><p><span>rdt2.2是rdt2.1的一个变体。它不再使用NAK分组，而是给ACK分组编号。rdt2.2的FSM如图：</span></p><p><img src="./img/rdt2.2.jpg" style="zoom: 33%;" /></p><p><span>其关键思路是：若发送方连续收到两次相同编号的ACK，则知道之前分组传送出问题了；接收方收到错误的分组，则返回和之前一样的ACK分组。这也称做</span><strong><span>冗余ACK（duplicate ACK）</span></strong><span>。</span></p><p><span>注意到接收方可能连续收到两次相同的分组，这便称为</span><strong><span>冗余数据分组（duplicate data packet）</span></strong><span>。</span></p><p><strong><span>3）Reliable Data Transfer over a Lossy Channel with Bit Errors: rdt3.0</span></strong></p><p><span>现在下层信道除了比特差错还会有丢包了。为此我们需要引入</span><strong><span>超时（timeout）</span></strong><span>，并使用</span><strong><span>定时器（timer）</span></strong><span>记录时间。简单来说，就是发送方在一定时间内没有收到ACK分组的话，就会重传之前的分组。rdt3.0发送方的FSM如图：（图中右边注释有误，应该时收到0号无损ACK）</span></p><p><img src="./img/rdt3.0.jpg" style="zoom:33%;" /></p><p><span>rdt3.0接收方的FSM图和rdt2.2接收方的FSM图一致。由于分组的序号在01之间交替，所以rdt3.0也称做</span><strong><span>alternating-bit protocol</span></strong><span>。下面是两个具体运行实例：</span></p><p><img src="./img/rdt3.0_instance.jpg" style="zoom: 33%;" /></p><p><span>至此我们使用检验和、序号、定时器、ACK和NAK分组，成功实现了一个可靠数据传输协议rdt3.0！它保证不丢包（定时器，重传），保证比特正确（检验和、序号，重传），保证按序（停等）。</span></p><h3 id='342-流水线可靠数据传输协议'><span>3.4.2 流水线可靠数据传输协议</span></h3><p><span>显然rdt3.0这种停等协议太慢了。发送一个分组要等半天ACK才能发下一个。我们希望允许发送方发送多个分组而无须等待确认。而这便是</span><strong><span>流水线（pipelining）</span></strong><span>。为此我们需要做一些改变：</span></p><ul><li><p><span>必须增加序号范围，因为每个运输中的分组（不计重传的）必须有一个唯一的序号</span></p></li><li><p><span>协议的接收方、发送方需要缓存多个分组。发送方至少要缓存那些已经发送但是未确认的分组。接收方或许也要缓存那些已经正确接收的分组（譬如缓存乱序分组）。</span></p></li><li><p><span>所需序号范围和对缓冲的要求取决于如何解决丢失。解决流水线的差错恢复有两种基本方法，下面两节会分别介绍。</span></p><ul><li><p><strong><span>回退N步（Go-Back-N, GBN）</span></strong></p></li><li><p><strong><span>选择重传（Selective Repeat, SR）</span></strong></p></li></ul></li></ul><h3 id='343-回退n步'><span>3.4.3 回退N步</span></h3><p><span>GBN的流水线中未确认的分组数不能超过某个最大允许数N，这个N称为</span><strong><span>窗口长度（window size）</span></strong><span>，GBN协议也被称为</span><strong><span>滑动窗口协议（sliding-window protocol）</span></strong><span>。GBN的发送方需要维护两个序号：</span></p><ul><li><p><span>base: the sequence number of the oldest unacknowledged packet</span></p></li><li><p><span>nextseqnum: the smallest unused sequence number (i.e. the sequence number of the next packet to be sent)</span></p></li></ul><p><img src="./img/GBN1.jpg" style="zoom: 50%;" /></p><p><span>GBN的FSM描述如下：（称为扩展是因为维护了变量+判断语句）</span></p><p><img src="./img/GBN2.jpg" style="zoom: 33%;" /></p><p><span>注意到：</span></p><ul><li><p><span>接收方只接收按序的分组（通过维护expectedseqnum实现），对于那些乱序到达（即后发的包先到）的分组就扔掉。</span></p></li><li><p><span>接收方返回的ACK序号n表明接收方已正确接收到序号为n及以前的所有分组。这种确认称为</span><strong><span>累计确认（cumulative acknowledgment）</span></strong><span>。因此，即使发送方没有收到ACK t（由于丢包），但是收到了ACK t+1，发送方也能确认分组t已经被收到了。</span></p></li><li><p><span>当超时发生，发送方会重发所有已经发送但是未确认的分组。这便是回退N步名字的由来。</span></p></li></ul><p><em><span>书上图3-22给出了一个GBN运行实例，但是其中分组2超时感觉和图3-21定义的超时不同。这里不再细究</span></em></p><h3 id='344-选择重传'><span>3.4.4 选择重传</span></h3><p><span>GBN有个很显然的问题：单个分组的差错会引起GBN重传大量分组。而SR协议通过让发送方仅重传那些它怀疑在接收方出错（丢失或受损）的分组，从而避免了不必要的重传。</span></p><p><span>和GBN类似的是，SR也使用了N来限制最大未确认的分组数。SR发送方也和GBN一样需要维护</span><code>send_base</code><span>和</span><code>nextseqnum</code><span>两个序号。但是SR接收方需要维护</span><code>rcv_base</code><span>序号来标识最小的期待但未收到的序号。如下图：</span></p><p><img src="./img/SR1.jpg" style="zoom: 50%;" /></p><p><span>书上没有提供FSM，而是用文字说明SR的发送方和接收方的时间与动作：</span></p><ul><li><p><span>发送方：</span></p><ul><li><p><span>从上层收到数据：在窗口内的发送，否则缓存或返回上层</span></p></li><li><p><span>超时：每个分组都有自己的定时器，当超时时，只重传该分组</span></p></li><li><p><span>收到ACK：标记为已经确认，如果等于</span><code>send_base</code><span>则移动窗口</span></p></li></ul></li><li><p><span>接收方：</span></p><ul><li><p><span>序号在[rcv_base,rcv_base+N-1]内的分组：返回相关序号的ACK。若失序则缓存；若是rcv_base序号，则将rcv_base及其以后收到的分组向上层交付。</span></p></li><li><p><span>序号在[rcv_base-N,rcv_base-1]内的分组：返回相关序号的ACK。</span></p></li><li><p><span>其他：忽略该分组</span></p></li></ul></li></ul><p><span>注意到：</span></p><ul><li><p><span>发送方和接收方的窗口大小都是N，但是两者不一致</span></p></li><li><p><span>接收方会缓存失序的分组，直到所有比它小的分组都接收到</span></p></li><li><p><span>接收方收到什么分组就返回什么ACK序号，不再具有累计确认的功能</span></p></li></ul><p><span>一个实例如下：</span></p><p><img src="./img/SR_instance.jpg" style="zoom: 50%;" /></p><p><span>最后需要强调窗口长度必须小于等于序号空间大小的一半。如果窗口长度大于序号空间长度，接收方无法分辨是一个新分组还是一次重传。</span></p><h2 id='35-面向连接的运输tcp'><span>3.5 面向连接的运输：TCP</span></h2><h3 id='351-tcp连接'><span>3.5.1 TCP连接</span></h3><p><span>仅强调</span></p><ul><li><p><span>TCP是</span><strong><span>面向连接的（connection-oriented）</span></strong><span>：发送数据前要进行</span><strong><span>三次握手（three-way handshake）</span></strong><span>——客户发送一个特殊的TCP报文段，服务器用另一个特殊的TCP报文段响应，客户再用第三个特殊报文段响应。其中前两个报文段不包含应用层数据，第三个可以包含。</span></p></li><li><p><span>作为因特网运输层，TCP协议只在端系统有</span></p></li><li><p><strong><span>全双工（full-duplex）</span></strong><span>：我可以同时发数据也可以接收数据</span></p></li><li><p><strong><span>点对点（point-to-point）</span></strong><span>：TCP两端只有一个服务端和客户端</span></p></li><li><p><strong><span>发送缓存（send buffer）</span></strong><span>和</span><strong><span>接收缓存（receive buffer）</span></strong><span>：分别用来存放要发送的数据和收到的数据</span></p></li><li><p><strong><span>MSS（最大报文段长度，maximum segment size）</span></strong><span>：报文段中数据字段的最大长度，不包括首部字段。MSS通常根据最大链路帧长度（即</span><strong><span>最大传输单元MTU</span></strong><span>）设置。</span></p></li></ul><h3 id='352-tcp报文段结构'><span>3.5.2 TCP报文段结构</span></h3><p><span>TCP报文段结构如图：</span></p><p><img src="./img/TCPstruct.jpg" style="zoom: 50%;" /></p><ul><li><p><strong><span>源端口号</span></strong><span>和</span><strong><span>目的端口号</span></strong><span>：已在3.2.2节介绍。</span></p></li><li><p><strong><span>序号（sequence number）</span></strong><span>：TCP把数据看成无结构、有序的字节流，序号建立在传送的字节流上（不再是报文段的序列）。譬如数据流由50000字节的文件组成，MSS为1000字节，数据流的首字节编号是828（一个随机数），那么第一个报文段的序号是828，第二个是1828，依次类推。</span></p></li><li><p><strong><span>确认号（acknowledgment number）</span></strong></p><ul><li><p><span>希望从对方收到的下一个字节的序号</span></p></li><li><p><strong><span>累计确认（cumulative acknowledgment）</span></strong><span>：确认号之前的所有字节都已经收到</span></p></li></ul></li><li><p><strong><span>首部长度（header length field）</span></strong><span>：因为选项字段的存在，首部长度是可变的</span></p></li><li><p><strong><span>选项字段（options field）</span></strong><span>：用于协商MSS</span></p></li><li><p><strong><span>标志字段（flag field）</span></strong><span>：</span></p><ul><li><p><span>ACK——确认有效</span></p></li><li><p><span>RST、SYN、FIN——建立连接和拆除</span></p></li><li><p><span>CWR、ECE——明确拥塞</span></p></li><li><p><span>PSH、URG</span></p></li></ul></li><li><p><strong><span>接收窗口（receive window）</span></strong><span>：用于流量控制（见3.5.5节），表示接收方愿意接收的字节数量</span></p></li><li><p><strong><span>因特网检验和（Internet checksum）</span></strong><span>：已经在3.3.2节初步讨论过</span></p></li></ul><p><span>Telnet</span><strong><span>回显（echo back）</span></strong><span>例子：</span></p><p><img src="./img/telnetecho.jpg" style="zoom: 50%;" /></p><p><span>再次强调，图中seq是报文段数据字段首字节的序号，ACK是我希望对方给我返回的报文段数据字段首字节的序号。特别的，当返回的数据字段为空，序号字段也要加一。由第二个报文段可以看到，ACK确认是</span><strong><span>捎带（piggybacked）</span></strong><span>在数据报文段中。</span></p><h3 id='353-往返时间的估计与超时'><span>3.5.3 往返时间的估计与超时</span></h3><p><span>如何去设置超时时间间隔（timeout interval）呢？那肯定要估计</span><strong><span>round-trip time（RTT）</span></strong><span>——the time from when a segment is sent until it is acknowledged. 具体如下：</span></p><ol start='' ><li><p><span>取样计算一个报文段的RTT，称为SampleRTT。但是不取重传的报文段作为样本。</span></p></li><li><p><span>计算加权平均：（a一般取1/8）</span></p><p><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="61.56ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 27209.3 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-10-TEX-I-1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path><path id="MJX-10-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path><path id="MJX-10-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-10-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-10-TEX-I-1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-10-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-10-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-10-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-10-TEX-I-1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path><path id="MJX-10-TEX-I-1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path><path id="MJX-10-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-10-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-10-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-10-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-10-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-10-TEX-N-2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path><path id="MJX-10-TEX-N-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path id="MJX-10-TEX-I-1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path><path id="MJX-10-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-10-TEX-I-1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D438" xlink:href="#MJX-10-TEX-I-1D438"></use></g><g data-mml-node="mi" transform="translate(764,0)"><use data-c="1D460" xlink:href="#MJX-10-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(1233,0)"><use data-c="1D461" xlink:href="#MJX-10-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(1594,0)"><use data-c="1D456" xlink:href="#MJX-10-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(1939,0)"><use data-c="1D45A" xlink:href="#MJX-10-TEX-I-1D45A"></use></g><g data-mml-node="mi" transform="translate(2817,0)"><use data-c="1D44E" xlink:href="#MJX-10-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(3346,0)"><use data-c="1D461" xlink:href="#MJX-10-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(3707,0)"><use data-c="1D452" xlink:href="#MJX-10-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(4173,0)"><use data-c="1D451" xlink:href="#MJX-10-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(4693,0)"><use data-c="1D445" xlink:href="#MJX-10-TEX-I-1D445"></use></g><g data-mml-node="mi" transform="translate(5452,0)"><use data-c="1D447" xlink:href="#MJX-10-TEX-I-1D447"></use></g><g data-mml-node="mi" transform="translate(6156,0)"><use data-c="1D447" xlink:href="#MJX-10-TEX-I-1D447"></use></g><g data-mml-node="mo" transform="translate(7137.8,0)"><use data-c="3D" xlink:href="#MJX-10-TEX-N-3D"></use></g><g data-mml-node="mo" transform="translate(8193.6,0)"><use data-c="28" xlink:href="#MJX-10-TEX-N-28"></use></g><g data-mml-node="mn" transform="translate(8582.6,0)"><use data-c="31" xlink:href="#MJX-10-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(9304.8,0)"><use data-c="2212" xlink:href="#MJX-10-TEX-N-2212"></use></g><g data-mml-node="mi" transform="translate(10305,0)"><use data-c="1D44E" xlink:href="#MJX-10-TEX-I-1D44E"></use></g><g data-mml-node="mo" transform="translate(10834,0)"><use data-c="29" xlink:href="#MJX-10-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(11445.2,0)"><use data-c="2217" xlink:href="#MJX-10-TEX-N-2217"></use></g><g data-mml-node="mi" transform="translate(12167.4,0)"><use data-c="1D438" xlink:href="#MJX-10-TEX-I-1D438"></use></g><g data-mml-node="mi" transform="translate(12931.4,0)"><use data-c="1D460" xlink:href="#MJX-10-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(13400.4,0)"><use data-c="1D461" xlink:href="#MJX-10-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(13761.4,0)"><use data-c="1D456" xlink:href="#MJX-10-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(14106.4,0)"><use data-c="1D45A" xlink:href="#MJX-10-TEX-I-1D45A"></use></g><g data-mml-node="mi" transform="translate(14984.4,0)"><use data-c="1D44E" xlink:href="#MJX-10-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(15513.4,0)"><use data-c="1D461" xlink:href="#MJX-10-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(15874.4,0)"><use data-c="1D452" xlink:href="#MJX-10-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(16340.4,0)"><use data-c="1D451" xlink:href="#MJX-10-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(16860.4,0)"><use data-c="1D445" xlink:href="#MJX-10-TEX-I-1D445"></use></g><g data-mml-node="mi" transform="translate(17619.4,0)"><use data-c="1D447" xlink:href="#MJX-10-TEX-I-1D447"></use></g><g data-mml-node="mi" transform="translate(18323.4,0)"><use data-c="1D447" xlink:href="#MJX-10-TEX-I-1D447"></use></g><g data-mml-node="mo" transform="translate(19249.7,0)"><use data-c="2B" xlink:href="#MJX-10-TEX-N-2B"></use></g><g data-mml-node="mi" transform="translate(20259.9,0)"><use data-c="1D44E" xlink:href="#MJX-10-TEX-I-1D44E"></use></g><g data-mml-node="mo" transform="translate(21001.1,0)"><use data-c="2217" xlink:href="#MJX-10-TEX-N-2217"></use></g><g data-mml-node="mi" transform="translate(21723.3,0)"><use data-c="1D446" xlink:href="#MJX-10-TEX-I-1D446"></use></g><g data-mml-node="mi" transform="translate(22368.3,0)"><use data-c="1D44E" xlink:href="#MJX-10-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(22897.3,0)"><use data-c="1D45A" xlink:href="#MJX-10-TEX-I-1D45A"></use></g><g data-mml-node="mi" transform="translate(23775.3,0)"><use data-c="1D45D" xlink:href="#MJX-10-TEX-I-1D45D"></use></g><g data-mml-node="mi" transform="translate(24278.3,0)"><use data-c="1D459" xlink:href="#MJX-10-TEX-I-1D459"></use></g><g data-mml-node="mi" transform="translate(24576.3,0)"><use data-c="1D452" xlink:href="#MJX-10-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(25042.3,0)"><use data-c="1D445" xlink:href="#MJX-10-TEX-I-1D445"></use></g><g data-mml-node="mi" transform="translate(25801.3,0)"><use data-c="1D447" xlink:href="#MJX-10-TEX-I-1D447"></use></g><g data-mml-node="mi" transform="translate(26505.3,0)"><use data-c="1D447" xlink:href="#MJX-10-TEX-I-1D447"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>E</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>a</mi><mo stretchy="false">)</mo><mo>∗</mo><mi>E</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>+</mo><mi>a</mi><mo>∗</mo><mi>S</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi>R</mi><mi>T</mi><mi>T</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">EstimatedRTT = (1 - a) * EstimatedRTT+ a * SampleRTT</script><span> </span></p></li><li><p><span>计算SampleRTT和EstimatedRTT偏离程度：（b一般取0.25）</span></p><p><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="67.968ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 30041.8 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-11-TEX-I-1D437" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path><path id="MJX-11-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-11-TEX-I-1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path><path id="MJX-11-TEX-I-1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path><path id="MJX-11-TEX-I-1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path><path id="MJX-11-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-11-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-11-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-11-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-11-TEX-I-1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path><path id="MJX-11-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-11-TEX-N-2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path><path id="MJX-11-TEX-N-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path id="MJX-11-TEX-I-1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path><path id="MJX-11-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-11-TEX-I-1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-11-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-11-TEX-I-1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path><path id="MJX-11-TEX-I-1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path><path id="MJX-11-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path><path id="MJX-11-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-11-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-11-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D437" xlink:href="#MJX-11-TEX-I-1D437"></use></g><g data-mml-node="mi" transform="translate(828,0)"><use data-c="1D452" xlink:href="#MJX-11-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(1294,0)"><use data-c="1D463" xlink:href="#MJX-11-TEX-I-1D463"></use></g><g data-mml-node="mi" transform="translate(1779,0)"><use data-c="1D445" xlink:href="#MJX-11-TEX-I-1D445"></use></g><g data-mml-node="mi" transform="translate(2538,0)"><use data-c="1D447" xlink:href="#MJX-11-TEX-I-1D447"></use></g><g data-mml-node="mi" transform="translate(3242,0)"><use data-c="1D447" xlink:href="#MJX-11-TEX-I-1D447"></use></g><g data-mml-node="mo" transform="translate(4223.8,0)"><use data-c="3D" xlink:href="#MJX-11-TEX-N-3D"></use></g><g data-mml-node="mo" transform="translate(5279.6,0)"><use data-c="28" xlink:href="#MJX-11-TEX-N-28"></use></g><g data-mml-node="mn" transform="translate(5668.6,0)"><use data-c="31" xlink:href="#MJX-11-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(6390.8,0)"><use data-c="2212" xlink:href="#MJX-11-TEX-N-2212"></use></g><g data-mml-node="mi" transform="translate(7391,0)"><use data-c="1D44F" xlink:href="#MJX-11-TEX-I-1D44F"></use></g><g data-mml-node="mo" transform="translate(7820,0)"><use data-c="29" xlink:href="#MJX-11-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(8431.2,0)"><use data-c="2217" xlink:href="#MJX-11-TEX-N-2217"></use></g><g data-mml-node="mi" transform="translate(9153.4,0)"><use data-c="1D437" xlink:href="#MJX-11-TEX-I-1D437"></use></g><g data-mml-node="mi" transform="translate(9981.4,0)"><use data-c="1D452" xlink:href="#MJX-11-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(10447.4,0)"><use data-c="1D463" xlink:href="#MJX-11-TEX-I-1D463"></use></g><g data-mml-node="mi" transform="translate(10932.4,0)"><use data-c="1D445" xlink:href="#MJX-11-TEX-I-1D445"></use></g><g data-mml-node="mi" transform="translate(11691.4,0)"><use data-c="1D447" xlink:href="#MJX-11-TEX-I-1D447"></use></g><g data-mml-node="mi" transform="translate(12395.4,0)"><use data-c="1D447" xlink:href="#MJX-11-TEX-I-1D447"></use></g><g data-mml-node="mo" transform="translate(13321.7,0)"><use data-c="2B" xlink:href="#MJX-11-TEX-N-2B"></use></g><g data-mml-node="mi" transform="translate(14321.9,0)"><use data-c="1D44F" xlink:href="#MJX-11-TEX-I-1D44F"></use></g><g data-mml-node="mo" transform="translate(14973.1,0)"><use data-c="2217" xlink:href="#MJX-11-TEX-N-2217"></use></g><g data-mml-node="mo" transform="translate(15695.3,0)"><use data-c="28" xlink:href="#MJX-11-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(16084.3,0)"><use data-c="1D446" xlink:href="#MJX-11-TEX-I-1D446"></use></g><g data-mml-node="mi" transform="translate(16729.3,0)"><use data-c="1D44E" xlink:href="#MJX-11-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(17258.3,0)"><use data-c="1D45A" xlink:href="#MJX-11-TEX-I-1D45A"></use></g><g data-mml-node="mi" transform="translate(18136.3,0)"><use data-c="1D45D" xlink:href="#MJX-11-TEX-I-1D45D"></use></g><g data-mml-node="mi" transform="translate(18639.3,0)"><use data-c="1D459" xlink:href="#MJX-11-TEX-I-1D459"></use></g><g data-mml-node="mi" transform="translate(18937.3,0)"><use data-c="1D452" xlink:href="#MJX-11-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(19403.3,0)"><use data-c="1D445" xlink:href="#MJX-11-TEX-I-1D445"></use></g><g data-mml-node="mi" transform="translate(20162.3,0)"><use data-c="1D447" xlink:href="#MJX-11-TEX-I-1D447"></use></g><g data-mml-node="mi" transform="translate(20866.3,0)"><use data-c="1D447" xlink:href="#MJX-11-TEX-I-1D447"></use></g><g data-mml-node="mo" transform="translate(21792.6,0)"><use data-c="2212" xlink:href="#MJX-11-TEX-N-2212"></use></g><g data-mml-node="mi" transform="translate(22792.8,0)"><use data-c="1D438" xlink:href="#MJX-11-TEX-I-1D438"></use></g><g data-mml-node="mi" transform="translate(23556.8,0)"><use data-c="1D460" xlink:href="#MJX-11-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(24025.8,0)"><use data-c="1D461" xlink:href="#MJX-11-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(24386.8,0)"><use data-c="1D456" xlink:href="#MJX-11-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(24731.8,0)"><use data-c="1D45A" xlink:href="#MJX-11-TEX-I-1D45A"></use></g><g data-mml-node="mi" transform="translate(25609.8,0)"><use data-c="1D44E" xlink:href="#MJX-11-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(26138.8,0)"><use data-c="1D461" xlink:href="#MJX-11-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(26499.8,0)"><use data-c="1D452" xlink:href="#MJX-11-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(26965.8,0)"><use data-c="1D451" xlink:href="#MJX-11-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(27485.8,0)"><use data-c="1D445" xlink:href="#MJX-11-TEX-I-1D445"></use></g><g data-mml-node="mi" transform="translate(28244.8,0)"><use data-c="1D447" xlink:href="#MJX-11-TEX-I-1D447"></use></g><g data-mml-node="mi" transform="translate(28948.8,0)"><use data-c="1D447" xlink:href="#MJX-11-TEX-I-1D447"></use></g><g data-mml-node="mo" transform="translate(29652.8,0)"><use data-c="29" xlink:href="#MJX-11-TEX-N-29"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>D</mi><mi>e</mi><mi>v</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>b</mi><mo stretchy="false">)</mo><mo>∗</mo><mi>D</mi><mi>e</mi><mi>v</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>+</mo><mi>b</mi><mo>∗</mo><mo stretchy="false">(</mo><mi>S</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>−</mo><mi>E</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">DevRTT = (1 - b) * DevRTT + b * (SampleRTT - EstimatedRTT)</script></p></li><li><p><span>设置超时时间间隔（经验公式）</span></p><p><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="50.478ex" height="1.756ex" role="img" focusable="false" viewBox="0 -694 22311.4 776" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.186ex;"><defs><path id="MJX-12-TEX-I-1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path><path id="MJX-12-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-12-TEX-I-1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-12-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-12-TEX-I-1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path><path id="MJX-12-TEX-I-1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-12-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-12-TEX-I-1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path><path id="MJX-12-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-12-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-12-TEX-I-1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path><path id="MJX-12-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-12-TEX-I-1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path><path id="MJX-12-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-12-TEX-I-1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path><path id="MJX-12-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path><path id="MJX-12-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-12-TEX-I-1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path><path id="MJX-12-TEX-N-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path id="MJX-12-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path id="MJX-12-TEX-N-2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path><path id="MJX-12-TEX-I-1D437" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D447" xlink:href="#MJX-12-TEX-I-1D447"></use></g><g data-mml-node="mi" transform="translate(704,0)"><use data-c="1D456" xlink:href="#MJX-12-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(1049,0)"><use data-c="1D45A" xlink:href="#MJX-12-TEX-I-1D45A"></use></g><g data-mml-node="mi" transform="translate(1927,0)"><use data-c="1D452" xlink:href="#MJX-12-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(2393,0)"><use data-c="1D45C" xlink:href="#MJX-12-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(2878,0)"><use data-c="1D462" xlink:href="#MJX-12-TEX-I-1D462"></use></g><g data-mml-node="mi" transform="translate(3450,0)"><use data-c="1D461" xlink:href="#MJX-12-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(3811,0)"><use data-c="1D43C" xlink:href="#MJX-12-TEX-I-1D43C"></use></g><g data-mml-node="mi" transform="translate(4315,0)"><use data-c="1D45B" xlink:href="#MJX-12-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(4915,0)"><use data-c="1D461" xlink:href="#MJX-12-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(5276,0)"><use data-c="1D452" xlink:href="#MJX-12-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(5742,0)"><use data-c="1D45F" xlink:href="#MJX-12-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(6193,0)"><use data-c="1D463" xlink:href="#MJX-12-TEX-I-1D463"></use></g><g data-mml-node="mi" transform="translate(6678,0)"><use data-c="1D44E" xlink:href="#MJX-12-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(7207,0)"><use data-c="1D459" xlink:href="#MJX-12-TEX-I-1D459"></use></g><g data-mml-node="mo" transform="translate(7782.8,0)"><use data-c="3D" xlink:href="#MJX-12-TEX-N-3D"></use></g><g data-mml-node="mi" transform="translate(8838.6,0)"><use data-c="1D438" xlink:href="#MJX-12-TEX-I-1D438"></use></g><g data-mml-node="mi" transform="translate(9602.6,0)"><use data-c="1D460" xlink:href="#MJX-12-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(10071.6,0)"><use data-c="1D461" xlink:href="#MJX-12-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(10432.6,0)"><use data-c="1D456" xlink:href="#MJX-12-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(10777.6,0)"><use data-c="1D45A" xlink:href="#MJX-12-TEX-I-1D45A"></use></g><g data-mml-node="mi" transform="translate(11655.6,0)"><use data-c="1D44E" xlink:href="#MJX-12-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(12184.6,0)"><use data-c="1D461" xlink:href="#MJX-12-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(12545.6,0)"><use data-c="1D452" xlink:href="#MJX-12-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(13011.6,0)"><use data-c="1D451" xlink:href="#MJX-12-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(13531.6,0)"><use data-c="1D445" xlink:href="#MJX-12-TEX-I-1D445"></use></g><g data-mml-node="mi" transform="translate(14290.6,0)"><use data-c="1D447" xlink:href="#MJX-12-TEX-I-1D447"></use></g><g data-mml-node="mi" transform="translate(14994.6,0)"><use data-c="1D447" xlink:href="#MJX-12-TEX-I-1D447"></use></g><g data-mml-node="mo" transform="translate(15920.8,0)"><use data-c="2B" xlink:href="#MJX-12-TEX-N-2B"></use></g><g data-mml-node="mn" transform="translate(16921,0)"><use data-c="34" xlink:href="#MJX-12-TEX-N-34"></use></g><g data-mml-node="mo" transform="translate(17643.2,0)"><use data-c="2217" xlink:href="#MJX-12-TEX-N-2217"></use></g><g data-mml-node="mi" transform="translate(18365.4,0)"><use data-c="1D437" xlink:href="#MJX-12-TEX-I-1D437"></use></g><g data-mml-node="mi" transform="translate(19193.4,0)"><use data-c="1D452" xlink:href="#MJX-12-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(19659.4,0)"><use data-c="1D463" xlink:href="#MJX-12-TEX-I-1D463"></use></g><g data-mml-node="mi" transform="translate(20144.4,0)"><use data-c="1D445" xlink:href="#MJX-12-TEX-I-1D445"></use></g><g data-mml-node="mi" transform="translate(20903.4,0)"><use data-c="1D447" xlink:href="#MJX-12-TEX-I-1D447"></use></g><g data-mml-node="mi" transform="translate(21607.4,0)"><use data-c="1D447" xlink:href="#MJX-12-TEX-I-1D447"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>a</mi><mi>l</mi><mo>=</mo><mi>E</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>R</mi><mi>T</mi><mi>T</mi><mo>+</mo><mn>4</mn><mo>∗</mo><mi>D</mi><mi>e</mi><mi>v</mi><mi>R</mi><mi>T</mi><mi>T</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">TimeoutInterval = EstimatedRTT + 4 * DevRTT</script></p></li></ol><p><span>一开始可以初始TimeoutInterval值为1s；出现超时之后，TimeoutInterval将加倍；但是一旦又收到报文段后，TimeoutInterval就又用该公式计算。之所以超时采用时间加倍的方法，是为了避免给已经拥堵的网络增添更多流量。</span></p><h3 id='354-可靠数据传输'><span>3.5.4 可靠数据传输</span></h3><p><span>由于管理定时器的开销不小，TCP协议（推荐下）仅使用一个重传定时器。现在我们不考虑流量控制（3.5.5节）和阻塞控制（3.6，3.7节），并且假设数据传送只在一个方向。TCP发送方可以描述为：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 43.9844px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>28</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -35.9983px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">NextSeqNum = InitialSeqNumber //最小的未使用的序号</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SendBase = InitialSeqNumber //最老的未确认的包</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">loop(forever) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  switch(event)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  event: 收到上面应用层数据</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  create TCP segment with sequence number NextSeqNum</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>if (timer not running)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  start timer //时间间隔根据3.5.3给出公式计算</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>pass segment to IP</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>NextSeqNum += length(data)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>break;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span>event: 超时</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>retransmit not-yet-acknowledged segment with smallest sequence number</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>start timer //时间间隔翻倍</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>break;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span>event: 收到y号ACK（即报文段确认号字段为y）</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>if (y &gt; SendBase) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>SendBase = y</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>if (还有未确认的分组)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>start timer //时间间隔根据3.5.3给出公式计算</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>else { //快速重传</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>increment number of duplicate ACKs received for y</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>if (number of duplicate ACKs received for y == 3)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">25</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>resend segment with sequence number y</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">26</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">27</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>break;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">28</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 645px;"></div><div class="CodeMirror-gutters" style="height: 645px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p><span>注意到：</span></p><ul><li><p><span>初始序号是随机的。这是为了minimize the possibility that a segment that is still present in the network from an earlier, already-terminated connection between two hosts is mistaken for a valid segment in a later connection between these same hosts (which also happen to be using the same port numbers as the old connection)</span></p></li><li><p><span>有三个事件，其中超时timeout interval计算方式和其他两个不同。计算细节见3.5.3</span></p></li><li><p><span>TCP使用</span><strong><span>累计确认（cumulative acknowledgment）</span></strong><span>，所以收到y号ACK，代表y之前（不包含y）所有字节都收到了。</span></p></li><li><p><span>报文段重传时只传最小未确认序号的</span></p></li><li><p><span>当收到三个</span><strong><span>冗余ACK（duplicate ACK）</span></strong><span>（就是该ACK第四次收到了）时，说明之前那个分组很有可能丢失了。与其等到超时，不如直接重传。这种重传方式称为</span><strong><span>快速重传（fast retransmit）</span></strong><span>。</span></p></li></ul><p><span>几个</span><strong><span>例子</span></strong></p><p><img src="./img/tcpeg.jpg" referrerpolicy="no-referrer"></p><ul><li><p><span>图3-34：ACK丢失引发超时，从而重传</span></p></li><li><p><span>图3-35：超时时间间隔较小。重传了最小的报文段92。</span></p></li><li><p><span>图3-36：ACK100丢失，但是ACK120正确到达。由于累计ACK，所以主机A知道主机B已经正确接收报文段92，不会重传</span></p></li><li><p><span>图3-37：连续收到三个冗余ACK100，快速重传</span></p></li></ul><p><strong><span>与GBN和SR异同</span></strong></p><p><span>累计ACK像GBN；不扔掉乱序分组、只重传一个分组像SR。故可以说TCP是GBN和SR的混合体。</span></p><h3 id='355-流量控制'><span>3.5.5 流量控制</span></h3><p><span>如果发送方发来的数据快于接收方应用读取的数据，那么接收缓冲区很快就会溢出，导致各种丢包。于是TCP采用了</span><strong><span>流量控制（flow control）</span></strong><span>，来使得发送者的发送速率和接收者的接收速率相当。注意到流量控制不等同于阻塞控制，阻塞控制是限制发送者的发送速率来避免网络中有过多流量，造成拥堵和丢包。</span></p><p><span>下面来看流量控制的具体实现</span></p><ul><li><p><strong><span>接收方</span></strong><span>：维护变量</span></p><ul><li><p><span>LastByteRead：应用进程从缓存读出的数据流的最后一个字节的编号</span></p></li><li><p><span>LastByteRcvd：从网络中到达的并且已放入接收缓存中的数据流的最后一个字节的编号</span></p></li></ul><p><img src="./img/flowcontrol.jpg" style="zoom:33%;" /></p><p><span>上图中RcvBuffer是整个接收缓存区的大小；rwnd是</span><strong><span>接收窗口（receive window）</span></strong><span>的大小，可以动态计算得到。</span></p></li><li><p><strong><span>发送方</span></strong><span>：维护变量</span></p><ul><li><p><span>LastByteSent：最后发送的字节序号</span></p></li><li><p><span>LastByteAcked：最后收到的字节序号</span></p></li></ul></li></ul><p><span>于是发送方只要控制</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n1055" cid="n1055" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="40.355ex" height="2.084ex" role="img" focusable="false" viewBox="0 -716 17837 921" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.464ex;"><defs><path id="MJX-2-TEX-I-1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path><path id="MJX-2-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-2-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path><path id="MJX-2-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-2-TEX-I-1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path><path id="MJX-2-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-2-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-2-TEX-I-1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path><path id="MJX-2-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-2-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-2-TEX-I-1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path><path id="MJX-2-TEX-I-1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path><path id="MJX-2-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path><path id="MJX-2-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-2-TEX-N-2264" d="M674 636Q682 636 688 630T694 615T687 601Q686 600 417 472L151 346L399 228Q687 92 691 87Q694 81 694 76Q694 58 676 56H670L382 192Q92 329 90 331Q83 336 83 348Q84 359 96 365Q104 369 382 500T665 634Q669 636 674 636ZM84 -118Q84 -108 99 -98H678Q694 -104 694 -118Q694 -130 679 -138H98Q84 -131 84 -118Z"></path><path id="MJX-2-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-2-TEX-I-1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D43F" xlink:href="#MJX-2-TEX-I-1D43F"></use></g><g data-mml-node="mi" transform="translate(681,0)"><use data-c="1D44E" xlink:href="#MJX-2-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(1210,0)"><use data-c="1D460" xlink:href="#MJX-2-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(1679,0)"><use data-c="1D461" xlink:href="#MJX-2-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(2040,0)"><use data-c="1D435" xlink:href="#MJX-2-TEX-I-1D435"></use></g><g data-mml-node="mi" transform="translate(2799,0)"><use data-c="1D466" xlink:href="#MJX-2-TEX-I-1D466"></use></g><g data-mml-node="mi" transform="translate(3289,0)"><use data-c="1D461" xlink:href="#MJX-2-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(3650,0)"><use data-c="1D452" xlink:href="#MJX-2-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(4116,0)"><use data-c="1D446" xlink:href="#MJX-2-TEX-I-1D446"></use></g><g data-mml-node="mi" transform="translate(4761,0)"><use data-c="1D452" xlink:href="#MJX-2-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(5227,0)"><use data-c="1D45B" xlink:href="#MJX-2-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(5827,0)"><use data-c="1D461" xlink:href="#MJX-2-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(6410.2,0)"><use data-c="2212" xlink:href="#MJX-2-TEX-N-2212"></use></g><g data-mml-node="mi" transform="translate(7410.4,0)"><use data-c="1D43F" xlink:href="#MJX-2-TEX-I-1D43F"></use></g><g data-mml-node="mi" transform="translate(8091.4,0)"><use data-c="1D44E" xlink:href="#MJX-2-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(8620.4,0)"><use data-c="1D460" xlink:href="#MJX-2-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(9089.4,0)"><use data-c="1D461" xlink:href="#MJX-2-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(9450.4,0)"><use data-c="1D435" xlink:href="#MJX-2-TEX-I-1D435"></use></g><g data-mml-node="mi" transform="translate(10209.4,0)"><use data-c="1D466" xlink:href="#MJX-2-TEX-I-1D466"></use></g><g data-mml-node="mi" transform="translate(10699.4,0)"><use data-c="1D461" xlink:href="#MJX-2-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(11060.4,0)"><use data-c="1D452" xlink:href="#MJX-2-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(11526.4,0)"><use data-c="1D434" xlink:href="#MJX-2-TEX-I-1D434"></use></g><g data-mml-node="mi" transform="translate(12276.4,0)"><use data-c="1D450" xlink:href="#MJX-2-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(12709.4,0)"><use data-c="1D458" xlink:href="#MJX-2-TEX-I-1D458"></use></g><g data-mml-node="mi" transform="translate(13230.4,0)"><use data-c="1D452" xlink:href="#MJX-2-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(13696.4,0)"><use data-c="1D451" xlink:href="#MJX-2-TEX-I-1D451"></use></g><g data-mml-node="mo" transform="translate(14494.2,0)"><use data-c="2264" xlink:href="#MJX-2-TEX-N-2264"></use></g><g data-mml-node="mi" transform="translate(15550,0)"><use data-c="1D45F" xlink:href="#MJX-2-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(16001,0)"><use data-c="1D464" xlink:href="#MJX-2-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(16717,0)"><use data-c="1D45B" xlink:href="#MJX-2-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(17317,0)"><use data-c="1D451" xlink:href="#MJX-2-TEX-I-1D451"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>L</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>B</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>S</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo>−</mo><mi>L</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>B</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>A</mi><mi>c</mi><mi>k</mi><mi>e</mi><mi>d</mi><mo>≤</mo><mi>r</mi><mi>w</mi><mi>n</mi><mi>d</mi></math></mjx-assistive-mml></mjx-container></div></div><p><span>便可保证发送的数据不超出接收方的接收缓存。</span></p><p><span>那接收方如何告知发送方自己的rwnd值呢？回忆到3.5.2节中TCP首部字段有接收窗口字段，通过该字段便可在返回ACK的时候，同时告诉发送方自己的rwnd值。</span></p><p><span>还有一个小问题。如果发送方得到rwnd是0的话，就不会给接收方发数据了。但是如果接收方此时也不给发送方发数据的话，发送方就永远不会知道接收缓存有没有空闲空间。因此，发送方需要继续发送只有一字节数据的报文段给接收方，接收方便可以在返回报文中告知发送方自己新的rwnd值。</span></p><p><span>最后提及UDP无流量控制。</span></p><h3 id='356-tcp连接管理'><span>3.5.6 TCP连接管理</span></h3><p><span>这里介绍</span><strong><span>三次握手（three-way handshake）</span></strong><span>和</span><strong><span>四次挥手</span></strong><span>。也就是TCP建立连接和断开连接的过程。</span><em><span>（书上没有提及四次挥手这个术语）</span></em></p><p><strong><span>1）三次握手</span></strong></p><ol start='' ><li><p><span>客户发送</span><strong><span>SYN报文段（SYN segment）</span></strong><span>。报文段首部中SYN=1，ACK=0，seq为随机初始化的值x，无数据部分。进入SYN-SENT状态。</span></p></li><li><p><span>服务器分配缓冲区和变量。返回</span><strong><span>SYNACK报文段（SYNACK segment）</span></strong><span>。首部SYN=1，ACK=1，seq为随机初始化值y，ack=x+1（ack是确认号字段，ACK是标志字段），无数据部分。进入SYN-RCVD状态</span></p></li><li><p><span>客户返回ACK=1，seq=x+1，ack=y+1。进入ESTABLISHED状态，服务器收到这个应答后也进入ESTABLISHED状态，此时连接的建立完成！这个报文段可以有数据部分。</span></p></li></ol><p><img src="./img/threewayHandshake.png" style="zoom:50%;" /></p><p><strong><span>2）四次挥手</span></strong></p><ol start='' ><li><p><span>若A认为数据发送完成，则它需要向B发送连接释放请求。该请求只有报文头，头中携带的主要参数为：</span>
<span>FIN=1，seq=u。此时，A将进入FIN-WAIT-1状态。</span></p></li><li><p><span>B收到连接释放请求后，会通知相应的应用程序，告诉它A向B这个方向的连接已经释放。此时B进入CLOSE-WAIT状态，并向A发送连接释放的应答，其报文头包含：ACK=1，seq=v，ack=u+1。</span>
<span>第二次挥手完成后，A到B方向的连接已经释放，B不会再接收数据，A也不会再发送数据。但B到A方向的连接仍然存在，B可以继续向A发送数据。</span></p></li><li><p><span>当B向A发完所有数据后，向A发送连接释放请求，请求头：FIN=1，ACK=1，seq=w，ack=u+1。B便进入LAST-ACK状态。</span></p></li><li><p><span>A收到释放请求后，向B发送确认应答，此时A进入TIME-WAIT状态。该状态会持续2MSL时间，若该时间段内没有B的重发请求的话，就进入CLOSED状态，释放内存。当B收到确认应答后，也便进入CLOSED状态，释放内存。</span></p></li></ol><p><img src="./img/fourwayWave.png" style="zoom:50%;" /></p><h2 id='36-阻塞控制原理'><span>3.6 阻塞控制原理</span></h2><h3 id='361-阻塞原因和代价'><span>3.6.1 阻塞原因和代价</span></h3><p><strong><span>原因</span></strong><span>有：分组太多，而带宽、速率、容量有限</span></p><p><strong><span>代价</span></strong><span>有：</span></p><ul><li><p><span>分组长时间排队等待</span></p></li><li><p><span>路由传送了不必要重传的分组（该分组其实到了，但是超时了）</span></p></li><li><p><span>当一个分组沿着一条路径被丢弃时，每个上游路由器用于转发该分组到丢弃该分组而使用的传输容量最终被浪费掉了</span></p></li></ul><h3 id='362-阻塞控制方法'><span>3.6.2 阻塞控制方法</span></h3><p><span>有两个方向：</span></p><ul><li><p><strong><span>端到端拥塞控制（end-to-end congestion control）</span></strong><span>：网络层并没有向传输层拥塞控制提供显式支持，即便网络中存在拥塞，端系统也必须通过对网络行为的观察（如分组丢失与时延）来判断</span></p></li><li><p><strong><span>网络辅助的拥塞控制（network-assisted congestion control）</span></strong><span>：网络层会向发送方提供关于网络中拥塞状态的显式反馈消息</span></p></li></ul><p><img src="./img/congestionfeedback.jpg" style="zoom:50%;" /></p><h2 id='37-tcp阻塞控制'><span>3.7 TCP阻塞控制</span></h2><p><span>TCP使用端到端的阻塞控制，这是因为IP协议并不会向端系统提供显式的网络拥塞反馈。TCP会根据网络阻塞情况动态调整其发送速率。这包含三个需要解决的问题：</span></p><ul><li><p><span>TCP发送方如何限制发送流量的速率？</span></p></li><li><p><span>TCP如何感知阻塞？</span></p></li><li><p><span>当感知到阻塞时，采用何种算法来改变发送速率？</span></p></li></ul><p><span>下面一一解决。</span></p><p><strong><span>如何限制发送速率</span></strong></p><p><span>在3.5.5节我们已经看到TCP使用了接收窗口来限制发送方的速率。类似的，我们可以引入</span><strong><span>阻塞窗口（congestion window）</span></strong><span>来进一步控制发送方的速率。阻塞窗口大小记作cwnd，则</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n1113" cid="n1113" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="52.529ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 23217.7 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-3-TEX-I-1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path><path id="MJX-3-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-3-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path><path id="MJX-3-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-3-TEX-I-1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path><path id="MJX-3-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-3-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-3-TEX-I-1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path><path id="MJX-3-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-3-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-3-TEX-I-1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path><path id="MJX-3-TEX-I-1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path><path id="MJX-3-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path><path id="MJX-3-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-3-TEX-N-2264" d="M674 636Q682 636 688 630T694 615T687 601Q686 600 417 472L151 346L399 228Q687 92 691 87Q694 81 694 76Q694 58 676 56H670L382 192Q92 329 90 331Q83 336 83 348Q84 359 96 365Q104 369 382 500T665 634Q669 636 674 636ZM84 -118Q84 -108 99 -98H678Q694 -104 694 -118Q694 -130 679 -138H98Q84 -131 84 -118Z"></path><path id="MJX-3-TEX-N-6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path id="MJX-3-TEX-N-69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z"></path><path id="MJX-3-TEX-N-6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path id="MJX-3-TEX-N-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path><path id="MJX-3-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-3-TEX-I-1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path><path id="MJX-3-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path id="MJX-3-TEX-N-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D43F" xlink:href="#MJX-3-TEX-I-1D43F"></use></g><g data-mml-node="mi" transform="translate(681,0)"><use data-c="1D44E" xlink:href="#MJX-3-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(1210,0)"><use data-c="1D460" xlink:href="#MJX-3-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(1679,0)"><use data-c="1D461" xlink:href="#MJX-3-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(2040,0)"><use data-c="1D435" xlink:href="#MJX-3-TEX-I-1D435"></use></g><g data-mml-node="mi" transform="translate(2799,0)"><use data-c="1D466" xlink:href="#MJX-3-TEX-I-1D466"></use></g><g data-mml-node="mi" transform="translate(3289,0)"><use data-c="1D461" xlink:href="#MJX-3-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(3650,0)"><use data-c="1D452" xlink:href="#MJX-3-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(4116,0)"><use data-c="1D446" xlink:href="#MJX-3-TEX-I-1D446"></use></g><g data-mml-node="mi" transform="translate(4761,0)"><use data-c="1D452" xlink:href="#MJX-3-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(5227,0)"><use data-c="1D45B" xlink:href="#MJX-3-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(5827,0)"><use data-c="1D461" xlink:href="#MJX-3-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(6410.2,0)"><use data-c="2212" xlink:href="#MJX-3-TEX-N-2212"></use></g><g data-mml-node="mi" transform="translate(7410.4,0)"><use data-c="1D43F" xlink:href="#MJX-3-TEX-I-1D43F"></use></g><g data-mml-node="mi" transform="translate(8091.4,0)"><use data-c="1D44E" xlink:href="#MJX-3-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(8620.4,0)"><use data-c="1D460" xlink:href="#MJX-3-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(9089.4,0)"><use data-c="1D461" xlink:href="#MJX-3-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(9450.4,0)"><use data-c="1D435" xlink:href="#MJX-3-TEX-I-1D435"></use></g><g data-mml-node="mi" transform="translate(10209.4,0)"><use data-c="1D466" xlink:href="#MJX-3-TEX-I-1D466"></use></g><g data-mml-node="mi" transform="translate(10699.4,0)"><use data-c="1D461" xlink:href="#MJX-3-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(11060.4,0)"><use data-c="1D452" xlink:href="#MJX-3-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(11526.4,0)"><use data-c="1D434" xlink:href="#MJX-3-TEX-I-1D434"></use></g><g data-mml-node="mi" transform="translate(12276.4,0)"><use data-c="1D450" xlink:href="#MJX-3-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(12709.4,0)"><use data-c="1D458" xlink:href="#MJX-3-TEX-I-1D458"></use></g><g data-mml-node="mi" transform="translate(13230.4,0)"><use data-c="1D452" xlink:href="#MJX-3-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(13696.4,0)"><use data-c="1D451" xlink:href="#MJX-3-TEX-I-1D451"></use></g><g data-mml-node="mo" transform="translate(14494.2,0)"><use data-c="2264" xlink:href="#MJX-3-TEX-N-2264"></use></g><g data-mml-node="mo" transform="translate(15550,0)"><use data-c="6D" xlink:href="#MJX-3-TEX-N-6D"></use><use data-c="69" xlink:href="#MJX-3-TEX-N-69" transform="translate(833,0)"></use><use data-c="6E" xlink:href="#MJX-3-TEX-N-6E" transform="translate(1111,0)"></use></g><g data-mml-node="mo" transform="translate(17217,0)"><use data-c="7B" xlink:href="#MJX-3-TEX-N-7B"></use></g><g data-mml-node="mi" transform="translate(17717,0)"><use data-c="1D45F" xlink:href="#MJX-3-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(18168,0)"><use data-c="1D464" xlink:href="#MJX-3-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(18884,0)"><use data-c="1D45B" xlink:href="#MJX-3-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(19484,0)"><use data-c="1D451" xlink:href="#MJX-3-TEX-I-1D451"></use></g><g data-mml-node="mo" transform="translate(20004,0)"><use data-c="2C" xlink:href="#MJX-3-TEX-N-2C"></use></g><g data-mml-node="mi" transform="translate(20448.7,0)"><use data-c="1D450" xlink:href="#MJX-3-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(20881.7,0)"><use data-c="1D464" xlink:href="#MJX-3-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(21597.7,0)"><use data-c="1D45B" xlink:href="#MJX-3-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(22197.7,0)"><use data-c="1D451" xlink:href="#MJX-3-TEX-I-1D451"></use></g><g data-mml-node="mo" transform="translate(22717.7,0)"><use data-c="7D" xlink:href="#MJX-3-TEX-N-7D"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>L</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>B</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>S</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo>−</mo><mi>L</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>B</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>A</mi><mi>c</mi><mi>k</mi><mi>e</mi><mi>d</mi><mo>≤</mo><mo data-mjx-texclass="OP" movablelimits="true">min</mo><mo fence="false" stretchy="false">{</mo><mi>r</mi><mi>w</mi><mi>n</mi><mi>d</mi><mo>,</mo><mi>c</mi><mi>w</mi><mi>n</mi><mi>d</mi><mo fence="false" stretchy="false">}</mo></math></mjx-assistive-mml></mjx-container></div></div><p><strong><span>如何感知阻塞</span></strong></p><p><span>一方面丢包（即超时或三个冗余ACK）表明了网络阻塞；另一方面无丢包的话，那说明网络还挺通畅，我们便可以增大阻塞窗口的大小，从而提高发送速率。进一步讲，如果达到ACK很快，那我可以较快地增加阻塞窗口大小；如果ACK以相当慢的速率到达，那我缓慢增加窗口大小。这也称作</span><strong><span>自计时（self-clocking）</span></strong><span>的。</span></p><p><strong><span>何种算法改变发送速率</span></strong></p><p><strong><span>TCP阻塞控制算法（TCP congestion control algorithm）</span></strong><span>包含三个部分：</span></p><ul><li><p><strong><span>慢启动（slow-start）</span></strong><span>：刚开始时，cwnd常设置为一个MSS（最大报文段长度）。每收到一个ACK，cwnd就增加一个MSS。可见，在慢启动阶段，发送速率是指数增加的，且收到ACK越快，窗口增大的也越快。如图：</span></p><p><img src="./img/slowstart.jpg" style="zoom:50%;" /></p><p><span>何时结束指数增长呢？有三种情况：</span></p><ul><li><p><span>超时：设置变量ssthresh（slow start threshold）为当前cwnd的一半，并设置cwnd为1个MSS，重传</span></p></li><li><p><span>cwnd到达ssthresh：进入阻塞避免状态</span></p></li><li><p><span>三个冗余ACK：做快速重传（3.5.4节），进入快速恢复状态</span></p></li></ul></li><li><p><strong><span>阻塞避免（congestion avoidance）</span></strong><span>：一旦进入拥塞避免状态，cwnd的值大约是上次遇到拥塞时的一半。TCP在每个RTT中，cwnd只增加一个1个MSS大小。也就是说在拥塞避免阶段，cwnd是线性增加的。</span></p><p><span>合适结束线性增加呢？有两个情况：</span></p><ul><li><p><span>超时：设置变量ssthresh为当前cwnd的一半，并设置cwnd为1个MSS，重传，进入慢启动状态</span></p></li><li><p><span>三个冗余ACK：cwnd减半加三（adding in 3 MSS for good measure to account for the triple duplicate ACKs received）然后将ssthresh置为cwnd值的一半，快速重传，并且进入快速恢复状态。</span></p></li></ul></li><li><p><strong><span>快速恢复（fast recovery）</span></strong><span>：对于引起TCP进入该状态的缺失报文段，每收到一个ACK，cwnd增加一个MSS；当丢失报文的ACK到达时，cwnd设置为ssthresh，并进入阻塞避免状态；当超时时，和慢启动阻塞避免的处理方式一致。快速恢复时TCP推荐但是非必须的构件。</span></p></li></ul><p><span>上述算法可以用FSM图表示：</span></p><p><img src="./img/congestionFSM.jpg" style="zoom:50%;" /></p><p><span>TCP Tahoe和TCP Reno是两个版本。Tahoe没有快速恢复，在三个冗余ACK时也会将窗口设置为1。而Reno有快速恢复状态。</span></p><p><img src="./img/tahoeReno.jpg" style="zoom:50%;" /></p><p><em><span>书上后面又细细碎碎讨论了一点点内容，但是我觉得不那么重要了</span></em></p><hr /><p>&nbsp;</p><h1 id='四网络层数据平面'><span>四、网络层：数据平面</span></h1><p><span>本章探讨网络层的数据平面。我们先会概述网络层，介绍数据平面和控制平面分别关心什么问题；然后深入路由器内部，研究其工作原理；接下来学习传统的基于目的IP地址的转发，并学习IPv4和IPv6；最后学习更一般的基于多个首部值的转发，并探讨SDN。</span></p><h2 id='41-网络层概述'><span>4.1 网络层概述</span></h2><h3 id='411-转发和路由选择数据平面和控制平面'><span>4.1.1 转发和路由选择：数据平面和控制平面</span></h3><p><span>我们知道网络层实现了主机之间的通信（而运输层是进程之间的通信）。具体来说：</span></p><ul><li><p><span>发送方：将传输层的</span><strong><span>报文段（segment）</span></strong><span>封装成</span><strong><span>数据报（datagram）</span></strong><span>，并发送到相邻的路由</span></p></li><li><p><span>接收方：从相邻路由获取数据报，取出其中的报文段，并传给传输层</span></p></li></ul><p><span>在端系统和路由器之中都有网络层。而网络层可以进一步分成两个平面：</span></p><ul><li><p><strong><span>数据平面（data plane）</span></strong><span>：路由器根据</span><strong><span>转发表（forwarding table）</span></strong><span>将输入链路的数据报</span><strong><span>转发（forwarding）</span></strong><span>到输出链路</span></p></li><li><p><strong><span>控制平面（control plane）</span></strong><span>：根据</span><strong><span>路由选择算法（routing algorithm）</span></strong><span>，计算数据报采用的路径，设置转发表，使得数据报能够实现端对端传输。</span><em><span>详见下文控制平面的两个设计思路</span></em></p></li></ul><p><span>再明确一下转发和路由选择的术语：</span></p><ul><li><p><strong><span>转发（forwarding）</span></strong><span>：将分组从一个输入链路转移到适当的输出链路，是路由器的本地动作。时间短（几纳秒），硬件实现。位于数据平面中。</span></p></li><li><p><strong><span>路由选择（routing）</span></strong><span>：the network-wide process that determines the end-to-end paths that packets take from source to destination. 时间长（几秒），软件实现。位于控制平面中。</span></p></li></ul><p><span>控制平面有如下两个设计思路：</span></p><ul><li><p><strong><span>传统方法（traditional approach）</span></strong><span>：路由选择算法位于路由器中，为此不同路由器的路由选择算法之间需要交换信息，具体在下一章讨论。如图：</span></p><p><img src="./img/controlPlaneTra.jpg" style="zoom: 33%;" /></p></li><li><p><strong><span>SDN方法（SDN approach）</span></strong><span>：有一个远程控制器负责计算路由转发表并分发给路由，此时路由选择算法不在路由器中。由于该控制器是由软件实现的，所以称这种网络是</span><strong><span>软件定义网络（software-defined network, SDN）</span></strong><span>。具体也在下一章讨论。示意图如下：</span></p><p><img src="./img/controlPlaneSDN.jpg" style="zoom:33%;" /></p></li></ul><h3 id='412-网络服务模型'><span>4.1.2 网络服务模型</span></h3><p><strong><span>网络层服务模型（network service model）</span></strong><span>定义了端对端运输特性：</span></p><ul><li><p><strong><span>确保交付</span></strong></p></li><li><p><span>具</span><strong><span>有时延上界</span></strong><span>的确保交付</span></p></li><li><p><strong><span>按序</span></strong><span>分组交付</span></p></li><li><p><span>确保</span><strong><span>最小带宽</span></strong></p></li><li><p><strong><span>安全性</span></strong><span>：加密数据报</span></p></li></ul><p><span>然而，因特网网络层IP协议只提供</span><strong><span>尽力而为服务（best-effort service）</span></strong><span>——无最小带宽保证、无交付保证、无顺序保证、无时延上界保证。就是无服务的委婉说法罢了。</span></p><p><span>最后提及，</span><strong><span>交换（switching）</span></strong><span>和</span><strong><span>转发（forwarding）</span></strong><span>是一个意思。</span><strong><span>分组交换机（packet switch）</span></strong><span>是一个广泛的名字，在因特网中：</span></p><ul><li><p><strong><span>链路层交换机（link-layer switch）</span></strong><span>：基于链路层帧相关字段转发</span></p></li><li><p><strong><span>路由器（router）</span></strong><span>：基于数据报首部字段转发</span></p></li></ul><p><span>由于本章讨论网络层，所以使用路由器这个名字。</span></p><h2 id='42-路由器工作原理'><span>4.2 路由器工作原理</span></h2><p><span>路由器体系结构如图：</span></p><p><img src="./img/routerArch.jpg" style="zoom:50%;" /></p><p><span>路由器的输入端口、输出端口和交换结构几乎总是用硬件实现，以满足高速率。而路由选择等控制平面功能由处理器上的软件实现。</span></p><p><span>在本章开头已提及，转发包含：</span></p><ul><li><p><span>基于目的IP地址转发</span></p></li><li><p><span>通用转发：基于多个首部值</span></p></li></ul><p><span>而目前我们只讨论基于目的地转发，通用转发在4.4节讨论。</span></p><p><span>下面逐一研究路由器的相关组件。</span></p><h3 id='421-输入端口处理和基于目的地转发'><span>4.2.1 输入端口处理和基于目的地转发</span></h3><p><span>输入端口处理如图：</span></p><p><img src="./img/inputPortProcessing.jpg" style="zoom:50%;" /></p><p><span>其中</span><strong><span>线路端接（link termination）</span></strong><span>和</span><strong><span>数据链路处理（data link processing）</span></strong><span>实现了物理层和链路层，我们目前不关心。现在关心最后一个“查找，转发，排队”框。在这里路由器使用转发表查找输出端口，使到达的分组能经过交换结构转发到该输出端口。注意到，每个入链路都有一个</span><strong><span>线路卡（line card）</span></strong><span>，存储了转发表的副本，转发决策可以在输入端口本地做出。而这些转发表的副本要么是由路由选择处理器分发的，要么是由SDN的远程控制器分发的。</span></p><p><span>查找转发表，路由器通常使用</span><strong><span>最长前缀匹配规则（longest prefix matching rule）</span></strong><span>——在表中寻找最长的匹配项，并向与最长前缀匹配相关联的链路接口转发分组，可以避免有多个匹配的情况。我们来看一个简单的转发表例子：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 35.9809px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -27.9948px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">前缀匹配<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>链路接口</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">11001000 00010111 00010<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>0</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">11001000 00010111 00011000<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span>1</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">11001000 00010111 00011<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>2</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -27.9948px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">otherwise<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>3</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="height: 115px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>当找到输出端口后，便把该分组发送到交换结构。有的交换结构设计至多只能由一个分组使用，所以可能产生阻塞的分组，需要在输入端口处排队。</span></p><p><span>这种查找目的IP地址（“匹配”）、然后发送分组进入交换结构（“动作”）的步骤，被称为</span><strong><span>“匹配加动作”（&quot;match plus action&quot;）</span></strong><span>。</span></p><h3 id='422-交换'><span>4.2.2 交换</span></h3><p><span>我们来看三种交换结构的设计：</span></p><p><img src="./img/switchingTech.jpg" style="zoom:50%;" /></p><ul><li><p><strong><span>经内存交换</span></strong><span>：一个分组到达输入端口时，该端口会产生中断。接着，分组会被复制到内存中。再从首部提取目的地址，查找输出端口，并将分组复制到输出端口的缓存中。不能同时转发两个分组，因为共享系统总线一次只能执行一次内存读/写。需要路由选择处理器或者输入线路卡处理。</span></p></li><li><p><strong><span>经总线交换</span></strong><span>：输入端口经一根共享总线将分组直接传送到输出端口，无需路由选择处理器的干预。由于只有一根总线，所以不能同时转发两个分组。</span></p></li><li><p><strong><span>经互联网络交换</span></strong><span>：纵横式（crossbar）网络能并行转发多个分组，实现非阻塞的转发。</span></p></li></ul><p><em><span>感觉书上这块并没有讲的很清楚，反正意会即可</span></em></p><h3 id='423-输出端口处理'><span>4.2.3 输出端口处理</span></h3><p><span>一图以蔽之：</span></p><p><img src="./img/outputPortProcessing.jpg" style="zoom:50%;" /></p><h3 id='424-何处出现排队'><span>4.2.4 何处出现排队</span></h3><p><strong><span>1）输入排队</span></strong></p><p><span>如果交换结构不够快，那么输入端口可能产生排队。假设我们采用FCFS方式处理输入队列，那么可能排在队伍后面的分组，即便它的目的端口没有竞争，它也要等前面的分组传完，才可以传送。这称为</span><strong><span>线路前部阻塞（head-of-the-line, HOL）</span></strong><span>。</span></p><p><strong><span>2）输出排队</span></strong></p><p><span>如果输出链路传送速率不够快，那么输出端口可能会产生排队。当没有足够内存来缓存一个分组时，就必须做出决定：</span></p><ul><li><p><strong><span>弃尾（drop-tail）</span></strong><span>：丢弃到达的分组</span></p></li><li><p><span>删去一个或多个已经排队的分组</span></p></li></ul><p><span>某些情况下，在缓存填满前便丢弃一个分组（或在首部加上标记）的做法时有利的，这可以向发送方提供一个拥塞信号。相关策略称为主动队列管理（active queue management, AQM），其中随机早期检测（random early detection, RED）最为广泛研究。</span></p><h3 id='425-分组调度'><span>4.2.5 分组调度</span></h3><p><span>一个队列先出队哪一个呢？这个问题已经在操作系统整理中进程调度详细讨论了。这里给出本书的几个做法：</span></p><ul><li><p><span>FCFS</span></p></li><li><p><span>优先级队列。非抢占式的</span></p></li><li><p><span>round robin：给分组分类，先传一个1组的，再传一个2组的，再传一个1组的，如此往复。</span></p></li><li><p><span>weighted fair queuing，WFQ：同样给分组分类，并给它们赋予不同的权重。权重大的类得到更长的服务时间。其实是带权重的round robin。</span></p></li></ul><h2 id='43-网际协议ipv4寻址ipv6及其他'><span>4.3 网际协议：IPv4、寻址、IPv6及其他</span></h2><p><span>本节讨论</span><strong><span>网际协议（Internet Protocol，IP）</span></strong><span>相关内容。</span></p><h3 id='431-ipv4数据报格式'><span>4.3.1 IPv4数据报格式</span></h3><p><span>IPv4数据报格式如图：</span></p><p><img src="./img/IPv4format.jpg" style="zoom:50%;" /></p><p><span>关键字段如下：</span></p><ul><li><p><strong><span>版本号</span></strong><span>：4比特，告诉路由器如何解释数据报的剩余部分。</span></p></li><li><p><strong><span>首部长度</span></strong><span>：因为可能有选项字段，所以要有首部长度。无选项字段的数据报首部20字节。</span></p></li><li><p><strong><span>服务类型（TOS）</span></strong><span>：路由器可以通过服务类型字段来提供不同的服务。目前大多情况下并不处理TOS字段。</span></p></li><li><p><strong><span>数据报长度</span></strong><span>：首部加上数据的总长度。</span></p></li><li><p><strong><span>标识（identifier）、标志（flag）、片偏移</span></strong><span>：和</span><strong><span>IP分片（IP fragmentation）</span></strong><span>有关，下一节讨论</span></p></li><li><p><strong><span>寿命（time-to-live，TTL）</span></strong><span>：当一台路由器处理数据报时，该字段的值减一。若TTL字段减为0，则需要丢弃。这可以避免数据报在网络里永远循环。</span></p></li><li><p><strong><span>上层协议</span></strong><span>：表明运输层协议。6表示为TCP，17表示UDP。</span></p></li><li><p><strong><span>首部检验和</span></strong><span>：只对首部中每两个字节进行检验和。</span></p></li><li><p><strong><span>源和目的IP地址</span></strong></p></li><li><p><strong><span>选项</span></strong><span>：允许IP首部被扩展。很少使用</span></p></li><li><p><strong><span>数据</span></strong><span>：运输层报文段或其他类型的数据</span></p></li></ul><h3 id='432-ipv4数据报分片'><span>4.3.2 IPv4数据报分片</span></h3><p><span>由于不同的链路层帧能承载的最大数据量</span><strong><span>MTU（maximum transmission unit）</span></strong><span>不同，IP数据报可能产生过大的情况，这时候就需要进行数据报</span><strong><span>分片（fragmentation）</span></strong><span>。每个小数据报称为</span><strong><span>片（fragment）</span></strong><span>。</span></p><p><span>分片的数据报将在端系统进行组装，将使用IPv4首部的</span><strong><span>标识、标志、片偏移</span></strong><span>字段。</span></p><ul><li><p><span>标识：当生成一个数据报时，发送主机会设置标识号。每发一个数据报就把标识号加一。分片的数据报具有相同的标识。</span></p></li><li><p><span>标志：标志该数据报是最后一个片</span></p></li><li><p><span>片偏移：指定该片应该放在初始IP数据报的哪个位置</span></p></li></ul><h3 id='433-ipv4编址'><span>4.3.3 IPv4编址</span></h3><p><span>主机与物理链路之间的边界称为</span><strong><span>接口（interface）</span></strong><span>，路由器与它任意一条链路之间的边界也称为接口。一个IP地址与一个接口相关联，而不是与包括该接口的主机或者路由器相关联。</span></p><p><span>每个IPv4地址长度为32比特，通常采用</span><strong><span>点分十进制记法（dotted-decimal notation）</span></strong><span>书写，即每个字节用它的十进制形式书写。如</span><code>193.32.216.9</code><span>，相应的二进制记法是</span><code>11000001 00100000 11011000 00001001</code><span>.</span></p><p><span>一个接口的IP地址一部分需要由其连接的</span><strong><span>子网（subnet）</span></strong><span>来确定。考虑下图左，可以看到有三个子网，每个子网里不同IP地址具有相同的高位地址；考虑下图右，可以看到IP编址给子网分配了一个地址223.1.1.0/24，其中</span><code>255.255.255.0</code><span>称为</span><strong><span>子网掩码（network mask）</span></strong><span>，表明最高24位（称为</span><strong><span>前缀prefix</span></strong><span>）定义了子网地址，而剩下的8位区分了子网内部的设备。</span><em><span>（图中灰灰的一块表明该网络是无路由器的）</span></em></p><p><img src="./img/subnet.jpg" style="zoom: 50%;" /></p><p><span>子网的定义是：</span></p><blockquote><p><span>To determine the subnets, detach each interface from its host or router, creating islands of isolated networks, with interfaces terminating the end points of the isolated networks. Each of theses isolated networks is called a </span><strong><span>subnet</span></strong><span>.</span></p></blockquote><p><span>譬如下图中，一共有六个子网。</span></p><p><img src="./img/subnetDef.jpg" style="zoom: 33%;" /></p><p><span>因特网的地址分配策略称为</span><strong><span>无类别域间路由选择（classless interdomain routing, CIDR）</span></strong><span>。也就是网络前缀x位的大小是不限的。在CIDPR被采用前，前缀大小被限制位8，16或24比特，这称为</span><strong><span>分类编址（classful addressing）</span></strong><span>方案。相应的子网称为A、B和C类子网。这种分配的子网支持的主机数要么太大（B类支持65534台），要么太小（C类支持254台主机）。</span></p><p><span>此外，255.255.255.255是IP广播地址，报文会交付给同一个子网中的所有主机。</span></p><p><span>现在我们研究主机和子网都是怎么得到它的IP地址的。</span></p><p><strong><span>1）子网获取地址</span></strong></p><p><span>子网的网络管理员从他的ISP那里获得一块地址，而ISP自己也要从</span><strong><span>因特网名字和编号分配机构（Internet Corporation for Assigned Names and Numbers, ICANN）</span></strong><span>这个全球性的权威机构获取地址。ISP给组织分配地址块的示例如下：</span></p><p><img src="./img/subnetGetAddr.jpg" style="zoom:33%;" /></p><p><strong><span>2）主机获取地址</span></strong></p><p><span>第一种获取地址的方法是</span><strong><span>手动配置</span></strong><span>。也就是系统管理员手动配置本组织内所有主机和路由器的IP地址、子网掩码、默认网关（应该就是第一跳路由器，家庭的话一般就是192.168.1.1样子）和本地DNS服务器地址等信息。而更常见的做法是采用</span><strong><span>动态主机配置协议（Dynamic Host Configuration Protocol, DHCP）</span></strong><span>实现主机自动获取（被分配）上述需要管理员手动配置的信息（IP地址、子网掩码、默认网关和本地DNS服务器地址）。</span></p><p><span>下面是我家华为路由A2的例子：</span></p><p><img src="./img/getIP.jpg" style="zoom:50%;" /></p><p><span>接下来我们来看DHCP的实现。DHCP是一个客户-服务器协议。客户是新到达的主机，服务器是DHCP服务器。如果子网里没有服务器，就需要有一个路由器来做DHCP中继代理（relay agent）。下图中，可以看到两个子网使用了提供中继代理服务的路由器，一个子网有DHCP服务器。</span></p><p><img src="./img/DHCP1.jpg" style="zoom: 33%;" /></p><p><span>一个新到达的主机通过以下四步从DHCP服务器那里得到配置。</span></p><p><img src="./img/DHCP2.jpg" style="zoom:33%;" /></p><ul><li><p><strong><span>DHCP server discovery</span></strong><span>：客户用UDP报文段分装了</span><strong><span>DHCP发现报文（DHCP discover message）</span></strong><span>，并发到广播地址255.255.255.255的67号端口。本机源IP地址使用0.0.0.0，端口号应该是随意的。</span></p></li><li><p><strong><span>DHCP server offer</span></strong><span>：DHCP服务器收到一个DHCP发现报文时，用</span><strong><span>DHCP提供报文（DHCP offer message）</span></strong><span>向用户做出相应。该报文目的地址仍使用广播地址255.255.255.255，使用和DHCP发现报文一致的事务ID，包含向客户推荐的IP地址</span><code>yiaddr</code><span>、子网掩码和IP</span><strong><span>地址租用期（address lease time）</span></strong><span>——即该IP地址有效的时间量。</span></p></li><li><p><strong><span>DHCP request</span></strong><span>：新到达的客户从一个或多个服务器中选择一个，并向选中的服务器发送</span><strong><span>DHCP请求报文（DHCP request message）</span></strong><span>，回显配置的参数。</span></p></li><li><p><strong><span>DHCP ACK</span></strong><span>：服务器用</span><strong><span>DHCP ACK报文（DHCP ACK message）</span></strong><span>对DHCP请求报文进行响应，正式所要求的参数。</span></p></li></ul><p><span>一旦客户收到了DHCP ACK后，交互便完成了。用户就可以在租用期内使用该IP地址。</span></p><p><span>可以看到DHCP有一个特点：每当节点连到一个新子网（譬如从宿舍到图书馆），就会从DHCP那里得到一个新的IP地址。这就会导致一个移动节点在子网之间移动时，就不能维持与远程应用之间的TCP连接。</span></p><h3 id='434-网络地址转换nat）'><span>4.3.4 网络地址转换（NAT）</span></h3><p><strong><span>网络地址转换（Network Address Translation, NAT）</span></strong><span>也是一种被广泛使用的技术，使IPv4地址不容易被耗尽。它能创建家庭网络等</span><strong><span>专用网络（private network）</span></strong><span>，也就是我们更常说的</span><strong><span>内网</span></strong><span>。</span></p><p><span>下图中，右半部分的10.0.0.0/24地址就是内网的地址，它只在给定的网络中才有意义，全球数十万的网络都在使用这块地址。NAT路由器维护了一个NAT转换表，把对应LAN端的地址加端口号映射到WAN端的地址和端口号。而这个WAN端的IP地址又是路由器从ISP的DHCP服务器得到的。可见，NAT路由器对外界的行为就如同一个单一IP地址的单一设备。</span></p><p><img src="./img/NAT.jpg" style="zoom:50%;" /></p><p><span>可能注意到，只能内网里的主机向公网服务器建立TCP连接。这是因为当我内网主机断开该TCP连接时，NAT转换表相关条目也将被清除，外面的主机就不可能通过映射后的WAN端IP地址加端口号访问该主机。那解决方法也很简单，就是在路由器中设置端口映射，也就是设置一个NAT转换表里的永久条目。下图是我家华为路由器A2的例子：</span></p><p><img src="./img/NATservice.jpg" style="zoom: 67%;" /></p><p><span>似乎这样就可以让外面的主机访问我内网的主机了（这个行为称为</span><strong><span>内网穿透</span></strong><span>，或者说是</span><strong><span>NAT穿透traversal</span></strong><span>）。然而并非如此。上述方案可行的前提条件是路由器的WAN端口是公网IP地址，事实上在我国家庭路由器WAN端口仍然是内网IP地址。家庭路由可能接在小区路由，而这个小区路由的WAN端口才可能是一个公网IP地址。这就出现套娃了。我们没有权利设置家庭路由器之外的路由器，所以通过设置端口映射是无法做到内网穿透的。而做内网穿透需要第三方具有公网IP的服务器介入，客户端和服务端都通过这个服务器进行通信。</span></p><h3 id='435-ipv6'><span>4.3.5 IPv6</span></h3><p><span>IPv6开发的首要动机是：IPv4的32位地址可能被用尽。IPv6使用128比特的地址，且在运行IPv4的经验基础上改进了IPv4的其他方面。</span></p><p><strong><span>1）IPv6数据报格式</span></strong></p><p><img src="./img/IPv6format.jpg" style="zoom:50%;" /></p><ul><li><p><strong><span>版本</span></strong><span>：4比特，值为6</span></p></li><li><p><strong><span>流量类型</span></strong><span>：8比特，和IPv4首部的</span><strong><span>服务类型（TOS）</span></strong><span>含义一致</span></p></li><li><p><strong><span>流标签</span></strong><span>：20比特。该字段用于&quot;labeling of packets belonging to particular flows for which the sender requests special handling, such as a non-default quality of service or real-time service&quot;. 所以音频与视频传输可以被当作一个流，而传统的文件传输和电子邮件就不会被当作流。高优先级用户（氪金用户）产生的流量也有可能当作一个流。</span></p></li><li><p><strong><span>有效载荷长度</span></strong><span>：16比特无符号整数，给出了数据字段的长度</span></p></li><li><p><strong><span>下一个首部</span></strong><span>：即IPv4首部的</span><strong><span>上层协议</span></strong><span>字段，标识数据字段需要交付给哪个协议</span></p></li><li><p><strong><span>跳限制（hop limit）</span></strong><span>：即IPv4首部的</span><strong><span>寿命（time-to-live，TTL）</span></strong><span>字段，每次处理就减一，减到0就丢弃</span></p></li><li><p><strong><span>源地址</span></strong><span>、</span><strong><span>目标地址</span></strong><span>、</span><strong><span>数据</span></strong></p></li></ul><p><span>注意到，IPv4以下字段在IPv6中不复存在：</span></p><ul><li><p><strong><span>分片/重新组装</span></strong><span>：IPv6不再允许在中间路由器进行分片与重新组装，大大加快网络中的IP转发速度。对于那些太大的数据报，路由器只需丢掉该数据报，并向发送方返回一个“分组太大”的ICMP差错报文（5.6节）。</span></p></li><li><p><strong><span>首部检验和</span></strong><span>：反正运输层的TCP/UDP和链路层的以太网都有检验操作，那网络层就不检验了吧。而且IPv4报文段的TTL是改变的，路由器还要重新计算IPv4首部检验和，十分耗时</span></p></li><li><p><strong><span>选项</span></strong><span>：可以通过IPv6的下一个首部字段实现，删去选项字段使IPv6数据报的首部成为定长。</span></p></li></ul><p><strong><span>2）IPv4到IPv6的迁移</span></strong></p><p><span>虽然新部署的IPv6设备可以支持收发IPv4数据报，但是旧的IPv4设备是无法处理IPv6数据报的。那如何让IPv4设备发IPv6数据报呢？</span><strong><span>隧道（tunnel）</span></strong><span>是一个简单粗暴的做法，也就是把整个IPv6数据报塞到IPv4数据报的数据字段，并把协议号字段设置为41，来告知路由该IPv4数据报里面塞了一个IPv6数据报。示例图如下：</span></p><p><img src="./img/tunneling.jpg" style="zoom: 50%;" /></p><h2 id='44-通用转发和sdn'><span>4.4 通用转发和SDN</span></h2><p><span>之前我们讨论的是传统意义上的转发，是基于IP地址的。同时我们也看到有一些</span><strong><span>中间盒（middlebox）</span></strong><span>来实现一些功能。譬如NAT中间盒可以重写IP地址和端口号、防火墙可以基于首部字段值阻拦流量或重定向分组，等等。大量链路层和网络层中间盒的管理，给网络操作员平添许多麻烦。而近期，</span><strong><span>软件定义网络SDN</span></strong><span>正在给出一种简洁现代的方法，来提供许多网络层和链路层功能。</span></p><p><span>我们已经在4.2.1节提及了</span><strong><span>匹配加动作</span></strong><span>的概念。对于通用转发，匹配加动作有更广泛的含义：</span></p><ul><li><p><strong><span>匹配</span></strong><span>：对协议栈的多个首部字段进行匹配</span></p><p><img src="./img/openflowmatch.jpg" style="zoom:50%;" /></p></li><li><p><strong><span>动作</span></strong><span>：将分组转发到一个或多个端口、重写首部值、阻挡/丢弃某个分组等等</span></p></li></ul><p><span>采用通用转发的SDN示意图如下：</span></p><p><img src="./img/generalForward.jpg" style="zoom: 33%;" /></p><p><span>本章我们基于OpenFlow来介绍通用转发。匹配加动作转发表在OpenFlow中称为</span><strong><span>流表（flow table）</span></strong><span>，每个表项包括：</span></p><ul><li><p><strong><span>首部字段值集合</span></strong><span>：入分组将与之匹配</span></p></li><li><p><strong><span>计数器集合</span></strong><span>：当分组与该表项匹配时，计数器会更新。包括上次更新的时间，和与之匹配的分组数量。</span></p></li><li><p><strong><span>动作集合</span></strong><span>：匹配时会采取的动作</span></p></li></ul><p><span>最后书上给了几个流表的例子，这里也就不放了。只是想说，我用软件来配置这些流表，从而控制路由器的动作，进而更容易地实现了许多网络的功能。在下一章中我们会对SDN的控制有更多讨论。</span></p><hr /><p>&nbsp;</p><h1 id='五网络层控制平面'><span>五、网络层：控制平面</span></h1><p><span>本章探讨网络层的控制平面。我们先会复习第四章中讨论的控制平面相关内容；然后研究LS和DV两种路由选择算法；再看看因特网路由选择协议OSPF和BGP；接着讨论SDN控制器的实现；最后涉及管理IP网络的具体细节：ICMP和SNMP。</span></p><h2 id='51-概述'><span>5.1 概述</span></h2><p><span>正如第四章所讨论的那样，网络层的控制平面关心转发表和流表的计算、维护和安装。并且已经知道了两种实现方法：</span></p><ul><li><p><strong><span>Per-router control</span></strong><span>：每台路由器都各自运行路由选择算法，并且有一个路由选择组件与其他路由器的路由选择组件通信，以计算转发表的值。目前广泛使用，如OSPF和BGP。</span></p><p><img src="./img/per-router.jpg" style="zoom:50%;" /></p></li><li><p><strong><span>Logically centralized control</span></strong><span>：</span><strong><span>逻辑集中式控制器（logically centralized controller）</span></strong><span>计算并分发转发表以供路由器使用。该控制器和路由器中的</span><strong><span>控制代理（control agent, CA）</span></strong><span>交互。CA具有很少功能，只负责与控制器通信并按控制器命令行事。所谓“逻辑集中式”是指控制器好似单一的集中服务点，即使可能由多个服务器实现。</span></p><p><img src="./img/CA.jpg" style="zoom:50%;" /></p></li></ul><h2 id='52-路由选择算法'><span>5.2 路由选择算法</span></h2><p><span>可以将网络结构看成无向有权图</span><em><span>（后文中链路和边混用、边权和链路开销混用）</span></em><span>。</span></p><p><span>根据不同标准可以把</span><strong><span>路由选择算法（routing algorithm）</span></strong><span>分类。</span></p><ul><li><p><strong><span>集中式（centralized）</span></strong><span>：节点使用全局的网络知识（网络拓扑和链路开销）计算出源到目的地的最小开销路径。如LS算法（5.2.1节）</span></p></li><li><p><strong><span>分散式（decentralized）</span></strong><span>：节点只知道邻边边权，以及邻点的相关信息。路由器使用迭代、分布式的方法计算出最低开销路径。如DV算法（5.2.2节）</span></p></li></ul><p><span>或者</span></p><ul><li><p><strong><span>静态（static）</span></strong><span>：路径随时间变化很缓慢，变化通常是由于人工干涉（人为编辑链路开销）</span></p></li><li><p><strong><span>动态（dynamic）</span></strong><span>：随着链路流量负载或拓扑结构发生变化，将动态改变路径</span></p></li></ul><p><span>再或者</span></p><ul><li><p><strong><span>负载敏感（load-sensitive）</span></strong><span>：边权动态反映链路当前的拥塞水平</span></p></li><li><p><strong><span>负载迟钝（load-insensitive）</span></strong><span>：边权不明确地反映链路当前或最近的拥塞水平</span></p></li></ul><p><span>接下来介绍LS和DV算法。</span></p><h3 id='521-the-link-state-ls-routing-algorithm'><span>5.2.1 The Link-State (LS) Routing Algorithm</span></h3><p><span>在LS中，网络拓扑和链路开销都是已知的，这是通过让每个节点向网络中其他节点广播链路状态分组实现的。所谓的</span><strong><span>链路状态（link state）</span></strong><span>就是指链路的标识和开销。相关算法称为</span><strong><span>链路状态广播（link state broadcast）</span></strong><span>算法。</span></p><p><span>我们只需知道此时每个节点知道整个网络的样子。于是这个问题就是求最短路径。那么LS算法其实就是</span><strong><span>Dijkstra算法</span></strong><span>。通过Dijkstra算法我们可以在O(n</span><sup><span>2</span></sup><span>)时间内算出源节点到所有其他节点的最短路径。当然使用堆可以进一步降低时间复杂度。关于Dijkstra算法这里不再展开，算法课已经学过。</span></p><p><span>最后，我们讨论动态算法带来的</span><strong><span>振荡（oscillation）</span></strong><span>问题。现在假设边权就是链路上承载的负载，x、y、z分别要发送1、e、1个数据给w，初始路由选择如a）所示。接下来每一时刻，x、y、z都会检测有没有更好的路径，分别如图b）、c）、d）所示。可以看到路径在顺时针和逆时针中振荡。解决办法是每个路由随机一段时间再执行路由选择算法。</span><em><span>（图中的箭头有点糊，但是依稀可辨）</span></em></p><p><img src="./img/oscillation.jpg" style="zoom: 67%;" /></p><h3 id='522-the-distance-vector-dv-routing-algorithm'><span>5.2.2 The Distance-Vector (DV) Routing Algorithm</span></h3><p><span>DV算法特点</span></p><ul><li><p><strong><span>分布式</span></strong><span>：节点从邻居接收信息，执行计算，再把结果分发给邻居</span></p></li><li><p><strong><span>迭代</span></strong><span>：上述过程一直持续到邻居之间无更多信息需要交换</span></p></li><li><p><strong><span>异步</span></strong><span>：节点无需同步进行计算更新等操作</span></p></li></ul><p><span>DV算法的关键是</span><strong><span>Bellman-Ford</span></strong><span>方程：</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n1434" cid="n1434" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="28.111ex" height="3.298ex" role="img" focusable="false" viewBox="0 -750 12425.1 1457.8" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -1.601ex;"><defs><path id="MJX-4-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-4-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path id="MJX-4-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-4-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-4-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-4-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-4-TEX-N-6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path id="MJX-4-TEX-N-69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z"></path><path id="MJX-4-TEX-N-6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path id="MJX-4-TEX-I-1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path><path id="MJX-4-TEX-N-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path><path id="MJX-4-TEX-I-1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path><path id="MJX-4-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path id="MJX-4-TEX-N-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path id="MJX-4-TEX-N-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-4-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(553,-150) scale(0.707)"><use data-c="1D465" xlink:href="#MJX-4-TEX-I-1D465"></use></g></g><g data-mml-node="mo" transform="translate(1007.5,0)"><use data-c="28" xlink:href="#MJX-4-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1396.5,0)"><use data-c="1D466" xlink:href="#MJX-4-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(1886.5,0)"><use data-c="29" xlink:href="#MJX-4-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(2553.2,0)"><use data-c="3D" xlink:href="#MJX-4-TEX-N-3D"></use></g><g data-mml-node="munder" transform="translate(3609,0)"><g data-mml-node="mo"><use data-c="6D" xlink:href="#MJX-4-TEX-N-6D"></use><use data-c="69" xlink:href="#MJX-4-TEX-N-69" transform="translate(833,0)"></use><use data-c="6E" xlink:href="#MJX-4-TEX-N-6E" transform="translate(1111,0)"></use></g><g data-mml-node="mi" transform="translate(662,-600) scale(0.707)"><use data-c="1D463" xlink:href="#MJX-4-TEX-I-1D463"></use></g></g><g data-mml-node="mo" transform="translate(5276,0)"><use data-c="7B" xlink:href="#MJX-4-TEX-N-7B"></use></g><g data-mml-node="mi" transform="translate(5776,0)"><use data-c="1D450" xlink:href="#MJX-4-TEX-I-1D450"></use></g><g data-mml-node="mo" transform="translate(6209,0)"><use data-c="28" xlink:href="#MJX-4-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(6598,0)"><use data-c="1D465" xlink:href="#MJX-4-TEX-I-1D465"></use></g><g data-mml-node="mo" transform="translate(7170,0)"><use data-c="2C" xlink:href="#MJX-4-TEX-N-2C"></use></g><g data-mml-node="mi" transform="translate(7614.7,0)"><use data-c="1D463" xlink:href="#MJX-4-TEX-I-1D463"></use></g><g data-mml-node="mo" transform="translate(8099.7,0)"><use data-c="29" xlink:href="#MJX-4-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(8710.9,0)"><use data-c="2B" xlink:href="#MJX-4-TEX-N-2B"></use></g><g data-mml-node="msub" transform="translate(9711.1,0)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-4-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(553,-150) scale(0.707)"><use data-c="1D463" xlink:href="#MJX-4-TEX-I-1D463"></use></g></g><g data-mml-node="mo" transform="translate(10657.1,0)"><use data-c="28" xlink:href="#MJX-4-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(11046.1,0)"><use data-c="1D466" xlink:href="#MJX-4-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(11536.1,0)"><use data-c="29" xlink:href="#MJX-4-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(11925.1,0)"><use data-c="7D" xlink:href="#MJX-4-TEX-N-7D"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>d</mi><mi>x</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><munder><mo data-mjx-texclass="OP" movablelimits="true">min</mo><mi>v</mi></munder><mo fence="false" stretchy="false">{</mo><mi>c</mi><mo stretchy="false">(</mo><mi>x</mi><mo>,</mo><mi>v</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>d</mi><mi>v</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo fence="false" stretchy="false">}</mo></math></mjx-assistive-mml></mjx-container></div></div><p><span>即</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="1.294ex" height="1.025ex" role="img" focusable="false" viewBox="0 -442 572 453" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.025ex;"><defs><path id="MJX-13-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D465" xlink:href="#MJX-13-TEX-I-1D465"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>x</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">x</script><span>到</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="1.109ex" height="1.464ex" role="img" focusable="false" viewBox="0 -442 490 647" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.464ex;"><defs><path id="MJX-14-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D466" xlink:href="#MJX-14-TEX-I-1D466"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>y</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">y</script><span>的最短路径</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="9.459ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 4181 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-15-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-15-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path id="MJX-15-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-15-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-15-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-15-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-15-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(553,-150) scale(0.707)"><use data-c="1D465" xlink:href="#MJX-15-TEX-I-1D465"></use></g></g><g data-mml-node="mo" transform="translate(1007.5,0)"><use data-c="28" xlink:href="#MJX-15-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1396.5,0)"><use data-c="1D466" xlink:href="#MJX-15-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(1886.5,0)"><use data-c="29" xlink:href="#MJX-15-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(2553.2,0)"><use data-c="3D" xlink:href="#MJX-15-TEX-N-3D"></use></g><g data-mml-node="mi" transform="translate(3609,0)"><use data-c="1D465" xlink:href="#MJX-15-TEX-I-1D465"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>d</mi><mi>x</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mi>x</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">d_x(y) = x</script><span>到相邻节点</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="1.097ex" height="1.027ex" role="img" focusable="false" viewBox="0 -443 485 454" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.025ex;"><defs><path id="MJX-19-TEX-I-1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D463" xlink:href="#MJX-19-TEX-I-1D463"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>v</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">v</script><span>的边权</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="7.897ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 3490.7 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-17-TEX-I-1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path><path id="MJX-17-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-17-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path id="MJX-17-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path id="MJX-17-TEX-I-1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path><path id="MJX-17-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-17-TEX-N-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D450" xlink:href="#MJX-17-TEX-I-1D450"></use></g><g data-mml-node="mo" transform="translate(433,0)"><use data-c="28" xlink:href="#MJX-17-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(822,0)"><use data-c="1D465" xlink:href="#MJX-17-TEX-I-1D465"></use></g><g data-mml-node="mo" transform="translate(1394,0)"><use data-c="2C" xlink:href="#MJX-17-TEX-N-2C"></use></g><g data-mml-node="mi" transform="translate(1838.7,0)"><use data-c="1D463" xlink:href="#MJX-17-TEX-I-1D463"></use></g><g data-mml-node="mo" transform="translate(2323.7,0)"><use data-c="29" xlink:href="#MJX-17-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(2712.7,0)"><use data-c="2B" xlink:href="#MJX-17-TEX-N-2B"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>c</mi><mo stretchy="false">(</mo><mi>x</mi><mo>,</mo><mi>v</mi><mo stretchy="false">)</mo><mo>+</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">c(x,v)+</script><span>相邻节点到y的最短路径</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="5.009ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2213.9 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-18-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-18-TEX-I-1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path><path id="MJX-18-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-18-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-18-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-18-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(553,-150) scale(0.707)"><use data-c="1D463" xlink:href="#MJX-18-TEX-I-1D463"></use></g></g><g data-mml-node="mo" transform="translate(945.9,0)"><use data-c="28" xlink:href="#MJX-18-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1334.9,0)"><use data-c="1D466" xlink:href="#MJX-18-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(1824.9,0)"><use data-c="29" xlink:href="#MJX-18-TEX-N-29"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>d</mi><mi>v</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">d_v(y)</script><span>的和的最小值。</span></p><p><span>每个节点x需要维护：</span></p><ul><li><p><span>到所有邻点</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="1.097ex" height="1.027ex" role="img" focusable="false" viewBox="0 -443 485 454" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.025ex;"><defs><path id="MJX-19-TEX-I-1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D463" xlink:href="#MJX-19-TEX-I-1D463"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>v</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">v</script><span>的开销</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="6.137ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2712.7 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-20-TEX-I-1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path><path id="MJX-20-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-20-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path id="MJX-20-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path id="MJX-20-TEX-I-1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path><path id="MJX-20-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D450" xlink:href="#MJX-20-TEX-I-1D450"></use></g><g data-mml-node="mo" transform="translate(433,0)"><use data-c="28" xlink:href="#MJX-20-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(822,0)"><use data-c="1D465" xlink:href="#MJX-20-TEX-I-1D465"></use></g><g data-mml-node="mo" transform="translate(1394,0)"><use data-c="2C" xlink:href="#MJX-20-TEX-N-2C"></use></g><g data-mml-node="mi" transform="translate(1838.7,0)"><use data-c="1D463" xlink:href="#MJX-20-TEX-I-1D463"></use></g><g data-mml-node="mo" transform="translate(2323.7,0)"><use data-c="29" xlink:href="#MJX-20-TEX-N-29"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>c</mi><mo stretchy="false">(</mo><mi>x</mi><mo>,</mo><mi>v</mi><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">c(x,v)</script></p></li><li><p><span>自己的</span><strong><span>距离向量（distance vector）</span></strong><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="20.866ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 9222.6 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-21-TEX-I-1D437" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path><path id="MJX-21-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path id="MJX-21-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-21-TEX-N-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path><path id="MJX-21-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-21-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-21-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-21-TEX-N-3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-21-TEX-N-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path><path id="MJX-21-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-21-TEX-N-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D437" xlink:href="#MJX-21-TEX-I-1D437"></use></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><use data-c="1D465" xlink:href="#MJX-21-TEX-I-1D465"></use></g></g><g data-mml-node="mo" transform="translate(1593.2,0)"><use data-c="3D" xlink:href="#MJX-21-TEX-N-3D"></use></g><g data-mml-node="mo" transform="translate(2649,0)"><use data-c="5B" xlink:href="#MJX-21-TEX-N-5B"></use></g><g data-mml-node="msub" transform="translate(2927,0)"><g data-mml-node="mi"><use data-c="1D437" xlink:href="#MJX-21-TEX-I-1D437"></use></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><use data-c="1D465" xlink:href="#MJX-21-TEX-I-1D465"></use></g></g><g data-mml-node="mo" transform="translate(4242.5,0)"><use data-c="28" xlink:href="#MJX-21-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(4631.5,0)"><use data-c="1D466" xlink:href="#MJX-21-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(5121.5,0)"><use data-c="29" xlink:href="#MJX-21-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(5788.3,0)"><use data-c="3A" xlink:href="#MJX-21-TEX-N-3A"></use></g><g data-mml-node="mi" transform="translate(6344,0)"><use data-c="1D466" xlink:href="#MJX-21-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(7111.8,0)"><use data-c="2208" xlink:href="#MJX-21-TEX-N-2208"></use></g><g data-mml-node="mi" transform="translate(8056.6,0)"><use data-c="1D441" xlink:href="#MJX-21-TEX-I-1D441"></use></g><g data-mml-node="mo" transform="translate(8944.6,0)"><use data-c="5D" xlink:href="#MJX-21-TEX-N-5D"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>D</mi><mi>x</mi></msub><mo>=</mo><mo stretchy="false">[</mo><msub><mi>D</mi><mi>x</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>:</mo><mi>y</mi><mo>∈</mo><mi>N</mi><mo stretchy="false">]</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">D_x=[D_x(y):y\in N]</script><span>，包含了x到所有其他节点的开销估计值</span></p></li><li><p><span>所有邻点的距离向量，和自己的距离向量一起组成了</span><strong><span>距离表（distance table）</span></strong></p></li></ul><p><span>DV算法为：</span></p><p><img src="./img/DV.jpg" style="zoom:50%;" /></p><p><span>说人话就是：</span><em><span>（我的理解下）</span></em></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5191px; left: 43.9844px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 36px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>12</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -35.9983px; width: 36px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">初始化：</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>遍历所有网络中的所有节点x：</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>计算 x 的距离向量。对于不是x的邻居节点，距离记为∞</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>遍历每个邻点 w: &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>发送本结点 x 的距离向量到每个邻接结点 w。</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">循环：</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>等待（直到存在与其直接相连的链路状态变化，或者收到邻点的距离向量之后终止等待）</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>遍历网络中的每个结点 y：</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>依照bellman-ford方程更新本地 x 距离向量</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 27px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>如果 x 的距离向量存在变化</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -35.9983px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 27px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>发送 x 的距离向量给每一个邻居结点</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 276px;"></div><div class="CodeMirror-gutters" style="height: 276px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 35px;"></div></div></div></div></pre><p><span>可以看到节点是异步更新的，并且将在某一时刻不再更新（收敛了）。</span></p><p><strong><span>例一</span></strong><span>：</span></p><p><img src="./img/DVeg.jpg" style="zoom:67%;" /></p><p><span>可以看到每个节点先计算自己的距离向量，再发送给邻点。当邻点收到距离向量后，根据Bellman-Ford方程更新自己的距离向量，如果有变化，那么再发给自己的邻点。</span></p><p><strong><span>例二</span></strong><span>：</span></p><p><img src="./img/DVeg2.jpg" style="zoom: 50%;" /></p><p><span>该例子中我们只考虑y和z到目的地x的距离表中的相关表项。</span></p><p><span>图a）边权4变为1，具体过程为：</span></p><ul><li><p><span>t0时刻，y检测到链路开销变化（4-&gt;1），更新其距离向量（4-&gt;1,0,1），并通知邻居z</span></p></li><li><p><span>t1时刻，z收到了y 的新的距离向量，更新距离表，并更新自己的距离向量（5-&gt;2,1,0），向邻居发送自己新的距离向量</span></p></li><li><p><span>t2时刻，y收到z的更新并更新其距离表，由于y的距离向量无需更新，所以不发送任何报文给z。更新结束</span></p></li></ul><p><span>图b）边权4变成60，具体过程为：</span></p><ul><li><p><span>t0时刻，y检测到链路开销变化（4-&gt;60），更新其距离向量，并通知邻居。注意到这里更新的时候用到的</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="10.008ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 4423.4 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-22-TEX-I-1D437" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path><path id="MJX-22-TEX-I-1D467" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"></path><path id="MJX-22-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-22-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path id="MJX-22-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-22-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-22-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D437" xlink:href="#MJX-22-TEX-I-1D437"></use></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><use data-c="1D467" xlink:href="#MJX-22-TEX-I-1D467"></use></g></g><g data-mml-node="mo" transform="translate(1239.8,0)"><use data-c="28" xlink:href="#MJX-22-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1628.8,0)"><use data-c="1D465" xlink:href="#MJX-22-TEX-I-1D465"></use></g><g data-mml-node="mo" transform="translate(2200.8,0)"><use data-c="29" xlink:href="#MJX-22-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(2867.6,0)"><use data-c="3D" xlink:href="#MJX-22-TEX-N-3D"></use></g><g data-mml-node="mn" transform="translate(3923.4,0)"><use data-c="35" xlink:href="#MJX-22-TEX-N-35"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>D</mi><mi>z</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mn>5</mn></math></mjx-assistive-mml></mjx-container><script type="math/tex">D_z(x)=5</script><span>，所以y的距离向量将更新为（4-&gt;6,0,1），显然是错误的。这中情况称为</span><strong><span>路由选择环路（routing loop）</span></strong><span>，即为到达x，y通过z，而z又要通过y，导致目的地为x的分组在y和z中反复横跳。</span></p></li><li><p><span>t1时刻，z收到了y 的新的距离向量，更新距离表，并更新自己的距离向量（5-&gt;7,1,0）。注意到这里的距离向量仍然是错误的。</span></p></li><li><p><span>t2时刻，y收到z的新的距离向量，更新自己的距离向量（6-&gt;8,0,1）</span></p></li><li><p><span>t3，z收到y 的新的距离向量，更新自己的距离向量（7-&gt;9,1,0）</span></p></li><li><p><span>......</span></p></li><li><p><span>直到某一时刻y的距离向量变成（51，0，1），z的距离向量变成（50，1，0）。才会停止迭代。</span></p></li></ul><p><span>可见，这种链路开销增加的坏消息传播的很慢，这种问题称为</span><strong><span>无穷计数问题（count-to-infinity problem）</span></strong><span>。</span></p><p><strong><span>毒性逆转</span></strong></p><p><strong><span>毒性逆转（poisoned reverse）</span></strong><span>是解决无穷计数问题的一个不完全的办法。其思想为：如果z通过y到x，则z告诉y，z到x的距离为无穷大。然而，这并不能解决一般性的无穷计数问题，对于3个或以上的节点，毒性逆转便无法解决。</span></p><p><strong><span>LS与DV比较</span></strong></p><ul><li><p><span>报文复杂性：LS为使所有节点知道每条链路的开销，需要发送O(|N||E|)个报文。而DV只要求在每次迭代时，相邻节点才需要交换报文。但是DV需要迭代的次数并不能确定。</span></p></li><li><p><span>收敛速度：LS是O(n</span><sup><span>2</span></sup><span>)复杂度的。而DV由于会遇到选择环路、无穷计数问题，收敛速度较慢。</span></p></li><li><p><span>健壮性：LS健壮性更好。</span><em><span>但是并没有很看懂书上的解释，LS算法广播只向相邻节点广播？</span></em></p></li></ul><h2 id='53-intra-as-routing-in-the-internet-ospf'><span>5.3 Intra-AS Routing in the Internet: OSPF</span></h2><p><span>在之前的讨论中，我们都将整个网络看作是一个互联路由器的集合。这会带来两个问题：</span></p><ul><li><p><strong><span>规模（scale）</span></strong><span>：当今因特网由数亿台主机组成。LS存储整个网络结构或者DV想要收敛都是不可能实现的。</span></p></li><li><p><strong><span>管理自治（administrative automony）</span></strong><span>：ISP希望按自己的意愿运行路由器，或对外部隐藏其网络内部组织面貌。</span></p></li></ul><p><span>这两个问题可以通过</span><strong><span>自治系统（autonomous system，AS）</span></strong><span>解决。ISP会将其网络划分为一个或多个AS。每个AS由其全局唯一的AS号（ASN）所标识，AS号由ICANN区域注册机构所分配。</span></p><p><span>在相同AS中的路由器运行相同的路由选择算法并有彼此的信息。在一个AS内运行的路由选择算法称为</span><strong><span>自治系统内部路由选择协议（intra-autonomous system routing protocol）</span></strong><span>。下面我们介绍</span><strong><span>OSPF（Open Shortest Path First，开放最短路优先）</span></strong><span>。</span></p><p><span>OSPF是一个链路状态协议（LS算法），使用洪泛链路状态信息（flooding of link-state information）+ Dijkstra算法。边权由管理员配置。每台路由器构建了整个AS的拓扑图，然后在本地运行Dijkstra算法。路由器向AS内所有（不仅仅是相邻路由器）其他路由器广播路由选择信息。即使链路未发生变化，也要周期性广播链路状态（at least once every 30 minutes），据说是为了更好的健壮性。OSPF报文由IP承载，上层协议值为89。</span></p><p><em><span>什么是洪泛？本章没有提及</span></em></p><p><span>OSPF优点：</span></p><ul><li><p><span>安全：能够鉴别OSPF路由器之间的交换，仅有受信任的路由器能参与AS内的OSPF协议。</span></p></li><li><p><span>当存在多条相同开销的路径时，无需仅选择单一路径承载所有流量</span></p></li><li><p><span>支持单播和多播路由选择</span></p></li><li><p><span>支持在单个AS中的层次结构：一个OSPF AS可以配置成多个区域，每个区域运行自己的OSPF LS算法。某区域内分组—&gt;区域边界路由器（border router）—&gt;主干（backbone，由AS所有区域边界路由器组成，还包含一些非边界路由器）—&gt;目的区域边界路由器—&gt;目的地</span></p></li></ul><p><em><span>书上讨论大体如上，也很简略</span></em></p><h2 id='54-routing-among-the-isps-bgp'><span>5.4 Routing Among the ISPs: BGP</span></h2><p><span>OSPF是一个AS内部的路由选择协议，那AS之间肯定也需要</span><strong><span>自治系统间路由选择协议（inter-autonomous system routing protocol）</span></strong><span>。这里我们介绍</span><strong><span>边界网关协议（Broder Gateway Protocol，BGP）</span></strong><span>。这是一种分布式和异步的协议（DV算法），粘合起因特网中的ISP。</span></p><h3 id='541-bgp作用'><span>5.4.1 BGP作用</span></h3><p><span>在BGP中，分组的目的地不再是一个具体的IP地址，而是一个子网的前缀。因此一个路由器的转发表具有(x,I)形式的表项，其中x是一个前缀（例如138.16.68/22），I是该路由器的一个接口号。</span></p><p><span>BGP给路由器提供了：</span></p><ul><li><p><span>Obtain prefix reachability information from neighboring ASs. 就是说BGP确保因特网中所有AS知道该子网。</span></p></li><li><p><span>Determine the &quot;best&quot; routes to the prefixes.</span></p></li></ul><h3 id='542-通告advertise）bgp路由信息'><span>5.4.2 通告（advertise）BGP路由信息</span></h3><p><span>考虑如下具有3个自治系统的网络，其中AS3包括一个具有前缀x的子网。</span></p><p><img src="./img/AS1.jpg" style="zoom:50%;" /></p><p><span>对于每个AS，路由器可以分成</span><strong><span>网关路由器（gateway router）</span></strong><span>和</span><strong><span>内部路由器（internal router）</span></strong><span>。譬如AS1中1c就是网关路由器，其他的都是内部路由器。</span></p><p><span>在BGP中，路由器使用179端口的半永久TCP连接。</span><em><span>（书上未解释半永久）</span></em><span>。BGP连接可以分成</span><strong><span>外部BGP（eBGP）</span></strong><span>连接和</span><strong><span>内部BGP（iBGP）</span></strong><span>连接。如图所示：</span></p><p><img src="./img/eiBGP.jpg" style="zoom:50%;" /></p><p><span>注意到iBGP连接并不总是与物理链路对应。</span></p><p><span>现在考虑向AS1和AS2中的所有路由器通告前缀x的可达性信息。在这个过程中，网关路由器3a先向网关路由器2c发送一个eBGP报文“AS3 x”。网关路由器2c然后向AS2中的所有其他路由器发送iBGP报文“AS3 x”。网关路由器2a接下来向网关路由器1c发送一个eBGP报文“AS2 AS3 x”。最后网关路由器1c使用iBGP向AS1中所有路由器发送报文“AS2 AS3 x”。至此所有AS1和AS2的路由器都知道了x的存在以及通往x的AS路径。</span></p><h3 id='543-确定最好的路由'><span>5.4.3 确定最好的路由</span></h3><p><span>现在路由器们都知道子网x的存在了。但是路由器可能发现到该子网的路径有很多条，本节关心如何选择最好的路径。</span></p><p><span>之前提及发送的BGP报文形如“AS2 AS3 x”，其中</span><code>AS2 AS3</code><span>称为AS-PATH，是一个</span><strong><span>BGP属性</span></strong><span>。除了AS-PATH，NEXT-HOP（下一跳）是另一个重要的BGP属性，它是AS-PATH起始路由器接口的IP地址。如下图所示：</span></p><p><img src="./img/AS2.jpg" style="zoom:50%;" /></p><p><span>用BGP术语来说，前缀及其属性称为</span><strong><span>路由（route）</span></strong><span>。这里路由包含：NEXT-HOP，AS-PATH和目的前缀。（不妨将路由理解为路径加上额外信息）</span></p><p><strong><span>1）热土豆路由选择</span></strong></p><p><span>想法很简单：路由器想要以最低开销将分组送出其AS，就好比分组是个烫手的土豆。譬如1b想要确定到前缀x的路径，它发现到网关2a的距离短于网关3d，于是选择到网关2a的端口I，并在转发表里加入表项(x,I)。</span></p><p><strong><span>2）路由选择算法</span></strong></p><p><span>BGP路由选择算法如下：</span></p><ol start='' ><li><p><span>路由被指派一个</span><strong><span>本地偏好值</span></strong><span>作为属性之一。本地偏好值完全取决于该AS的网络管理员。具有最好本地偏好值的路由将被选择。</span></p></li><li><p><span>从最高的本地偏好值的路由们中，选出具有最短AS-PATH的路由。BGP将使用DV算法决定路径，其中距离使用AS跳的跳数，而不是路由器跳的跳数。</span></p></li><li><p><span>如果还有多个路由可以选择，使用热土豆算法。</span></p></li><li><p><span>如果仍留下多条路由，使用BGP标识符来进行最终的选择。这里不介绍。</span></p></li></ol><p><span>上面的例子中，1b将选择到网关3d的端口I（因为此时AS-PATH最小），并在转发表里加入表项(x,I)。</span></p><h3 id='544-ip任播'><span>5.4.4 IP任播</span></h3><p><span>BGP还被用于实现</span><strong><span>IP任播（IP anycast）</span></strong><span>服务，该服务通常用于DNS中。IP任播动机包括：</span></p><ul><li><p><span>replicating the same content on different servers in many different dispersed geographical locations</span></p></li><li><p><span>having each user access the content from the server that is closest</span></p></li></ul><p><img src="./img/IPanycast.jpg" style="zoom:50%;" /></p><p><em><span>书上解释看不懂:（</span></em></p><h3 id='545-路由选择策略'><span>5.4.5 路由选择策略</span></h3><p><span>在如下图所示的网络中有6个AS，其中ABC是骨干提供商网络，而wxy是接入ISP。x通过两个不同的提供商接入网络，称为</span><strong><span>多宿接入ISP（multi-homed access ISP）</span></strong><span>。</span></p><p><img src="./img/BGPpolicy.jpg" style="zoom: 50%;" /></p><p>&nbsp;</p><p><span>可以理解X是不会把B的流量转发到C去，不然接入ISP会给提供商分担流量（我买了你的服务，还要给你干活）。而这一点是通过BGP通告方式实现的。X不会向B和C通告它有通向除自身以外任何其他目的地的路径。比如说X知道自己有XCY路径能到Y，但是它不会告诉B这一条路径。</span></p><p><span>那么现在B知道了AW路径，它显然会告诉客户X路径BAW，但是要不要告诉另一个骨干提供商C呢？如果告诉的话，就要为AC之间通信分担流量。目前是没有官方标准，但是一般遵循：穿越骨干网的流量的源或者目的地两者至少一个位于客户网络中。</span></p><h2 id='55-sdn控制平面'><span>5.5 SDN控制平面</span></h2><p><span>SDN基本内容不再重复。</span></p><h3 id='551-结构'><span>5.5.1 结构</span></h3><p><span>我们已经知道了SDN控制器是由软件实现的，连接起了分组交换器和网络控制应用程序。SDN控制器由大体组织为3个层次：</span></p><ul><li><p><span>通信层：负责SDN和受控网络设备之间的通信。OpenFlow是其中一个协议。</span></p></li><li><p><span>网络范围状态管理层：维护各种状态信息</span></p></li><li><p><span>对于网络控制应用程序层的接口：给程序提供API，REST是其中的一种</span></p></li></ul><p><img src="./img/SDNcontroller.jpg" style="zoom:50%;" /></p><h3 id='552-openflow协议'><span>5.5.2 OpenFlow协议</span></h3><p><span>OpenFlow协议运行在TCP之上，使用6653默认端口号。</span></p><p><span>从控制器到交换机的报文有：</span></p><ul><li><p><span>配置交换机相关设置参数</span></p></li><li><p><span>修改交换器流表项</span></p></li><li><p><span>读取交换机状态</span></p></li><li><p><span>从特定端口发送特定报文</span></p></li></ul><p><span>从交换机到控制器的报文有：</span></p><ul><li><p><span>告知已删除流表项</span></p></li><li><p><span>通知端口状态</span></p></li><li><p><span>packet-in：如果一个分组不能与任何流表项目匹配，那么这个分组将被发送到控制器进行额外处理。如果分组有匹配，也可能被要求发送到控制器。而packet-in该报文就用来将分组发送给控制器。</span></p></li></ul><h3 id='553-例子'><span>5.5.3 例子</span></h3><p><span>下图中s1和s2之间的链路断开</span></p><p><img src="./img/SDNeg.jpg" style="zoom:50%;" /></p><p><span>于是将有以下步骤：</span></p><ol start='' ><li><p><span>s1发现与s2之间的链路故障，使用OpenFlow“端口状态”报文向SDN控制器汇报</span></p></li><li><p><span>SDN控制器接收报文，修改链路状态信息</span></p></li><li><p><span>Dijkstra程序得知链路状态信息改变</span></p></li><li><p><span>Dijkstra程序从链路状态管理器以及管理层其他组件那里，获取希望的信息，重新计算最低开销路径</span></p></li><li><p><span>Dijkstra程序与流表管理器交互，流表管理器决定新的流表</span></p></li><li><p><span>流表管理器使用OpenFlow协议更新多个交换器的流表项</span></p></li></ol><h2 id='56-icmp-the-internet-control-message-protocol'><span>5.6 ICMP: The Internet Control Message Protocol</span></h2><p><span>ICMP也是网络层的协议，典型用途是差错报告。通常被认为是IP协议的一部分，但是ICMP报文是承载在IP数据报的数据字段里的。IP数据报首部上层协议字段为1，表明该数据报有效负载是ICMP报文。</span></p><p><span>ICMP报文有type和code字段，以及包含引起该ICMP报文生成的IP数据报的首部和前8个字节（以便发送方能确定引发该差错的数据报）。type和code字段如下：</span></p><p><img src="./img/icmp.jpg" style="zoom:50%;" /></p><p><span>譬如ping程序发送一个type=8 code=0的ICMP报文给指定主机，目的主机会发回一个type=code=0的ICMP回显回答。</span></p><h2 id='57-网络管理和snmp'><span>5.7 网络管理和SNMP</span></h2><p><span>网络管理定义为：</span></p><blockquote><p><span>Network management includes the deployment, integration, and coordination of the hardware, software, and human elements to monitor, test, poll, configure, analyze, evaluate, and control the network and element resources to meet the real-time, operational performance, and Quality of Service requirements at a reasonable cost.</span></p></blockquote><p><span>本节讨论网络管理的入门知识——体系结构、协议和信息库。</span></p><h3 id='571-网络管理框架'><span>5.7.1 网络管理框架</span></h3><p><img src="./img/manageElement.jpg" style="zoom:50%;" /></p><ul><li><p><strong><span>管理服务器（managing server）</span></strong><span>：它是一个应用程序，通常有人参与，并运行在网络运营中心（NOC）的集中式网络管理站上，它是执行网络管理活动的地方，它控制网络管理信息的收集、处理、分析和显示。发起控制网络行为的动作。</span></p></li><li><p><strong><span>被管设备（managed device）</span></strong><span>：网络装备的一部分，位于被管理的网络中，可以是一台主机、路由器、交换机等联网设备。这些被管设备实际被管对象是设备中的硬件部分和硬件及软件的组成部分。</span></p></li><li><p><strong><span>管理信息库（MIB）</span></strong><span>：一个被管设备中的每个被管对象的管理信息收集地。这些信息可被管理信息服务器所用。</span></p></li><li><p><strong><span>网络管理代理（network management agent）</span></strong><span>：运行在被管设备中的一个进程，该进程与管理服务器通信，在管理服务器的命令和控制下在被管设备中采取本地动作。</span></p></li><li><p><strong><span>网络管理协议（network management protocol）</span></strong><span>：运行在网络管理服务器和被管设备之间，允许服务器查询被管设备的状态，并经过代理间接地在这些设备上采取动作。</span></p></li></ul><h3 id='572-the-simple-network-management-protocol-snmp'><span>5.7.2 The Simple Network Management Protocol (SNMP)</span></h3><p><span>SNMP是一个应用层协议，用于管理服务器和代表管理服务器执行的代理之间传递网络管理控制和信息报文。</span></p><p><span>SNNP最常用的是请求响应模式，其中SNMPP管理服务器向SNMP 代理发送一个请求，代理收到请求之后执行某些动作。然后对该请求发送一个回答。请求通常用于查询或修改某个被管设备关联的MIB对象值。</span></p><p><span>还有一个用途是代理向管理服务器发送一种非请求报文，该报文称为</span><strong><span>陷阱报文（trap message）</span></strong><span>，用于通知管理服务器有异常情况导致MIB对象值已改变。</span></p><p><span>更多内容不再展开。</span></p><hr /><p>&nbsp;</p><h1 id='六链路层和局域网'><span>六、链路层和局域网</span></h1><p><span>网络层已经实现了任意两台主机之间的通信服务，数据报经过一系列通信链路和分组交换机（交换机和路由器），到达目的主机。我们也知道了路由器和端系统如何通过IP地址进行数据报的转发。但是分组又是如何在各段链路上传播的呢？不同的链路又会采用怎样不同的链路层协议呢？这便是链路层需要解决的问题。做个类比，旅行社设计了一条欧洲之行方案——德国飞法国，法国乘船到英国。这里游客好比一个数据报，运输方式好比一种链路层协议，旅行社好比一个路由选择协议。</span></p><p><span>有两种截然不同的链路层信道：</span></p><ul><li><p><strong><span>广播信道（broadcast channels）</span></strong><span>：如无线局域网、卫星网和HFC网络</span></p></li><li><p><strong><span>点对点通信链路（point-to-point communication link）</span></strong><span>：如长距离链路连接的两台路由器之间，相关的</span><strong><span>点到点协议（point-to-point，PPP）</span></strong><span>本书没有介绍。</span></p></li></ul><p><span>本章将从差错检验出发，再深入讨论多路访问网络和以太网，最后学习虚拟局域网和数据中心网络。</span></p><h2 id='61-链路层概述'><span>6.1 链路层概述</span></h2><p><span>复习一些</span><strong><span>术语</span></strong><span>：</span></p><ul><li><p><strong><span>节点（node）</span></strong><span>：运行链路层协议的设备</span></p></li><li><p><strong><span>链路（link）</span></strong><span>：连接相邻节点的通信信道</span></p></li><li><p><strong><span>链路层帧（link-layer frame）</span></strong><span>：即链路层的分组</span></p></li></ul><h3 id='611-链路层提供的服务'><span>6.1.1 链路层提供的服务</span></h3><p><span>链路层提供的服务包括：</span></p><ul><li><p><strong><span>framing</span></strong><span>：用链路层帧封装数据报</span></p></li><li><p><strong><span>link access</span></strong><span>：</span><strong><span>媒体访问控制（Medium Access Control, MAC）</span></strong><span>协议规定了帧在链路上传播的规则</span></p></li><li><p><strong><span>reliable delivery</span></strong><span>：许多有线链路层协议并不提供，因为出错概率低。对于那些容易产生高差错率的链路（如无线链路），通常在本地纠正差错，而不是通过重传。</span></p></li><li><p><strong><span>error detection and correction</span></strong><span>：发现比特差错并纠正</span></p></li></ul><h3 id='612-链路层在何处实现'><span>6.1.2 链路层在何处实现</span></h3><p><span>链路层大部分功能在</span><strong><span>网络适配器（network adapter）</span></strong><span>上实现，如framing、link access和error detection and correction。网络适配器其实就是</span><strong><span>网卡（network interface card, NIC）</span></strong><span>。当下网卡很多时候直接集成在主机的主板上了，无需额外购买。</span></p><p><span>当然也有部分链路层功能由主机CPU上的软件实现。</span></p><h2 id='62-差错检测和纠正技术'><span>6.2 差错检测和纠正技术</span></h2><p><span>在发送的数据之外，额外传送</span><strong><span>差错检测和纠正比特（Error-Detection and -Correction, EDC）</span></strong><span>，来检测并纠正传来数据的错误。注意到并不是所有的比特差错都可以被检测出来，也并不是所有的差错都可以纠正。下面我们会讨论三种技术。</span></p><h3 id='621-奇偶校验'><span>6.2.1 奇偶校验</span></h3><p><span>使用单个</span><strong><span>奇偶校验位（parity bit）</span></strong><span>。其中：</span></p><ul><li><p><strong><span>even parity scheme</span></strong><span>：原数据加上偶校验位，一共由偶数个1</span></p></li><li><p><strong><span>odd parity scheme</span></strong><span>：原数据加上奇校验位，一共由奇数个1</span></p></li></ul><p><span>一个偶校验的例子如下：</span></p><p><img src="./img/evenParity.jpg" style="zoom:50%;" /></p><p><span>为了可以纠正错误，可以使用二维奇偶校验方案。如图：</span></p><p><img src="./img/2Dparity.jpg" style="zoom:50%;" /></p><p><span>显然奇偶校验的方法很简单，但是一旦犯了多个差错，奇偶校验就显得无能为力了。</span></p><h3 id='622-检验和方法'><span>6.2.2 检验和方法</span></h3><p><span>已经在3.3.2节介绍过了。</span><strong><span>检验和（checksum）</span></strong><span>优点在于其空间开销小，但仍然提供弱的差错保护。</span></p><p><span>但是为什么运输层使用检验和呢？这是因为运输层差错检验是用软件实现的，采用简单而快速的方案是重要的。而马上在6.2.3节可以看到，链路层的差错检测在适配器中用专用的硬件实现，能够快速执行更复杂的CRC操作。</span></p><h3 id='623-循环冗余检测'><span>6.2.3 循环冗余检测</span></h3><p><strong><span>循环冗余检测（cyclic redundancy check, CRC）</span></strong><span>广泛应用于现今的计算机网路。在发送d比特的数据D之前，发送方和接收方首先要协商一个r+1比特的</span><strong><span>生成多项式（generator）</span></strong><span>G。对于一个给定的数据段D，发送方要选择r比特的R，并附加到D后，得到的d+r比特的一个二进制数，可以用模2算术被G整除。所谓模2算术，就是加法不进位，减法不借位，都等价于按位异或。而接收方只需要判断G是否可以整除这个d+r比特的二进制数即可。</span></p><p><img src="./img/crc.jpg" style="zoom:50%;" /></p><p><span>也就是存在正整数n，满足</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n1694" cid="n1694" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="19.355ex" height="1.827ex" role="img" focusable="false" viewBox="0 -725.5 8554.9 807.5" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.186ex;"><defs><path id="MJX-5-TEX-I-1D437" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path><path id="MJX-5-TEX-N-22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path><path id="MJX-5-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-5-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-5-TEX-I-1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path><path id="MJX-5-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-5-TEX-I-1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path><path id="MJX-5-TEX-N-A0" d=""></path><path id="MJX-5-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-5-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-5-TEX-I-1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D437" xlink:href="#MJX-5-TEX-I-1D437"></use></g><g data-mml-node="mo" transform="translate(1050.2,0)"><use data-c="22C5" xlink:href="#MJX-5-TEX-N-22C5"></use></g><g data-mml-node="msup" transform="translate(1550.4,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-5-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,413) scale(0.707)"><use data-c="1D45F" xlink:href="#MJX-5-TEX-I-1D45F"></use></g></g><g data-mml-node="mi" transform="translate(2452.3,0)"><use data-c="1D44B" xlink:href="#MJX-5-TEX-I-1D44B"></use></g><g data-mml-node="mi" transform="translate(3304.3,0)"><use data-c="1D442" xlink:href="#MJX-5-TEX-I-1D442"></use></g><g data-mml-node="mi" transform="translate(4067.3,0)"><use data-c="1D445" xlink:href="#MJX-5-TEX-I-1D445"></use></g><g data-mml-node="mtext" transform="translate(4826.3,0)"><use data-c="A0" xlink:href="#MJX-5-TEX-N-A0"></use></g><g data-mml-node="mi" transform="translate(5076.3,0)"><use data-c="1D445" xlink:href="#MJX-5-TEX-I-1D445"></use></g><g data-mml-node="mo" transform="translate(6113.1,0)"><use data-c="3D" xlink:href="#MJX-5-TEX-N-3D"></use></g><g data-mml-node="mi" transform="translate(7168.9,0)"><use data-c="1D45B" xlink:href="#MJX-5-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(7768.9,0)"><use data-c="1D43A" xlink:href="#MJX-5-TEX-I-1D43A"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>D</mi><mo>⋅</mo><msup><mn>2</mn><mi>r</mi></msup><mi>X</mi><mi>O</mi><mi>R</mi><mtext>&nbsp;</mtext><mi>R</mi><mo>=</mo><mi>n</mi><mi>G</mi></math></mjx-assistive-mml></mjx-container></div></div><p><span>也就是</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n1696" cid="n1696" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="21.925ex" height="4.676ex" role="img" focusable="false" viewBox="0 -1359 9690.9 2067" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -1.602ex;"><defs><path id="MJX-6-TEX-I-1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path><path id="MJX-6-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-6-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-6-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-6-TEX-I-1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-6-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-6-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-6-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-6-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-6-TEX-I-1D437" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path><path id="MJX-6-TEX-N-22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path><path id="MJX-6-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-6-TEX-I-1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D445" xlink:href="#MJX-6-TEX-I-1D445"></use></g><g data-mml-node="mo" transform="translate(1036.8,0)"><use data-c="3D" xlink:href="#MJX-6-TEX-N-3D"></use></g><g data-mml-node="mi" transform="translate(2092.6,0)"><use data-c="1D45F" xlink:href="#MJX-6-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(2543.6,0)"><use data-c="1D452" xlink:href="#MJX-6-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(3009.6,0)"><use data-c="1D45A" xlink:href="#MJX-6-TEX-I-1D45A"></use></g><g data-mml-node="mi" transform="translate(3887.6,0)"><use data-c="1D44E" xlink:href="#MJX-6-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(4416.6,0)"><use data-c="1D456" xlink:href="#MJX-6-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(4761.6,0)"><use data-c="1D45B" xlink:href="#MJX-6-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(5361.6,0)"><use data-c="1D451" xlink:href="#MJX-6-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(5881.6,0)"><use data-c="1D452" xlink:href="#MJX-6-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(6347.6,0)"><use data-c="1D45F" xlink:href="#MJX-6-TEX-I-1D45F"></use></g><g data-mml-node="mfrac" transform="translate(6798.6,0)"><g data-mml-node="mrow" transform="translate(220,676)"><g data-mml-node="mi"><use data-c="1D437" xlink:href="#MJX-6-TEX-I-1D437"></use></g><g data-mml-node="mo" transform="translate(1050.2,0)"><use data-c="22C5" xlink:href="#MJX-6-TEX-N-22C5"></use></g><g data-mml-node="msup" transform="translate(1550.4,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-6-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><use data-c="1D45F" xlink:href="#MJX-6-TEX-I-1D45F"></use></g></g></g><g data-mml-node="mi" transform="translate(1053.2,-686)"><use data-c="1D43A" xlink:href="#MJX-6-TEX-I-1D43A"></use></g><rect width="2652.3" height="60" x="120" y="220"></rect></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>R</mi><mo>=</mo><mi>r</mi><mi>e</mi><mi>m</mi><mi>a</mi><mi>i</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>r</mi><mfrac><mrow><mi>D</mi><mo>⋅</mo><msup><mn>2</mn><mi>r</mi></msup></mrow><mi>G</mi></mfrac></math></mjx-assistive-mml></mjx-container></div></div><p><span>例子如：</span></p><p><img src="./img/crcEg.jpg" style="zoom:50%;" /></p><p><span>国际标准已经定义了8、12、16、32比特的生成多项式G。其中CRC-32 32比特的标准被广泛使用，大小为：</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n1700" cid="n1700" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="53.329ex" height="2.066ex" role="img" focusable="false" viewBox="0 -705 23571.3 913" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.471ex;"><defs><path id="MJX-7-TEX-I-1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path><path id="MJX-7-TEX-I-1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path><path id="MJX-7-TEX-I-1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path><path id="MJX-7-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-7-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-7-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-7-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-7-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-7-TEX-N-A0" d=""></path><path id="MJX-7-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D43A" xlink:href="#MJX-7-TEX-I-1D43A"></use></g><g data-mml-node="TeXAtom" transform="translate(819,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D436" xlink:href="#MJX-7-TEX-I-1D436"></use></g><g data-mml-node="mi" transform="translate(760,0)"><use data-c="1D445" xlink:href="#MJX-7-TEX-I-1D445"></use></g><g data-mml-node="mi" transform="translate(1519,0)"><use data-c="1D436" xlink:href="#MJX-7-TEX-I-1D436"></use></g><g data-mml-node="mo" transform="translate(2279,0)"><use data-c="2212" xlink:href="#MJX-7-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(3057,0)"><use data-c="33" xlink:href="#MJX-7-TEX-N-33"></use><use data-c="32" xlink:href="#MJX-7-TEX-N-32" transform="translate(500,0)"></use></g></g></g><g data-mml-node="mo" transform="translate(4015.5,0)"><use data-c="3D" xlink:href="#MJX-7-TEX-N-3D"></use></g><g data-mml-node="mn" transform="translate(5071.3,0)"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use></g><g data-mml-node="mtext" transform="translate(5571.3,0)"><use data-c="A0" xlink:href="#MJX-7-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(5821.3,0)"><use data-c="30" xlink:href="#MJX-7-TEX-N-30"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1000,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1500,0)"></use></g><g data-mml-node="mtext" transform="translate(7821.3,0)"><use data-c="A0" xlink:href="#MJX-7-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(8071.3,0)"><use data-c="30" xlink:href="#MJX-7-TEX-N-30"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1000,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1500,0)"></use></g><g data-mml-node="mtext" transform="translate(10071.3,0)"><use data-c="A0" xlink:href="#MJX-7-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(10321.3,0)"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1000,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1500,0)"></use></g><g data-mml-node="mtext" transform="translate(12321.3,0)"><use data-c="A0" xlink:href="#MJX-7-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(12571.3,0)"><use data-c="30" xlink:href="#MJX-7-TEX-N-30"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1000,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(1500,0)"></use></g><g data-mml-node="mtext" transform="translate(14571.3,0)"><use data-c="A0" xlink:href="#MJX-7-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(14821.3,0)"><use data-c="30" xlink:href="#MJX-7-TEX-N-30"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1000,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(1500,0)"></use></g><g data-mml-node="mtext" transform="translate(16821.3,0)"><use data-c="A0" xlink:href="#MJX-7-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(17071.3,0)"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1000,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(1500,0)"></use></g><g data-mml-node="mtext" transform="translate(19071.3,0)"><use data-c="A0" xlink:href="#MJX-7-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(19321.3,0)"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(500,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(1000,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(1500,0)"></use></g><g data-mml-node="mtext" transform="translate(21321.3,0)"><use data-c="A0" xlink:href="#MJX-7-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(21571.3,0)"><use data-c="30" xlink:href="#MJX-7-TEX-N-30"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(500,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(1000,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(1500,0)"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>G</mi><mrow data-mjx-texclass="ORD"><mi>C</mi><mi>R</mi><mi>C</mi><mo>−</mo><mn>32</mn></mrow></msub><mo>=</mo><mn>1</mn><mtext>&nbsp;</mtext><mn>0000</mn><mtext>&nbsp;</mtext><mn>0100</mn><mtext>&nbsp;</mtext><mn>1100</mn><mtext>&nbsp;</mtext><mn>0001</mn><mtext>&nbsp;</mtext><mn>0001</mn><mtext>&nbsp;</mtext><mn>1101</mn><mtext>&nbsp;</mtext><mn>1011</mn><mtext>&nbsp;</mtext><mn>0111</mn></math></mjx-assistive-mml></mjx-container></div></div><p><span>CRC可以检测出所有连续的小于等于r比特的差错。对于长度大于r+1比特的差错也有概率被检测到。</span></p><h2 id='63-多路访问链路和协议'><span>6.3 多路访问链路和协议</span></h2><p><span>已提及链路层信道有点对点和广播两种。本节讨论广播信道中的一个重要问题：如何协调多个发送和接收节点对一个共享广播信道的访问，这就是</span><strong><span>多路访问问题（multiple access problem）</span></strong><span>，相关协议称为</span><strong><span>多路访问协议（multiple access protocol）</span></strong><span>。</span></p><p><span>多个节点可能同时传输帧，导致所有节点同时接到多个帧，这称为</span><strong><span>碰撞（collide）</span></strong><span>。当碰撞发生时，接收节点无法区分碰撞帧的信号，只能扔掉这些帧，从而导致了广播信道的大量带宽被浪费。</span></p><p><span>当下多路访问协议有几十种，但是可以被分为以下三种类型：</span><strong><span>信道划分协议（channel partitioning protocol）</span></strong><span>，</span><strong><span>随机接入协议（random access protocol）</span></strong><span>和</span><strong><span>轮流协议（taking-turns protocol）</span></strong><span>。</span></p><p><span>对于速率为R bps的广播信道，我们希望多路访问协议有以下特性：</span></p><ul><li><p><span>仅有一个节点发送数据时，节点具有R bps的吞吐量</span></p></li><li><p><span>当M个节点发送数据时，每个节点平均吞吐量R/M bps</span></p></li><li><p><span>协议是分散的，不会因为主节点故障而导致整个系统崩溃</span></p></li><li><p><span>协议简单不昂贵</span></p></li></ul><h3 id='631-信道划分协议'><span>6.3.1 信道划分协议</span></h3><p><span>即1.3.2节介绍的</span><strong><span>时分多路复用（TDM）</span></strong><span>和</span><strong><span>频分多路复用（FDM）</span></strong><span>。</span></p><p><span>优点：</span></p><ul><li><p><span>消除碰撞且公平：每个节点平均吞吐量R/M bps</span></p></li></ul><p><span>缺点：</span></p><ul><li><p><span>当只有一个节点要发数据时，吞吐量仍然为R/M bps</span></p></li></ul><p><span>此外还有</span><strong><span>码分多址（code division multiple access, CDMA）</span></strong><span>，将在第七章介绍。</span></p><h3 id='632-随机接入协议'><span>6.3.2 随机接入协议</span></h3><p><span>随机接入协议设计思想包括：</span></p><ul><li><p><span>一个传输节点总是以信道的全部速率进行发送</span></p></li><li><p><span>当有碰撞时，节点等待一个随机时间，然后再重发</span></p></li></ul><p><span>本小节介绍ALOHA协议和CSMA协议。</span></p><p><strong><span>1. Slotted ALOHA</span></strong></p><p><span>一些假设和策略如下：</span></p><ul><li><p><span>所有帧由L比特组成</span></p></li><li><p><span>时间被划分成长度为L/R秒的时隙（slot），也就是一个时隙可以传一帧</span></p></li><li><p><span>节点只在时隙起点开始传输帧</span></p></li><li><p><span>节点是同步的，每个节点都知道时隙何时开始</span></p></li><li><p><span>如果产生碰撞，则所有节点在该时隙结束之前检测到该碰撞事件。该节点以概率p在后续的每个时隙中重传它的帧，直到无碰撞地传输出去。</span></p></li></ul><p><span>那效率如何呢？也就是一段时间内成功传输的时隙占比多大呢？</span></p><p><img src="./img/slottedALOHA.jpg" style="zoom:50%;" /></p><p><span>易知，成功时隙的概率为</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="13.595ex" height="2.48ex" role="img" focusable="false" viewBox="0 -846 6009 1096" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-23-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-23-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-23-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-23-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-23-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-23-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D441" xlink:href="#MJX-23-TEX-I-1D441"></use></g><g data-mml-node="mi" transform="translate(888,0)"><use data-c="1D45D" xlink:href="#MJX-23-TEX-I-1D45D"></use></g><g data-mml-node="mo" transform="translate(1391,0)"><use data-c="28" xlink:href="#MJX-23-TEX-N-28"></use></g><g data-mml-node="mn" transform="translate(1780,0)"><use data-c="31" xlink:href="#MJX-23-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(2502.2,0)"><use data-c="2212" xlink:href="#MJX-23-TEX-N-2212"></use></g><g data-mml-node="mi" transform="translate(3502.4,0)"><use data-c="1D45D" xlink:href="#MJX-23-TEX-I-1D45D"></use></g><g data-mml-node="msup" transform="translate(4005.4,0)"><g data-mml-node="mo"><use data-c="29" xlink:href="#MJX-23-TEX-N-29"></use></g><g data-mml-node="TeXAtom" transform="translate(422,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D441" xlink:href="#MJX-23-TEX-I-1D441"></use></g><g data-mml-node="mo" transform="translate(888,0)"><use data-c="2212" xlink:href="#MJX-23-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(1666,0)"><use data-c="31" xlink:href="#MJX-23-TEX-N-31"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>N</mi><mi>p</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><msup><mo stretchy="false">)</mo><mrow data-mjx-texclass="ORD"><mi>N</mi><mo>−</mo><mn>1</mn></mrow></msup></math></mjx-assistive-mml></mjx-container><script type="math/tex">Np(1-p)^{N-1}</script><span>，当</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="8.427ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 3724.6 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-24-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-24-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-24-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-24-TEX-N-2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path><path id="MJX-24-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D45D" xlink:href="#MJX-24-TEX-I-1D45D"></use></g><g data-mml-node="mo" transform="translate(780.8,0)"><use data-c="3D" xlink:href="#MJX-24-TEX-N-3D"></use></g><g data-mml-node="mn" transform="translate(1836.6,0)"><use data-c="31" xlink:href="#MJX-24-TEX-N-31"></use></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2336.6,0)"><g data-mml-node="mo"><use data-c="2F" xlink:href="#MJX-24-TEX-N-2F"></use></g></g><g data-mml-node="mi" transform="translate(2836.6,0)"><use data-c="1D441" xlink:href="#MJX-24-TEX-I-1D441"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>p</mi><mo>=</mo><mn>1</mn><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow><mi>N</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">p=1/N</script><span>时取到最大值。当N无穷大时，最大值有极限</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="10.356ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 4577.6 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-25-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-25-TEX-N-2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path><path id="MJX-25-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-25-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-25-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-25-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-25-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-25-TEX-N-37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-25-TEX-N-31"></use></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(500,0)"><g data-mml-node="mo"><use data-c="2F" xlink:href="#MJX-25-TEX-N-2F"></use></g></g><g data-mml-node="mi" transform="translate(1000,0)"><use data-c="1D452" xlink:href="#MJX-25-TEX-I-1D452"></use></g><g data-mml-node="mo" transform="translate(1743.8,0)"><use data-c="3D" xlink:href="#MJX-25-TEX-N-3D"></use></g><g data-mml-node="mn" transform="translate(2799.6,0)"><use data-c="30" xlink:href="#MJX-25-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-25-TEX-N-2E" transform="translate(500,0)"></use><use data-c="33" xlink:href="#MJX-25-TEX-N-33" transform="translate(778,0)"></use><use data-c="37" xlink:href="#MJX-25-TEX-N-37" transform="translate(1278,0)"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1</mn><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow><mi>e</mi><mo>=</mo><mn>0.37</mn></math></mjx-assistive-mml></mjx-container><script type="math/tex">1/e=0.37</script><span>。所以当有大量节点有很多帧要传输时，最多仅有37%的时隙在做有用的工作。</span></p><p><strong><span>2. ALOHA</span></strong></p><p><span>ALOHA不再要求节点需要同步时隙（从而做到完全分散），当一帧首次到达时，节点立刻将该帧完整地传输进广播信道。如果产生碰撞，这个节点将立即（在完全传输完它的碰撞帧之后）以概率p重传该帧。否则，该节点等待一个帧传输事件。在此等待之后，它则以概率p传输该帧，或者以概率1-p在另一个帧时间保持等待。</span></p><p><span>下面分析效率，仍然假设每个帧的大小相同。</span></p><p><img src="./img/ALOHA.jpg" style="zoom:50%;" /></p><p><span>上图中如何保证[t0, t0+1]时间内节点i的帧不产生碰撞呢？这要求所有其他节点在[t0-1,t0+1]的范围内不传输。概率是</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="13.631ex" height="2.587ex" role="img" focusable="false" viewBox="0 -893.3 6024.7 1143.3" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-26-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-26-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-26-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-26-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-26-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-26-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-26-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D45D" xlink:href="#MJX-26-TEX-I-1D45D"></use></g><g data-mml-node="mo" transform="translate(503,0)"><use data-c="28" xlink:href="#MJX-26-TEX-N-28"></use></g><g data-mml-node="mn" transform="translate(892,0)"><use data-c="31" xlink:href="#MJX-26-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(1614.2,0)"><use data-c="2212" xlink:href="#MJX-26-TEX-N-2212"></use></g><g data-mml-node="mi" transform="translate(2614.4,0)"><use data-c="1D45D" xlink:href="#MJX-26-TEX-I-1D45D"></use></g><g data-mml-node="msup" transform="translate(3117.4,0)"><g data-mml-node="mo"><use data-c="29" xlink:href="#MJX-26-TEX-N-29"></use></g><g data-mml-node="TeXAtom" transform="translate(422,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-26-TEX-N-32"></use></g><g data-mml-node="mo" transform="translate(500,0)"><use data-c="28" xlink:href="#MJX-26-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(889,0)"><use data-c="1D441" xlink:href="#MJX-26-TEX-I-1D441"></use></g><g data-mml-node="mo" transform="translate(1777,0)"><use data-c="2212" xlink:href="#MJX-26-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(2555,0)"><use data-c="31" xlink:href="#MJX-26-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(3055,0)"><use data-c="29" xlink:href="#MJX-26-TEX-N-29"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>p</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><msup><mo stretchy="false">)</mo><mrow data-mjx-texclass="ORD"><mn>2</mn><mo stretchy="false">(</mo><mi>N</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup></math></mjx-assistive-mml></mjx-container><script type="math/tex">p(1-p)^{2(N-1)}</script><span>，同理Slotted ALOHA的分析可以得到最大效率仅为</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="4.448ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 1966 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-27-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-27-TEX-N-2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path><path id="MJX-27-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-27-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-27-TEX-N-31"></use></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(500,0)"><g data-mml-node="mo"><use data-c="2F" xlink:href="#MJX-27-TEX-N-2F"></use></g></g><g data-mml-node="mn" transform="translate(1000,0)"><use data-c="32" xlink:href="#MJX-27-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(1500,0)"><use data-c="1D452" xlink:href="#MJX-27-TEX-I-1D452"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1</mn><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow><mn>2</mn><mi>e</mi></math></mjx-assistive-mml></mjx-container><script type="math/tex">1/2e</script><span>。是Slotted ALOHA的一半。</span></p><p><strong><span>3. CSMA</span></strong></p><p><span>在ALOHA的传输中，节点不关心在它传输时是否有其他节点碰巧在传输。而</span><strong><span>CSMA（carrier sense multiple access, 载波侦听多路访问）</span></strong><span>和</span><strong><span>CSMA/CD（CSMA with collision detection）</span></strong><span>有如下重要规则：</span></p><ul><li><p><strong><span>载波侦听（carrier sensing）</span></strong><span>：即说话前先听，没人说话我再说</span></p></li><li><p><strong><span>碰撞检测（collision detection）</span></strong><span>：即如果其他人也开始说话，那我就停止说话，并随机等待一段时间再侦听信道</span></p></li></ul><p><span>为什么有了载波侦听还是会产生碰撞呢？这是因为广播信道有</span><strong><span>信道传播时延（channel propagation delay）</span></strong><span>。即我的话要过一会儿才能被你听到，而这一会儿你可能觉得没有人在说话，于是你也开始说话了，从而产生了碰撞。</span></p><p><img src="./img/CSMA.jpg" style="zoom:50%;" /></p><p><span>CSMA/CD步骤总结如下：</span></p><ol start='' ><li><p><span>适配器从网络层获得一条数据报，准备链路层帧，并将其放入帧适配器缓存中</span></p></li><li><p><span>如果适配器侦听到信道空闲，开始传输帧；如果侦听到信道在忙，等待，直到空闲</span></p></li><li><p><span>传输过程中，适配器监视信道</span></p></li><li><p><span>如果适配器传输整个帧而未检测到其他信号，则该适配器完成了该帧；若检测到其它帧，则停止传输</span></p></li><li><p><span>中止传输后，适配器等待一个随机时间量，返回步骤2</span></p></li></ol><p><span>随机等待多久呢？想法是当碰撞节点数量较少时，等待时间较短；当碰撞节点数量较大时，等待时间较长。这里介绍</span><strong><span>二进制指数后退（binary exponential backoff）</span></strong><span>算法，被以太网和DOCSIS采用。要点有：</span></p><ul><li><p><span>帧经历一连串n次碰撞，节点随机从</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="23.238ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 10271 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-28-TEX-N-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path><path id="MJX-28-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-28-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-28-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-28-TEX-N-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path><path id="MJX-28-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-28-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-28-TEX-N-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="7B" xlink:href="#MJX-28-TEX-N-7B"></use></g><g data-mml-node="mn" transform="translate(500,0)"><use data-c="30" xlink:href="#MJX-28-TEX-N-30"></use></g><g data-mml-node="mi" transform="translate(1000,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mn" transform="translate(1884,0)"><use data-c="31" xlink:href="#MJX-28-TEX-N-31"></use></g><g data-mml-node="mi" transform="translate(2384,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mn" transform="translate(3268,0)"><use data-c="32" xlink:href="#MJX-28-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(3768,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mo" transform="translate(4818.7,0)"><use data-c="2026" xlink:href="#MJX-28-TEX-N-2026"></use></g><g data-mml-node="mi" transform="translate(6157.3,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="msup" transform="translate(7041.3,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-28-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><use data-c="1D45B" xlink:href="#MJX-28-TEX-I-1D45B"></use></g></g><g data-mml-node="mo" transform="translate(8270.8,0)"><use data-c="2212" xlink:href="#MJX-28-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(9271,0)"><use data-c="31" xlink:href="#MJX-28-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(9771,0)"><use data-c="7D" xlink:href="#MJX-28-TEX-N-7D"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo fence="false" stretchy="false">{</mo><mn>0</mn><mi>，</mi><mn>1</mn><mi>，</mi><mn>2</mn><mi>，</mi><mo>…</mo><mi>，</mi><msup><mn>2</mn><mi>n</mi></msup><mo>−</mo><mn>1</mn><mo fence="false" stretchy="false">}</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">\{0，1，2，…，2^n-1\}</script><span>选择一个K值</span></p></li><li><p><span>n最大值为10</span></p></li><li><p><span>一个帧经历碰撞越多，K选择的间隔越大</span></p></li><li><p><span>以太网中，一个节点等待的实际时间是发送512比特进入以太网所需时间的K倍</span></p></li></ul><p><span>CSMA/CD效率如何呢？近似式为：</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n1788" cid="n1788" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="31.121ex" height="5.292ex" role="img" focusable="false" viewBox="0 -1342 13755.3 2339.2" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -2.256ex;"><defs><path id="MJX-8-TEX-I-1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path><path id="MJX-8-TEX-I-1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path><path id="MJX-8-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-8-TEX-I-1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path><path id="MJX-8-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-8-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-8-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-8-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-8-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-8-TEX-N-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path id="MJX-8-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path id="MJX-8-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-8-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-8-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-8-TEX-I-1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path><path id="MJX-8-TEX-N-2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path><path id="MJX-8-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-8-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-8-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D438" xlink:href="#MJX-8-TEX-I-1D438"></use></g><g data-mml-node="mi" transform="translate(764,0)"><use data-c="1D453" xlink:href="#MJX-8-TEX-I-1D453"></use></g><g data-mml-node="mi" transform="translate(1314,0)"><use data-c="1D453" xlink:href="#MJX-8-TEX-I-1D453"></use></g><g data-mml-node="mi" transform="translate(1864,0)"><use data-c="1D456" xlink:href="#MJX-8-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(2209,0)"><use data-c="1D450" xlink:href="#MJX-8-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(2642,0)"><use data-c="1D456" xlink:href="#MJX-8-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(2987,0)"><use data-c="1D452" xlink:href="#MJX-8-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(3453,0)"><use data-c="1D45B" xlink:href="#MJX-8-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(4053,0)"><use data-c="1D450" xlink:href="#MJX-8-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(4486,0)"><use data-c="1D466" xlink:href="#MJX-8-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(5253.8,0)"><use data-c="3D" xlink:href="#MJX-8-TEX-N-3D"></use></g><g data-mml-node="mfrac" transform="translate(6309.6,0)"><g data-mml-node="mn" transform="translate(3472.9,676)"><use data-c="31" xlink:href="#MJX-8-TEX-N-31"></use></g><g data-mml-node="mrow" transform="translate(220,-710)"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-8-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(722.2,0)"><use data-c="2B" xlink:href="#MJX-8-TEX-N-2B"></use></g><g data-mml-node="mn" transform="translate(1722.4,0)"><use data-c="35" xlink:href="#MJX-8-TEX-N-35"></use></g><g data-mml-node="msub" transform="translate(2222.4,0)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-8-TEX-I-1D451"></use></g><g data-mml-node="TeXAtom" transform="translate(553,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45D" xlink:href="#MJX-8-TEX-I-1D45D"></use></g><g data-mml-node="mi" transform="translate(503,0)"><use data-c="1D45F" xlink:href="#MJX-8-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(954,0)"><use data-c="1D45C" xlink:href="#MJX-8-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(1439,0)"><use data-c="1D45D" xlink:href="#MJX-8-TEX-I-1D45D"></use></g></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(4198.6,0)"><g data-mml-node="mo"><use data-c="2F" xlink:href="#MJX-8-TEX-N-2F"></use></g></g><g data-mml-node="msub" transform="translate(4698.6,0)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-8-TEX-I-1D451"></use></g><g data-mml-node="TeXAtom" transform="translate(553,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-8-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D45F" xlink:href="#MJX-8-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(812,0)"><use data-c="1D44E" xlink:href="#MJX-8-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(1341,0)"><use data-c="1D45B" xlink:href="#MJX-8-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(1941,0)"><use data-c="1D460" xlink:href="#MJX-8-TEX-I-1D460"></use></g></g></g></g><rect width="7205.8" height="60" x="120" y="220"></rect></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>E</mi><mi>f</mi><mi>f</mi><mi>i</mi><mi>c</mi><mi>i</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>y</mi><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><mn>5</mn><msub><mi>d</mi><mrow data-mjx-texclass="ORD"><mi>p</mi><mi>r</mi><mi>o</mi><mi>p</mi></mrow></msub><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow><msub><mi>d</mi><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>s</mi></mrow></msub></mrow></mfrac></math></mjx-assistive-mml></mjx-container></div></div><p><span>式中</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="4.471ex" height="2.22ex" role="img" focusable="false" viewBox="0 -694 1976.2 981.2" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.65ex;"><defs><path id="MJX-29-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-29-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-29-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-29-TEX-I-1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-29-TEX-I-1D451"></use></g><g data-mml-node="TeXAtom" transform="translate(553,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45D" xlink:href="#MJX-29-TEX-I-1D45D"></use></g><g data-mml-node="mi" transform="translate(503,0)"><use data-c="1D45F" xlink:href="#MJX-29-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(954,0)"><use data-c="1D45C" xlink:href="#MJX-29-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(1439,0)"><use data-c="1D45D" xlink:href="#MJX-29-TEX-I-1D45D"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>d</mi><mrow data-mjx-texclass="ORD"><mi>p</mi><mi>r</mi><mi>o</mi><mi>p</mi></mrow></msub></math></mjx-assistive-mml></mjx-container><script type="math/tex">d_{prop}</script><span>是信道传播时延，</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="5.22ex" height="1.927ex" role="img" focusable="false" viewBox="0 -694 2307.1 851.8" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.357ex;"><defs><path id="MJX-30-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-30-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-30-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-30-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-30-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-30-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-30-TEX-I-1D451"></use></g><g data-mml-node="TeXAtom" transform="translate(553,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-30-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D45F" xlink:href="#MJX-30-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(812,0)"><use data-c="1D44E" xlink:href="#MJX-30-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(1341,0)"><use data-c="1D45B" xlink:href="#MJX-30-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(1941,0)"><use data-c="1D460" xlink:href="#MJX-30-TEX-I-1D460"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>d</mi><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>s</mi></mrow></msub></math></mjx-assistive-mml></mjx-container><script type="math/tex">d_{trans}</script><span>是传输一个最大长度的以太网帧的时间。可见当</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="14.468ex" height="2.22ex" role="img" focusable="false" viewBox="0 -694 6394.9 981.2" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.65ex;"><defs><path id="MJX-31-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-31-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-31-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-31-TEX-I-1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path><path id="MJX-31-TEX-N-3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"></path><path id="MJX-31-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-31-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-31-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-31-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-31-TEX-I-1D451"></use></g><g data-mml-node="TeXAtom" transform="translate(553,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45D" xlink:href="#MJX-31-TEX-I-1D45D"></use></g><g data-mml-node="mi" transform="translate(503,0)"><use data-c="1D45F" xlink:href="#MJX-31-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(954,0)"><use data-c="1D45C" xlink:href="#MJX-31-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(1439,0)"><use data-c="1D45D" xlink:href="#MJX-31-TEX-I-1D45D"></use></g></g></g><g data-mml-node="mo" transform="translate(2254,0)"><g data-mml-node="text"><use data-c="3C" xlink:href="#MJX-31-TEX-N-3C"></use></g><g data-mml-node="text" transform="translate(778,0)"><use data-c="3C" xlink:href="#MJX-31-TEX-N-3C"></use></g></g><g data-mml-node="msub" transform="translate(4087.8,0)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-31-TEX-I-1D451"></use></g><g data-mml-node="TeXAtom" transform="translate(553,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-31-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D45F" xlink:href="#MJX-31-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(812,0)"><use data-c="1D44E" xlink:href="#MJX-31-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(1341,0)"><use data-c="1D45B" xlink:href="#MJX-31-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(1941,0)"><use data-c="1D460" xlink:href="#MJX-31-TEX-I-1D460"></use></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>d</mi><mrow data-mjx-texclass="ORD"><mi>p</mi><mi>r</mi><mi>o</mi><mi>p</mi></mrow></msub><mo>&lt;&lt;</mo><msub><mi>d</mi><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>s</mi></mrow></msub></math></mjx-assistive-mml></mjx-container><script type="math/tex">d_{prop}<<d_{trans}</script><span>的时候，效率为1，这是与直观相符合的。</span></p><h3 id='633-轮流协议'><span>6.3.3 轮流协议</span></h3><p><span>这里介绍两种</span></p><ul><li><p><strong><span>轮询协议（polling protocol）</span></strong></p><ul><li><p><span>指定一个主结点，以循环的方式轮询每个结点</span></p></li><li><p><span>主结点首先向结点A发送一个报文，告知A能传输帧的最大数量。A传完后，主结点告诉B能传帧的最多数量，如此循环</span></p></li><li><p><span>缺点：有轮询时延，即通知一个节点它可以传输所需的时间；主结点故障导致整个信道崩溃</span></p></li></ul></li><li><p><strong><span>令牌传递协议（token-passing protocol）</span></strong></p><ul><li><p><span>没有主结点，一个叫令牌token的特殊帧在结点之间以固定次序交换，如1发给2，2发给3，N发给1，就像网络拓扑结构中的环状网络令牌</span></p></li><li><p><span>当一个结点收到令牌时，有帧发送，则发送最大数量的帧，然后转发令牌；没帧发送，直接把令牌转发</span></p></li><li><p><span>缺点：单点故障导致整个信道崩溃</span></p></li></ul></li></ul><h3 id='634-案例docsis'><span>6.3.4 案例：DOCSIS</span></h3><p><span>DOCSIS即Data-Over-Cable Service Interface Specifications，定义了电缆数据网络体系结构及其协议。我们将看到它采用了多路访问协议的全部三种类型。</span></p><p><img src="./img/DOCSIS.jpg" style="zoom:50%;" /></p><ul><li><p><span>信道划分</span></p><ul><li><p><span>使用FDM划分上行和下行信道。</span></p></li><li><p><span>由于CMTS（cable modem termination system）只有一个，下行信道不会产生碰撞，而上行会。使用TDM划分了mini-slot（微时隙）解决，也就是把mini-slot明确分配给电缆调制解调器。</span></p></li></ul></li><li><p><span>随机接入</span></p><ul><li><p><span>但是CMTS一开始如何知道哪个电缆调制解调器要发数据呢？这是通过让电缆调制解调器在专用于此目的的一组特殊微时隙间隔内向CMTS发送微时隙请求帧来实现的。而微时隙请求帧以随机接入方式传输，可能产生碰撞。由于modem无法侦听上行行道也无法检测碰撞，所以若modem没有在下一个下行控制报文（MAP帧）收到对请求分配的响应的话，就推断出它的微时隙请求帧发生了碰撞。</span></p></li></ul></li></ul><p><em><span>所以轮流协议体现在哪里呢？？？</span></em></p><h2 id='64-交换局域网'><span>6.4 交换局域网</span></h2><p><img src="./img/lan.jpg" style="zoom:50%;" /></p><p><span>上图是一个由4台交换机连接起来的网络。第一章已经提及交换机运行在链路层，不使用网络层地址。</span></p><h3 id='641-链路层寻址和arp'><span>6.4.1 链路层寻址和ARP</span></h3><p><strong><span>1. MAC地址</span></strong></p><p><span>链路层地址也叫</span><strong><span>LAN地址</span></strong><span>、</span><strong><span>物理地址</span></strong><span>、</span><strong><span>MAC地址</span></strong><span>，但是MAC地址最为常见。类似IP协议，主机或路由器与它任意一条链路之间的边界（即网络接口，适配器）有自己的MAC地址。注意到链路层交换机并不要求要有MAC地址。这是因为链路层交换机的任务是在主机与路由器之间承载数据报，它将透明地执行这项任务，也就是说主机或路由器不必明确地将帧寻址到其间的交换机。</span></p><p><img src="./img/macaddr.jpg" style="zoom:50%;" /></p><p><span>此外，一些要点如下：</span></p><ul><li><p><span>MAC地址长度6字节，共有2^48个可能的MAC地址。通常用十六进制表示法，如5C-66-AB-90-75-B1</span></p></li><li><p><span>MAC地址一般是固定的（也有软件改变适配器MAC地址的可能），像身份证号</span></p></li><li><p><span>没有两块适配器有相同的MAC地址，MAC地址空间由IEEE管理，IEEE给公司固定前24个比特，后面24个比特让公司自己去生成</span></p></li><li><p><span>MAC地址是扁平结构，而IP地址是层次结构</span></p></li><li><p><span>当适配器接受一个并非向它寻址的帧时，检查帧中的目的MAC地址与自己的MAC地址是否匹配，若匹配则取出数据报，向上传递，否则丢弃</span></p></li><li><p><span>适配器通过MAC广播地址FF-FF-FF-FF-FF-FF来广播</span></p></li></ul><p><strong><span>为什么有了网络层地址外还要MAC地址？</span></strong></p><ul><li><p><span>局域网是为任意网络层协议而设计的，而不只是用于IP和因特网。如果适配器被指派IP地址而不是中性的MAC地址的话，则适配器将不能方便地支持其他网络层协议</span></p></li><li><p><span>如果适配器使用网络层地址而不是MAC地址的话，网络层地址必须存储在适配器的RAM中，并且在每次适配器移动时要重新配置。另一种选择是在适配器中不适用任何地址，让每个适配器将它收到的每帧数据沿协议栈向上传递。然后网络层则能核对网络地址层是否匹配。这种选择所带来的问题是，主机将被局域网上发送的每个帧中断，包括被目的地是在相同广播局域网上的其他节点的帧中断。</span></p></li><li><p><span>总之，为了使各层保持独立，它们需要自己的寻址方案。如应用层的主机名、网络层的IP地址和链路层的MAC地址。</span></p></li></ul><p><strong><span>2. ARP</span></strong></p><p><span>我们知道我们只需要通过IP地址就可以访问其他主机，但是链路层又要求我们要知道MAC地址。这便是</span><strong><span>地址解析协议（Address Resolution Protocol, ARP）</span></strong><span>的任务。下面通过一个例子说明</span></p><p><img src="./img/ARP.jpg" style="zoom:50%;" /></p><p><span>该例中，主机C想发送数据给主机A。那它是怎么确定222.222.222.222对应的MAC地址呢？主机C将向它的ARP模块提供IP地址222.222.222.222，而ARP模块将返回相应的MAC地址49-BD-D2-C7-56-2A。注意到，不同于DNS为因特网中任何地方的主机解析主机名，ARP只为在同一个子网上的主机和路由器接口解析IP地址。</span></p><p><span>那具体是如何做到IP解析的呢？要点如下：</span></p><ul><li><p><span>每台主机和路由器在内存中有一个</span><strong><span>ARP表</span></strong><span>，包含IP地址到MAC地址的映射关系，表项过期时间通常为20分钟</span></p></li><li><p><span>若发送方的ARP表没有目的主机的表项，则发送方用ARP协议来解析这个地址</span></p><ul><li><p><span>首先发送方构造一个</span><strong><span>ARP分组</span></strong><span>，字段包括发送和接收IP地址和MAC地址</span></p></li><li><p><span>适配器用MAC广播地址（FF-FF-FF-FF-FF-FF）发送该ARP查询分组，每个适配器都把ARP分组向上传递给ARP模块，检查自己的IP地址和分组中的目的IP地址是否一致</span></p></li><li><p><span>匹配的主机发送回一个ARP响应分组（不是广播），然后查询主机便可以更新它的ARP表，并发送它的IP数据报</span></p></li></ul></li></ul><p><span>注意到</span></p><ul><li><p><span>ARP是即插即用的（plug-and-play），ARP表是自动建立的，不需要管理员来配置。</span></p></li><li><p><span>ARP分组封装在链路层帧中，但是分组具有包含链路层地址的字段，所以可以将ARP看成是跨越链路层和网络层边界的协议</span></p></li></ul><p><strong><span>3. 发送数据到子网以外</span></strong></p><p><span>ARP只能实现子网内的IP解析，那么如果这个IP地址位于子网外怎么办？</span></p><p><img src="./img/ARP2.jpg" style="zoom:50%;" /></p><p><span>譬如上图中111.111.111.111想要发数据给222.222.222.222。适当的MAC地址是第一跳路由器（网关）的MAC地址E6-E9-00-17-BB-4B（网关的IP地址可以手动设置，或者通过DHCP，再利用ARP得到网关的MAC地址）。111.111.111.110适配器分析该帧中的IP地址，利用转发表，交给222.222.222.220适配器。该适配器把数据报封装到一个新的帧中，此时该帧便和目标主机在同一个子网下了。</span></p><h3 id='642-以太网'><span>6.4.2 以太网</span></h3><p><strong><span>以太网（Ethernet）</span></strong><span>占据着现有的有线局域网市场，就像因特网之于全球联网的地位。</span></p><p><span>以太网帧结构如下：</span></p><p><img src="./img/ethernetFrame.jpg" style="zoom:67%;" /></p><ul><li><p><strong><span>数据字段</span></strong><span>（46~1500字节）：承载了IP数据报，超过1500字节（MTU，最大传输单元）的数据报需要分片；若小于46字节，需要填充到46字节</span></p></li><li><p><strong><span>目的地址</span></strong><span>（6字节）：目的适配器的MAC地址。当目的适配器收到一个以太网帧，若目的地址是自己的MAC地址或广播地址，将数据字段传给网络层，其他则丢弃</span></p></li><li><p><strong><span>源地址</span></strong><span>（6字节）</span></p></li><li><p><strong><span>类型字段</span></strong><span>（2字节）：允许以太网复用多种网络层协议</span></p></li><li><p><strong><span>CRC</span></strong><span>（4字节）：循环冗余检测</span></p></li><li><p><strong><span>前同步码preamble</span></strong><span>（8字节）：以太网帧以前同步码开始，前7个字节用于唤醒接收适配器，同步发送方接收方时钟，第8个字节最后两个比特（11）警告目的适配器，重要内容来了</span></p></li></ul><p><span>以太网提供的服务是</span></p><ul><li><p><strong><span>无连接的</span></strong><span>：不需要握手</span></p></li><li><p><strong><span>不可靠的</span></strong><span>：没有通过CRC校验只是丢弃</span></p></li></ul><p><span>此外，以太网标准包括了CSMA/CD协议，但是在当下基于交换机的星形拓扑网络下，不会产生碰撞，甚至MAC协议都是不必要的。</span></p><h3 id='643-链路层交换机'><span>6.4.3 链路层交换机</span></h3><p><span>交换机相关特点有：</span></p><ul><li><p><span>交换机的任务：接收入链路层帧，转发到出链路</span></p></li><li><p><span>交换机自身对子网中的主机和路由器是透明的，主机/路由器向另一个主机/路由器寻址一个帧，开心地将帧发送进局域网，并不知道交换机干嘛</span></p></li><li><p><span>交换机输出接口设有缓存</span></p></li><li><p><span>交换机是即插即用设备，管理员无需配置</span></p></li><li><p><span>交换机是双工的，任何交换机接口能同时发送和接收</span></p></li></ul><p><strong><span>转发和过滤</span></strong></p><p><span>现在假定目的地址为DD-DD-DD-DD-DD-DD的帧从交换机接口x到达。有三种可能：</span></p><ul><li><p><span>表中没有该地址，交换机向除接口x外的所有接口广播该帧</span></p></li><li><p><span>表中有表项将该地址与接口x联系起来，过滤掉（即扔掉）</span></p></li><li><p><span>表中有表项将该地址与接口y≠x联系起来，该帧需要被转发到与接口y相连的局域网段，放到接口y前的输出缓存，完成转发功能</span></p></li></ul><p><strong><span>自学习</span></strong><span>——交换机表是自动、动态建立的</span></p><ul><li><p><span>交换机表初始为空</span></p></li><li><p><span>对于每个接口接收到的每个入帧，交换机在其表中存储</span></p><ul><li><p><span>该帧源MAC地址</span></p></li><li><p><span>帧到达的接口</span></p></li></ul></li><li><p><span>一段时间后，交换机没有再接受到以该地址作为源地址的帧，在表中删除该地址</span></p></li></ul><p><strong><span>链路层交换机的性质</span></strong></p><ul><li><p><strong><span>消除碰撞</span></strong><span>：交换机缓存帧并且不会在网段上同时传输多于一个帧，交换机提供了比广播链路局域网高的多的性能改善</span></p></li><li><p><strong><span>异质的链路</span></strong><span>：交换机将链路彼此隔离，因此局域网中的不同链路能够以不同速率运行，在不同媒介上运行</span></p></li><li><p><strong><span>网络管理</span></strong><span>：交换机可以主动断开异常适配器；收集带宽使用的统计数据、碰撞率和流量类型，这些信息用来调试解决问题</span></p></li></ul><p><strong><span>交换机和路由器比较</span></strong><span>：路由器是第三层的分组交换机，交换机是第二层的分组交换机</span></p><ul><li><p><span>交换机：</span></p><ul><li><p><span>优点：即插即用；相对高的分组过滤和转发速率</span></p></li><li><p><span>缺点：防止广播帧循环，交换网络的活跃拓扑限制为一颗生成树；大型交换网络要求在主机和路由器中有大的ARP表，生成大量ARP流量和处理量；对广播风暴（即某主机出了故障并传输没完没了的广播帧流）不提供任何保护，使得以太网崩溃</span></p></li></ul></li><li><p><span>路由器：</span></p><ul><li><p><span>优点：分组不会被限制到生成树上，可以使用源到目的地的最佳路径，拓扑结构更加丰富；对第二层的广播风暴提供了防火墙保护</span></p></li><li><p><span>缺点：不是即插即用，需要人为配置IP地址；对分组处理时间较长，因为必须处理第三层字段</span></p></li></ul></li></ul><p><img src="./img/fig624.jpg" style="zoom:50%;" /></p><p><span>通常，在几百台主机组成的小网络使用交换机就够了；但是对于几千台主机组成的更大网络中，还需要使用路由器，来提供更健壮的流量隔离方式（流量隔离的解释见6.4.4节）和对广播风暴的控制。</span></p><h3 id='644-虚拟局域网'><span>6.4.4 虚拟局域网</span></h3><p><img src="./img/lan.jpg" style="zoom:50%;" /></p><p><span>上图的配置存在3个缺点：</span></p><ul><li><p><strong><span>缺乏流量隔离（traffic isolation）</span></strong><span>：广播流量会传送到整个机构网络上，影响局域网的性能和安全</span></p></li><li><p><strong><span>交换机的无效使用</span></strong><span>：一个交换机有几十个端口，但是一个系如果人比较少，很多端口就浪费了</span></p></li><li><p><strong><span>管理用户</span></strong><span>：如果一个雇员在不同组间移动，必须改变物理布线</span></p></li></ul><p><span>上述问题可以通过支持</span><strong><span>虚拟局域网（virtual local area networks, VLAN）</span></strong><span>来解决。也就是在一个交换机上创建多个虚拟局域网，管理员只需重新配置VLAN软件便可以实现。</span></p><p><img src="./img/vlan.jpg" style="zoom: 67%;" /></p><p><span>但来自电子工程系的流量如何才能发送到计算机系呢？一种解决方法是将VLAN交换机的一个端口（譬如上图的端口1）与一台外部的路由器相连，并且将该端口配置为同属于EE和CS。幸运的是交换机厂商帮你省去了这个麻烦。</span></p><p><em><span>书上关于VLAN还有一小些内容，这里不再整理。</span></em></p><h2 id='65-link-virtualization-a-network-as-a-link-layer'><span>6.5 Link Virtualization: A Network as a Link Layer</span></h2><p><span>本节介绍了MPLS（Multiprotocol Label Switching），它在链路层和网络层首部之间加入了MPLS首部，可以改善IP路由器的转发速度。具体内容这里不再整理。</span></p><h2 id='66-数据中心网络'><span>6.6 数据中心网络</span></h2><p><img src="./img/dataCenter.jpg" style="zoom:50%;" /></p><p><span>数据中心中的主机称为</span><strong><span>刀片（blade）</span></strong><span>，被堆放在</span><strong><span>机架（rack）</span></strong><span>上。每个机架顶部有一个交换机，称为机架顶部（Top of Rack, TOR）交换机。数据中心网络包含了一台或多台</span><strong><span>边界路由器（border router）</span></strong><span>，将数据中心网络和公共因特网相连。</span></p><p><strong><span>负载均衡器（load balancer）</span></strong><span>负责向主机分发外部请求，平衡主机间的工作负载。此外负载均衡器还提供类似NAT的功能，进行外部IP地址和内部适当主机的IP地址之间的转换。</span></p><p><span>对于上万主机规模，通常会应用</span><strong><span>路由器和交换机等级结构（hierarchy of router and switch）</span></strong><span>。</span></p><p><em><span>书上关于数据中心网络还有一些内容，这里不再整理。</span></em></p><h2 id='67-web页面请求的历程'><span>6.7 Web页面请求的历程</span></h2><p><span>本节我们将详细讨论Bob在学校网络下载Google主页的过程。Bob把他的笔记本电脑用一根以太网电缆连接到学校的以太网交换机，以太网交换机又与学校的路由器相连，路由器再与ISP（本例中为comcast.net）相连。</span></p><p><img src="./img/webPageRequest.jpg" style="zoom:50%;" /></p><h3 id='671-准备dhcpudpip和以太网'><span>6.7.1 准备：DHCP、UDP、IP和以太网</span></h3><ol start='' ><li><p><span>Bob笔记本的操作系统生成一个DHCP请求报文，并将这个报文放入具有目的端口67和源端口68的UDP报文段。该UDP报文段则被放置在一个具有广播IP目的地址（255.255.255.255）和源IP地址0.0.0.0的IP数据报中</span></p></li><li><p><span>包含DHCP请求报文的IP数据报则被放置在以太网帧中。该以太网帧具有目的MAC地址FF:FF:FF:FF:FF:FF，使该帧将广播到与交换机连接的所有设备（其中包含DHCP服务器）；该帧的源MAC地址是Bob笔记本的MAC地址00:16:D3:23:68:8A</span></p></li></ol><figure><table><thead><tr><th><span>协议层</span></th><th><span>数据</span></th></tr></thead><tbody><tr><td><span>应用层</span></td><td><span>DHCP 请求报文</span></td></tr><tr><td><span>传输层</span></td><td><span>UDP 源端口 68 目的端口 67</span></td></tr><tr><td><span>网络层</span></td><td><span>源 IP 0.0.0.0 目的 IP 255.255.255.255</span></td></tr><tr><td><span>链路层</span></td><td><span>源 MAC 00:16:D3:23:68:8A 目的 MAC FF:FF:FF:FF:FF:FF</span></td></tr></tbody></table></figure><ol start='3' ><li><p><span>包含DHCP请求的广播以太网帧是第一个由Bob笔记本发送到以太网交换机的帧。该交换机在所有的出端口广播该帧，包括连接到路由器的端口。同时交换机会在交换机表中新添加一条记录，内容包括 MAC 地址、通往该 MAC 地址的交换机接口和该记录放置在表中的时间。</span></p></li><li><p><span>路由器在它的具有MAC地址00:22:6B:45:1F:1B的接口接收到该广播以太网帧，并且从该以太网帧中抽取出IP数据报。该数据报的广播IP目的地址指示了这个IP数据报应当由在该节点的高层协议处理，因此该数据报的载荷被分解向上到达UDP，DHCP请求报文从此UDP报文段中抽取出来。此时DHCP服务器有了DHCP请求报文。</span><em><span>这里似乎假定了DHCP服务器在路由器中</span></em></p></li><li><p><span>我们假设运行在路由器中的 DHCP 服务器能够以 CIDR 块 68.85.2.0/24 分配 IP 地址，然后分配地址 68.85.2.101 给 Bob 计算机。DHCP 服务器生成一个 DHCP ACK 报文，包含内容</span></p><ul><li><p><span>IP地址：68.85.2.101</span></p></li><li><p><span>DNS服务器IP地址：68.87.71.226</span></p></li><li><p><span>默认网关路由器（第一跳路由）：68.85.2.1</span></p></li><li><p><span>子网掩码：68.85.2.0/24</span></p></li></ul><p><span>该 DHCP 报文被放入一个 UDP 报文段中，UDP 报文段被放入一个 IP 数据报中，IP 数据报再被放入一个以太网帧中。这个以太网帧的源 MAC 地址是路由器连到归属网络时接口的 MAC 地址（00:22:6B:45:1F:1B），目的 MAC 地址是 Bob 计算机的 MAC 地址（00-16-D3-23-68-8A）。</span></p></li><li><p><span>包含 DHCP ACK 报文的以太网帧由路由器发送给交换机。因为交换机是自学习的，并且先前从 Bob 计算机收到（包含 DHCP 请求的）以太网帧，所以该交换机从交换机表中查询到通往 Bob 计算机 MAC 地址 00:22:6B:45:1F:1B 的相应接口。</span></p></li><li><p><span>Bob 计算机接收到包含 DHCP ACK 的以太网帧，从该以太网帧中抽取 IP 数据报，从 IP 数据报中抽取 UDP 报文段，从 UDP 报文段中抽取 DHCP ACK 报文。Bob 的 DHCP 客户则记录下它的 IP 地址和它的 DNS 服务器的 IP 地址。它还在其 IP 转发表中安装默认网关的地址。</span><em><span>4.3.3节介绍DHCP有四步，这里似乎简化成了两步</span></em></p></li></ol><h3 id='672-仍在准备dns和arp'><span>6.7.2 仍在准备：DNS和ARP</span></h3><ol start='8' ><li><p><span>Bob 计算机上的操作系统生成一个 DNS 查询报文，将字符串 </span><a href='http://www.google.com/'><span>www.google.com</span></a><span> 放入 DNS 报文的问题段中。该 DNS 报文则放置在一个具有 53 号（DNS 服务器）目的端口的 UDP 报文段中。该 UDP 报文段则被放入具有 IP 目的地址 68.87.71.226（在 DHCP ACK 返回的 DNS 服务器地址）和源地址 68.85.2.101 的 IP 数据报中。</span></p></li><li><p><span>Bob 计算机把包含 DNS 请求报文的数据报放入一个以太网帧中。该帧将发送到（在链路层寻址）Bob 学校网络中的网关路由器。目前仅从 DHCP ACK 报文知道学校网关路由器的 IP 地址 65.85.2.1，但不知道网关路由器的 MAC 地址。此时就需要 ARP 协议提供 IP 地址到 MAC 地址的转换服务。</span></p></li><li><p><span>Bob 的计算机生成一个具有目的 IP 地址 68.85.2.1（默认网关）的 ARP 查询报文，将该 ARP 报文放置在一个具有广播目的地址 FF:FF:FF:FF:FF:FF 的以太网帧中，并向交换机发送该以太网帧，交换机将该帧交付给所有连接的设备，包括网关路由器。</span></p></li><li><p><span>网关路由器在通往学校网络的接口上接收到包含该 ARP 查询报文的帧，发现在 ARP 报文中的目标地址 68.85.2.1 匹配其接口地址。网关路由器因此准备一个 ARP 回答，指示 IP 地址 68.85.2.1 对应的 MAC 地址为 00:22:6B:45:1F:1B。它将 ARP 回答放在一个以太网帧中，其目的地址为 00:16:D3:23:68:8A（Bob 的计算机），并向交换机发送该帧，再由交换机将帧交付给 Bob 的计算机。</span></p></li><li><p><span>Bob 计算机收到包含 ARP 回到报文的帧，并从 ARP 回答报文中抽取网关路由器的 MAC 地址（00:22:6B:45:1F:1B），在本地 ARP 表中创建一条新的记录。</span></p></li><li><p><span>Bob&#39;s laptop can now address the Ethernet frame containing the DNS query to the gateway router&#39;s MAC address。 注意到在该帧中的 IP 数据报具有 IP 目的地址 68.87.71. 226 (DNS 服务器) , 而该帧具有目的地 00: 22: 6B: 45: 1F: 1B (网关路由器) 。Bob 便携机向交换机发送该帧， 交换机将该帧交付给网关路由器。</span></p></li></ol><h3 id='673-仍在准备域内路由选择到dns服务器'><span>6.7.3 仍在准备：域内路由选择到DNS服务器</span></h3><ol start='14' ><li><p><span>网关路由器接收该帧并抽取包含 DNS 查询的 IP 数据报。路由器查找该数据报的目的地址（68.87.71.226），并根据其转发表决定该数据报应道发送到 Comcast 网络中最左边的路由器。</span></p></li><li><p><span>Comcast 最左边的路由器接到该帧，抽取 IP 数据报，检查该数据报的目的地址（68.87.71.226），并根据其转发表确定接口，经过该接口朝着 DNS 服务器转发数据报，而转发表已根据 Comcast 的域内协议（如 RIP、OSPF 或 IS-IS）以及因特网的域间协议 BGP 所填写。</span></p></li><li><p><span>最终包含 DNS 查询的 IP 数据报到达了 DNS 服务器。DNS 服务器抽取出 DNS 查询报文，在它的 DNS 数据库中查找域名 </span><a href='http://www.google.com' target='_blank' class='url'>www.google.com</a><span>，找到包含对应</span><a href='http://www.google.com' target='_blank' class='url'>www.google.com</a><span>的 IP 地址（64.233.169.105）的 DNS 源记录。该 DNS 服务器形成了一个包含这种主机名到 IP 地址映射的 DNS 回答报文，将该 DNS 回答报文放入 UDP 报文段中，该报文段放入寻址到 Bob 计算机的 IP 数据报中。该数据报将通过 Comcast 网络反向转发到学校的路由器，并从这里经过以太网交换机到 Bob 计算机。</span></p></li><li><p><span>Bob 计算机从 DNS 报文抽取出服务器 </span><a href='http://www.google.com/'><span>www.google.com</span></a><span> 的 IP 地址，并添加到浏览器的 DNS 缓存中。</span></p></li></ol><h3 id='674-web客户-服务器交互tcp和http'><span>6.7.4 Web客户-服务器交互：TCP和HTTP</span></h3><ol start='18' ><li><p><span>Bob 便携机有了 </span><a href='http://www.google.com' target='_blank' class='url'>www.google.com</a><span> 的 IP 地址，它能够生成 TCP 套接字 ，该套接字将用于向 </span><a href='http://www.google.com' target='_blank' class='url'>www.google.com</a><span> 发送 HTTP GET 报文 。Bob 生成 TCP 套接字时，在 Bob 便携机中的 TCP 必须首先与 </span><a href='http://www.google.com' target='_blank' class='url'>www.google.com</a><span> 中的 TCP 执行三次握手。Bob 便携机因此首先生成一个具有目的端口 80 (针对 HTTP 的)的 TCP SYN 报文段，将该 TCP 报文段放置在具有目的 IP 地址 64.233.169.105 (</span><a href='http://www.google.com' target='_blank' class='url'>www.google.com</a><span>) 的 IP 数据报中，将该数据报放置在 MAC 地址为 00:22:6B:45:1F:1B (网关路由器)的帧中， 并向交换机发送该帧。</span></p></li><li><p><span>在学校网络、 Comcast 网络和谷歌网络中的路由器朝着</span><a href='http://www.google.com' target='_blank' class='url'>www.google.com</a><span> 转发包含 TCP SYN 的数据报，使用每台路由器中的转发表。 </span></p></li><li><p><span>最终，包含 TCP SYN 的数据报到达 </span><a href='http://www.google.com' target='_blank' class='url'>www.google.com</a><span>。 从数据报抽取出 TCP SYN 报文并分解到与端口 80 相联系的欢迎套接字。 对于谷歌 HTTP 服务器和 Bob 便携机之间的 TCP 连接生成一个连接套接字。 产生一个 TCP SYNACK 报文段， 将其放入向 Bob 便携机寻址的一个数据报中，最后放入链路层帧。</span></p></li><li><p><span>包含 TCP SYNACK 报文段的数据报通过谷歌、 Comcast 和学校网络，最终到达 Bob 便携机的以太网卡。 数据报在操作系统中分解到步骤 18 生成的 TCP 套接字，从而进入连接状态</span></p></li><li><p><span>借助于 Bob 计算机上的套接字，现在准备向 </span><a href='http://www.google.com' target='_blank' class='url'>www.google.com</a><span> 发送字节了， Bob 的浏览器生成包含要获取的 URL 的 HTTP GET 报文。 HTTP GET 报文则写入套接字，其中 GET 报文成为一个 TCP 报文段的载荷。 该 TCP 报文段放置进一个数据报，交付到 </span><a href='http://www.google.com' target='_blank' class='url'>www.google.com</a><span> ，如前面步骤 18 -20 所述。</span></p></li><li><p><span>在 </span><a href='http://www.google.com' target='_blank' class='url'>www.google.com</a><span> 的 HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一 个 HTTP 响应报文，将请求的 Web 页内容放入 HTTP 响应体中，并将报文发送进 TCP 套接字中。</span></p></li><li><p><span>包含 HTTP 回答报文的数据报通过谷歌、 Comcast 和学校网络转发，到达 Bob 计算机。 Bob 的 Web 浏览器程序从套接字读取 HTTP 响应，从 HTTP 响应体中抽取 Web 网页 的 html，终于显示了 Web 网页。</span></p></li></ol><hr /><p>&nbsp;</p><h1 id='七无线网络和移动网络'><span>七、无线网络和移动网络</span></h1><p><span>开始前先区分两个概念——</span><strong><span>无线（wireless）</span></strong><span>和</span><strong><span>移动（mobile）</span></strong></p><ul><li><p><span>无线但非移动：譬如具有固定工作站的家庭或办公网络</span></p></li><li><p><span>移动但非无线：在家里使用笔记本的员工，关闭笔记本，开车去上班，然后将该笔记本连接到公司的有线网络上</span></p></li><li><p><span>无线且移动：在高速公路上飞驰的车中的一部手机</span></p></li></ul><p><span>本章我们先从无线入手，先介绍基本知识、CDMA，再介绍WiFi和蜂窝网等。接着探讨移动性，研究如何在移动中保持IP地址不变。然后我们探讨移动IP标准，并且研究了GSM网络是如何管理移动性的。最后讨论无线和移动性对高层协议的影响。</span></p><h2 id='71-概述'><span>7.1 概述</span></h2><p><img src="./img/wirelessNet.jpg" style="zoom:50%;" /></p><p><span>无线网络的组成要素有：</span></p><ul><li><p><strong><span>无线主机（wireless hosts）</span></strong><span>：如笔记本、手机等</span></p></li><li><p><strong><span>无线链路（wireless links）</span></strong><span>：有覆盖区域和链路速率两个特性</span></p><p><img src="./img/wirelessLink.jpg" style="zoom:50%;" /></p></li><li><p><strong><span>基站（base station）</span></strong><span>：无线局域网的</span><strong><span>接入点（access point）</span></strong><span>、蜂窝网络的</span><strong><span>蜂窝塔（cell tower）</span></strong><span>。主机从一个</span><strong><span>相连（associate）</span></strong><span>的基站移动到另一个基站，这一过程称为</span><strong><span>切换（handoff）</span></strong><span>。</span>
<span>与基站相连的主机称为以</span><strong><span>基础设施模式（infrastructure mode）</span></strong><span>运行；相反</span><strong><span>自组织网络（ad hoc network）</span></strong><span>中没有基础设施，主机自身需要提供路由选择、地址分配等服务。</span></p></li></ul><p><span>根据(1) whether a packet in the wireless network crosses exactly one wireless hop or multiple hops, and (2) whether there is infrastructure可以将无线网络分类：</span></p><ul><li><p><strong><span>单跳，基于基础设施</span></strong><span>：基站与无线主机之间的通信经过一个无线跳。绝大部分无线网络，包含WiFi和4G。</span></p></li><li><p><strong><span>单跳，无基础设施</span></strong><span>：如蓝牙</span></p></li><li><p><strong><span>多跳，基于基础设施</span></strong><span>：无线节点为了与基站通信，需要通过其他无线节点中继它们的通信</span></p></li><li><p><strong><span>多跳，无基础设施</span></strong><span>：没基站，并且节点为了到达目的地可能必须在几个其他无线节点之间中继报文</span></p></li></ul><p><span>本书不讨论多跳网络。</span></p><h2 id='72-无线链路和网络特征'><span>7.2 无线链路和网络特征</span></h2><p><span>无线链路有以下特点</span></p><ul><li><p><span>衰减的信号强度：也称作</span><strong><span>路径损耗（path loss）</span></strong></p></li><li><p><span>其他源的干扰：同一频段下的信号会互相干扰</span></p></li><li><p><strong><span>多径传播（multipath propagation）</span></strong><span>：受各种反射，电磁波走了不同长度的路径，使得接收方收到的信号模糊</span></p></li></ul><p><strong><span>信噪比（signal-to-noise, SNR）</span></strong><span>是所收到的信号和噪声强度的相对测量。</span><strong><span>比特差错率（bit error rate）</span></strong><span>是收到信号出错的概率。BER-SNR图如下：</span></p><p><img src="./img/BER-SNR.jpg" style="zoom:50%;" /></p><p><span>可以看到：</span></p><ul><li><p><span>相同比特传输率的调制（modulation）方案下，信噪比越高（信号越强），比特差错率越低</span></p></li><li><p><span>相同信噪比下，较高比特传输率的调制技术具有较高的比特差错率</span></p></li></ul><p><strong><span>CDMA</span></strong></p><p><strong><span>码分多址（code division multiple access, CDMA）</span></strong><span>已经在6.3.1提过一嘴，属于信道划分协议族，在无线LAN和蜂窝技术中应用广泛。通过仔细选择CDMA编码，可以实现下面的神奇操作：（不过这里假定了不同发送方的信号强度是相同的）</span></p><p><img src="./img/CDMA.jpg" style="zoom:50%;" /></p><h2 id='73-wifi80211无线lan'><span>7.3 WiFi：802.11无线LAN</span></h2><p><strong><span>WiFi</span></strong><span>也就是</span><strong><span>IEEE 802.11 wireless LAN</span></strong><span>。包括以下不同标准</span></p><figure><table><thead><tr><th><span>标准</span></th><th><span>频率范围</span></th><th><span>最大数据率</span></th></tr></thead><tbody><tr><td><span>802.11b</span></td><td><span>2.4GHz</span></td><td><span>11Mbps</span></td></tr><tr><td><span>802.11a</span></td><td><span>5GHz</span></td><td><span>54Mbps</span></td></tr><tr><td><span>802.11g</span></td><td><span>2.4GHz</span></td><td><span>54Mbps</span></td></tr><tr><td><span>802.11n</span></td><td><span>2.5~5GHz</span></td><td><span>450Mbps</span></td></tr><tr><td><span>802.11ac</span></td><td><span>5GHz</span></td><td><span>1300Mbps</span></td></tr></tbody></table></figure><p><span>注意到2.4GHz频段实际为2.4</span><span>~</span><span>2.485GHz，5GHz频段实际为5.1</span><span>~</span><span>5.8GHz。</span></p><h3 id='731-80211体系结构'><span>7.3.1 802.11体系结构</span></h3><p><span>一些术语</span></p><ul><li><p><strong><span>接入点（access point，AP）</span></strong><span>：即802.11下的基站，AP之间通过路由器或交换机相连</span></p></li><li><p><strong><span>基本服务集（basic service set, BSS）</span></strong><span>：包含一个或多个无线主机和一个AP</span></p></li><li><p><strong><span>站点（station）</span></strong><span>：指无线主机和AP</span></p></li><li><p><strong><span>服务集标识（service set identifier, SSID）</span></strong><span>：即WiFi名字</span></p></li></ul><p><span>下面介绍</span><strong><span>信道（channel）</span></strong><span>与</span><strong><span>关联（associate）</span></strong><span>的有关内容。</span></p><p><span>2.4</span><span>~</span><span>2.485GHz的频段被分成11个部分重叠的信道，当且仅当两个信道由4个或更多信道隔开时才无重叠。关联AP有被动扫描和主动扫描两种方式：</span></p><ul><li><p><strong><span>被动扫描（passive scanning）</span></strong><span>：802.11标准要求每个AP周期性发送</span><strong><span>信标帧（beacon frame）</span></strong><span>，每个信标帧包括该AP的SSID和MAC地址。无线站点可以通过扫描11个信道，找到可能位于该区域的AP所发出的信标帧。最后可以选择一个AP用于关联。</span></p></li><li><p><strong><span>主动扫描（active scanning）</span></strong><span>：通过向AP发送广播探测请求帧实现，如图</span></p></li></ul><p><img src="./img/scan.jpg" style="zoom:50%;" /></p><h3 id='732-80211mac协议'><span>7.3.2 802.11MAC协议</span></h3><p><span>802.11的接入采取了随机访问协议——</span><strong><span>CSMA/CA（CSMA with collision avoidance）</span></strong><span>。具体为</span></p><ol start='' ><li><p><span>如果某站点最初监听到信道空闲，它将在一个称为分布式帧间间隔（distributed inter-frame space，DIFS）的短时间后发送该帧</span></p></li><li><p><span>否则，该站点选择一个随机回退（backoff，见6.3.2节）值，并且在侦听信道空闲时递减该值。当侦听信道忙时，计数值不变</span></p></li><li><p><span>当计数值为0时，该站点发送整个数据帧并等待确认</span></p></li><li><p><span>目的站点等待</span><strong><span>SIFS（short inter-frame spacing）</span></strong><span>时间间隔之后，返回一个确认帧。如果发送站点收到确认，知道它的帧已经被目的站点正确接收。如果该站点要发送新的一帧，它将从第二步开始CSMA/CA协议。如果没有收到确认，将重新进入第二部的回退阶段，从更大范围内选择回退值，并之后重传该帧</span></p></li></ol><p><img src="./img/wuwuwu.jpg" style="zoom:50%;" /></p><p><span>上述方案称为</span><strong><span>链路层确认/重传（link-layer acknowledgment/retransmission）</span></strong><span>方案。</span></p><p><span>802.11MAC协议为什么不像以太网那样实现碰撞检测（CD）呢？主要原因是802.11适配器做不到。由于发送信号远远强于接收信号的强度，所以适配器在发送数据的同时难以监听信号。而且就算可以同时发送和监听信号，适配器也会由于</span><strong><span>隐藏终端（hidden terminal）</span></strong><span>（A和B分别与AP相关联，但是AB之间距离过远或有阻挡，AB不能发现对方）和信号衰减问题，无法检测所有碰撞。</span></p><p><span>由于802.11MAC协议不能实现碰撞检测，所以一旦发送一个帧，就会完全发送该帧，即使产生了碰撞。因此802.11MAC协议目的是尽可能</span><strong><span>避免碰撞</span></strong><span>，所以该协议并不是在侦听到信号空闲时立刻传输，而是要等回退值倒计时到0的时候，才开始传输。</span></p><p><span>然而还是有一个问题。对于隐藏终端，我并不能侦听到它的信号。这便会产生大量碰撞。为了避免这个问题，引入了</span><strong><span>RTS（request to send）</span></strong><span>和</span><strong><span>CTS（clear to send）</span></strong><span>两个控制帧来预约信道。</span></p><p><img src="./img/rtscts.jpg" style="zoom:50%;" /></p><ul><li><p><span>RTS用来指示传输DATA帧和确认（ACK）帧需要的总时间</span></p></li><li><p><span>CTS广播给所有节点，一方面给发送方明确的发送许可，另一方面指示其他节点不要在预约期间发送</span></p></li><li><p><span>优势：有效降低碰撞</span></p></li><li><p><span>劣势：引入时延和消耗信道资源，所以对于大DATA帧，才会使用RTS/CTS来预约信道</span></p></li></ul><h3 id='733-ieee-80211帧'><span>7.3.3 IEEE 802.11帧</span></h3><p><img src="./img/80211frame.jpg" style="zoom:50%;" /></p><ul><li><p><span>有效载荷：通常由一个IP数据报或者ARP分组组成，通常小于1500字节。</span></p></li><li><p><span>CRC字段：无线局域网中比特错误更容易产生，因此CRC将更加有用</span></p></li><li><p><span>地址字段</span></p><ul><li><p><span>地址2：传输该帧的站点的MAC地址</span></p></li><li><p><span>地址1：接收该帧的站点的MAC地址</span></p></li><li><p><span>地址4：与自组织模式中互相转发有关，不在我们的讨论范围</span></p></li><li><p><span>地址3：回忆到BSS是一个子网的一部分，并且这个子网经一些路由器接口与其他子网相连。而地址3就包含这个路由器接口的MAC地址。在BSS和有线局域网互联中起到关键作用。</span></p></li></ul></li><li><p><span>序号：同3.4.1节讨论的序号，为了使接收方区分新传输的帧和以前帧的重传</span></p></li><li><p><span>持续期：存放7.3.2节介绍的信道预约的时间</span></p></li></ul><p><span>我们再来仔细研究一下地址字段</span></p><p><img src="./img/80211frame2.jpg" style="zoom:50%;" /></p><p><span>考虑H1发送一个数据报给R1的过程。</span></p><ul><li><p><span>H1生成一个802.11帧发送给AP</span></p><ul><li><p><span>地址1：AP的mac地址</span></p></li><li><p><span>地址2：H1的mac地址</span></p></li><li><p><span>地址3：R1的mac地址</span></p></li></ul></li><li><p><span>当AP接收到该帧后，将其转换为以太网帧</span></p><ul><li><p><span>源地址字段：H1的mac地址，通过地址2得到</span></p></li><li><p><span>目的地址字段：R1的mac地址，通过地址3得到</span></p></li></ul></li></ul><p><span>可见地址3在BSS和有线局域网互联中起到关键作用。</span></p><h3 id='734-在相同ip子网中的移动性'><span>7.3.4 在相同IP子网中的移动性</span></h3><p><img src="./img/mobility.jpg" style="zoom:50%;" /></p><p><span>在相同子网的前提下，现在希望无线站点H1能在维持TCP会话的同时，无缝地从BSS1移动到BSS2。注意到图中使用的交换机，所以BSS1和BSS2在同一子网。</span></p><ul><li><p><span>从主机和AP的角度：H1检测到AP1信号变弱，AP2信号变强。于是与AP1解除关联，并与AP2关联起来，同时维持其IP地址和正在进行的TCP会话</span></p></li><li><p><span>从交换机的角度：回忆到交换机是自学习的，H1从AP2发送的数据自然会修改交换机的转发表。但是这并不能很好满足用户在不同BSS间高速移动（原来转发到BSS1的数据应该立刻改成BSS2）。一种不规范的解决方法是，在新的关联形成后，让AP2以H1的源地址向交换机发送一个以太网广播帧。当交换机收到该帧后，修改器转发表。</span></p></li></ul><h3 id='735-80211中的高级特色'><span>7.3.5 802.11中的高级特色</span></h3><p><span>由生产厂商可以实现：</span></p><ul><li><p><strong><span>速率适应（rate adaptation）</span></strong><span>：在7.2节的比特差错率-信噪比图可以看到，我们可以动态选择最佳的调制方法，实现高信噪比和高传输速率。</span></p></li><li><p><strong><span>功率管理（power management）</span></strong><span>：即使得移动设备侦听、传输和接收功能等时间量最小化，从而节约能源。</span></p></li></ul><h3 id='736-个人域网络蓝牙和zigbee'><span>7.3.6 个人域网络：蓝牙和ZigBee</span></h3><p><span>IEEE 802.11 WiFi标准主要针对相距多达100米的设备间的通信，而IEEE 802.15.1蓝牙技术和802.15.4 ZigBee技术则更针对低功率、小范围、低速率的通信需求。</span></p><ul><li><p><strong><span>蓝牙（Bluetooth）</span></strong></p><ul><li><p><span>以TDM方式工作于无需许可证的2.4GHz无线电波端，每个时隙长度625μs。每个时隙中，发送方利用79个信道中的一个进行传输，with the channel changing in a known but pseudo-random manner from slot to slot. This form of channel hopping, know as </span><strong><span>frequency-hopping spread spectrum (FHSS)</span></strong><span>, spreads transmissions in time over the frequency spectrum. </span></p></li><li><p><span>最高4Mbps的数据率</span></p></li><li><p><span>自组织网络：不需要网络基础设施来互联蓝牙设备。网络称为</span><strong><span>微微网（piconet）</span></strong><span>，其中包含</span></p><ul><li><p><span>一个</span><strong><span>主设备（master device）</span></strong><span>：控制微微网，确定时钟</span></p></li><li><p><span>至多七个</span><strong><span>从设备（slave device）</span></strong><span>：活动设备。只有当主设备在前一时隙与其通信后才能发送，并只能发送给主设备</span></p></li><li><p><span>至多255个</span><strong><span>寄放设备（packed device）</span></strong><span>：只有主设备将其从寄放状态变成活动后，才能进行通信</span></p></li></ul></li></ul></li><li><p><strong><span>ZigBee</span></strong><span>：比蓝牙还要低功率、低数据率（kbps）和低工作周期。这里不多介绍。</span></p></li></ul><h2 id='74-蜂窝因特网接入'><span>7.4 蜂窝因特网接入</span></h2><p><span>想必对于2、3、4G已经挺熟悉了，废话就不多说了。</span></p><h3 id='741-2g'><span>7.4.1 2G</span></h3><p><span>我们将使用</span><strong><span>全球移动通信系统（global system for mobile communication，GSM）</span></strong><span>标准的术语。2G蜂窝提供语音服务。使用了组合的FDM/TDM，即把信道划分成多个频率子带，每个子带被分成多个时隙，可以支持多个并发的呼叫。</span></p><p><img src="./img/2g.jpg" style="zoom:50%;" /></p><ul><li><p><strong><span>蜂窝（cellular）</span></strong><span>：由一个蜂窝网覆盖的区域被分成多个</span><strong><span>cell</span></strong></p></li><li><p><strong><span>收发基站（base transceiver station, BTS）</span></strong><span>：每个cell有一个BTS，负责向位于该cell内的移动站点收发信号</span></p></li><li><p><strong><span>基站控制器（base station controller，BSC）</span></strong><span>：负责为移动用户分配BTS无线信道、寻呼（paging）——找出某移动用户所在的cell、执行移动用户的切换（见7.7.2）</span></p></li><li><p><strong><span>基站系统（base station system, BSS）</span></strong><span>：有BSC和BTS构成</span></p></li><li><p><strong><span>移动交换中心（mobile switching center, MSC）</span></strong><span>：用户鉴别和账户管理、呼叫建立和切换（见7.7.2）</span></p></li></ul><h3 id='742-3g'><span>7.4.2 3G</span></h3><p><span>在3G和4G标准的讨论中，我们关注由3rd Generation Partnership project (3GPP) 研发的UMTS (Universal Mobile Telecommunications Service) .</span></p><p><span>3G数据服务设计采取的方法：不去触动现有核心的GSM蜂窝语音网，增加与现有蜂窝语音网平行的附加蜂窝数据功能（原来只有语音功能）。</span></p><p><img src="./img/3g.jpg" style="zoom: 67%;" /></p><p><strong><span>1）3G核心网</span></strong></p><ul><li><p><strong><span>服务通用分组无线服务支持节点（serving generalized packet radio service support node, SGSN）</span></strong><span>：负责向位于其连接的无线电接入网中的移动节点交付/获取数据报。与MSC进行交互，提供用户认证和切换、维护活跃移动节点的位置信息、执行无线电接入网中的移动节点和GGSN之间的数据报转发</span></p></li><li><p><strong><span>网关GPRS支持节点（gateway GPRS support node, GGSN）</span></strong><span>：起网关作用，将多个SGSN连接到更大的因特网。</span><strong><span>GPRS (general packet radio service)</span></strong><span> 网络也就是2.5G，是2G网络中提供互联网连接的一种方式。</span></p></li></ul><p><strong><span>2）无线电接入网：无线边缘</span></strong></p><ul><li><p><strong><span>无线电网络控制器（radio network controller，RNC）</span></strong><span>：控制几个cell的收发基站</span></p></li><li><p><span>不再使用GSM的FDM/TDM方案，而是在TDM时隙中使用</span><strong><span>直接序列宽带CDMA（direct sequence wideband CDMA）</span></strong></p></li></ul><h3 id='743-4g'><span>7.4.3 4G</span></h3><p><span>由3GPP提出的4G </span><strong><span>Long-Term Evolution (LTE)</span></strong><span> 标准较之3G有两大创新</span></p><ul><li><p><span>an all-IP core network</span></p></li><li><p><span>an enhanced radio access network</span></p></li></ul><p><img src="./img/4g.jpg" style="zoom:50%;" /></p><p><span>所谓all-IP指：语音和数据都承载在IP数据报中。使用了4G，蜂窝网络来源于电话的最后痕迹已经荡然无存，让位给统一的IP服务了。</span></p><p><em><span>书上还有更多介绍，这里不展开。</span></em></p><h2 id='75-移动管理'><span>7.5 移动管理</span></h2><p><span>不同程度的移动性包含</span></p><ul><li><p><span>低：在相同的无线接入网中移动</span></p></li><li><p><span>中：在接入网之间移动，当在网间移动时关闭连接</span></p></li><li><p><span>高：在接入网之间移动，同时维持进行中的TCP连接。这是我们关心的！</span></p></li></ul><p><span>移动网络体系结构中的初始要素包含</span></p><ul><li><p><strong><span>归属网络（home network）</span></strong><span>：移动节点的永久居所</span></p></li><li><p><strong><span>归属代理（home agent）</span></strong><span>：归属网络中代表移动节点执行移动管理功能的实体</span></p></li><li><p><strong><span>外部网络（foreign network）</span></strong><span>：也称为</span><strong><span>被访网络（visited network）</span></strong><span>，移动节点当前所在网络</span></p></li><li><p><strong><span>外部代理（foreign agent）</span></strong><span>：外部网络中代表移动节点执行移动管理功能的实体</span></p></li><li><p><strong><span>通信者（correspondent）</span></strong><span>：希望与该移动节点通信的实体</span></p></li></ul><p><img src="./img/mobile.jpg" style="zoom:50%;" /></p><h3 id='751-寻址'><span>7.5.1 寻址</span></h3><p><span>如何做到移动节点在接入网之间移动，同时保持IP地址不变呢？有两个方案</span></p><ul><li><p><span>外部网络向所有其他网络发通告（advertise），告诉它们该移动节点在它的网络中。不需要对现有网络设施做重大改动，但是扩展性不好，因为路由器必须修改非常多的移动节点的转发表表项</span></p></li><li><p><span>移动节点的IP地址称为</span><strong><span>永久地址（permanent address）</span></strong><span>，此外移动节点还有一个</span><strong><span>转交地址（care-of address，COA）</span></strong><span>，转交地址可以是外部网络的一个边缘路由器（也就是外部代理）的IP地址。归属代理将发送到归属网络的数据，转发到COA所在的外部网络中，再利用永久地址，便可以成功找到外部网络中的移动节点（其他做法详见7.5.2节）。该方案被广泛采用。</span></p></li></ul><h3 id='752-路由选择到移动节点'><span>7.5.2 路由选择到移动节点</span></h3><p><span>路由选择有两种</span></p><ul><li><p><strong><span>间接路由选择（indirect routing）</span></strong><span>：归属代理将把原来的数据报封装到更大的数据报里，再发送给外部代理。</span><strong><span>三角路由选择问题（triangle routing problem）</span></strong><span>：显然路由选择绕圈子了</span></p></li></ul><p><img src="./img/indirectRouting.jpg" style="zoom:50%;" /></p><ul><li><p><strong><span>直接路由选择（direct routing）</span></strong><span>：较间接方案复杂，但是解决了三角路由问题。还有一个问题是当移动节点从一个外部网络移动到另一个外部网络怎么办？如果是间接路由选择，这个问题可以通过更新归属代理解决。然而对于直接路由选择，归属代理仅在会话开始时被通信者代理访问一次。一种解决办法时创建一个新的协议来告知通信者变化后的COA。另一种方法（GSM采用）是用原来的外部代理（此时称为</span><strong><span>锚外部代理</span></strong><span>）向新的外部代理转发数据。</span></p></li></ul><p><img src="./img/directRouting.jpg" style="zoom:50%;" /></p><h2 id='76-移动ip'><span>7.6 移动IP</span></h2><p><span>支持移动性的因特网体系结构与协议合起来称为</span><strong><span>移动IP（mobile IP）</span></strong><span>。移动IP标准由三部分组成：</span></p><ul><li><p><strong><span>代理发现</span></strong><span>：到达一个新网络的某移动IP节点（不管是连到一个外部网络还是返回其归属网络），它都必须知道相应的外部代理或归属代理的身份。这就是代理发现。</span></p></li><li><p><strong><span>向归属代理注册</span></strong><span>：移动IP定义了移动节点和/或外部代理向一个移动节点的归属代理注册或注销COA所使用的协议</span></p></li><li><p><strong><span>数据报的间接路由选择</span></strong><span>：该标准也定义了数据报被一个归属代理转发给移动节点的方式，包括转发数据报使用的规则、处理差错情况的规则和几种不同的封装形式</span></p></li></ul><p><em><span>书上还有一些具体内容</span></em></p><h2 id='77-管理蜂窝网中的移动性'><span>7.7 管理蜂窝网中的移动性</span></h2><p><span>书上本节详细地介绍了GSM网络（即2G网络）中对移动用户呼叫的路由选择，以及如何在不同基站中切换。十分冗杂，主要就是体现了7.5节的一些设计思想。这里也不赘述了。（主要自己也看的不明觉厉</span></p><h2 id='78-无线和移动性对高层协议的影响'><span>7.8 无线和移动性：对高层协议的影响</span></h2><p><span>由于无线信道的高比特差错率和切换丢失的可能性，TCP的拥塞控制反应在无线情况下可能会有问题。有三大类可能的方法用于处理这一问题：</span></p><ul><li><p><strong><span>本地恢复</span></strong></p></li><li><p><strong><span>TCP发送方知晓无线链路</span></strong><span>：让TCP发送方和接收方知道无线链路的存在，从而将在有线网络中发生的拥塞性丢包和在无线网络中发生的差错/丢包区分开，并且仅对有线网络中的拥塞性丢包采用拥塞控制。</span></p></li><li><p><strong><span>分离连接方法</span></strong><span>：在分离连接方法中，移动用户和其他端点之间的端到端连接被打断为两个运输层连接：一个从移动主机到无线接入点，一个从无线接入点到其他通信端点。该端到端连接因此是由一个无线部分和一个有线部分分级连形成的。经无线段的运输层能够是一个标准的TCP连接，或是一个特别定制运行在UDP上的差错恢复协议。</span></p></li></ul><hr /><p>&nbsp;</p></div></div>
</body>
</html>