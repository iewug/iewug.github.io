<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}



mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
  stroke-width: 3;
}

g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

.MathJax g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}
mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
							stroke-width: 0;
						}
</style><title>笔记_计算机组成与设计</title>
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='计算机组成与设计-硬件软件接口笔记'><span>《计算机组成与设计 硬件/软件接口》笔记</span></h1><p style="text-align:right;">
    Gu Wei 2022年6月
</p><p>&nbsp;</p><p><span>读的是英文版，risc-v版，原书第5版，机械工业出版社。原名为《Computer Organization and Design The Hardware/Software Interface, RISC-V Edition》</span></p><p><span>主要就是谈一谈自己的想法，也不按照书上的小节顺序了。书是看完了前四章，第五章和第六章就跟着课上（上海交通大学，CS2305计算机系统结构，邓倩妮）来了。不同于操作系统整理的那么详细，本整理更多是一些内化后的东西。想要看懂的话，也是需要提前有一些基础知识的吧。限于水平，疏忽和误解在所难免。</span></p><p><span>本书的大体思路是：</span></p><ol start='' ><li><span>绪论</span></li><li><span>RISC-V</span></li><li><span>计算机如何做算术、RISC-V</span></li><li><span>处理器：单周期、流水线、多发射</span></li><li><span>存储器结构、虚拟内存</span></li><li><span>并行</span></li></ol><p><span>个人觉得书还是不错的，把许多问题的前因后果帮你讲清楚。虽然是关于计算机组成的书，但是也涉及到了许多体系结构的内容（各种并行之类的）。总的来说值得一读！</span></p><hr /><p>&nbsp;</p><h1 id='chapter-1'><span>Chapter 1</span></h1><p><span>第一部分主要就是绪论了。作者站的高度很高。</span></p><h2 id='11-八大思想'><span>1.1 八大思想</span></h2><p><span>计算机体系结构有这么八个重要思想：</span></p><ol start='' ><li><p><span>摩尔定律</span></p><p><span>英特尔创始人摩尔指出：集成电路上可以容纳的晶体管数目在大约每经过18个月便会增加一倍，性能也随之增加一倍。对于计算机架构师来说，由于设计体系结构的开发周期长，因此在设计体系结构的时候就要考虑到将来更高性能的处理器。</span></p></li><li><p><span>抽象</span></p><p><span>本书多次提到：指令集架构是硬件和低级软件之间的抽象层，它允许不同的硬件来运行相同的程序。说人话就是，我的处理器用的指令集是X86-64的，我可以买来各种不同品牌、型号、性能的硬件，只要我操作系统里有这个东西的驱动程序（当然是X86-64的），我就能立即使用这些硬件。当然个人认为抽象包含的东西很广，但书中并没有更多讨论了。</span></p></li><li><p><span>让常见事件运行得快</span></p><p><strong><span>Amdahl&#39;s Law（阿姆达尔定律）</span></strong><span>指出提升的一个部分的性能对整个系统有多大影响取决于：1. 这部分有多重要；2. 这部分提升了多少。所以让常见事件运行得快是提升系统性能的重要思想。需要强调的是：整体性能的提升并不会与部分性能的提升成比例。</span></p></li><li><p><span>通过并行提升性能</span></p><p><span>先再次明确</span><strong><span>并行（parallelism）</span></strong><span>和</span><strong><span>并发（concurrency）</span></strong><span>的区别。并行是指：多个处理器同时处理单个或多个任务；并发是指：单个处理器依次处理多个任务。但是我对这个定义存疑，个人认为并行并不严格需要多个处理器，只需要多个处理单元即可。</span></p><p><span>再谈论为什么我们会从单核处理器走向多核处理器。从1986年到2002年，微处理器的性能以平均50%的速度不断提升。但从2002年开始，单处理器的性能提升速度下降到每年大约20%。单核处理器发展遇到瓶颈主要在于能耗的上升、散热能力达到极限。与其去设计更快更复杂的单核处理器，不如放置多个相对简单的多核处理器。</span></p></li><li><p><span>通过流水线提高性能</span></p><p><span>既然处理器的不同部分分管不同的活，自然要让他们忙起来！</span></p></li><li><p><span>通过预测提高性能</span></p><p><span>只要预测成功率较高、从预测失败中恢复的代价不大，便可以预测。</span></p></li><li><p><span>存储器分级</span></p><p><span>多级缓存。</span></p></li><li><p><span>通过冗余设计提高可靠性</span></p><p><span>RAID是个好例子。</span></p></li></ol><h2 id='12-性能'><span>1.2 性能</span></h2><h3 id='121-如何定义性能'><span>1.2.1 如何定义性能</span></h3><p><span>我们通过时间来衡量性能。时间可以分为两种：</span></p><ul><li><p><span>wall clock time, response time, elapsed time: 跑一个任务实际花费的时间，包含了I/O活动、磁盘访问、操作系统的调度时间等等。</span></p></li><li><p><span>CPU execution time, CPU time: CPU实际花费的时间，不再包括I/O活动、访存等。还可以细分为：</span></p><ul><li><span>user CPU time: The CPU time spent in a program itself.</span></li><li><span>system CPU time: The CPU time spent in the operating system performing tasks on behalf of the program.</span></li></ul></li></ul><p><span>我们真正关心的是user CPU time。</span></p><h3 id='122-cpu-性能公式'><span>1.2.2 CPU 性能公式</span></h3><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n68" cid="n68" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="57.512ex" height="2.059ex" role="img" focusable="false" viewBox="0 -705 25420.4 910" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.464ex;"><defs><path id="MJX-5-TEX-I-1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path><path id="MJX-5-TEX-I-1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path><path id="MJX-5-TEX-I-1D448" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"></path><path id="MJX-5-TEX-N-A0" d=""></path><path id="MJX-5-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-5-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-5-TEX-I-1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-5-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-5-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-5-TEX-I-1D43C" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path><path id="MJX-5-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-5-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path><path id="MJX-5-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-5-TEX-I-1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-5-TEX-I-1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path><path id="MJX-5-TEX-I-1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path><path id="MJX-5-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-5-TEX-I-1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path><path id="MJX-5-TEX-I-1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path><path id="MJX-5-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D436" xlink:href="#MJX-5-TEX-I-1D436"></use></g><g data-mml-node="mi" transform="translate(760,0)"><use data-c="1D443" xlink:href="#MJX-5-TEX-I-1D443"></use></g><g data-mml-node="mi" transform="translate(1511,0)"><use data-c="1D448" xlink:href="#MJX-5-TEX-I-1D448"></use></g><g data-mml-node="mtext" transform="translate(2278,0)"><use data-c="A0" xlink:href="#MJX-5-TEX-N-A0"></use></g><g data-mml-node="mi" transform="translate(2528,0)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(2889,0)"><use data-c="1D456" xlink:href="#MJX-5-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(3234,0)"><use data-c="1D45A" xlink:href="#MJX-5-TEX-I-1D45A"></use></g><g data-mml-node="mi" transform="translate(4112,0)"><use data-c="1D452" xlink:href="#MJX-5-TEX-I-1D452"></use></g><g data-mml-node="mo" transform="translate(4855.8,0)"><use data-c="3D" xlink:href="#MJX-5-TEX-N-3D"></use></g><g data-mml-node="mi" transform="translate(5911.6,0)"><use data-c="1D43C" xlink:href="#MJX-5-TEX-I-1D43C"></use></g><g data-mml-node="mi" transform="translate(6415.6,0)"><use data-c="1D45B" xlink:href="#MJX-5-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(7015.6,0)"><use data-c="1D460" xlink:href="#MJX-5-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(7484.6,0)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(7845.6,0)"><use data-c="1D45F" xlink:href="#MJX-5-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(8296.6,0)"><use data-c="1D462" xlink:href="#MJX-5-TEX-I-1D462"></use></g><g data-mml-node="mi" transform="translate(8868.6,0)"><use data-c="1D450" xlink:href="#MJX-5-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(9301.6,0)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(9662.6,0)"><use data-c="1D456" xlink:href="#MJX-5-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(10007.6,0)"><use data-c="1D45C" xlink:href="#MJX-5-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(10492.6,0)"><use data-c="1D45B" xlink:href="#MJX-5-TEX-I-1D45B"></use></g><g data-mml-node="mtext" transform="translate(11092.6,0)"><use data-c="A0" xlink:href="#MJX-5-TEX-N-A0"></use></g><g data-mml-node="mi" transform="translate(11342.6,0)"><use data-c="1D450" xlink:href="#MJX-5-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(11775.6,0)"><use data-c="1D45C" xlink:href="#MJX-5-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(12260.6,0)"><use data-c="1D462" xlink:href="#MJX-5-TEX-I-1D462"></use></g><g data-mml-node="mi" transform="translate(12832.6,0)"><use data-c="1D45B" xlink:href="#MJX-5-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(13432.6,0)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(14015.8,0)"><use data-c="D7" xlink:href="#MJX-5-TEX-N-D7"></use></g><g data-mml-node="mi" transform="translate(15016,0)"><use data-c="1D436" xlink:href="#MJX-5-TEX-I-1D436"></use></g><g data-mml-node="mi" transform="translate(15776,0)"><use data-c="1D443" xlink:href="#MJX-5-TEX-I-1D443"></use></g><g data-mml-node="mi" transform="translate(16527,0)"><use data-c="1D43C" xlink:href="#MJX-5-TEX-I-1D43C"></use></g><g data-mml-node="mo" transform="translate(17253.2,0)"><use data-c="D7" xlink:href="#MJX-5-TEX-N-D7"></use></g><g data-mml-node="mi" transform="translate(18253.4,0)"><use data-c="1D436" xlink:href="#MJX-5-TEX-I-1D436"></use></g><g data-mml-node="mi" transform="translate(19013.4,0)"><use data-c="1D459" xlink:href="#MJX-5-TEX-I-1D459"></use></g><g data-mml-node="mi" transform="translate(19311.4,0)"><use data-c="1D45C" xlink:href="#MJX-5-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(19796.4,0)"><use data-c="1D450" xlink:href="#MJX-5-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(20229.4,0)"><use data-c="1D458" xlink:href="#MJX-5-TEX-I-1D458"></use></g><g data-mml-node="mtext" transform="translate(20750.4,0)"><use data-c="A0" xlink:href="#MJX-5-TEX-N-A0"></use></g><g data-mml-node="mi" transform="translate(21000.4,0)"><use data-c="1D450" xlink:href="#MJX-5-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(21433.4,0)"><use data-c="1D466" xlink:href="#MJX-5-TEX-I-1D466"></use></g><g data-mml-node="mi" transform="translate(21923.4,0)"><use data-c="1D450" xlink:href="#MJX-5-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(22356.4,0)"><use data-c="1D459" xlink:href="#MJX-5-TEX-I-1D459"></use></g><g data-mml-node="mi" transform="translate(22654.4,0)"><use data-c="1D452" xlink:href="#MJX-5-TEX-I-1D452"></use></g><g data-mml-node="mtext" transform="translate(23120.4,0)"><use data-c="A0" xlink:href="#MJX-5-TEX-N-A0"></use></g><g data-mml-node="mi" transform="translate(23370.4,0)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(23731.4,0)"><use data-c="1D456" xlink:href="#MJX-5-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(24076.4,0)"><use data-c="1D45A" xlink:href="#MJX-5-TEX-I-1D45A"></use></g><g data-mml-node="mi" transform="translate(24954.4,0)"><use data-c="1D452" xlink:href="#MJX-5-TEX-I-1D452"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>C</mi><mi>P</mi><mi>U</mi><mtext>&nbsp;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>=</mo><mi>I</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext>&nbsp;</mtext><mi>c</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo>×</mo><mi>C</mi><mi>P</mi><mi>I</mi><mo>×</mo><mi>C</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mtext>&nbsp;</mtext><mi>c</mi><mi>y</mi><mi>c</mi><mi>l</mi><mi>e</mi><mtext>&nbsp;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi></math></mjx-assistive-mml></mjx-container></div></div><p><span>CPI：clock cycles per instruction</span></p><p><span>需要强调，若只用instruction count、CPI、clock cycle time三个中部分来评价性能的话是不正确的。比如MIPS（millon instructions per second）没有把指令数考虑进去，一个程序可能有很高的MIPS，但是指令数很多，该程序并不一定会有很好的性能。</span></p><p><span>此外这三个因素相互影响相互关联。</span></p><h2 id='13-能耗'><span>1.3 能耗</span></h2><p><span>现在的集成电路采用的科技是CMOS（互补金属氧化物半导体），它的能耗是动态的，公式为：</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n74" cid="n74" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="63.888ex" height="4.588ex" role="img" focusable="false" viewBox="0 -1342 28238.4 2028" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -1.552ex;"><defs><path id="MJX-6-TEX-I-1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path><path id="MJX-6-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-6-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-6-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-6-TEX-I-1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path><path id="MJX-6-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-6-TEX-N-221D" d="M56 124T56 216T107 375T238 442Q260 442 280 438T319 425T352 407T382 385T406 361T427 336T442 315T455 297T462 285L469 297Q555 442 679 442Q687 442 722 437V398H718Q710 400 694 400Q657 400 623 383T567 343T527 294T503 253T495 235Q495 231 520 192T554 143Q625 44 696 44Q717 44 719 46H722V-5Q695 -11 678 -11Q552 -11 457 141Q455 145 454 146L447 134Q362 -11 235 -11Q157 -11 107 56ZM93 213Q93 143 126 87T220 31Q258 31 292 48T349 88T389 137T413 178T421 196Q421 200 396 239T362 288Q322 345 288 366T213 387Q163 387 128 337T93 213Z"></path><path id="MJX-6-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-6-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-6-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-6-TEX-I-1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path><path id="MJX-6-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-6-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-6-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-6-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-6-TEX-I-1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path><path id="MJX-6-TEX-N-A0" d=""></path><path id="MJX-6-TEX-I-1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path><path id="MJX-6-TEX-I-1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path><path id="MJX-6-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-6-TEX-I-1D449" d="M52 648Q52 670 65 683H76Q118 680 181 680Q299 680 320 683H330Q336 677 336 674T334 656Q329 641 325 637H304Q282 635 274 635Q245 630 242 620Q242 618 271 369T301 118L374 235Q447 352 520 471T595 594Q599 601 599 609Q599 633 555 637Q537 637 537 648Q537 649 539 661Q542 675 545 679T558 683Q560 683 570 683T604 682T668 681Q737 681 755 683H762Q769 676 769 672Q769 655 760 640Q757 637 743 637Q730 636 719 635T698 630T682 623T670 615T660 608T652 599T645 592L452 282Q272 -9 266 -16Q263 -18 259 -21L241 -22H234Q216 -22 216 -15Q213 -9 177 305Q139 623 138 626Q133 637 76 637H59Q52 642 52 648Z"></path><path id="MJX-6-TEX-I-1D439" d="M48 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H742Q749 676 749 669Q749 664 736 557T722 447Q720 440 702 440H690Q683 445 683 453Q683 454 686 477T689 530Q689 560 682 579T663 610T626 626T575 633T503 634H480Q398 633 393 631Q388 629 386 623Q385 622 352 492L320 363H375Q378 363 398 363T426 364T448 367T472 374T489 386Q502 398 511 419T524 457T529 475Q532 480 548 480H560Q567 475 567 470Q567 467 536 339T502 207Q500 200 482 200H470Q463 206 463 212Q463 215 468 234T473 274Q473 303 453 310T364 317H309L277 190Q245 66 245 60Q245 46 334 46H359Q365 40 365 39T363 19Q359 6 353 0H336Q295 2 185 2Q120 2 86 2T48 1Z"></path><path id="MJX-6-TEX-I-1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-6-TEX-I-1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-6-TEX-I-1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path><path id="MJX-6-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path><path id="MJX-6-TEX-I-1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path><path id="MJX-6-TEX-I-210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D438" xlink:href="#MJX-6-TEX-I-1D438"></use></g><g data-mml-node="mi" transform="translate(764,0)"><use data-c="1D45B" xlink:href="#MJX-6-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(1364,0)"><use data-c="1D452" xlink:href="#MJX-6-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(1830,0)"><use data-c="1D45F" xlink:href="#MJX-6-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(2281,0)"><use data-c="1D454" xlink:href="#MJX-6-TEX-I-1D454"></use></g><g data-mml-node="mi" transform="translate(2758,0)"><use data-c="1D466" xlink:href="#MJX-6-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(3525.8,0)"><use data-c="221D" xlink:href="#MJX-6-TEX-N-221D"></use></g><g data-mml-node="mfrac" transform="translate(4581.6,0)"><g data-mml-node="mn" transform="translate(220,676)"><use data-c="31" xlink:href="#MJX-6-TEX-N-31"></use></g><g data-mml-node="mn" transform="translate(220,-686)"><use data-c="32" xlink:href="#MJX-6-TEX-N-32"></use></g><rect width="700" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(5743.8,0)"><use data-c="D7" xlink:href="#MJX-6-TEX-N-D7"></use></g><g data-mml-node="mi" transform="translate(6744,0)"><use data-c="1D436" xlink:href="#MJX-6-TEX-I-1D436"></use></g><g data-mml-node="mi" transform="translate(7504,0)"><use data-c="1D44E" xlink:href="#MJX-6-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(8033,0)"><use data-c="1D45D" xlink:href="#MJX-6-TEX-I-1D45D"></use></g><g data-mml-node="mi" transform="translate(8536,0)"><use data-c="1D44E" xlink:href="#MJX-6-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(9065,0)"><use data-c="1D456" xlink:href="#MJX-6-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(9410,0)"><use data-c="1D461" xlink:href="#MJX-6-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(9771,0)"><use data-c="1D456" xlink:href="#MJX-6-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(10116,0)"><use data-c="1D463" xlink:href="#MJX-6-TEX-I-1D463"></use></g><g data-mml-node="mi" transform="translate(10601,0)"><use data-c="1D452" xlink:href="#MJX-6-TEX-I-1D452"></use></g><g data-mml-node="mtext" transform="translate(11067,0)"><use data-c="A0" xlink:href="#MJX-6-TEX-N-A0"></use></g><g data-mml-node="mi" transform="translate(11317,0)"><use data-c="1D459" xlink:href="#MJX-6-TEX-I-1D459"></use></g><g data-mml-node="mi" transform="translate(11615,0)"><use data-c="1D45C" xlink:href="#MJX-6-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(12100,0)"><use data-c="1D44E" xlink:href="#MJX-6-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(12629,0)"><use data-c="1D451" xlink:href="#MJX-6-TEX-I-1D451"></use></g><g data-mml-node="mo" transform="translate(13371.2,0)"><use data-c="D7" xlink:href="#MJX-6-TEX-N-D7"></use></g><g data-mml-node="mi" transform="translate(14371.4,0)"><use data-c="1D449" xlink:href="#MJX-6-TEX-I-1D449"></use></g><g data-mml-node="mi" transform="translate(15140.4,0)"><use data-c="1D45C" xlink:href="#MJX-6-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(15625.4,0)"><use data-c="1D459" xlink:href="#MJX-6-TEX-I-1D459"></use></g><g data-mml-node="mi" transform="translate(15923.4,0)"><use data-c="1D461" xlink:href="#MJX-6-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(16284.4,0)"><use data-c="1D44E" xlink:href="#MJX-6-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(16813.4,0)"><use data-c="1D454" xlink:href="#MJX-6-TEX-I-1D454"></use></g><g data-mml-node="msup" transform="translate(17290.4,0)"><g data-mml-node="mi"><use data-c="1D452" xlink:href="#MJX-6-TEX-I-1D452"></use></g><g data-mml-node="mn" transform="translate(499,413) scale(0.707)"><use data-c="32" xlink:href="#MJX-6-TEX-N-32"></use></g></g><g data-mml-node="mo" transform="translate(18415.2,0)"><use data-c="D7" xlink:href="#MJX-6-TEX-N-D7"></use></g><g data-mml-node="mi" transform="translate(19415.4,0)"><use data-c="1D439" xlink:href="#MJX-6-TEX-I-1D439"></use></g><g data-mml-node="mi" transform="translate(20164.4,0)"><use data-c="1D45F" xlink:href="#MJX-6-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(20615.4,0)"><use data-c="1D452" xlink:href="#MJX-6-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(21081.4,0)"><use data-c="1D45E" xlink:href="#MJX-6-TEX-I-1D45E"></use></g><g data-mml-node="mi" transform="translate(21541.4,0)"><use data-c="1D462" xlink:href="#MJX-6-TEX-I-1D462"></use></g><g data-mml-node="mi" transform="translate(22113.4,0)"><use data-c="1D452" xlink:href="#MJX-6-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(22579.4,0)"><use data-c="1D45B" xlink:href="#MJX-6-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(23179.4,0)"><use data-c="1D450" xlink:href="#MJX-6-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(23612.4,0)"><use data-c="1D466" xlink:href="#MJX-6-TEX-I-1D466"></use></g><g data-mml-node="mtext" transform="translate(24102.4,0)"><use data-c="A0" xlink:href="#MJX-6-TEX-N-A0"></use></g><g data-mml-node="mi" transform="translate(24352.4,0)"><use data-c="1D460" xlink:href="#MJX-6-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(24821.4,0)"><use data-c="1D464" xlink:href="#MJX-6-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(25537.4,0)"><use data-c="1D456" xlink:href="#MJX-6-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(25882.4,0)"><use data-c="1D461" xlink:href="#MJX-6-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(26243.4,0)"><use data-c="1D450" xlink:href="#MJX-6-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(26676.4,0)"><use data-c="210E" xlink:href="#MJX-6-TEX-I-210E"></use></g><g data-mml-node="mi" transform="translate(27252.4,0)"><use data-c="1D452" xlink:href="#MJX-6-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(27718.4,0)"><use data-c="1D451" xlink:href="#MJX-6-TEX-I-1D451"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>E</mi><mi>n</mi><mi>e</mi><mi>r</mi><mi>g</mi><mi>y</mi><mo>∝</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>×</mo><mi>C</mi><mi>a</mi><mi>p</mi><mi>a</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mo>×</mo><mi>V</mi><mi>o</mi><mi>l</mi><mi>t</mi><mi>a</mi><mi>g</mi><msup><mi>e</mi><mn>2</mn></msup><mo>×</mo><mi>F</mi><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>y</mi><mtext>&nbsp;</mtext><mi>s</mi><mi>w</mi><mi>i</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi>e</mi><mi>d</mi></math></mjx-assistive-mml></mjx-container></div></div><p><span>近20年，CPU频率上升了1000倍（i3 10100是3.6GHz），电压从5V降到了1V，能耗上升30倍。</span></p><p><span>但是电压下降使得CPU中存在泄漏电流（leakage current），浪费能源。服务器芯片大约40%的能耗是由泄漏导致的。</span></p><p><span>此外还需强调，同一块芯片中能耗和性能也不成正比。比如100%使用时是260W，而10%使用时也有121W。</span></p><hr /><div style="page-break-after: always;"></div> <h1 id='chapter-2'><span>Chapter 2</span></h1><p><span>这一章主要介绍RISC-V指令集。RISC-V的二进制编码采用小端格式，譬如0x1234567存在0x100时：</span></p><figure><table><thead><tr><th><span>地址</span></th><th><span>0x100</span></th><th><span>0x101</span></th><th><span>0x102</span></th><th><span>0x103</span></th></tr></thead><tbody><tr><td><span>大端</span></td><td><span>01</span></td><td><span>23</span></td><td><span>45</span></td><td><span>67</span></td></tr><tr><td><span>小端</span></td><td><span>67</span></td><td><span>45</span></td><td><span>23</span></td><td><span>01</span></td></tr></tbody></table></figure><h2 id='21-risc-v-base-and-extension'><span>2.1 RISC-V Base and Extension</span></h2><p><span>RISC-V可以被分成基本指令I以及五个拓展指令M、A、F、D和C。本书探讨的是64位地址的指令集，对应的RISC-V叫做RV64I、RV64M以此类推。RISC-V基本和拓展指令一共有184个，此外还有13个系统指令（具体个数可能会有出入）。其划分依据为：</span></p><figure><table><thead><tr><th><span>Mnemonic</span></th><th><span>Description</span></th><th><span>Insn. Count</span></th></tr></thead><tbody><tr><td><span>I</span></td><td><span>Base architecture</span></td><td><span>51</span></td></tr><tr><td><span>M</span></td><td><span>Integer multiply/divide</span></td><td><span>13</span></td></tr><tr><td><span>A</span></td><td><span>Atomic operations</span></td><td><span>22</span></td></tr><tr><td><span>F</span></td><td><span>Single-precision floating point</span></td><td><span>30</span></td></tr><tr><td><span>D</span></td><td><span>Double-precision floating point</span></td><td><span>32</span></td></tr><tr><td><span>C</span></td><td><span>Compressed instructions</span></td><td><span>36</span></td></tr></tbody></table></figure><p><span>这章我们将会探讨RV64I和RV64A。Chapter 3会探讨M、F、D拓展指令。</span></p><h2 id='22-寄存器约定'><span>2.2 寄存器约定</span></h2><figure><table><thead><tr><th><span>Register</span></th><th><span>Name</span></th><th><span>Use</span></th><th><span>Saver</span></th></tr></thead><tbody><tr><td><span>x0</span></td><td><span>zero</span></td><td><span>the constant value 0</span></td><td><span>N.A.</span></td></tr><tr><td><span>x1</span></td><td><span>ra</span></td><td><span>return address</span></td><td><span>caller</span></td></tr><tr><td><span>x2</span></td><td><span>sp</span></td><td><span>stack pointer</span></td><td><span>callee</span></td></tr><tr><td><span>x3</span></td><td><span>gp</span></td><td><span>global pointer</span></td><td><span>--</span></td></tr><tr><td><span>x4</span></td><td><span>tp</span></td><td><span>thread pointer</span></td><td><span>--</span></td></tr><tr><td><span>x5-x7</span></td><td><span>t0-t2</span></td><td><span>temporaries</span></td><td><span>caller</span></td></tr><tr><td><span>x8</span></td><td><span>s0/fp</span></td><td><span>saved register/frame pointer</span></td><td><span>callee</span></td></tr><tr><td><span>x9</span></td><td><span>s1</span></td><td><span>saved register</span></td><td><span>callee</span></td></tr><tr><td><span>x10-x11</span></td><td><span>a0-a1</span></td><td><span>function arguments/return values</span></td><td><span>caller</span></td></tr><tr><td><span>x12-x17</span></td><td><span>a2-a7</span></td><td><span>function arguments</span></td><td><span>caller</span></td></tr><tr><td><span>x18-x27</span></td><td><span>s2-s11</span></td><td><span>saved registers</span></td><td><span>callee</span></td></tr><tr><td><span>x28-x31</span></td><td><span>t3-t6</span></td><td><span>temporaries</span></td><td><span>caller</span></td></tr><tr><td><span>f0-f7</span></td><td><span>ft0-ft7</span></td><td><span>FP temporaries</span></td><td><span>caller</span></td></tr><tr><td><span>f8-f9</span></td><td><span>fs0-fs1</span></td><td><span>FP saved registers</span></td><td><span>callee</span></td></tr><tr><td><span>f10-f11</span></td><td><span>fa0-fa1</span></td><td><span>FP function arguments/return values</span></td><td><span>caller</span></td></tr><tr><td><span>f12-f17</span></td><td><span>fa2-fa7</span></td><td><span>FP function arguments</span></td><td><span>caller</span></td></tr><tr><td><span>f18-f27</span></td><td><span>fs2-fs11</span></td><td><span>FP saved registers</span></td><td><span>callee</span></td></tr><tr><td><span>f28-f31</span></td><td><span>ft8-ft11</span></td><td><span>R[rd] = R[rs1] + R[rs2]</span></td><td><span>caller</span></td></tr></tbody></table></figure><p><span>下面是几点说明：</span></p><ul><li><span>以上寄存器都是64位（当然RV32I的话就是32位了）。f是浮点寄存器，为完整性，在此记录。</span></li><li><span>caller是调用者要想办法保存（如果需要的话），被调用的函数可以随意修改这些寄存器。callee是被调用者必须要保存（压到栈中），返回到调用者时，再重新load回来，保证这些寄存器值不变。</span></li><li><span>x0寄存器永远是0，任何写入x0寄存器的值都将被丢弃。</span></li><li><span>x1寄存器用来存函数范围地址的，详情见jal和jalr指令。</span></li><li><span>fp通常是不使用的。可变栈帧才需要fp。</span></li><li><span>栈帧结构与x86类似（应该就是一致吧）。从高地址到低地址依次是保存的返回地址、saved saved registers（s0-s7）和局部变量。在保存的返回地址上面的栈帧最后还可能有argument build area，如果传入的参数个数大于八个的话。当然如果没有必要存在栈中，就不存了。</span></li><li><span>name列个人理解为别名，就是在写汇编程序的时候可以用sp替代x2。事实上，书上示例代码中都是用sp来表示栈顶指针的，但是没有见到其他的替代（譬如a0替代x10）。不过课上大量用了name列。</span></li></ul><h2 id='23-常见指令'><span>2.3 常见指令</span></h2><figure><table><thead><tr><th><span>Category</span></th><th><span>Instruction</span></th><th><span>Example</span></th><th><span>Meaning</span></th><th><span>Format</span></th></tr></thead><tbody><tr><td><span>Arithmetic</span></td><td><span>Add</span></td><td><span>add x5,x6,x7</span></td><td><span>x5=x6+x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Subtract</span></td><td><span>sub x5,x6,x7</span></td><td><span>x5=x6-x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Add immediate</span></td><td><span>addi x5,x6,20</span></td><td><span>x5=x6+20</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Add word</span></td><td><span>addw x5,x6,x7</span></td><td><span>x5=x6+x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Subtract word</span></td><td><span>subw x5,x6,x7</span></td><td><span>x5=x6-x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Add word immediate</span></td><td><span>addiw x5,x6,20</span></td><td><span>x5=x6+20</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Set if less than</span></td><td><span>slt x5,x6,x7</span></td><td><span>x5=1 if x6&lt;x7, else 0</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Set if less than, unsigned</span></td><td><span>sltu x5,x6,x7</span></td><td><span>x5=1 if x6&lt;x7, else 0</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Set if less than, immediate</span></td><td><span>slti x5,x6,x7</span></td><td><span>x5=1 if x6&lt;x7, else 0</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Set if less than, immediate, uns.</span></td><td><span>sltiu x5,x6,x7</span></td><td><span>x5=1 if x6&lt;x7, else 0</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Add upper immediate to PC</span></td><td><span>auipc x5,0x123</span></td><td><span>x5=PC+0x123000</span></td><td><span>U</span></td></tr><tr><td><span>Data transfer</span></td><td><span>Load doubleword</span></td><td><span>ld x5,40(x6)</span></td><td><span>x5=memory[x6+40]</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Store doubleword</span></td><td><span>sd x5,40(x6)</span></td><td><span>memory[x6+40]=x5</span></td><td><span>S</span></td></tr><tr><td>&nbsp;</td><td><span>Load word</span></td><td><span>lw x5,40(x6)</span></td><td><span>x5=memory[x6+40]</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Load word, unsigned</span></td><td><span>lwu x5,40(x6)</span></td><td><span>x5=memory[x6+40]</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Store word</span></td><td><span>sw x5,40(x6)</span></td><td><span>memory[x6+40]=x5</span></td><td><span>S</span></td></tr><tr><td>&nbsp;</td><td><span>Load halfword</span></td><td><span>lh x5,40(x6)</span></td><td><span>x5=memory[x6+40]</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Load halfword, unsigned</span></td><td><span>lhu x5,40(x6)</span></td><td><span>x5=memory[x6+40]</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Store halfword</span></td><td><span>sh x5,40(x6)</span></td><td><span>memory[x6+40]=x5</span></td><td><span>S</span></td></tr><tr><td>&nbsp;</td><td><span>Load byte</span></td><td><span>lb x5,40(x6)</span></td><td><span>x5=memory[x6+40]</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Load byte, unsigned</span></td><td><span>lbu x5,40(x6)</span></td><td><span>x5=memory[x6+40]</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Store byte</span></td><td><span>sb x5,40(x6)</span></td><td><span>memory[x6+40]=x5</span></td><td><span>S</span></td></tr><tr><td>&nbsp;</td><td><span>Load reserved</span></td><td><span>lr.d x5,(x6)</span></td><td><span>x5=memory[x6]</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Store conditional</span></td><td><span>sc.d x7,x5,(x6)</span></td><td><span>memory[x6]=x5; x7=0/1</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Load upper immediate</span></td><td><span>lui x5,0x12345</span></td><td><span>x5=0x12345000</span></td><td><span>U</span></td></tr><tr><td><span>Logical</span></td><td><span>And</span></td><td><span>and x5,x6,x7</span></td><td><span>x5=x6&amp;x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Inclusive or</span></td><td><span>or x5,x6,x7</span></td><td><span>x5=x6</span><span>|</span><span>x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Exclusive or</span></td><td><span>xor x5,x6,x7</span></td><td><span>x5=x6^x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>And immediate</span></td><td><span>andi x5,x6,20</span></td><td><span>x5=x6&amp;20</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Inclusive or immediate</span></td><td><span>ori x5,x6,20</span></td><td><span>x5=x6</span><span>|</span><span>20</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Exclusive or immediate</span></td><td><span>xori x5,x6,20</span></td><td><span>x5=x6^20</span></td><td><span>I</span></td></tr><tr><td><span>Shift</span></td><td><span>Shift left logical</span></td><td><span>sll x5,x6,x7</span></td><td><span>x5=x6&lt;&lt;x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Shift right logical</span></td><td><span>srl x5,x6,x7</span></td><td><span>x5=x6&gt;&gt;x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Shift right arithmetic</span></td><td><span>sra x5,x6,x7</span></td><td><span>x5=x6&gt;&gt;x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Shift left logical immediate</span></td><td><span>slli x5,x6,3</span></td><td><span>x5=x6&lt;&lt;3</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Shift right logical immediate</span></td><td><span>srli x5,x6,3</span></td><td><span>x5=x6&gt;&gt;3</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>Shift right arithmetic immediate</span></td><td><span>srai x5,x6,3</span></td><td><span>x5=x6&gt;&gt;3</span></td><td><span>I</span></td></tr><tr><td>&nbsp;</td><td><span>以上六个末尾加上w，生成新指令</span></td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td><span>Conditional branch</span></td><td><span>Branch if equal</span></td><td><span>beq x5,x6,100</span></td><td><span>if(x5==x6) go to PC+100</span></td><td><span>B</span></td></tr><tr><td>&nbsp;</td><td><span>Branch if not equal</span></td><td><span>bne x5,x6,100</span></td><td><span>if(x5!=x6) go to PC+100</span></td><td><span>B</span></td></tr><tr><td>&nbsp;</td><td><span>Branch if less than</span></td><td><span>blt x5,x6,100</span></td><td><span>if(x5&lt;x6) go to PC+100</span></td><td><span>B</span></td></tr><tr><td>&nbsp;</td><td><span>Branch if greater or equal</span></td><td><span>bge x5,x6,100</span></td><td><span>if(x5&gt;=x6) go to PC+100</span></td><td><span>B</span></td></tr><tr><td>&nbsp;</td><td><span>Branch if less, unsigned</span></td><td><span>bltu x5,x6,100</span></td><td><span>if(x5&lt;x6) go to PC+100</span></td><td><span>B</span></td></tr><tr><td>&nbsp;</td><td><span>Branch if greater or equal, unsigned</span></td><td><span>bgeu x5,x6,100</span></td><td><span>if(x5&gt;=x6) go to PC+100</span></td><td><span>B</span></td></tr><tr><td><span>Unconditional branch</span></td><td><span>Jump and link</span></td><td><span>jal x1,100</span></td><td><span>x1=PC+4; go to PC+100</span></td><td><span>J</span></td></tr><tr><td>&nbsp;</td><td><span>Jump and link register</span></td><td><span>jalr x1,100(x5)</span></td><td><span>x1=PC+4; go to x5+100</span></td><td><span>I</span></td></tr></tbody></table></figure><p><strong><span>几点说明：</span></strong></p><ul><li><p><span>d: doubleword, 8B; w: word, 4B; h: halfword, 2B; b: byte, 1B</span></p></li><li><p><span>没有subi是因为可以用addi代替，没有not是因为可以用xor FF...FF代替。可见addi的立即数可以表示负数，是带符号的。还有似乎好像应该那些做offset的立即数都是带符号的</span></p></li><li><p><span>逻辑右移：左边补零；算术右移：左边补符号位</span></p></li><li><p><span>对于load指令，好像可能应该都要做符号扩展，有u做零扩展，无u做符号位扩展。至少PPT上RV32I，lb符号扩展；书上RV64I，lw符号扩展。</span></p></li><li><p><span>load是从内存中加载数据到寄存器，store是从寄存器中存储数据到内存。</span></p></li><li><p><span>lr.d与sc.d是RV64A中的两个指令，以上其余指令都是RV64I的。若lr.d的内存在sc.d执行之前被修改，那么sc.d会失败且不向内存中写值。此外sc.d若成功则将某个寄存器值改为0，否则为非0值。下面是利用这两个指令实现原子交换的简单例子：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># an atomic swap between x23 and memory[x20]</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">again:</span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">lr</span>.d x10, (x20)<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># x10 = memory[x20]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>sc.d x11, x23, (x20)<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># 若memroy[x20]改变了，则x11非0；否则memory[x20]=x23且x11=0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">bne</span> <span class="cm-keyword">x11</span>, x0, again<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># if x11 != 0, go to again</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">addi</span> <span class="cm-keyword">x23</span>, x10, 0<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># x23 = x10</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 113px;"></div><div class="CodeMirror-gutters" style="display: none; height: 113px;"></div></div></div></pre></li><li><p><span>lui使得将32位立即数复制到寄存器可行。由2.4可知I-type的立即数编码只有12位，利用lui可扩展立即数的位数。lui拷贝一个20位的常数到寄存器的第12到31位（0-base），最左边的32位设置为第31位的值，最右边的12位设置为0。下面是具体方案：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># copy 00 00 00 00 00 3d 05 00 to x19</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">lui</span> <span class="cm-keyword">x19</span>, 0x3d0 <span class="cm-comment"># x19 becomes 00 00 00 00 00 3d 00 00</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">addi</span> <span class="cm-keyword">x19</span>, x19, 0x500</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="display: none; height: 68px;"></div></div></div></pre><p><span>但是这里还存在一个问题，addi的立即数会进行符号扩展（将最高的第11位扩展），产生如下问题：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># copy FF FF FF FF DE AD BE EF to x19</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">lui</span> <span class="cm-keyword">x19</span>, 0xDEADB <span class="cm-comment"># x19 becomes FF FF FF FF DE AD B0 00</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">addi</span> <span class="cm-keyword">x19</span>, x19, 0xEEF <span class="cm-comment"># we get FF FF FF FF DE AD AE EF, not the result we want</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 68px;"></div><div class="CodeMirror-gutters" style="display: none; height: 68px;"></div></div></div></pre><p><span>解决方法是将</span><code>lui x19, 0xDEADB</code><span>改成</span><code>lui x19, 0xDEADC</code></p></li><li><p><span>auipc对立即数的操作和lui一致。auipc和jalr的联合使用可以实现相对PC地址32位偏移量的相对跳转；lui和jalr的联合使用则实现了32位绝对地址的跳转。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># jump PC-relative with 32-bit offset</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">auipc</span> <span class="cm-keyword">x1</span>, &lt;hi20bits&gt; <span class="cm-comment"># PC加高20位后存在x1（不改变PC）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">jalr</span> <span class="cm-keyword">x0</span>, x1, &lt;lo12bits&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># call function at any 32-bit absolute address</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">lui</span> <span class="cm-keyword">x1</span>, &lt;hi20bits&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">jalr</span> <span class="cm-keyword">ra</span>, x1, &lt;lo12bits&gt;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 159px;"></div><div class="CodeMirror-gutters" style="display: none; height: 159px;"></div></div></div></pre><p><span>同样的，个人认为也会存在lui的相同问题，但是没有搜到有人对此的讨论。</span></p></li><li><p><span>jal和jalr实现了类似x86的call和ret指令。对于leaf procedure (i.e. procedures that do not call others)，我们无需把x1压入栈中。通常是这样操作：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># a procedure sample(not a leaf procedure)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">func1:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">addi</span> <span class="cm-variable">sp</span>, <span class="cm-variable">sp</span>, -32</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">sd</span> <span class="cm-keyword">x1</span>, 24(<span class="cm-variable">sp</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">sd</span> <span class="cm-keyword">x21</span>, 16(<span class="cm-variable">sp</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">sd</span> <span class="cm-keyword">x20</span>, 8(<span class="cm-variable">sp</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">sd</span> <span class="cm-keyword">x19</span>, 0(<span class="cm-variable">sp</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">jal</span> <span class="cm-keyword">x1</span>, func2</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">ld</span> <span class="cm-keyword">x19</span>, 0(<span class="cm-variable">sp</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">ld</span> <span class="cm-keyword">x20</span>, 8(<span class="cm-variable">sp</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">ld</span> <span class="cm-keyword">x21</span>, 16(<span class="cm-variable">sp</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">ld</span> <span class="cm-keyword">x1</span>, 24(<span class="cm-variable">sp</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">addi</span> <span class="cm-variable">sp</span>, <span class="cm-variable">sp</span>, 32</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">jalr</span> <span class="cm-keyword">x0</span>, 0(x1)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 363px;"></div><div class="CodeMirror-gutters" style="display: none; height: 363px;"></div></div></div></pre></li><li><p><span>此外，</span><code>jalr</code><span>是I型的指令，书上都是写成</span><code>jalr x0, 0(x1)</code><span>这样子的，但是I型指令写成</span><code>jalr x0, x1, 0</code><span>可能更好一点。</span></p></li></ul><p><span>此外assember还接受一些伪指令用来简化汇编程序的书写：</span></p><figure><table><thead><tr><th><span>pseudoinstruction</span></th><th><span>base instruction</span></th><th><span>meaning</span></th></tr></thead><tbody><tr><td><span>li rd, immediate</span></td><td><span>addi rd, x0, immediate</span></td><td><span>Load immediate</span></td></tr><tr><td><span>la rd, label</span></td><td><span>见表格后讨论</span></td><td><span>Load label&#39;s address</span></td></tr><tr><td><span>mv rd, rs</span></td><td><span>addi rd, rs, 0</span></td><td><span>Copy register</span></td></tr><tr><td><span>nop</span></td><td><span>addi x0, x0, 0</span></td><td><span>No operation</span></td></tr><tr><td><span>and rd, rs, immediate</span></td><td><span>andi rd, rs, immediate</span></td><td><span>rd = rs &amp; immediate</span></td></tr><tr><td><span>call label</span></td><td><span>见表格后讨论</span></td><td>&nbsp;</td></tr><tr><td><span>tail label</span></td><td><span>见表格后讨论</span></td><td>&nbsp;</td></tr><tr><td><span>ret</span></td><td><span>jalr x0, 0(x1)</span></td><td><span>return</span></td></tr><tr><td><span>jalr rs</span></td><td><span>jalr x1, 0(rs)</span></td><td>&nbsp;</td></tr><tr><td><span>jal label</span></td><td><span>jal x1, label</span></td><td>&nbsp;</td></tr><tr><td><span>j label</span></td><td><span>jal x0, label</span></td><td>&nbsp;</td></tr><tr><td><span>jr rs</span></td><td><span>jalr x0, 0(rs)</span></td><td>&nbsp;</td></tr></tbody></table></figure><p><strong><span>注意到</span></strong><span>：</span></p><ul><li><span>对于超过12位的立即数，li指令等价于：</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># li rd, immediate</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># immediate larger than 12 bits</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">lui</span> <span class="cm-keyword">rd</span>, imm[<span class="cm-tag">31:</span>12]+imm[11] <span class="cm-comment"># 当然没有imm[31:12]+imm[11]这种写法</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">addi</span> <span class="cm-keyword">rd</span>,rd,imm[<span class="cm-tag">11:</span>0]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="display: none; height: 91px;"></div></div></div></pre><ul><li><span>加载32位地址，la等价于（然而64位地址咋办呢，现在母鸡啊）：</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># la rd, label</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># load a 32-bit address</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># offset is the difference of address between label and PC</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">auipc</span> <span class="cm-keyword">rd</span>, offset[<span class="cm-tag">31:</span>12]+offset[11]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">addi</span> <span class="cm-keyword">rd</span>, rd, offset[<span class="cm-tag">11:</span>0]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 113px;"></div><div class="CodeMirror-gutters" style="display: none; height: 113px;"></div></div></div></pre><ul><li><span>call label and tail label</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># offset is the difference of address between label and PC</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># note that x6 is temporary variable</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># call label</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">auipc</span> <span class="cm-keyword">x6</span>, offset[<span class="cm-tag">31:</span>12]+offset[11]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">jalr</span> <span class="cm-keyword">x1</span>, offset[<span class="cm-tag">11:</span>0](x6)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># tail label</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">auipc</span> <span class="cm-keyword">x6</span>, offset[<span class="cm-tag">31:</span>12]+offset[11]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">jalr</span> <span class="cm-keyword">x0</span>, offset[<span class="cm-tag">11:</span>0](x6)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 204px;"></div><div class="CodeMirror-gutters" style="display: none; height: 204px;"></div></div></div></pre><p><span>最后谈一下和x86-64的一些指令上的异同：</span></p><ul><li><span>RISC-V很多都是三元的指令，而x86都是二元的。比如：</span><code>add x5,x6,x7</code><span>和 </span><code>addq %rbx, %rax</code></li><li><span>RISC-V的条件分支不需要条件码，而x86需要。比如x86需要先cmp设置条件码后才能jmp，而RISC-V只需要一条指令就好了。不用条件码可以帮助减少设计流水线时的数据相关问题。</span></li><li><span>RISC-V和x86对于比较大小都给出了无符号数和有符号数的版本。比如RISC-V条件跳转有bge和bgeu之分，而类似的x86有jge和jae之分。</span></li></ul><h2 id='24-core-instruction-formats'><span>2.4 Core Instruction Formats</span></h2><p><span>指令编码可以分成六类：</span></p><p><img src="./img/image-20220123105128950.png" referrerpolicy="no-referrer" alt="instructionFormat"></p><p><span>对于不同类型的命名我推测如下</span></p><ul><li><span>R-type。R = register。特点为：需要三个寄存器，不需要立即数。比如：add、sll等</span></li><li><span>I-type。I = immediate。特点为：两个寄存器，一个立即数。比如addi、slli等</span></li><li><span>S-type。S = store。特点为：两个寄存器，一个立即数。比如各种store指令</span></li><li><span>B-type。B = branch，又称SB-type。特点为：两个寄存器，一个立即数，且这个立即数一定是偶数（这是由指令地址一定是偶数所保证的：一个指令4字节，事实上此时最后两位都是0，但是为了兼容16位的RISC-V指令，这里只省去最低位），因此最低位必定是0，可以省略。比如各种branch指令。</span></li><li><span>U-type。U=upper。特点为：一个寄存器，一个立即数。有lui指令、auipc指令。两者都设置寄存器的高20位（12-31位），可以用来把一个12位的立即数扩充到32位。</span></li><li><span>J-type。又称UJ-type，UJ = unconditional jump-and-link。只有jal一个指令使用了UJ-type。特点为一个寄存器，一个立即数，且这个立即数一定是偶数，不必记录最低位。</span></li></ul><p><span>几点说明：</span></p><ul><li><p><span>这里所有的RISC-V指令都是32位的。当然RISCV其实有多种长度的编码格式，我们只关心32位的，32位的指令编码有特点：最低五位是abc11（abc不为111）的样子。</span></p></li><li><p><span>S、B、J-type中立即数奇怪的划分是为了和保证其余部分尽可能的统一。比如B-type和S-type中立即数的1～4以及5～10位是在相同编码位置的。</span></p></li><li><p><span>B-type和J-type的立即数不再需要最低位，这使得可以表示的立即数范围变大。</span></p></li><li><p><span>寻址很多时候采取的是PC-relative模式。</span></p></li><li><p><span>对于采用B-type的branch指令，可以有±4KiB的跳转范围（13位立即数）；对于采用J-type的jal指令，可以有±1MiB（21位立即数）的跳转范围；采用I-type的jalr指令偏移的地址范围在rs1寄存器中存储地址的±2KiB（12位立即数）。至于想要更大的跳转范围，需要使用auipc与jalr指令（相对PC）或者lui与jalr指令（绝对地址），前者跳转范围可达±2GiB（32位立即数），后者绝对地址范围32位。</span></p></li><li><p><span>可以看出jalr采用I-type浪费了最低位立即数，个人认为如果特地为jalr新设一种类型，会造成硬件实现上的困难。此外±2GiB已经挺大了。</span></p></li><li><p><span>branch指令只有±4KiB的跳转范围，可以使用以下技巧增大范围：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># origin code</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">beq</span> <span class="cm-keyword">x10</span>, x0, far</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">wulala</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># modified</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">bne</span> <span class="cm-keyword">x10</span>, x0, next</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">j</span> <span class="cm-keyword">far</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">wulala</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 181px;"></div><div class="CodeMirror-gutters" style="display: none; height: 181px;"></div></div></div></pre></li></ul><p><span>最后理应给出指令的opcode、funct3和funct7编码，但是个人觉得没有必要了。可以参考本书封底。</span></p><h2 id='25-一个详实的例子'><span>2.5 一个详实的例子</span></h2><p><span>2.13节A C Sort Example to Put It All Together。P134～P139，一个冒泡排序的RISC-V汇编程序，值得一看。这里就不摘录下来了。</span></p><h2 id='26-设计思想'><span>2.6 设计思想</span></h2><ol start='' ><li><span>Simplicity favors regularity.</span></li><li><span>Smaller is faster.</span></li><li><span>Good design demands good compromises.</span></li></ol><h2 id='27-可执行文件的生成和执行'><span>2.7 可执行文件的生成和执行</span></h2><p><span>比较粗糙的整理。之前</span><a href='https://iewug.github.io/book/csapp/chapter7.html'><span>Chapter7 (Gu Wei.cn)</span></a><span>也有整理，事实上已经忘光光了。csapp第七章链接相当难读。事实上，个人觉得有以下mind map即可。</span></p><p><span>高级语言程序通过compiler转换为汇编程序，汇编程序通过assembler转换为可重定位目标文件，多个可重定位目标文件通过linker链接成可执行文件，可执行文件由loader加载到内存。</span></p><p><span>编译器compiler做啥呢？多次扫描进行词法分析、语法分析、语义分析和优化、代码生成。这是编译原理关心的内容。</span></p><p><span>汇编器assembler做啥呢？替换伪指令，把那些指令中的label替换为相对偏移量offset，创建符号表、重定位表、代码段、数据段。</span></p><p><span>链接器linker做啥呢？把各种可重定位目标文件拼起来，把那些之前无法确定的值确定下来（譬如外部函数调用之类的）。</span></p><p><span>动态链接就是等到程序要加载时或要运行时才进行链接；而静态链接则在linker后就把所有东西都链接起来了，然后加载到内存。静态链接有以下缺点：需要定期维护和更新，占用大量的内存资源。</span></p><hr /><div style="page-break-after: always;"></div> <h1 id='chapter-3'><span>Chapter 3</span></h1><p><span>这章先是介绍了整数的四则运算、背后的硬件设计和相关RISC-V指令，然后介绍浮点数、浮点数加法和乘法以及相关硬件，最后介绍子字并行和x86的SIMD相关内容。个人觉得讲的不够清晰，也可能是本人水平有限吧。</span></p><h2 id='31-基本知识'><span>3.1 基本知识</span></h2><p><span>之前的整理已经十分详细了，见</span><a href='https://iewug.github.io/book/csapp/chapter2.html' target='_blank' class='url'>https://iewug.github.io/book/csapp/chapter2.html</a></p><p><span>这里还有一点补充。</span></p><ul><li><p><span>整数加减法的溢出。具体体现为正数相加为负数，负数相加为正数等，也就是运算结果超过了数据表示范围。x86会设置OF寄存器为1。如果最高位（符号位）用两位表示，00为正数、11为负数，那么01和10为溢出。也可以通过：最高位进位和次高位进位不同时为0或1（异或运算），来判断溢出。乘法指令一般没有判断溢出的功能，但我们可以通过运算结果是否超过数据表示范围进行判断。</span></p></li><li><p><span>整数的加减法以及和或等逻辑运算。通过ALU实现，ALU具体设计在本书附录A。</span></p></li><li><p><span>整数的乘法。主要思路就是通过移位和加法运算实现。先是给出一个和竖式乘法思路一致的乘法器，然后改良硬件使得移位和加法并行处理、寄存器进一步节约，最后通过引入大量的ALU使得一个64位乘法所需要的时间只要六次加法时间，并提及利用carry save adders或流水线可以进一步加快运算。</span></p></li><li><p><span>整数的除法。主要思路就是通过移位和减法运算实现。先是给出一个和竖式除法思路类似的乘法器，然后改良硬件使得移位和减法并行处理、寄存器进一步节约，最后可以通过预测来进一步加快运算时间。恢复余数法、加减交替法。</span></p></li><li><p><span>浮点加法。采用向偶舍入的方法。小阶往大阶对（下例中-2向-1对）；尾数加减；规格化（左规：尾数左移，阶码减一；右规：尾数右移，阶码加一）；舍入（四舍六入五凑偶）；溢出检查。不如举个例子：</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n705" cid="n705" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="50.857ex" height="13.302ex" role="img" focusable="false" viewBox="0 -3189.8 22478.9 5879.7" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -6.086ex;"><defs><path id="MJX-7-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path id="MJX-7-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-7-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-7-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-7-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-7-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-7-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-7-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path id="MJX-7-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-7-TEX-N-37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z"></path><path id="MJX-7-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-7-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-7-TEX-I-1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path><path id="MJX-7-TEX-I-1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path><path id="MJX-7-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-7-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-7-TEX-S4-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-7-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-7-TEX-I-1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-7-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtable"><g data-mml-node="mtr" transform="translate(0,2305.9)"><g data-mml-node="mtd"><g data-mml-node="msub"><g data-mml-node="mn"><use data-c="35" xlink:href="#MJX-7-TEX-N-35"></use><use data-c="2E" xlink:href="#MJX-7-TEX-N-2E" transform="translate(500,0)"></use><use data-c="35" xlink:href="#MJX-7-TEX-N-35" transform="translate(778,0)"></use></g><g data-mml-node="TeXAtom" transform="translate(1311,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-7-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D452" xlink:href="#MJX-7-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(827,0)"><use data-c="1D45B" xlink:href="#MJX-7-TEX-I-1D45B"></use></g></g></g><g data-mml-node="mo" transform="translate(2592.3,0)"><use data-c="2212" xlink:href="#MJX-7-TEX-N-2212"></use></g><g data-mml-node="msub" transform="translate(3592.5,0)"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-7-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-7-TEX-N-2E" transform="translate(500,0)"></use><use data-c="34" xlink:href="#MJX-7-TEX-N-34" transform="translate(778,0)"></use><use data-c="33" xlink:href="#MJX-7-TEX-N-33" transform="translate(1278,0)"></use><use data-c="37" xlink:href="#MJX-7-TEX-N-37" transform="translate(1778,0)"></use><use data-c="35" xlink:href="#MJX-7-TEX-N-35" transform="translate(2278,0)"></use></g><g data-mml-node="TeXAtom" transform="translate(2811,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-7-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D452" xlink:href="#MJX-7-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(827,0)"><use data-c="1D45B" xlink:href="#MJX-7-TEX-I-1D45B"></use></g></g></g></g><g data-mml-node="mtd" transform="translate(7462.5,0)"><g data-mml-node="mi"></g><g data-mml-node="mo" transform="translate(277.8,0)"><use data-c="3D" xlink:href="#MJX-7-TEX-N-3D"></use></g><g data-mml-node="msub" transform="translate(1333.6,0)"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use><use data-c="2E" xlink:href="#MJX-7-TEX-N-2E" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(778,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1278,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1778,0)"></use></g><g data-mml-node="TeXAtom" transform="translate(2311,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-7-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D464" xlink:href="#MJX-7-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(1077,0)"><use data-c="1D45C" xlink:href="#MJX-7-TEX-I-1D45C"></use></g></g></g><g data-mml-node="mo" transform="translate(5021.3,0)"><use data-c="D7" xlink:href="#MJX-7-TEX-N-D7"></use></g><g data-mml-node="msup" transform="translate(6021.5,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-7-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><use data-c="2212" xlink:href="#MJX-7-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(778,0)"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use></g></g></g><g data-mml-node="mo" transform="translate(7730.4,0)"><use data-c="2212" xlink:href="#MJX-7-TEX-N-2212"></use></g><g data-mml-node="msub" transform="translate(8730.6,0)"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use><use data-c="2E" xlink:href="#MJX-7-TEX-N-2E" transform="translate(500,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(778,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(1278,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1778,0)"></use></g><g data-mml-node="TeXAtom" transform="translate(2311,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-7-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D464" xlink:href="#MJX-7-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(1077,0)"><use data-c="1D45C" xlink:href="#MJX-7-TEX-I-1D45C"></use></g></g></g><g data-mml-node="mo" transform="translate(12418.4,0)"><use data-c="D7" xlink:href="#MJX-7-TEX-N-D7"></use></g><g data-mml-node="msup" transform="translate(13418.6,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-7-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><use data-c="2212" xlink:href="#MJX-7-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(778,0)"><use data-c="32" xlink:href="#MJX-7-TEX-N-32"></use></g></g></g></g></g><g data-mml-node="mtr" transform="translate(0,872)"><g data-mml-node="mtd" transform="translate(7462.5,0)"></g><g data-mml-node="mtd" transform="translate(7462.5,0)"><g data-mml-node="mi"></g><g data-mml-node="mo" transform="translate(277.8,0)"><use data-c="3D" xlink:href="#MJX-7-TEX-N-3D"></use></g><g data-mml-node="msub" transform="translate(1333.6,0)"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use><use data-c="2E" xlink:href="#MJX-7-TEX-N-2E" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(778,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1278,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1778,0)"></use></g><g data-mml-node="TeXAtom" transform="translate(2311,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-7-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D464" xlink:href="#MJX-7-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(1077,0)"><use data-c="1D45C" xlink:href="#MJX-7-TEX-I-1D45C"></use></g></g></g><g data-mml-node="mo" transform="translate(5021.3,0)"><use data-c="D7" xlink:href="#MJX-7-TEX-N-D7"></use></g><g data-mml-node="msup" transform="translate(6021.5,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-7-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><use data-c="2212" xlink:href="#MJX-7-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(778,0)"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use></g></g></g><g data-mml-node="mo" transform="translate(7730.4,0)"><use data-c="2212" xlink:href="#MJX-7-TEX-N-2212"></use></g><g data-mml-node="msub" transform="translate(8730.6,0)"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-7-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-7-TEX-N-2E" transform="translate(500,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(778,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(1278,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(1778,0)"></use></g><g data-mml-node="TeXAtom" transform="translate(2311,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-7-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D464" xlink:href="#MJX-7-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(1077,0)"><use data-c="1D45C" xlink:href="#MJX-7-TEX-I-1D45C"></use></g></g></g><g data-mml-node="mo" transform="translate(12418.4,0)"><use data-c="D7" xlink:href="#MJX-7-TEX-N-D7"></use></g><g data-mml-node="msup" transform="translate(13418.6,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-7-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><use data-c="2212" xlink:href="#MJX-7-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(778,0)"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use></g></g></g></g></g><g data-mml-node="mtr" transform="translate(0,-569.7)"><g data-mml-node="mtd" transform="translate(7462.5,0)"></g><g data-mml-node="mtd" transform="translate(7462.5,0)"><g data-mml-node="mi"></g><g data-mml-node="mo" transform="translate(277.8,0)"><use data-c="3D" xlink:href="#MJX-7-TEX-N-3D"></use></g><g data-mml-node="msub" transform="translate(1333.6,0)"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-7-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-7-TEX-N-2E" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(778,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1278,0)"></use><use data-c="31" xlink:href="#MJX-7-TEX-N-31" transform="translate(1778,0)"></use></g><g data-mml-node="TeXAtom" transform="translate(2311,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-7-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D464" xlink:href="#MJX-7-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(1077,0)"><use data-c="1D45C" xlink:href="#MJX-7-TEX-I-1D45C"></use></g></g></g><g data-mml-node="mo" transform="translate(5021.3,0)"><use data-c="D7" xlink:href="#MJX-7-TEX-N-D7"></use></g><g data-mml-node="msup" transform="translate(6021.5,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-7-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><use data-c="2212" xlink:href="#MJX-7-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(778,0)"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use></g></g></g><g data-mml-node="mo" transform="translate(7786,0)"><use data-c="3D" xlink:href="#MJX-7-TEX-N-3D"></use></g><g data-mml-node="msub" transform="translate(8841.7,0)"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use><use data-c="2E" xlink:href="#MJX-7-TEX-N-2E" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(778,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1278,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1778,0)"></use></g><g data-mml-node="TeXAtom" transform="translate(2311,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-7-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D464" xlink:href="#MJX-7-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(1077,0)"><use data-c="1D45C" xlink:href="#MJX-7-TEX-I-1D45C"></use></g></g></g><g data-mml-node="mo" transform="translate(12529.5,0)"><use data-c="D7" xlink:href="#MJX-7-TEX-N-D7"></use></g><g data-mml-node="msup" transform="translate(13529.7,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-7-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><use data-c="2212" xlink:href="#MJX-7-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(778,0)"><use data-c="34" xlink:href="#MJX-7-TEX-N-34"></use></g></g></g></g></g><g data-mml-node="mtr" transform="translate(0,-2439.8)"><g data-mml-node="mtd" transform="translate(7462.5,0)"></g><g data-mml-node="mtd" transform="translate(7462.5,0)"><g data-mml-node="mi"></g><g data-mml-node="mover" transform="translate(277.8,0)"><g data-mml-node="mstyle"><g data-mml-node="mo"><svg width="2408.4" height="865" x="0" y="-182" viewBox="602.1 -182 2408.4 865"><use data-c="3D" xlink:href="#MJX-7-TEX-S4-3D" transform="scale(4.643,1)"></use></svg></g></g><g data-mml-node="mpadded" transform="translate(0,870.8) scale(0.707)"><g transform="translate(389,-200)"><g data-mml-node="mi"><use data-c="1D45F" xlink:href="#MJX-7-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(451,0)"><use data-c="1D45C" xlink:href="#MJX-7-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(936,0)"><use data-c="1D462" xlink:href="#MJX-7-TEX-I-1D462"></use></g><g data-mml-node="mi" transform="translate(1508,0)"><use data-c="1D45B" xlink:href="#MJX-7-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(2108,0)"><use data-c="1D451" xlink:href="#MJX-7-TEX-I-1D451"></use></g><g data-mml-node="mspace" transform="translate(2628,0)"></g></g></g></g><g data-mml-node="msub" transform="translate(2964,0)"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-7-TEX-N-31"></use><use data-c="2E" xlink:href="#MJX-7-TEX-N-2E" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(778,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1278,0)"></use><use data-c="30" xlink:href="#MJX-7-TEX-N-30" transform="translate(1778,0)"></use></g><g data-mml-node="TeXAtom" transform="translate(2311,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D461" xlink:href="#MJX-7-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(361,0)"><use data-c="1D464" xlink:href="#MJX-7-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(1077,0)"><use data-c="1D45C" xlink:href="#MJX-7-TEX-I-1D45C"></use></g></g></g><g data-mml-node="mo" transform="translate(6651.7,0)"><use data-c="D7" xlink:href="#MJX-7-TEX-N-D7"></use></g><g data-mml-node="msup" transform="translate(7651.9,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-7-TEX-N-32"></use></g><g data-mml-node="TeXAtom" transform="translate(533,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><use data-c="2212" xlink:href="#MJX-7-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(778,0)"><use data-c="34" xlink:href="#MJX-7-TEX-N-34"></use></g></g></g></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mtable displaystyle="true" columnalign="right left" columnspacing="0em" rowspacing="3pt"><mtr><mtd><msub><mn>5.5</mn><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>e</mi><mi>n</mi></mrow></msub><mo>−</mo><msub><mn>0.4375</mn><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>e</mi><mi>n</mi></mrow></msub></mtd><mtd><mi></mi><mo>=</mo><msub><mn>1.000</mn><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>w</mi><mi>o</mi></mrow></msub><mo>×</mo><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mo>−</mo><mn>1</mn></mrow></msup><mo>−</mo><msub><mn>1.110</mn><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>w</mi><mi>o</mi></mrow></msub><mo>×</mo><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mo>−</mo><mn>2</mn></mrow></msup></mtd></mtr><mtr><mtd></mtd><mtd><mi></mi><mo>=</mo><msub><mn>1.000</mn><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>w</mi><mi>o</mi></mrow></msub><mo>×</mo><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mo>−</mo><mn>1</mn></mrow></msup><mo>−</mo><msub><mn>0.111</mn><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>w</mi><mi>o</mi></mrow></msub><mo>×</mo><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mo>−</mo><mn>1</mn></mrow></msup></mtd></mtr><mtr><mtd></mtd><mtd><mi></mi><mo>=</mo><msub><mn>0.001</mn><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>w</mi><mi>o</mi></mrow></msub><mo>×</mo><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mo>−</mo><mn>1</mn></mrow></msup><mo>=</mo><msub><mn>1.000</mn><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>w</mi><mi>o</mi></mrow></msub><mo>×</mo><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mo>−</mo><mn>4</mn></mrow></msup></mtd></mtr><mtr><mtd></mtd><mtd><mi></mi><mover><mstyle scriptlevel="0"><mo data-mjx-texclass="REL" stretchy="true">=</mo></mstyle><mpadded width="+0.778em" lspace="0.389em" voffset="-.2em" height="-.2em"><mi>r</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>d</mi><mspace depth=".25em"></mspace></mpadded></mover><msub><mn>1.000</mn><mrow data-mjx-texclass="ORD"><mi>t</mi><mi>w</mi><mi>o</mi></mrow></msub><mo>×</mo><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mo>−</mo><mn>4</mn></mrow></msup></mtd></mtr></mtable></math></mjx-assistive-mml></mjx-container></div></div><p><span>在做计算的时候，尾数后面要再多保存三位，由高到低分别是guard、round、sticky位。当guard是0时，就不用进位了；guard为1，round为1，进位；guard为1，round为0，sticky为1，进位；guard为1，round为0，sticky为0，看guard前面一位（尾数最后一位），如果为0，就不进位，如果为1，进位。之所以要sticky位，考虑</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="59.135ex" height="2.09ex" role="img" focusable="false" viewBox="0 -841.7 26137.5 923.7" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.186ex;"><defs><path id="MJX-11-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-11-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-11-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-11-TEX-N-A0" d=""></path><path id="MJX-11-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-11-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-11-TEX-N-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path id="MJX-11-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-11-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-11-TEX-N-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-11-TEX-N-31"></use><use data-c="2E" xlink:href="#MJX-11-TEX-N-2E" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-11-TEX-N-30" transform="translate(778,0)"></use><use data-c="30" xlink:href="#MJX-11-TEX-N-30" transform="translate(1278,0)"></use><use data-c="30" xlink:href="#MJX-11-TEX-N-30" transform="translate(1778,0)"></use></g><g data-mml-node="mtext" transform="translate(2278,0)"><use data-c="A0" xlink:href="#MJX-11-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(2528,0)"><use data-c="30" xlink:href="#MJX-11-TEX-N-30"></use><use data-c="30" xlink:href="#MJX-11-TEX-N-30" transform="translate(500,0)"></use></g><g data-mml-node="mo" transform="translate(3750.2,0)"><use data-c="D7" xlink:href="#MJX-11-TEX-N-D7"></use></g><g data-mml-node="msup" transform="translate(4750.4,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-11-TEX-N-32"></use></g><g data-mml-node="mn" transform="translate(533,363) scale(0.707)"><use data-c="35" xlink:href="#MJX-11-TEX-N-35"></use></g></g><g data-mml-node="mo" transform="translate(5909.2,0)"><use data-c="2212" xlink:href="#MJX-11-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(6909.4,0)"><use data-c="30" xlink:href="#MJX-11-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-11-TEX-N-2E" transform="translate(500,0)"></use><use data-c="30" xlink:href="#MJX-11-TEX-N-30" transform="translate(778,0)"></use><use data-c="30" xlink:href="#MJX-11-TEX-N-30" transform="translate(1278,0)"></use><use data-c="30" xlink:href="#MJX-11-TEX-N-30" transform="translate(1778,0)"></use></g><g data-mml-node="mtext" transform="translate(9187.4,0)"><use data-c="A0" xlink:href="#MJX-11-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(9437.4,0)"><use data-c="31" xlink:href="#MJX-11-TEX-N-31"></use><use data-c="31" xlink:href="#MJX-11-TEX-N-31" transform="translate(500,0)"></use></g><g data-mml-node="mo" transform="translate(10659.7,0)"><use data-c="D7" xlink:href="#MJX-11-TEX-N-D7"></use></g><g data-mml-node="msup" transform="translate(11659.9,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-11-TEX-N-32"></use></g><g data-mml-node="mn" transform="translate(533,363) scale(0.707)"><use data-c="35" xlink:href="#MJX-11-TEX-N-35"></use></g></g><g data-mml-node="mo" transform="translate(12874.2,0)"><use data-c="3D" xlink:href="#MJX-11-TEX-N-3D"></use></g><g data-mml-node="mn" transform="translate(13930,0)"><use data-c="30" xlink:href="#MJX-11-TEX-N-30"></use><use data-c="2E" xlink:href="#MJX-11-TEX-N-2E" transform="translate(500,0)"></use><use data-c="31" xlink:href="#MJX-11-TEX-N-31" transform="translate(778,0)"></use><use data-c="31" xlink:href="#MJX-11-TEX-N-31" transform="translate(1278,0)"></use><use data-c="31" xlink:href="#MJX-11-TEX-N-31" transform="translate(1778,0)"></use></g><g data-mml-node="mtext" transform="translate(16208,0)"><use data-c="A0" xlink:href="#MJX-11-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(16458,0)"><use data-c="30" xlink:href="#MJX-11-TEX-N-30"></use><use data-c="31" xlink:href="#MJX-11-TEX-N-31" transform="translate(500,0)"></use></g><g data-mml-node="mo" transform="translate(17680.2,0)"><use data-c="D7" xlink:href="#MJX-11-TEX-N-D7"></use></g><g data-mml-node="msup" transform="translate(18680.4,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-11-TEX-N-32"></use></g><g data-mml-node="mn" transform="translate(533,363) scale(0.707)"><use data-c="35" xlink:href="#MJX-11-TEX-N-35"></use></g></g><g data-mml-node="mo" transform="translate(19894.8,0)"><use data-c="3D" xlink:href="#MJX-11-TEX-N-3D"></use></g><g data-mml-node="mn" transform="translate(20950.5,0)"><use data-c="31" xlink:href="#MJX-11-TEX-N-31"></use><use data-c="2E" xlink:href="#MJX-11-TEX-N-2E" transform="translate(500,0)"></use><use data-c="31" xlink:href="#MJX-11-TEX-N-31" transform="translate(778,0)"></use><use data-c="31" xlink:href="#MJX-11-TEX-N-31" transform="translate(1278,0)"></use><use data-c="30" xlink:href="#MJX-11-TEX-N-30" transform="translate(1778,0)"></use></g><g data-mml-node="mtext" transform="translate(23228.5,0)"><use data-c="A0" xlink:href="#MJX-11-TEX-N-A0"></use></g><g data-mml-node="mn" transform="translate(23478.5,0)"><use data-c="31" xlink:href="#MJX-11-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(24200.8,0)"><use data-c="D7" xlink:href="#MJX-11-TEX-N-D7"></use></g><g data-mml-node="msup" transform="translate(25201,0)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-11-TEX-N-32"></use></g><g data-mml-node="mn" transform="translate(533,363) scale(0.707)"><use data-c="34" xlink:href="#MJX-11-TEX-N-34"></use></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1.000</mn><mtext>&nbsp;</mtext><mn>00</mn><mo>×</mo><msup><mn>2</mn><mn>5</mn></msup><mo>−</mo><mn>0.000</mn><mtext>&nbsp;</mtext><mn>11</mn><mo>×</mo><msup><mn>2</mn><mn>5</mn></msup><mo>=</mo><mn>0.111</mn><mtext>&nbsp;</mtext><mn>01</mn><mo>×</mo><msup><mn>2</mn><mn>5</mn></msup><mo>=</mo><mn>1.110</mn><mtext>&nbsp;</mtext><mn>1</mn><mo>×</mo><msup><mn>2</mn><mn>4</mn></msup></math></mjx-assistive-mml></mjx-container><script type="math/tex">1.000\ 00\times 2^5-0.000\ 11\times2^5=0.111\ 01\times2^5=1.110\ 1\times2^4</script><span>，此时就不知道要不要舍入了。</span></p></li><li><p><span>浮点乘法。指数和指数运算，尾数和尾数运算，规格化，舍入，设置符号位。</span></p></li></ul><h2 id='32-risc-v指令'><span>3.2 RISC-V指令</span></h2><p><strong><span>关于RV64M有以下指令：</span></strong></p><figure><table><thead><tr><th><span>Category</span></th><th><span>Instruction</span></th><th><span>Example</span></th><th><span>Meaning</span></th><th><span>Format</span></th></tr></thead><tbody><tr><td><span>Arithmetic</span></td><td><span>Multiply</span></td><td><span>mul x5,x6,x7</span></td><td><span>x5=x6*x7, lower 64 bits</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Multiply high</span></td><td><span>mulh x5,x6,x7</span></td><td><span>x5=(x6*x7)&gt;&gt;64</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Multiply high,unsigned</span></td><td><span>mulhu x5,x6,x7</span></td><td><span>x5=(x6*x7)&gt;&gt;64</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Multiply high,signed-unsigned</span></td><td><span>mulhsu x5,x6,x7</span></td><td><span>x5=(x6*x7)&gt;&gt;64</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Divide</span></td><td><span>div x5,x6,x7</span></td><td><span>x5=x6/x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Divide unsigned</span></td><td><span>divu x5,x6,x7</span></td><td><span>x5=x6/x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Remainder</span></td><td><span>rem x5,x6,x7</span></td><td><span>x5=x6%x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>Remainder unsigned</span></td><td><span>remu x5,x6,x7</span></td><td><span>x5=x6%x7</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>还有mulw divw remw remuw</span></td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table></figure><p><span>注意到：64位乘法的积是128位的，而寄存器只能存64位，故有multiply high这种指令。</span></p><p><strong><span>关于RV64F和RV64D有以下指令：</span></strong></p><p><span>RISC-V利用32个64位寄存器f0～f31来存储浮点数。</span></p><figure><table><thead><tr><th><span>Category</span></th><th><span>Instruction</span></th><th><span>Example</span></th><th><span>Meaning</span></th><th><span>Format</span></th></tr></thead><tbody><tr><td><span>Arithmetic</span></td><td><span>add single</span></td><td><span>fadd.s f0,f1,f2</span></td><td><span>f0=f1+f2</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>subtract single</span></td><td><span>fsub.s f0,f1,f2</span></td><td><span>f0=f1-f2</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>multiply single</span></td><td><span>fmul.s f0,f1,f2</span></td><td><span>f0=f1*f2</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>divide single</span></td><td><span>fdiv.s f0,f1,f2</span></td><td><span>f0=f1/f2</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>square root single</span></td><td><span>fsqrt.s f0,f1</span></td><td><span>f0=√f1</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>add double</span></td><td><span>fadd.d f0,f1,f2</span></td><td><span>f0=f1+f2</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>subtract double</span></td><td><span>fsub.d f0,f1,f2</span></td><td><span>f0=f1-f2</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>multiply double</span></td><td><span>fmul.d f0,f1,f2</span></td><td><span>f0=f1*f2</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>divide double</span></td><td><span>fdiv.d f0,f1,f2</span></td><td><span>f0=f1/f2</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>square root double</span></td><td><span>fsqrt.d f0,f1</span></td><td><span>f0=√f1</span></td><td><span>R</span></td></tr><tr><td><span>Comparison</span></td><td><span>equality single</span></td><td><span>feq.s x5,f0,f1</span></td><td><span>x5=1 if f0==f1, else 0</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>less than single</span></td><td><span>flt.s x5,f0,f1</span></td><td><span>x5=1 if f0&lt;f1, else 0</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>less than or equal single</span></td><td><span>fle.s x5,f0,f1</span></td><td><span>x5=1 if f0&lt;=f1, else 0</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>equality double</span></td><td><span>feq.d x5,f0,f1</span></td><td><span>x5=1 if f0==f1, else 0</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>less than double</span></td><td><span>flt.d x5,f0,f1</span></td><td><span>x5=1 if f0&lt;f1, else 0</span></td><td><span>R</span></td></tr><tr><td>&nbsp;</td><td><span>less than or equal double</span></td><td><span>fle.d x5,f0,f1</span></td><td><span>x5=1 if f0&lt;=f1, else 0</span></td><td><span>R</span></td></tr><tr><td><span>Data transfer</span></td><td><span>load word</span></td><td><span>flw f0,4(x5)</span></td><td><span>f0=memory[x5+4]</span></td><td><span>L</span></td></tr><tr><td>&nbsp;</td><td><span>load double word</span></td><td><span>fld f0,8(x5)</span></td><td><span>f0=memory[x5+8]</span></td><td><span>L</span></td></tr><tr><td>&nbsp;</td><td><span>store word</span></td><td><span>fsw f0,4(x5)</span></td><td><span>memory[x5+4]=f0</span></td><td><span>S</span></td></tr><tr><td>&nbsp;</td><td><span>store double word</span></td><td><span>fsd f0,8(x5)</span></td><td><span>memory[x5+8]=f0</span></td><td><span>S</span></td></tr></tbody></table></figure><h2 id='33-子字并行'><span>3.3 子字并行</span></h2><p><span>3.6 Parallelism and Computer Arithmetic: Subword Parallelism以及3.7 Real Stuff: Streaming SIMD Extensions and Advanced Vector Extensions in x86看的我不明觉厉。这里这能大概说一下思路。</span></p><p><span>一个128位的寄存器可以存4个32位的int数，现在可以用一个指令将这四个整数和另外四个整数相加，这就是向量或者SIMD（single instruction, multiple data）。通过这个方法我们可以让多核处理器更好地做并行运算。这样在一个wide word下发生的并行被称作子字并行（subword parallism），也可以被分到</span><strong><span>数据级并行（data level parallelism）</span></strong><span>之下。RISC-V目前没有相关指令，所以3.7讨论了x86下的SIMD操作。</span></p><p><span>x86中MMX（MultiMedia eXtension）支持整数向量的操作；SSE（Streaming SIMD Extension）支持单精度浮点数的操作；SSE2支持了双精度浮点数的操作，有128位的XMM寄存器；2011年发布了AVX（Advance Vector Extensions)，有256位的YMM寄存器。想要在C程序里使用到SIMD操作的话，需要学习SIMD编程，要学习x86intrin库。书上在3.8节给出了一个矩阵乘法的例子，这里不再展开了。</span></p><hr /><div style="page-break-after: always;"></div> <h1 id='chapter-4'><span>Chapter 4</span></h1><p><span>第四章先是介绍顺序实现的处理器，然后是五级流水，最后再介绍了指令级并行。个人认为本书对流水线的介绍比csapp更流畅。csapp介绍流水线时充斥着过多的实现细节，更像是一个实验参考资料；而本书则更聚焦于主要思想。这一定程度上是由于csapp用自创的HCL硬件描述语言来描述各个硬件，在提供给读者一个模拟处理器方案的同时，也加大了行文上的困难。此外RISC-V的设计思想也进一步降低了流水线讲解的难度。但是还是觉得本章在讲述控制冒险和异常的时候，只是介绍为主，并没有深入挖掘。</span></p><p><span>在正式整理处理器前， 先补充点数电常识。</span></p><h2 id='41-逻辑电路'><span>4.1 逻辑电路</span></h2><p><span>由内部是否可以存储内存，可以把逻辑电路分为组合逻辑（combinational logic）和时序逻辑（sequential logic）。组合逻辑没有内存（memory），当输入一样的时候，输出也一样；而时序逻辑有内存，输出取决于当前内存和输入。</span></p><p><span>信号是true、1或是asserted对应着高电平；false、0、deasserted对应着低电平。</span></p><h3 id='411-组合逻辑'><span>4.1.1 组合逻辑</span></h3><ul><li><strong><span>解码器（decoder）</span></strong><span>：一个n位输入端口，</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.279ex" height="1.528ex" role="img" focusable="false" viewBox="0 -675.5 1007.3 675.5" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: 0px;"><defs><path id="MJX-12-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-12-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-12-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><use data-c="1D45B" xlink:href="#MJX-12-TEX-I-1D45B"></use></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mi>n</mi></msup></math></mjx-assistive-mml></mjx-container><script type="math/tex">2^n</script><span>个一位输出端口，每次输出端口只有一个是1，其余都是0。3-8解码器特指n为3的情况。</span></li><li><strong><span>多路复用器（multiplexor）</span></strong><span>：利用控制信号来选择多个输入的其中一个，并输出</span></li><li><strong><span>ROM（read-only memory）</span></strong><span>：对于一个m位的输入（i.e.地址），有一个n位的输出（i.e.地址上的数据）</span></li><li><strong><span>PLA（可编程逻辑阵列）</span></strong><span>：利用与门和或门实现任意逻辑函数。想法是按照T列写逻辑函数，然后利用与门阵列和或门阵列实现。</span></li><li><strong><span>ALU（arithmetic logic unit）</span></strong><span>：实现加减法等算术运算以及与或等逻辑运算。</span></li></ul><p><span>对于硬件描述语言，当下最流行的当属verilog。</span></p><h3 id='412-时序逻辑'><span>4.1.2 时序逻辑</span></h3><p><span>clock methodology采用edge-triggered clocking，也就是当低高电平转换的时候，元器件的状态会发生改变。</span></p><p><span>先给一个直观的例子。最简单的是S-R latch（set-reset latch），并不需要时钟信号。下图是两个或非门组成的sr锁存器。当R=0，S=1时，Q=1，Q‘=0；当R=1，S=0时，Q=0，Q’=1；当R=Q=0时，Q与Q‘的值由上一次R和Q的值决定；而R=Q=1时，Q与Q’值是不确定的，被认为是错误的操作。</span></p><p><img src="./img/2022-02-04 15-32-25 的屏幕截图.png" style="zoom:33%;" /></p><ul><li><p><strong><span>锁存器（latch）</span></strong><span>和</span><strong><span>触发器（flip-flop）</span></strong><span>：两者的输出都是由内部存储状态（state）所决定，只是触发器在clock edge时才会更新状态，而锁存器在clock信号is asserted就会。而我们采用edge-triggered clocking，所以只使用触发器。</span></p><ul><li><strong><span>D latch</span></strong><span>有两个输入C（clock signal）和D（data value）。当C=T时，输出=D；当C=F时，输出保持为之前值。</span></li><li><strong><span>D flip-flop</span></strong><span>：利用D latch可以造出。书A-52给出了一个falling-edge trigger的D flip-flop</span></li></ul></li><li><p><strong><span>寄存器文件（register file，寄存器堆）</span></strong><span>：写入受时钟控制，读取不受。也就是说读取可以当作是组合逻辑。同样的</span><strong><span>数据存储器（Data memory）</span></strong><span>也是一个写入受时钟控制、读取不受的单元。</span><strong><span>PC寄存器</span></strong><span>是时序电路。</span></p></li></ul><p><strong><span>关于时间的一些术语</span></strong><span>：</span></p><p><img src="./img/image-20220315120310249.png" alt="image-20220315120310249" style="zoom:50%;" /></p><ul><li><strong><span>Setup Time</span></strong><span>: The minimum time that the input must be valid before the clock edge.</span></li><li><strong><span>Hold Time</span></strong><span>: The minimum time during which it must be valid after the clock edge.</span></li><li><strong><span>&quot;CLK-to-Q&quot; Delay</span></strong><span>: how long it takes the output to change, measured from the edge of the CLK. 这里CLK就是C（clock signal）</span></li></ul><h2 id='42-顺序实现'><span>4.2 顺序实现</span></h2><p><span>我们只实现ld、sd，add、sub、and、or，beq七个指令。下面直接放出顺序实现的最终硬件版本。</span></p><p><img src="./img/image-20220204161236105.png" alt="image-20220204161236105" style="zoom: 25%;" /></p><p><span>基本上按照从左向右的顺序解读。由于许多内容环环相扣，可能会有点乱。下面以PC设置为例，讲解一下上图。</span></p><p><span>首先PC可能加4（每个指令都是四字节）或者由beq条件跳转。beq这个地址怎么生成呢？首先将指令全部传到Imm Gen（immediate generation）中，取出中间的12位立即数，然后将其符号扩展为64位。注意到B-type格式中立即数最后一位0被省略了，所以需要左移一位，再和当前PC加和。那么如何选取两个地址呢？这需要利用多路复用器，而控制信号就要讲讲Control单元了。</span></p><p><span>通过opcode（指令0～6位）就可以设置Control信号，具体如下表：</span></p><figure><table><thead><tr><th><span>Instruction</span></th><th><span>ALUSrc</span></th><th><span>MemtoReg</span></th><th><span>RegWrite</span></th><th><span>MemRead</span></th><th><span>MemWrite</span></th><th><span>Branch</span></th><th><span>ALUOp</span></th></tr></thead><tbody><tr><td><span>R-type</span></td><td><span>0</span></td><td><span>0</span></td><td><span>1</span></td><td><span>0</span></td><td><span>0</span></td><td><span>0</span></td><td><span>10</span></td></tr><tr><td><span>ld</span></td><td><span>1</span></td><td><span>1</span></td><td><span>1</span></td><td><span>1</span></td><td><span>0</span></td><td><span>0</span></td><td><span>00</span></td></tr><tr><td><span>sd</span></td><td><span>1</span></td><td><span>x</span></td><td><span>0</span></td><td><span>0</span></td><td><span>1</span></td><td><span>0</span></td><td><span>00</span></td></tr><tr><td><span>beq</span></td><td><span>0</span></td><td><span>x</span></td><td><span>0</span></td><td><span>0</span></td><td><span>0</span></td><td><span>1</span></td><td><span>01</span></td></tr></tbody></table></figure><p><span>x意味着随便设置；ALUOp信号是两位的，ALU控制信号具体细节如下：</span></p><figure><table><thead><tr><th><span>ALU control lines</span></th><th><span>Function</span></th></tr></thead><tbody><tr><td><span>0000</span></td><td><span>AND</span></td></tr><tr><td><span>0001</span></td><td><span>OR</span></td></tr><tr><td><span>0010</span></td><td><span>add</span></td></tr><tr><td><span>0110</span></td><td><span>subtract</span></td></tr></tbody></table></figure><p><span>ALU通过上述四位控制信号决定做什么运算，而ALU control lines的值怎么生成呢？具体如下表：</span></p><figure><table><thead><tr><th><span>ALUOp</span></th><th><span>Func7</span></th><th><span>Func3</span></th><th><span>ALU control</span></th></tr></thead><tbody><tr><td><span>00</span></td><td><span>xxxxxxx</span></td><td><span>xxx</span></td><td><span>0010</span></td></tr><tr><td><span>x1</span></td><td><span>xxxxxxx</span></td><td><span>xxx</span></td><td><span>0110</span></td></tr><tr><td><span>1x</span></td><td><span>0000000</span></td><td><span>000</span></td><td><span>0010</span></td></tr><tr><td><span>1x</span></td><td><span>0100000</span></td><td><span>000</span></td><td><span>0110</span></td></tr><tr><td><span>1x</span></td><td><span>0000000</span></td><td><span>111</span></td><td><span>0000</span></td></tr><tr><td><span>1x</span></td><td><span>0000000</span></td><td><span>110</span></td><td><span>0001</span></td></tr></tbody></table></figure><p><span>可见区分add、sub、and、or只需要第30、14～12位，所以传入ALU control的信号是这几位。beq的ALUOp为01，那么ALU将会做减法运算。如果传入ALU的两个数据减法的差为0，那么ALU的ZERO端口将设置为1，再与branch信号做与运算，传入右上方的多路复用器，就会选择跳转地址作为下一次的PC了。</span></p><p><span>而将Control和ALU control分开可以降低各自的硬件复杂度，从而提升运行速度。</span></p><p><span>那ALU数据又哪里来呢，这要通过寄存器文件了。我们15-19，20-24，7-11位（分别对应编码中的rs1, rs2和rd）传入寄存器文件。由于beq设置RegWrite为0，所以7-11位没有任何作用。同样由于beq设置ALUSrc为0，所以我们选取Read Data2端口的数据而不是Imm Gen的数据传入ALU。</span></p><p><span>最后，beq设置MemWrite和MemRead都是0，所以将不会有内存的读写。我在想当我们设置MemRead为0时，那内存的Read data端口应当也是有值的吧（就是原先值，没有改变吧），应该是内存将不会去寻找这地址上的值，避免内存访问上时间上的开销。反正MemWrite控制信号为0，内存上的数据读了也写不进去。此外，课上（上交 邓倩妮 计算机体系结构）的Data Memory单元甚至没有MemRead控制信号，而是采用了MemRW来控制要么Read要么Write。</span></p><p><span>显然顺序实现的时钟周期过长，运行过慢了。于是引入了流水线。</span></p><h2 id='43-五级流水'><span>4.3 五级流水</span></h2><p><mark><span>五级：取指IF、译码ID、执行EX、访存MEM、写回WB</span></mark></p><p><strong><span>冒险（hazard）</span></strong><span>：</span><strong><span>结构冒险（structural hazard）</span></strong><span>——硬件不支持一些指令组合操作；</span><strong><span>数据冒险（data hazard）</span></strong><span>——指令中存在数据相关，通过暂停stall和转发forward解决；</span><strong><span>控制冒险（control hazard）</span></strong><span>——利用预测来处理条件分支，从而产生了控制冒险。</span></p><p><span>下面这种脑图要有哈，分析的时候很重要的：</span></p><p><img src="./img/2022-03-29 11-46-52 的屏幕截图.png" style="zoom: 50%;" /></p><h3 id='版本1------无法应对冒险'><span>版本1——无法应对冒险</span></h3><p><span>下面先放出一个包含控制信号，但是无法应对冒险的硬件版本。</span></p><p><img src="./img/image-20220204175933131.png" alt="image-20220204175933131" style="zoom:25%;" /></p><p><span>引入了四个流水线寄存器，它们都是受时钟控制的时序逻辑电路。存储的数据一方面是左边stage算出来的值，另一方面是一些控制信号。譬如ID/EX寄存器存了WB、M、EX三类控制信号，PC值，rs1，rs2，扩展的立即数，部分指令。我们将之前七个控制信号按照作用的阶段分为三类，其中EX控制信号有两个ALUSrc、ALUOp，MEM有三个，WB有两个。</span></p><p><span>书上打了一个挺好的比方，流水线寄存器就像是洗衣服、烘干衣服、烫衣服过程中的衣服桶。</span></p><p><span>特别的，寄存器文件在前半个时钟周期写入，在后半个周期读取。这样使得一个寄存器若在同一个时钟周期读写的话，那么读的内容是刚刚写入的内容。</span></p><p><span>可惜存在冒险，我们不得不修改这个简单的设计。</span></p><h3 id='版本2------应对冒险'><span>版本2——应对冒险</span></h3><p><strong><span>数据冒险</span></strong></p><p><span>数据冒险包含：先写后读（read after write, </span><strong><span>RAW</span></strong><span>）、先读后写（</span><strong><span>WAR</span></strong><span>）和写后再写（</span><strong><span>WAW</span></strong><span>）。</span></p><p><strong><span>Forwarding unit</span></strong><span>用来实现转发，</span><strong><span>Hazard detection unit</span></strong><span>用来检测是否是</span><strong><span>load-use data hazard</span></strong><span>。一般数据冒险利用转发就可以完美处理了，然而load-use数据冒险需要先stall一个周期才能forward。</span></p><p><span>先考虑Forwarding unit的设计。我们只考虑EX阶段的数据冒险，一共有两类四种：</span></p><p><span>1a. EX/MEM.RegisterRd = ID/EX.RegisterRs1</span></p><p><span>1b. EX/MEM.RegisterRd = ID/EX.RegisterRs2</span></p><p><span>2a. MEM/WB.RegisterRd = ID/EX.RegisterRs1</span></p><p><span>2b. MEM/WB.RegisterRd = ID/EX.RegisterRs2</span></p><p><span>此外我们还需要考虑该指令是否写入寄存器（RegWrite==0）以及目标寄存器是否非零，从而避免一些错误的转发。通过以上数据设置ForwardA和ForwardB信号，多路复用器通过该控制信号选择ALU的参数是来自寄存器堆、先前的ALU结果还是内存的数据。</span></p><p><span>再考虑Hazard detection unit的设计。Hazard detection unit通过ID/EX.MemRead判断是否是load，再判断是否load后是否下一个指令就用了这个数据（ID/EX.RegisterRd == IF/ID.RegisterRs1/2)。如果确实产生了load-use data hazard就要stall the pipeline。暂停也就是要加入bubble，我们可以简单地通过设置ID/EX的控制信号都为0，并且保证PC寄存器和IF/ID流水线寄存器不变即可。</span></p><p><strong><span>控制冒险</span></strong></p><p><span>书上似乎并没有给出详细的方案，只是谈谈我们可以怎么做以及会遇到什么困难。我们采取了</span><em><span>永远不跳转</span></em><span>的预测方案（这样便于实现）。下图最明显的调整就是</span><mark><span>把跳转地址计算以及判断两个寄存器是否相等放到了ID阶段</span></mark><span>，而不是之前的EX阶段。这样如果预测失败的话，只需要一条指令需要被</span><strong><span>清空（flush）</span></strong><span>；如果预测成功的话完美解决问题，无需其余操作。为了清空IF阶段的指令，引入了IF.Flush信号，它将把IF/ID寄存器的指令部分置零。此外应当还需把WB、M、EX的控制信号置零。书上也没有更多展开了，个人觉得没有讲的很清楚。</span></p><p><span>然而这也引来了更多的麻烦事。我们需要判断寄存器文件中两个值是否相等，如果还满足是branch指令的话，需要把新的跳转地址转发到PC寄存器中。而寄存器文件的两个值可能是来自EX/MEM或MEM/WB寄存器中，这需要更多的转发组件。此外，对于一些特定的指令顺序我们还可能需要暂停来避免冒险。书上并没有对这一块进行展开，下图硬件设计上也没有体现。</span></p><p><img src="./img/image-20220204213406038.png" alt="image-20220204213406038" style="zoom:20%;" /></p><p><span>此外，个人相当怀疑上图把MEM/WB和EX/MEM标反了。还有上图显然略去了Imm Gen在EX阶段的多路复用器，以及所有多路复用器的控制信号。</span></p><p><span>这里再讨论一下</span><strong><span>静态转移预测</span></strong><span>和</span><strong><span>动态转移预测</span></strong><span>。预测成功是不会有惩罚的，错误的话就flush掉错误的指令。</span></p><ul><li><span>静态转移预测就是在程序运行前预测，比如预测分支永远不跳转或者永远跳转。</span></li><li><span>动态转移预测是在程序运行时进行预测，通过学习过去来预测未来。比如说，维护一个</span><strong><span>转移历史表（branch history table，BHT）</span></strong><span>，可以利用指令某些位比如2～9位，来做一个索引，找到BHT的条目。条目可以是一位的，0的话就不转、1就转，如果预测错了就修正条目；条目也可以两位，11与10转、01与00不转，转换如下图：</span></li></ul><p><img src="./img/2022-03-29 11-13-33 的屏幕截图.png" alt="image-20220204213406038" style="zoom:60%;" /></p><p><span>此外，动态转移预测还需要维护一个</span><strong><span>BTB（branch target buffer）</span></strong><span>记录预测跳转地址，利用和BHT相同的索引方式，这样在IF阶段就可以知道预测地址了，无论预测是跳转还是不跳转。之前的实现是不跳转的话在IF阶段知道地址、跳转的话要在ID阶段知道地址。</span></p><h3 id='版本3------应对异常'><span>版本3——应对异常</span></h3><p><strong><span>异常（exception）</span></strong><span>见之前整理的CSAPP</span><a href='https://iewug.github.io/book/csapp/chapter8.html'><span>chapter 8.1</span></a><span>。这里主要讨论CPU对异常的支持。有的时候就用中断来统称异常，但是csapp是认为异常包含了中断。</span></p><p><span>RISC-V中为了处理异常，需要添加</span><strong><span>控制与状态寄存器（control and state register）</span></strong><span>。如下表所示：</span></p><p><img src="./img/2022-03-31 10-37-19 的屏幕截图.png" style="zoom:67%;" /></p><p><span>简单来说，</span><code>mepc</code><span>记录发生异常的指令地址；</span><code>mcause</code><span>记录发生异常的原因；通过</span><code>mtvec</code><span> 可以找到响应的异常处理程序；</span><code>mstatus</code><span>可以：控制CPU进入内核态处理中断、禁止中断响应（即“关中断“），控制CPU进入用户态从中断返回、允许新的中断响应（即“开中断“）。当然，我们还需要把现场保护起来（把相关信息压入栈）。</span></p><p><span>本书给出了这样一个简单的设计。在IF、ID、EX流水线寄存器增加了flush控制信号；添加</span><code>cause</code><span>和</span><code>epc</code><span>两个寄存器分别记录异常的来由和异常指令的地址；对于异常发生后，应把PC置到操作系统预设的处理函数的地址。具体硬件图如下：</span></p><p><img src="./img/2022-03-31 11-12-33 的屏幕截图.png" style="zoom:67%;" /></p><p><span>上图中，在EX阶段发生了溢出，于是我们flush掉IF、ID和EX阶段的指令，PC跳转到异常处理程序。</span></p><p><span>然而这个模型很粗糙。我们知道五级流水各阶段都可能会发生异常，比如取指——page fault or TLB miss，译码——未定义的指令，执行——溢出，访存——page fault or TLB miss。就可能产生多个指令异常同时发生、后面的指令先于前面的指令发生异常：</span></p><p><img src="./img/2022-03-31 11-29-48 的屏幕截图.png" style="zoom:67%;" /></p><p><span>我们希望的是</span><strong><span>精确中断（precise interrupt）</span></strong><span>——中断指令前的所有指令都已完成、中断指令包括后续指令没有改变任何机器状态。有这样的一个设计：统一在写回阶段处理异常；之前阶段发生的异常由流水线寄存器记录并向后传递；异常发生后flush掉所有指令；如果一个指令在两个阶段都产生了异常，记录第一个异常；如果异步中断（如时钟中断）和同步的异常同时发生，可以先处理内部异常（避免饥饿）。</span></p><p><img src="./img/2022-03-31 12-43-20 的屏幕截图.png" style="zoom:50%;" /></p><p><strong><span>最后谈一下深度流水导致的问题：</span></strong></p><ul><li><p><strong><span>开销增加：</span></strong><span>流水段越多，复杂度增加。</span></p></li><li><p><strong><span>性能下降：</span></strong><span>流水段寄存器个数增加，一条指令的延迟就越大；重叠执行的指令越多，可能出现的相关性越多，停顿stall的可能性越大。</span></p></li><li><p><strong><span>功耗增加：</span></strong><span>时钟频率高，功耗大。</span></p><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n1117" cid="n1117" mdtype="math_block" data-math-tag-before="0" data-math-tag-after="0" data-math-labels="[]"><div class="md-rawblock-container md-math-container" tabindex="-1"><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="63.888ex" height="4.588ex" role="img" focusable="false" viewBox="0 -1342 28238.4 2028" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -1.552ex;"><defs><path id="MJX-8-TEX-I-1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path><path id="MJX-8-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-8-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-8-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-8-TEX-I-1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path><path id="MJX-8-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-8-TEX-N-221D" d="M56 124T56 216T107 375T238 442Q260 442 280 438T319 425T352 407T382 385T406 361T427 336T442 315T455 297T462 285L469 297Q555 442 679 442Q687 442 722 437V398H718Q710 400 694 400Q657 400 623 383T567 343T527 294T503 253T495 235Q495 231 520 192T554 143Q625 44 696 44Q717 44 719 46H722V-5Q695 -11 678 -11Q552 -11 457 141Q455 145 454 146L447 134Q362 -11 235 -11Q157 -11 107 56ZM93 213Q93 143 126 87T220 31Q258 31 292 48T349 88T389 137T413 178T421 196Q421 200 396 239T362 288Q322 345 288 366T213 387Q163 387 128 337T93 213Z"></path><path id="MJX-8-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-8-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-8-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-8-TEX-I-1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path><path id="MJX-8-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-8-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-8-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-8-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-8-TEX-I-1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path><path id="MJX-8-TEX-N-A0" d=""></path><path id="MJX-8-TEX-I-1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path><path id="MJX-8-TEX-I-1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path><path id="MJX-8-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-8-TEX-I-1D449" d="M52 648Q52 670 65 683H76Q118 680 181 680Q299 680 320 683H330Q336 677 336 674T334 656Q329 641 325 637H304Q282 635 274 635Q245 630 242 620Q242 618 271 369T301 118L374 235Q447 352 520 471T595 594Q599 601 599 609Q599 633 555 637Q537 637 537 648Q537 649 539 661Q542 675 545 679T558 683Q560 683 570 683T604 682T668 681Q737 681 755 683H762Q769 676 769 672Q769 655 760 640Q757 637 743 637Q730 636 719 635T698 630T682 623T670 615T660 608T652 599T645 592L452 282Q272 -9 266 -16Q263 -18 259 -21L241 -22H234Q216 -22 216 -15Q213 -9 177 305Q139 623 138 626Q133 637 76 637H59Q52 642 52 648Z"></path><path id="MJX-8-TEX-I-1D439" d="M48 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H742Q749 676 749 669Q749 664 736 557T722 447Q720 440 702 440H690Q683 445 683 453Q683 454 686 477T689 530Q689 560 682 579T663 610T626 626T575 633T503 634H480Q398 633 393 631Q388 629 386 623Q385 622 352 492L320 363H375Q378 363 398 363T426 364T448 367T472 374T489 386Q502 398 511 419T524 457T529 475Q532 480 548 480H560Q567 475 567 470Q567 467 536 339T502 207Q500 200 482 200H470Q463 206 463 212Q463 215 468 234T473 274Q473 303 453 310T364 317H309L277 190Q245 66 245 60Q245 46 334 46H359Q365 40 365 39T363 19Q359 6 353 0H336Q295 2 185 2Q120 2 86 2T48 1Z"></path><path id="MJX-8-TEX-I-1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-8-TEX-I-1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-8-TEX-I-1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path><path id="MJX-8-TEX-I-1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path><path id="MJX-8-TEX-I-1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path><path id="MJX-8-TEX-I-210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D438" xlink:href="#MJX-8-TEX-I-1D438"></use></g><g data-mml-node="mi" transform="translate(764,0)"><use data-c="1D45B" xlink:href="#MJX-8-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(1364,0)"><use data-c="1D452" xlink:href="#MJX-8-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(1830,0)"><use data-c="1D45F" xlink:href="#MJX-8-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(2281,0)"><use data-c="1D454" xlink:href="#MJX-8-TEX-I-1D454"></use></g><g data-mml-node="mi" transform="translate(2758,0)"><use data-c="1D466" xlink:href="#MJX-8-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(3525.8,0)"><use data-c="221D" xlink:href="#MJX-8-TEX-N-221D"></use></g><g data-mml-node="mfrac" transform="translate(4581.6,0)"><g data-mml-node="mn" transform="translate(220,676)"><use data-c="31" xlink:href="#MJX-8-TEX-N-31"></use></g><g data-mml-node="mn" transform="translate(220,-686)"><use data-c="32" xlink:href="#MJX-8-TEX-N-32"></use></g><rect width="700" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(5743.8,0)"><use data-c="D7" xlink:href="#MJX-8-TEX-N-D7"></use></g><g data-mml-node="mi" transform="translate(6744,0)"><use data-c="1D436" xlink:href="#MJX-8-TEX-I-1D436"></use></g><g data-mml-node="mi" transform="translate(7504,0)"><use data-c="1D44E" xlink:href="#MJX-8-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(8033,0)"><use data-c="1D45D" xlink:href="#MJX-8-TEX-I-1D45D"></use></g><g data-mml-node="mi" transform="translate(8536,0)"><use data-c="1D44E" xlink:href="#MJX-8-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(9065,0)"><use data-c="1D456" xlink:href="#MJX-8-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(9410,0)"><use data-c="1D461" xlink:href="#MJX-8-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(9771,0)"><use data-c="1D456" xlink:href="#MJX-8-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(10116,0)"><use data-c="1D463" xlink:href="#MJX-8-TEX-I-1D463"></use></g><g data-mml-node="mi" transform="translate(10601,0)"><use data-c="1D452" xlink:href="#MJX-8-TEX-I-1D452"></use></g><g data-mml-node="mtext" transform="translate(11067,0)"><use data-c="A0" xlink:href="#MJX-8-TEX-N-A0"></use></g><g data-mml-node="mi" transform="translate(11317,0)"><use data-c="1D459" xlink:href="#MJX-8-TEX-I-1D459"></use></g><g data-mml-node="mi" transform="translate(11615,0)"><use data-c="1D45C" xlink:href="#MJX-8-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(12100,0)"><use data-c="1D44E" xlink:href="#MJX-8-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(12629,0)"><use data-c="1D451" xlink:href="#MJX-8-TEX-I-1D451"></use></g><g data-mml-node="mo" transform="translate(13371.2,0)"><use data-c="D7" xlink:href="#MJX-8-TEX-N-D7"></use></g><g data-mml-node="mi" transform="translate(14371.4,0)"><use data-c="1D449" xlink:href="#MJX-8-TEX-I-1D449"></use></g><g data-mml-node="mi" transform="translate(15140.4,0)"><use data-c="1D45C" xlink:href="#MJX-8-TEX-I-1D45C"></use></g><g data-mml-node="mi" transform="translate(15625.4,0)"><use data-c="1D459" xlink:href="#MJX-8-TEX-I-1D459"></use></g><g data-mml-node="mi" transform="translate(15923.4,0)"><use data-c="1D461" xlink:href="#MJX-8-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(16284.4,0)"><use data-c="1D44E" xlink:href="#MJX-8-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(16813.4,0)"><use data-c="1D454" xlink:href="#MJX-8-TEX-I-1D454"></use></g><g data-mml-node="msup" transform="translate(17290.4,0)"><g data-mml-node="mi"><use data-c="1D452" xlink:href="#MJX-8-TEX-I-1D452"></use></g><g data-mml-node="mn" transform="translate(499,413) scale(0.707)"><use data-c="32" xlink:href="#MJX-8-TEX-N-32"></use></g></g><g data-mml-node="mo" transform="translate(18415.2,0)"><use data-c="D7" xlink:href="#MJX-8-TEX-N-D7"></use></g><g data-mml-node="mi" transform="translate(19415.4,0)"><use data-c="1D439" xlink:href="#MJX-8-TEX-I-1D439"></use></g><g data-mml-node="mi" transform="translate(20164.4,0)"><use data-c="1D45F" xlink:href="#MJX-8-TEX-I-1D45F"></use></g><g data-mml-node="mi" transform="translate(20615.4,0)"><use data-c="1D452" xlink:href="#MJX-8-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(21081.4,0)"><use data-c="1D45E" xlink:href="#MJX-8-TEX-I-1D45E"></use></g><g data-mml-node="mi" transform="translate(21541.4,0)"><use data-c="1D462" xlink:href="#MJX-8-TEX-I-1D462"></use></g><g data-mml-node="mi" transform="translate(22113.4,0)"><use data-c="1D452" xlink:href="#MJX-8-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(22579.4,0)"><use data-c="1D45B" xlink:href="#MJX-8-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(23179.4,0)"><use data-c="1D450" xlink:href="#MJX-8-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(23612.4,0)"><use data-c="1D466" xlink:href="#MJX-8-TEX-I-1D466"></use></g><g data-mml-node="mtext" transform="translate(24102.4,0)"><use data-c="A0" xlink:href="#MJX-8-TEX-N-A0"></use></g><g data-mml-node="mi" transform="translate(24352.4,0)"><use data-c="1D460" xlink:href="#MJX-8-TEX-I-1D460"></use></g><g data-mml-node="mi" transform="translate(24821.4,0)"><use data-c="1D464" xlink:href="#MJX-8-TEX-I-1D464"></use></g><g data-mml-node="mi" transform="translate(25537.4,0)"><use data-c="1D456" xlink:href="#MJX-8-TEX-I-1D456"></use></g><g data-mml-node="mi" transform="translate(25882.4,0)"><use data-c="1D461" xlink:href="#MJX-8-TEX-I-1D461"></use></g><g data-mml-node="mi" transform="translate(26243.4,0)"><use data-c="1D450" xlink:href="#MJX-8-TEX-I-1D450"></use></g><g data-mml-node="mi" transform="translate(26676.4,0)"><use data-c="210E" xlink:href="#MJX-8-TEX-I-210E"></use></g><g data-mml-node="mi" transform="translate(27252.4,0)"><use data-c="1D452" xlink:href="#MJX-8-TEX-I-1D452"></use></g><g data-mml-node="mi" transform="translate(27718.4,0)"><use data-c="1D451" xlink:href="#MJX-8-TEX-I-1D451"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>E</mi><mi>n</mi><mi>e</mi><mi>r</mi><mi>g</mi><mi>y</mi><mo>∝</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>×</mo><mi>C</mi><mi>a</mi><mi>p</mi><mi>a</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mtext>&nbsp;</mtext><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mo>×</mo><mi>V</mi><mi>o</mi><mi>l</mi><mi>t</mi><mi>a</mi><mi>g</mi><msup><mi>e</mi><mn>2</mn></msup><mo>×</mo><mi>F</mi><mi>r</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>n</mi><mi>c</mi><mi>y</mi><mtext>&nbsp;</mtext><mi>s</mi><mi>w</mi><mi>i</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi>e</mi><mi>d</mi></math></mjx-assistive-mml></mjx-container></div></div></li></ul><h2 id='44-指令级并行'><span>4.4 指令级并行</span></h2><p><span>这块内容在量化研究方法上用了200页的篇幅介绍，本书只用了13页，所以只能算是一个粗浅的了解吧。想要有更多了解要去看量化了，但是本人应该不会再深入研究这块内容了。</span></p><h3 id='441-综述'><span>4.4.1 综述</span></h3><p><span>流水线挖掘了指令间潜在的并行度，这种并行性被称为</span><strong><span>指令并行（instruction-level parallelism， ILP）</span></strong><span>。有两种方法可以增加潜在的指令级并行程度：1. 增加流水线的深度可以重叠更多的指令；2. 复制计算机内部部件的数量，使得每个流水线阶段可以启动更多指令。该种技术被称为</span><strong><span>多发射（multiple issue）</span></strong><span>。此外发射的地方叫做</span><strong><span>发射槽（issue slot）</span></strong><span>。</span></p><p><span>多发射我理解为一个处理器可以同时取多条指令并进行译码。实现多发射处理器主要有两种方式：</span><strong><span>静态（static）多发射</span></strong><span>和</span><strong><span>动态（dynamic）多发射</span></strong><span>。其区别是将主要工作交给编译器还是硬件来做。多发射流水线必须处理以下两个问题：1）怎么发，发多少条，发哪些；2）冒险怎么处理。</span></p><h3 id='442-推测speculation'><span>4.4.2 推测Speculation</span></h3><p><span>推测可以由编译器或硬件来完成。感觉和流水线的预测prediction很像。主要要面对的麻烦是如何从错误的推测中恢复以及处理本不该出现的异常。</span></p><h3 id='443-静态多发射处理器'><span>4.4.3 静态多发射处理器</span></h3><p><span>所有的静态多发射处理器都是用编译器来帮助封装多条指令并处理冒险。在一个静态发射处理器中，可以在给定时钟周期内发射多条指令，也称为</span><strong><span>发射包（issue packet）</span></strong><span>。可以认为发射包就是一个指令多个操作，这也是最初名字</span><strong><span>超长指令字（VLIW, very long intruction word）</span></strong><span>的由来。</span></p><p><span>静态多发射处理器下的编译器的任务可能包括</span><strong><span>静态分支预测</span></strong><span>和</span><strong><span>代码调度</span></strong><span>（代码调度如循环展开，见4.4.7），以减少冒险或阻止所有的冒险。比如，编译器通过调度指令和插入nop等方法使得代码在执行时完全不需要冒险检测和硬件产生阻塞；或者利用硬件检测数据冒险并在两个发射包间产生stall，而编译器负责避免一个发射包中指令之间的依赖。</span></p><p><span>此外硬件也要修改，比如ALU的端口要增加，来避免结构冒险。</span></p><p><span>总之，静态多发射把大部分任务交给了编译器，以得到更加简单的硬件，并有成本低、能耗少的优势。但是劣势是更加致命的：</span></p><ul><li><span>编译器需要知道处理器每次发射多少指令等相关架构，才能编写出适合该处理器的VLIW程序，这导致代码的可移植能力差，换一个环境后，代码往往需要重新编译</span></li><li><span>编译复杂、编译时间长</span></li><li><span>代码膨胀，譬如充斥大量空指令，或者采取循环展开时，也需要更多存储空间</span></li></ul><h3 id='444-动态多发射处理器'><span>4.4.4 动态多发射处理器</span></h3><p><span>动态多发射处理器通常称为</span><strong><span>超标量处理器（superscalar）</span></strong><span>。超标量处理器都是由硬件来保证执行的正确性，并且编译得到的代码应当始终正常执行，而与指令发射速率和处理器的流水线结构无关。而静态多发射处理器下，当我们换环境时，代码往往需要重新编译。</span></p><p><span>在这种处理器中，流水线被划分为3个主要单元：一个取指与发射单元、多个功能单元和一个提交单元。利用各种缓冲区使得三个单元依次实现：</span><strong><span>顺序发射，乱序执行，顺序提交</span></strong><span>。之所以乱序执行是为了最大程度利用处理器的计算能力。</span><strong><span>保留站（reservation station）</span></strong><span>是功能单元的缓冲区，可以缓冲运算参数和运算符；提交单元里也有</span><strong><span>重排序缓冲区（reorder buffer）</span></strong><span>来缓冲结果，满足最后顺序提交的要求。动态多发射处理器的保留站和重排序缓冲区都提供</span><strong><span>寄存器重命名</span></strong><span>操作，来避免本应不存在的名称相关。</span></p><p><img src="https://img-blog.csdnimg.cn/20190410094052946.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxMzk0MTU1,size_16,color_FFFFFF,t_70" alt="img" style="zoom:66%;" /></p><p><span>动态多发射和推测不可避免地增加了处理器的能耗和复杂度。所以处理器已经走向了多核处理器。</span></p><p><span>关于寄存器重命名，再多做一些介绍。乱序执行可能会导致本应不存在的名称相关，称为</span><strong><span>假相关</span></strong><span>。那些确实存在的相关就称为</span><strong><span>真相关</span></strong><span>。假相关包含</span><strong><span>输出相关</span></strong><span>和</span><strong><span>反相关</span></strong><span>。输出相关又称为(Write after Write)</span><strong><span>WAW相关</span></strong><span>，反相关又称为(Write after Read)</span><strong><span>WAR相关</span></strong><span>。通过寄存器重命名就可以避免这两种假相关了。例子如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="assembly" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="assembly"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 输出相关 WAW相关</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 如果lw晚于addu写$t0，那么sub会获得错误的$t0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">LW</span> $t0,0($s1)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ADDU</span> $t0,$t1,$s2</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SUB</span> $t2, $t0, $s2</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 寄存器重命名解决上述问题</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">LW</span> $t0a,0($s1)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ADDU</span> $t0b,$t1,$s2</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SUB</span> $t2, $t0b, $s2</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 反相关 WAR相关</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 如果sub写结果早于add读F8，add会获得错误的F8</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ADDD</span> <span class="cm-keyword">F10</span>,F0,F8</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SUBD</span> <span class="cm-keyword">F8</span>,F8,F14</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 寄存器重命名解决上述问题</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ADDD</span> <span class="cm-keyword">F10</span>,F0,F8a</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SUBD</span> <span class="cm-keyword">F8b</span>,F8a,F14</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 真相关 RAW</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">mul</span> <span class="cm-variable">r2</span>, <span class="cm-variable">r0</span>, <span class="cm-variable">r1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">add</span> <span class="cm-variable">r4</span>, <span class="cm-variable">r2</span>, <span class="cm-variable">r3</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 476px;"></div><div class="CodeMirror-gutters" style="display: none; height: 476px;"></div></div></div></pre><h3 id='446-课堂上对多发射处理器的分类'><span>4.4.6 课堂上对多发射处理器的分类</span></h3><p><span>课上似乎对多发射的分类更加详细一点（似乎就是量化里的图。。。），如下：</span></p><p><img src="./img/2022-04-07 13-20-46 的屏幕截图.png" style="zoom: 50%;" /></p><p><span>静态调度方案是指编译器来尽可能完成冲突检测和指令调度；动态调度方案是指4.4.4节那样的操作，其中最著名的动态调度方案是</span><strong><span>Tomasulo</span></strong><span>，不再过多展开。</span></p><p><span>动态发射结构是指每次发射的指令数目是动态的，而静态发射结构每次发射的指令数是固定的、编译器预先设定好的（有依赖就发射空指令）。</span></p><h3 id='447-优化程序性能'><span>4.4.7 优化程序性能</span></h3><p><span>这一部分内容可以参考之前</span><a href='https://iewug.github.io/book/csapp/chapter5.html'><span>csapp第五章</span></a><span>的整理。</span></p><p><span>注意到，</span><strong><span>循环展开（loop unrolling）</span></strong><span>可以提高性能是由于充分利用了功能单元且减少了分支预测次数。</span></p><hr /><div style="page-break-after: always;"></div> <h1 id='chapter-5'><span>Chapter 5</span></h1><p><span>存储器层次结构这部分其实</span><a href='https://iewug.github.io/book/csapp/chapter6.html'><span>csapp第六章</span></a><span>已经做了一定程度上的整理了。在之前csapp整理的基础上，再加入课堂上的内容，就得到了这部分的整理。并没有参考《计算机组成与设计 硬件/软件接口》，一是读起来感觉没什么新收获、行文拖沓，二是学期将尽时间紧张。</span></p><h2 id='51-存储技术'><span>5.1 存储技术</span></h2><p><span>我强烈觉得这部分内容如果没学过数电，还是具有一定困难的。但是我尽可能地还是去做了一些硬件层面的理解，虽然难免还是有偏差。事实上后面研究缓存时，存储器会进一步抽象，显得5.1节不那么重要了。</span></p><h3 id='511-ram'><span>5.1.1 RAM</span></h3><p><strong><span>随机访问存储器（Random-Access Memory，RAM）</span></strong><span>可以分为两类：静态的RAM（</span><strong><span>SRAM</span></strong><span>）和动态的RAM（</span><strong><span>DRAM</span></strong><span>）。区别如下：</span></p><ul><li><strong><span>SRAM</span></strong><span>：每一位保存到由6到8个晶体管电路构成的双稳态的（Bistable）存储器单元。只要有供电，它保存的数据就不会丢失。对光和电噪音等干扰不敏感。访问速度快，但造价较为昂贵且密集度低。适合作为小容量高速的高速缓存存储器。当下SRAM用作L1、L2、L3级缓存，且在CPU内部。</span></li><li><strong><span>DRAM</span></strong><span>：每一位都用一个电容的充电量来表示，且用一个晶体管来控制读写。除了有供电外，还需要刷新电路才能保持存储的数据不丢失，这是因为电容会漏电且读取操作会让电容电压降低（destructive read）。对光和电噪音等干扰敏感。访问速度相对较慢，但造价便宜且密集度高。适合作为主存。当下我们购买的DDR4内存条（DDR5都开卖了）就是一种DRAM。</span></li></ul><p><em><span>下面是对DRAM的更多讨论</span></em></p><p><strong><span>DRAM的简单认识</span></strong></p><p><span>一些名称约定：</span></p><ul><li><strong><span>cell</span></strong><span>：DRAM芯片中的一个bit</span></li><li><strong><span>supercell</span></strong><span>：w个cell组成的单元（似乎只有csapp这么叫）</span></li><li><strong><span>pin</span></strong><span>：引脚，每个引脚可以传递一个比特信号</span></li></ul><p><span>现在将DRAM芯片（常称作</span><strong><span>内存颗粒</span></strong><span>）分为d个supercell，每个supercell中包含了w个cell。则称这是一个d × w DRAM芯片，存储了dw位信息。下图是一个16 × 8的DRAM芯片（16个supercell，每个supercell存8位数据）。</span></p><p><img src="https://iewug.github.io/pic/csapp/DRAMchip.jpg" alt="img" style="zoom:67%;" /></p><p><span>首先内存控制器通过addr引脚发送两位行地址到DRAM芯片，DRAM芯片找到该行并放入内部行缓冲区。内存控制器再发送两位的列地址，DRAM芯片找到行缓冲区的该列，并通过data引脚发送8位的数据（一个超单元存8位）到内存控制器。之所以把DRAM芯片排列成矩阵的形式，是为了减少addr引脚数。如果我们把八个这样的DRAM芯片封装到一个内存模块中，就可以一次能对64位字进行读写。</span></p><p><strong><span>对DRAM刷新的进一步认知</span></strong></p><p><span>一些名称约定：</span></p><ul><li><strong><span>存取周期</span></strong><span>：连续启动两次独立的“读”或“写”操作所需的最短时间。存取周期大于真正用于存取的时间，因为存取操作完还需要一些时间来更改状态。约0.5μs。</span></li><li><strong><span>刷新时间</span></strong><span>：进行一次行刷新所用的时间，等于存取周期。</span></li><li><strong><span>刷新周期</span></strong><span>：全部DRAM行进行一波刷新的周期。通常为2ms。</span></li></ul><p><span>刷新方式有三种：</span></p><ul><li><strong><span>集中刷新</span></strong><span>：所有存储单元约好了一起刷新。此时不能进行正常读写，称为</span><strong><span>死时间</span></strong><span>或者访存</span><strong><span>死区</span></strong><span>。</span></li><li><strong><span>分散刷新</span></strong><span>：大体想法是每读取一次，该行就刷新一次。不存在死区，但是加倍了存取周期。</span></li><li><strong><span>异步刷新</span></strong><span>：通常采用的方法。把各行的刷新分散安排在刷新周期内。譬如我们要在2ms内对128行各刷新一遍，那么就每隔15.6μs刷新一行，而每行刷新的时间仍为0.5μs。对每行来说，刷新周期仍为2ms，而死时间为0.5μs。事实上，只要把刷新放在CPU的译码阶段，就不会遇到死区了。</span></li></ul><p><strong><span>DIMM——我们买的内存条</span></strong></p><p><span>首先要知道，</span><strong><span>DDR</span></strong><span>全称是</span><strong><span>Double Data Rate SDRAM</span></strong><span>。</span><strong><span>SDRAM（Synchronous DRAM ）</span></strong><span>是指DRAM的时钟频率和计算机的系统总线同步。</span><strong><span>DDR</span></strong><span>是指DRAM在时钟上升沿、下降沿都传输数据。其中DDR一个时钟周期传两位数据（两位</span><strong><span>预取</span></strong><span>，2-bit </span><strong><span>prefetch</span></strong><span>），DDR2是4位预取，DDR3和DDR4都是8位预取（上升沿和下降沿各传4位数据，一个时钟周期传8位数据）。</span></p><p><span>DRAM芯片都放在</span><strong><span>DIMM（dual inline memory module，双列直插式存储模块）</span></strong><span>。如下图是一个DDR3的示例。双列应该体现在正反两面各有八个DRAM芯片（组成一个</span><strong><span>rank</span></strong><span>），它们共用了一组针脚。注意到，一个DRAM芯片每次传送8位数据，八个DRAM芯片传送64位数据。每个芯片由八个</span><strong><span>bank</span></strong><span>组成，每个bank同一时间只有一个能被选中。每个bank由16384行1024列个超单元组成，每个超单元有8位。每个bank有自己的行列decoder和行缓冲区，可以并行读写（不是严格同时，可见图示），增加带宽。这种方法称为</span><strong><span>地址交叉（address interleaving）</span></strong><span>。</span></p><p><img src="http://images.anandtech.com/doci/3851/DRAM%20Memory%20Topology.png" alt="img" style="zoom:67%;" /></p><p><img src="./img/2022-04-25 21-16-00 的屏幕截图.png" style="zoom: 67%;" /></p><p><strong><span>命名</span></strong></p><p><span>虽然是古早的数据了，但是很典型。我是这么理解下面的数据的。核心频率是DRAM内部的时钟频率；IO频率就是存储器总线的时钟频率，由于DDR2是四位预取每次传2位数据，所以IO频率是核心频率的两倍，同理DDR3是八位预取每次传4位数据，所以IO频率是核心频率的四倍；有效传播频率是IO频率的两倍，这是因为DDR在上升沿和下降沿都进行一次数据传播；单通道带宽是有效传播频率的八倍，这是因为每次传播8个字节（64位数据）。</span></p><p><span>可能对“单通道带宽是有效传播频率的八倍“感到疑惑，可能觉得是一次传一位数据，而不是64位。个人认为之前所说的八位预取是针对一个cell来说的，这里“每次传播8个字节”则是针对DIMM所说的。</span></p><figure><table><thead><tr><th><span>DRAM name</span></th><th><span>DIMM name</span></th><th><span>核心频率</span></th><th><span>I/O频率</span></th><th><span>有效传输频率</span></th><th><span>单通道带宽</span></th><th><span>双通道带宽</span></th></tr></thead><tbody><tr><td><span>DDR2-667</span></td><td><span>PC2-5300</span></td><td><span>166MHz</span></td><td><span>333MHz</span></td><td><span>667MHz</span></td><td><span>5.3 GB/s</span></td><td><span>10.6 GB/s</span></td></tr><tr><td><span>DDR2-800</span></td><td><span>PC2-6400</span></td><td><span>200MHz</span></td><td><span>400MHz</span></td><td><span>800MHz</span></td><td><span>6.4 GB/s</span></td><td><span>12.8 GB/s</span></td></tr><tr><td><span>DDR3-800</span></td><td><span>PC3-6400</span></td><td><span>100MHz</span></td><td><span>400MHz</span></td><td><span>800MHz</span></td><td><span>6.4 GB/s</span></td><td><span>12.8 GB/s</span></td></tr><tr><td><span>DDR3-1066</span></td><td><span>PC3-8500</span></td><td><span>133MHz</span></td><td><span>533MHz</span></td><td><span>1066MHz</span></td><td><span>8.5 GB/s</span></td><td><span>17.0 GB/s</span></td></tr><tr><td><span>DDR3-1333</span></td><td><span>PC3-10600</span></td><td><span>166MHz</span></td><td><span>667MHz</span></td><td><span>1333MHz</span></td><td><span>10.6 GB/s</span></td><td><span>21.3 GB/s</span></td></tr><tr><td><span>DDR3-1600</span></td><td><span>PC3-12800</span></td><td><span>200MHz</span></td><td><span>800MHz</span></td><td><span>1600MHz</span></td><td><span>12.8 GB/s</span></td><td><span>25.6 GB/s</span></td></tr></tbody></table></figure><p><strong><span>理解性能参数</span></strong></p><ul><li><span>tRCD：row to column delay，从行选到列选的延迟时间</span></li><li><span>CL：CAS (column adress strobe) latency，从列选到数据输出的延迟周期数</span></li><li><span>tRP：RAS (row address strobe) precharge，行预充电的延迟时间</span></li></ul><p><span>想要理解这些参数（主要是precharge）必须深入看看硬件实现。下面是一个cell阵列。每个cell由一个晶体管和电容组成。首先我们要进行precharge，即给bit line充上DRAM工作电压的一半（1.5V）。然后把目标word line设置为asserted，这样原来没有充电的电容会被充上一点电，sense amplifier会感知到bit line电压低于1.5V；原来充好电的电容会失去一点电量，sense amplifer会感知到bit line电压高于1.5V。基于此我们便把一行数据读了出来。通过上述过程我们也可以看出DRAM的读取是破坏性的。</span></p><p><img src="./img/2022-04-25 22-19-27 的屏幕截图.png" style="zoom:40%;" /></p><p><span>于是我们可以得到如下示意图：</span></p><p><img src="./img/2022-04-26 09-20-30 的屏幕截图.png" style="zoom:67%;" /></p><h3 id='512-rom'><span>5.1.2 ROM</span></h3><p><span>之前介绍的DRAM和SRAM在断电时都会丢失数据，所以是</span><strong><span>易失的（Volatile）</span></strong><span>。而</span><strong><span>非易失性存储器（Nonvolatile Memory）</span></strong><span>即使断电后，也会保存信息，该类存储器称为</span><strong><span>只读存储器（Read-Only Memory，ROM）</span></strong><span>。事实上现在ROM中有的类型既可以读也可以写了。ROM可以分为以下几类： </span></p><ul><li><strong><span>PROM</span></strong><span>：programmable ROM，由保险丝等实现，只可编程一次</span></li><li><strong><span>EPROM</span></strong><span>：erasable programmable ROM，通过石英、紫外线等物理手段实现。可以擦写1000次</span></li><li><strong><span>EEPROM</span></strong><span>：electrically erasable PROM，由电路实现，可擦写100000次</span></li><li><strong><span>Flash memory</span></strong><span>：闪存，基于EEPROM，固态硬盘（SSD，Solid State Disk）就基于闪存</span></li></ul><p><span>存储在ROM设备中的程序称为</span><strong><span>固件（Firmware）</span></strong><span>，包括BIOS、磁盘控制器、网卡、图形加速器和安全子系统等。当计算机系统通电后，会运行存储在ROM中的固件。</span></p><h3 id='513-磁盘'><span>5.1.3 磁盘</span></h3><p><strong><span>磁盘（Disk）</span></strong><span>是被用来保存大量数据的存储设备，但是读信息的速度比DRAM慢10万倍，比SRAM慢100万倍。    </span></p><p><img src="https://iewug.github.io/pic/csapp/disk.jpg" referrerpolicy="no-referrer" alt="img"></p><p><span>上图所示的是一个磁盘的构造。磁盘是由多个叠放在一起的</span><strong><span>盘片（Platter）</span></strong><span>构成。每个盘片有两个覆盖着磁性记录材料的</span><strong><span>表面（Surface）</span></strong><span>。每个表面由一组称为</span><strong><span>磁道（Track）</span></strong><span>的同心圆组成。每个磁道被划分为若干</span><strong><span>扇区（Sector）</span></strong><span>。每个扇区包含相同数量的数据位（通常为512位）作为读写数据的基本单位。扇区之间通过</span><strong><span>间隙（Gap）</span></strong><span>分隔开来，间隙不保存数据信息，只用来表示扇区的格式化位。通常会使用</span><strong><span>柱面（Cylinder）</span></strong><span>来描述不同表面上相同磁道的集合，比如柱面k就是6个表面上磁道k的集合。盘片中央会有一个可以旋转的</span><strong><span>主轴（Spindle）</span></strong><span>，使得盘片以固定的</span><strong><span>旋转速率（Rotational Rate）</span></strong><span>旋转，单位通常为</span><strong><span>RPM（Revolution Per Minute）</span></strong><span>。    </span></p><p><span>现代大容量磁盘采用</span><strong><span>多区记录（Multiple Zone Recording）</span></strong><span>技术，将一组连续的柱面划分成一个区。在同一个区中，每个柱面的每条磁道都有相同数量的扇区，数量由该区中最内侧的磁道决定。由此外侧的区能划分成更多的扇区。但有意思的是，即便采用了多区记录，磁盘仍提供给操作系统一个虚拟的空间布局，仍然所有的磁道有相同的扇区数量。</span></p><p><span>磁盘的性能可由以下几个参数评价</span></p><ul><li><strong><span>seek time</span></strong><span>：找磁道所花时间</span></li><li><strong><span>rotational latency</span></strong><span>：找扇区所花时间</span></li><li><strong><span>transfer time</span></strong><span>：传播数据所花时间</span></li></ul><h3 id='514-ssd'><span>5.1.4 SSD</span></h3><p><strong><span>固态硬盘（Solid State Disk，SSD）</span></strong><span>是一种基于闪存的存储技术。从CPU的角度来看，SSD与磁盘完全相同，有相同的接口和包装。</span></p><p><img src="https://iewug.github.io/pic/csapp/ssd.jpg" alt="img" style="zoom:67%;" /></p><p><span>如上图所示是一个SSD的基本结构。它由闪存和闪存翻译层（Flash Translation Layer）组成    </span></p><ul><li><span>闪存翻译层是一个硬件/固件设备，用来将对逻辑块的请求翻译成对底层物理设备的访问。</span></li><li><span>闪存的基本属性决定了SSD随机读写的性能，通常由B个块的序列组成，每个块由P页组成，页作为数据的单位进行读写。通常页大小为512B</span><span>~</span><span>4KB，块中包含32</span><span>~</span><span>128页，则块的大小有16KB~512KB。</span></li></ul><p><span>SSD的随机写操作慢于随机读操作，这是因为：1）擦除块耗时长；2）当块中包含其他数据时，会先将块中带有有效数据的页复制到被擦出过的块中，才能对那个块进行擦除。</span></p><p><span>SSD的优缺点：    </span></p><ul><li><span>优点：由于闪存是半导体存储器，没有移动的部件，所以速度比磁盘更快且磨损小，能耗低</span></li><li><span>缺点：SSD每字节比磁盘贵大约30倍。此外SSD做为一种闪存也有擦除次数的限制，但是由于闪存翻译层会把擦除尽可能平分到每一个块中，这件事情不用担心。</span></li></ul><h2 id='52-局部性'><span>5.2 局部性</span></h2><p><strong><span>高速缓存（cache）</span></strong><span>是小而快的存储器，它存放着大且慢存储器里的部分数据。如果我们访问的数据均来自顶层的缓存之中，则可以提高程序运行速度。这一点可由程序的</span><strong><span>局部性（locality）</span></strong><span>保证。局部性有两种：</span></p><ul><li><strong><span>时间局部性（Temporal Locality）</span></strong><span>：引用过的数据项在不久会被多次引用。譬如循环会多次访问相同的数据和代码。</span></li><li><strong><span>空间局部性（Spatial Locality）</span></strong><span>：引用过的数据项，在不久会引用附近的数据项。譬如访问数组。</span></li></ul><h2 id='53-存储器层次结构'><span>5.3 存储器层次结构</span></h2><p><img src="https://iewug.github.io/pic/csapp/memory hierarchy.jpg" alt="img" style="zoom:67%;" /></p><p><span>存储器层次结构的中心思想是让层次结构中的每一层来缓存低一层的数据对象，将第k层的更快更小的存储设备作为第k+1层的更大更慢的存储设备的缓存。显然该结构利用了局部性。    </span></p><p><span>相邻层的存储器以</span><strong><span>块（block）</span></strong><span>（有时也称做</span><strong><span>行，line</span></strong><span>）作为数据传送单元。通常较低层的存储器使用较大的块。    </span></p><h3 id='531-缓存命中'><span>5.3.1 缓存命中</span></h3><p><span>当程序需要第k+1层的某个数据对象d时，会先在第k层的块中搜索d，如果d刚好缓存在第k层中，则称为</span><strong><span>缓存命中（Cache Hit）</span></strong><span>。于是该程序会直接从第k层中读取d。</span></p><h3 id='532-缓存不命中'><span>5.3.2 缓存不命中</span></h3><p><span>如果第k层没有缓存数据对象d，则称为</span><strong><span>缓存不命中（Cache Miss）</span></strong><span>。则会从第k+1层中取出包含d的块，然后第k层的缓存会执行某个</span><strong><span>放置策略（Placement Policy）</span></strong><span>来决定该块要保存在第k层的什么位置。如果第k层的缓存满了，则会覆盖现存的一个</span><strong><span>牺牲块（Victim Block）</span></strong><span>，称为</span><strong><span>替换（Replacing）</span></strong><span>或</span><strong><span>驱逐（Evicting）</span></strong><span>这个牺牲块，会根据</span><strong><span>替换策略（Replacement Policy）</span></strong><span>来决定要替换第k层的哪个块。</span></p><p><span>替换策略（如FIFO、LRU之类的）在操作系统页面替换算法已经详细讨论过了，这里就不再展开。放置策略将与缓存的组织结构相关，这将是5.4节讨论的重点。</span></p><p><span>特殊地，如果第k层的缓存为空，那么对于任意的数据对象的访问都会不命中。空的缓存称为</span><strong><span>冷缓存（Cold Cache）</span></strong><span>，该不命中称为</span><strong><span>强制性不命中（Compulsory Miss）</span></strong><span>或</span><strong><span>冷不命中（Cold Miss）</span></strong><span>。</span></p><p><span>特殊地，如果访问的块是一个相对不变的集合，比如在嵌套循环中反复访问一个数组的每个元素，那么该集合称为</span><strong><span>工作集（Working Set）</span></strong><span>。如果工作集大小超过缓存大小，则缓存会出现</span><strong><span>容量不命中（Capacity Miss）</span></strong><span>，这是由缓存太小导致的。    </span></p><h3 id='533-缓存管理'><span>5.3.3 缓存管理</span></h3><p><span>缓存在现代计算机系统中无处不在：    </span></p><p><img src="https://iewug.github.io/pic/csapp/ubiquity_cache.jpg" alt="img" style="zoom: 80%;" /></p><p><span>当下Intel酷睿处理器告诉高速缓存层次结构如下：（i-cache：只保存指令的高速缓存；d-cache：只保存程序数据的高速缓存）</span></p><p><img src="https://iewug.github.io/pic/csapp/i7cache hierarchy.jpg" alt="img" style="zoom:67%;" /></p><h2 id='54-高速缓存存储器组织结构'><span>5.4 高速缓存存储器组织结构</span></h2><p><span>要讨论放置策略，即新来的块应该放在何处。有三种方法：</span></p><ul><li><strong><span>直接 (direct mapped)：</span></strong><span>只能放在一个块中</span></li><li><strong><span>全相联 (fully-associated)：</span></strong><span>可以放在任何块中</span></li><li><strong><span>组相联 (set-associated)：</span></strong><span>可以放在一组块的任何块中</span></li></ul><p><span>其实也就是在讨论给出一个地址，如何找到缓存中相应的一字节数据。</span></p><h3 id='541-通用的高速缓存存储器组织结构'><span>5.4.1 通用的高速缓存存储器组织结构</span></h3><p><img src="https://iewug.github.io/pic/csapp/generalcacheorg.jpg" alt="img" style="zoom: 80%;" /></p><p><span>如上图b中所示，会将m位的地址划分成三部分：</span></p><ul><li><span>s位：高速缓存被组织成S = 2</span><sup><span>s</span></sup><span> </span><strong><span>组（set）</span></strong></li><li><span>b位：每个组包含E个高速缓存</span><strong><span>行（line）</span></strong><span>，每行有一个高速缓存块（所以block有时也称做line），每个高速缓存块有B = 2</span><sup><span>b</span></sup><span>个字节。E的大小也称作</span><strong><span>路（way）</span></strong><span>。</span></li><li><span>t位：每一个高速缓存行有一个t = m - s - b位的</span><strong><span>标记位（tag）</span></strong></li></ul><p><span>显然可以方便地通过地址确定目标数据块。该高速缓存的结构可以通过元组(S, E, B, m)来描述，且容量C为所有块的大小之和，C = S × E × B。    </span></p><h3 id='542-直接映射高速缓存'><span>5.4.2 直接映射高速缓存</span></h3><p><img src="https://iewug.github.io/pic/csapp/direct-mapped cache.jpg" referrerpolicy="no-referrer" alt="img"></p><p><span>如上图所示，当E = 1时，高速缓存称为</span><strong><span>直接映射高速缓存（Direct-mapped Cache）</span></strong><span>，每个高速缓存组中只含有一个高速缓存行。    </span></p><p><span>首先读取地址的s位，找到该组。然后检查有效位是否为1以及标记和t位是否一致。如果一致，再通过b位找到目标字节，返回即可。如果不一致，则发生不命中情况，从下一级的缓存找到该目标高速缓存块，并替换当前的块。    </span></p><p><span>运气不好的话，会发生</span><strong><span>抖动（Thrash）</span></strong><span>，即高速缓存反复地加载和驱逐相同的高速缓存块的组。</span></p><p><strong><span>优点</span></strong></p><ul><li><span>地址变换速度快，一对一映射</span></li><li><span>替换算法简单、容易实现</span></li></ul><p><strong><span>缺点</span></strong></p><ul><li><span>容易冲突，cache利用率低</span></li><li><span>命中率低</span></li></ul><h3 id='543-组相联高速缓存'><span>5.4.3 组相联高速缓存</span></h3><p><span>直接映射高速缓存的冲突不命中是由于每个高速缓存组中只有一个高速缓存行，所以扩大E的值，当1 &lt; E &lt; C/B时，称为</span><strong><span>E路组相联高速缓存（E-way set associative cache）</span></strong><span>。下图所示的是一个2路组相联高速缓存。    </span></p><p><img src="https://iewug.github.io/pic/csapp/set_associative.jpg" alt="img" style="zoom:80%;" /></p><p><span>当缓存不命中时需要进行缓存行替换，如果对应的高速缓存组中有空的高速缓存行，则直接将其保存到空行中。但是如果没有空行，就要考虑合适的替换策略。</span></p><p><span>关于比较地址的tag部分和缓存的标记位，可以同时进行，不需要顺序比较。</span></p><h3 id='544-全相联高速缓存'><span>5.4.4 全相联高速缓存</span></h3><p><strong><span>全相联高速缓存（Fully Associative Cache）</span></strong><span>是用一个包含所有高速缓存行的组组成的，其中E = C/B，即S = 1。    </span></p><p><img src="https://iewug.github.io/pic/csapp/fully associative.jpg" alt="img" style="zoom:80%;" /></p><p><span>由于全相联高速缓存只有一个组，所以不包含组索引编码。其行匹配和字选择与组相联高速缓存相同，只是规模大小不同。想要得到高速的全相联高速缓存十分困难，但是块冲突的概率低（只有装满后才会出现块冲突），所以通常适合用于较小的高速缓存，比如TLB。</span></p><h3 id='545-写操作'><span>5.4.5 写操作</span></h3><p><span>当CPU想要对地址A进行写操作时，会通过地址A判断是否缓存了该地址，如果缓存了则称为</span><strong><span>写命中（Write Hit）</span></strong><span>，否则称为</span><strong><span>写不命中（Write Miss）</span></strong><span>。问题的关键在于如何保证缓存之间数据块的一致性。下面分别分析写命中和写不命中的不同实现思路：</span></p><p><strong><span>写命中</span></strong></p><ul><li><strong><span>直写（Write-Though）</span></strong><span>：立即更新下一层的副本值。缺点是每次写都会引起总线流量。</span></li><li><strong><span>写回（Write-Back）</span></strong><span>：为每个高速缓存行维护一个</span><strong><span>脏位（Dirty Bit）</span></strong><span>，表明这个高速缓存块是否被修改。当被修改的高速缓存块被驱逐时，才会更新下一层的副本值。能够显著减少总线流量，但是复杂性高。</span></li></ul><p><strong><span>写不命中</span></strong></p><ul><li><strong><span>写分配（write-allocate）</span></strong><span>：加载相应的下一层的块到当前层的高速缓存中，然后更新当前高速缓存块。得益于空间局部性，进行一次写分配后，下一次有较高几率会写命中，但是缺点是每次写不命中就要将块从低级向上传输。</span></li><li><strong><span>写不分配（no-write-allocate）</span></strong><span>：绕过缓存，直接把内容写到下一层中</span></li></ul><p><strong><span>直写高速缓存通常为写不分配的，写回高速缓存通常为写分配的。</span></strong><span>建议采用写回写分配模型，因为随着逻辑电路密度的提高，写回的复杂性不再成为阻碍，并且和处理读相同，都利用了局部性原理，效率较高。</span></p><h3 id='546-一道题'><span>5.4.6 一道题</span></h3><p><span>cache可能是：</span></p><ul><li><span>associativity (1, 2 or 4 ways)</span></li><li><span>block size (1, 2, 4, 8 or 32 bytes)</span></li><li><span>total cache size (256B or 512B)</span></li><li><span>replacement policy (LRU or FIFO)</span></li></ul><p><span>已知四个访问地址序列和相应的命中率如下：</span></p><figure><table><thead><tr><th><span>sequence</span></th><th><span>address sequence</span></th><th><span>hit ratio</span></th></tr></thead><tbody><tr><td><span>1</span></td><td><span>0,2,4,8,16,32</span></td><td><span>0.33</span></td></tr><tr><td><span>2</span></td><td><span>0,512,1025,1536,2048,1536,1025,512,0</span></td><td><span>0.33</span></td></tr><tr><td><span>3</span></td><td><span>0,64,128,256,512,256,128,64,0</span></td><td><span>0.33</span></td></tr><tr><td><span>4</span></td><td><span>0,512,1024,0,1536,0,2048,512</span></td><td><span>0.25</span></td></tr></tbody></table></figure><p><strong><span>答案：</span></strong></p><p><span>4 ways; 8 bytes; 256B; LRU</span></p><h2 id='55-高速缓存友好代码'><span>5.5 高速缓存友好代码</span></h2><h3 id='551-重新排列循环来改善空间局部性'><span>5.5.1 重新排列循环来改善空间局部性</span></h3><p><span>我们可以有不同的循环方式来实现矩阵乘法C = AB</span></p><p><img src="./img/csapp6.6-1.jpg" style="zoom: 50%;" /></p><p><span>假设每个块中能保存4个元素，则可以分析内循环（上图中红色代码）每个变量的命中率。之所以分析内循环，是因为它的时间复杂度将乘上n</span><sup><span>2</span></sup><span>，比外循环中的元素对运行时长影响更大。</span></p><p><img src="./img/csapp6.6-2.jpg" style="zoom:67%;" /></p><p><span>说明我们可以对循环重排列，来提高空间局部性，增加命中率。</span></p><h3 id='552-使用分块来提高时间局部性'><span>5.5.2 使用分块来提高时间局部性</span></h3><p><span>仍然考虑矩阵乘法C = AB。现在一个缓存块可以保存8个元素，缓存的容量C远小于矩阵大小n</span><span>*</span><span>n，三个矩阵分块（大小B</span><span>*</span><span>B）可以同时放入缓存（即3B</span><sup><span>2</span></sup><span>&lt;C）。分析时只考虑内层循环开销。下面对两种方案分别进行分析：</span></p><p><img src="./img/2022-04-26 17-13-53 的屏幕截图.png" referrerpolicy="no-referrer"></p><ul><li><span>上图左：取一行元素有n/8次不命中，取一列元素有n次不命中，共有9n/8次不命中。一共n</span><sup><span>2</span></sup><span>个元素，所以一共有9n</span><sup><span>3</span></sup><span>/8次不命中。</span></li><li><span>上图右：每个块有B</span><sup><span>2</span></sup><span>/8次不命中，每一行每一列各有n/8个块，计算C中的一个块有2n/8</span><span>*</span><span>B</span><sup><span>2</span></sup><span>/8=nB/4次不命中，一共会有nB/4</span><span>*</span><span>(n/B)</span><sup><span>2</span></sup><span>=n</span><sup><span>3</span></sup><span>/(4B)次不命中，小于9n</span><sup><span>3</span></sup><span>/8。</span></li></ul><h3 id='553-一些建议'><span>5.5.3 一些建议</span></h3><ul><li><span>将你的注意力集中在内循环上，大部分计算的存储器访问都集中在这里</span></li><li><span>按照数据对象存储在内存中的顺序，以步长为1来读数据，使得空间局部性最大</span></li><li><span>一旦从存储器读入一个数据对象时，就尽可能使用它，使得时间局部性最大。特别是局部变量，编译器会将其保存在寄存器中。</span></li></ul><h2 id='56-改善cache性能的技术'><span>5.6 改善cache性能的技术</span></h2><p><strong><span>衡量高速缓存的指标有：</span></strong></p><ul><li><strong><span>命中率（Hit Rate/Ratio）：</span></strong><span>内存引用命中的比率，命中数量/引用数量。</span></li><li><strong><span>不命中率（Miss Rate/Ratio）：</span></strong><span>内存引用不命中的比率，不命中数量/引用数量。通常，L1高速缓存为3~10%，L2高速缓存为&lt;1%。</span></li><li><strong><span>命中时间（Hit Time）：</span></strong><span> 从高速缓存传输一个字到CPU的时间。通常，L1高速缓存需要4个时钟周期，L2高速缓存需要10个时钟周期。</span></li><li><strong><span>不命中惩罚（Miss Penalty）：</span></strong><span>当缓存不命中时，要从下一层的存储结构中传输对应块到当前层中，需要额外的时间（不包含命中时间）。通常，主存需要50~200个时钟周期。</span></li><li><strong><span>平均访问时间</span></strong><span>：命中时间+不命中率*不命中惩罚</span></li></ul><p><strong><span>一些提升性能的手段</span></strong></p><ol start='' ><li><p><strong><span>减少命中时间</span></strong></p><ul><li><span>更小更简单的高速缓存</span></li><li><span>直接映射高速缓存</span></li><li><span>更小的块</span></li></ul></li><li><p><strong><span>减少不命中率</span></strong></p><ul><li><span>更大的高速缓存</span></li><li><span>增加相联度</span></li><li><span>更大的块</span></li><li><span>增加victim cache，用来存放最近丢弃的块</span></li><li><strong><span>预取（prefetching）</span></strong><span>：软件或硬件实现。通过观察访存规律，预先获取内存块。</span></li><li><span>编译优化、写缓存友好代码</span></li></ul></li><li><p><strong><span>降低不命中惩罚</span></strong></p><ul><li><span>更小的块</span></li><li><span>增加wirte buffer，顶层缓存只需要将数据写入write buffer就可以不管后续操作了</span></li><li><span>多级缓存</span></li><li><span>非阻塞缓存：Cache can service multiple hits while waiting on a miss</span></li></ul></li></ol><p><strong><span>各级缓存参数参考</span></strong></p><p><img src="./img/2022-04-26 22-12-52 的屏幕截图.png" style="zoom:67%;" /></p><p><strong><span>总结</span></strong></p><p><img src="./img/2022-04-26 22-14-13 的屏幕截图.png" style="zoom:67%;" /></p><h2 id='57-虚拟内存'><span>5.7 虚拟内存</span></h2><h3 id='571-虚拟地址的转换过程'><span>5.7.1 虚拟地址的转换过程</span></h3><p><span>TLB、页表之类的基本知识都在操作系统课程上讨论过了。简单来说，虚拟地址先通过CPU中的TLB生成物理地址，如果TLB miss，就要根据内存/缓存（当然也可能页表只在磁盘里，此时额外增添一次缺页故障）中的页表生成物理地址。先根据物理地址在缓存中找数据，如果cache miss，就要从内存中找数据，如果内存也miss，那就是缺页故障，要从磁盘里找数据了。下面是一系列事件组合：</span></p><p><img src="./img/2022-05-21 15-16-33 的屏幕截图.png" style="zoom:67%;" /></p><p><span>虽然图是来源于硬件软件接口的书的，但是个人觉得页表命不命中的说法甚是诡异。这里页表命中就是指内存中有对应的页帧，不命中就是指缺页故障。缓存不命中指数据不在缓存中，但是可以在内存中。因为TLB是页表的子集，所以TLB命中，页表肯定命中。因为缓存是内存的子集，所以页表不命中，缓存肯定不命中。</span></p><p><span>直接、全相联和组相联都可以作为TLB的设计方案，全相联和组相联更常见。组相联映射TLB设计类似如下图：</span></p><p><img src="./img/2022-04-26 22-17-50 的屏幕截图.png" style="zoom:67%;" /></p><p><span>csapp上这幅图我一直很喜欢，也放在这里。四路组相联的TLB，四级页表，八路组相联的一级数据缓存。</span></p><p><img src="https://iewug.github.io/pic/csapp/i7_virtual memory.jpg" alt="img" style="zoom:67%;" /></p><h3 id='572-高速缓存寻址方案'><span>5.7.2 高速缓存寻址方案</span></h3><p><span>关于寻址，我们脑子里一直是这么一个方案：程序只知道虚拟地址，CPU中的MMU把虚拟地址翻译成物理地址后，交给缓存，缓存再由这个物理地址找数据。也就是说访问高速缓存用的都是物理地址。然而实际上是把问题想简单了。</span></p><p><span>上述的方案称为</span><strong><span>PIPT（physical index physical tag）</span></strong><span>，缓存也相应地称为物理缓存。然而这个方案每次访问缓存前都要先做地址翻译，会增加延迟时间、降低性能。</span></p><p><span>那用虚拟地址来寻址呢，也就是虚拟缓存采用的</span><strong><span>VIVT（virtual index virtual tag）</span></strong><span>方案呢？就不用在访问缓存前做地址翻译了。然而这引入了</span><strong><span>别名（aliasing）</span></strong><span>问题和</span><strong><span>同名异义（homonyms）</span></strong><span>问题。</span></p><ul><li><span>aliasing：我们知道虚拟内存存在共享页面的情况——两个进程不同的虚拟地址指向同一个页帧。于是同一个内存块可能会在高速缓存的不同缓存块出现。当一个进程更新其中一个高速缓存块时，根据5.4.5节讨论的写策略，我们知道内存块会更新，但是另一个高速缓存块怎么知道要更新呢。</span></li><li><span>homonyms：不同进程的相同虚拟地址通常指向不同的物理地址，而缓存中一个缓存块总不能对应多个内存块吧。那在切换进程时还需要清除高速缓存，想必代价不小。</span></li></ul><p><span>既然PIPT性能不佳，VIVT又存在大麻烦，那么把两者综合起来怎么样呢？这就是</span><strong><span>VIPT（virtual index physical tag）</span></strong><span>。目前被广泛采用。上面那张csapp的图，我们之前都是把它当作PIPT看待的，但实际上它也是个VIPT。我们注意到L1数据缓存使用了物理地址中的PPO部分来作为索引和偏移。然而PPO就是VPO，也就是说寻找高速缓存块用的是虚拟地址中的相关数据。但是标记位是与物理地址进行比较的，所以称为VIPT。换句话说，寻找高速缓存块和生成物理地址是同时进行的，这样便提升了性能。</span></p><p><span>采用VIPT也有可能产生aliasing的问题，也就是高速缓存中两个不同的块存放了相同的数据。在上面csapp那幅图中，如果两个不同的虚拟地址生成相同的物理地址，那么虚拟地址的0～11位肯定相同。现在假设L1 d-cache使用虚拟地址的0～12位来寻址（而不是0～11位），且第12位不相同。那么利用0～12位找到的高速缓存块是不同的。然而我们又假定了这两个虚拟地址对应着同一个物理地址，这就构造出了一个aliasing的例子。想要避免aliasing其实很简单，只需要高速缓存的索引位和偏移位全部来自VPO就好了。</span></p><h3 id='573-高速缓存一致性'><span>5.7.3 高速缓存一致性</span></h3><p><span>之前在5.4.5节我们已经讨论过了各级高速缓存间的一致性问题，也看到了脏位在写回策略中的作用。现在我们讨论多核处理器下的高速缓存一致性问题。</span></p><p><img src="https://iewug.github.io/pic/csapp/i7cache hierarchy.jpg" alt="img" style="zoom:67%;" /></p><p><span>我们在5.3.3节就看到不同核用的L1和L2高速缓存是不一样的。现在一个内存块已经缓存在不同核的L1L2高速缓存中，那么如果核0更新了这个内存块，其他核的高速缓存怎么知道这个内存块被更新了呢？这便是这节的主题。下面简单地介绍多个协议。这些问题都是由硬件实现，对软件透明。</span></p><p><strong><span>总线嗅探协议（bus snooping protocol）</span></strong></p><ul><li><strong><span>Write Update</span></strong><span>:  Writes are broadcast and update all other cache copes</span></li><li><strong><span>Write Invalidate</span></strong><span>: Writes invalidate all other cache copies</span></li></ul><p><img src="./img/2022-05-22 10-10-25 的屏幕截图.png" style="zoom:67%;" /></p><p><span>上图中，X是一个共享的内存数据，在P1、P2、P3的高速缓存中都有一个备份。现在P3更新了X。如果采用write update，那么所有的缓存拷贝都会被更新；如果采用write invalidate，那么所有的缓存拷贝都会标记为invalid。</span></p><p><span>在上例write invalidate方案中，P1想要读X，就会发生read miss，P1的cache controller将读X的消息广播到总线上，P3的cache controller将X‘写回到内存中，P1从内存中读取新的X’。同样，如果P1想要写X，就会发生write miss，就要先把P3 cache中的X‘写到内存和P1的cache，然后P1的cache将X‘更新为X’‘，再把其他缓存拷贝标记为invalid。</span></p><p><span>相比之下，write invalidate方案比write update产生的总线流量小。</span></p><p><strong><span>MSI协议</span></strong></p><p><span>总线嗅探协议中，每个缓存块只有invalid和valid两种状态。MSI使用了三种状态（可以由高速缓存行两个状态位来维护）：</span></p><ul><li><strong><span>Modified</span></strong><span>: The cached copy is the only valid copy in the system. The copy in the main memory is also invalid.</span></li><li><strong><span>Shared</span></strong><span>: The cached copy is valid and it may or may not be shared by other caches. Initial state after first loaded. The copy in the main memory is up to date.</span></li><li><strong><span>Invalid</span></strong><span>: The cached copy is not existence.</span></li></ul><p><span>可以减少一些总线流量。譬如修改modified状态的缓存块，就修改就好了，无需产生更多总线流量。更多细节不再展开。</span></p><p><strong><span>MESI协议</span></strong></p><p><span>MESI比MSI多了一个exclusive状态，shared语义有所改变，其实就是把shared状态拆成了exclusive和shared。</span></p><ul><li><strong><span>M</span></strong><span>（Modified）：这行数据有效，数据被修改了，和内存中的数据不一致，数据只存在于本Cache中。</span></li><li><strong><span>E</span></strong><span>（Exclusive）：这行数据有效，数据和内存中的数据一致，数据只存在于本Cache中。</span></li><li><strong><span>S</span></strong><span>（Shared）：这行数据有效，数据和内存中的数据一致，数据存在于很多Cache中。</span></li><li><strong><span>I</span></strong><span>（Invalid）：这行数据无效。</span></li></ul><p><strong><span>MOESI协议</span></strong><span> （AMD）</span></p><p><span>现在多核之间可以直接通信（网络结构），而不是先要核0通过总线将数据写到内存后，核1再通过总线从内存读取数据（总线结构）。如果多个核的缓存行都标记为shared，那么从哪个核的缓存读取数据呢？这就需要owned状态，就从owned状态的缓存行读数据就好了。避免多个缓存行都要发送数据造成的流量浪费。此外，MOESI协议下当一个缓存行状态为S时，其包含的数据并不一定与存储器一致。</span></p><p><strong><span>MESIF</span></strong><span>（Intel）</span></p><p><span>增加forward状态，从forward状态的缓存行读数据。</span></p><p><img src="./img/moesi.jpg" style="zoom:50%;" /></p><h3 id='574-假共享'><span>5.7.4 假共享</span></h3><p><span>假设线程0对arr[0]和arr[2]做平方，线程1对arr[1]和arr[3]做平方，线程0由CPU0处理，线程1由CPU1处理，arr存放在同一个高速缓存块中。看似是一个并行的程序，但是当CPU0修改了arr[0]后，CPU1就会把它缓存的arr高速缓存块标记为I，在访问arr[1]时就会需要从CPU0的高速缓存中获取数据。这其实就变成了一个串行执行的程序了，甚至性能还不如单核上的情况。这种问题称为</span><strong><span>假共享（false sharing）</span></strong><span>。</span></p><hr /><div style="page-break-after: always;"></div> <h1 id='chapter-6'><span>Chapter 6</span></h1><p><span>这章就开始研究并行处理器了。限于时间，我并没有看书，而是根据上课的PPT整理的。</span></p><h2 id='61-并行体系结构分类'><span>6.1 并行体系结构分类</span></h2><p><span>根据指令流和数据流的个数可以将并行体系结构分类为：（S: single, M: multiple, I: instruction, D: data）</span></p><ul><li><span>SISD：单一指令流，单一数据流。单核处理器。</span></li><li><span>SIMD：见3.3节。向量（vector）与标量（scalar）</span></li><li><span>MISD：The closest we can come to MISD processor might be a &quot;stream processor&quot; that would perform a series of computations on a single data stream in a pipelined fashion: parse the input from the network, decrypt the data, decompress it, search for match, and so on. 现实中无实际例子。</span></li><li><span>MIMD：多核处理器。</span></li></ul><h2 id='62-硬件多线程'><span>6.2 硬件多线程</span></h2><p><span>之前我们已经学习了流水线带来的</span><strong><span>指令级并行（ILP）</span></strong><span>和SIMD扩展指令集带来的</span><strong><span>数据级并行（DLP）</span></strong><span>。这里我们研究</span><strong><span>硬件多线程（hardware multithreading）</span></strong><span>带来的</span><strong><span>线程级并行（TLP）</span></strong><span>。</span></p><p><span>我们知道超标量处理器有多个功能单元，然而通常一个线程不能在同时全部使用这些单元，造成了性能浪费。而硬件多线程允许多个线程以一种交替的形式使用单核处理器的功能部件，从而最大程度挖掘硬件的性能。</span></p><p><span>有这么几类：</span></p><ul><li><strong><span>粗粒度多线程（coarse-grained multithreading）</span></strong><span>：imply switching between threads only after significant events, such as a last-level cache miss</span></li><li><strong><span>细粒度多线程（fine-grained multithreading）</span></strong><span>：imply switching between threads after every instruction</span></li><li><strong><span>同时多线程（simutaneous multithreading，SMT）</span></strong><span>：允许多个线程同时使用功能单元。现在的超线程技术其实就是SMT，同时允许两个线程使用功能单元，给操作系统提供了一个核是两个的假象。</span></li></ul><p><img src="./img/2022-05-22 14-36-34 的屏幕截图.png" style="zoom: 67%;" /></p><p><span>动态调度乱序执行超标量处理器对SMT的支持包括：</span></p><ul><li><span>大量的寄存器</span></li><li><span>寄存器换名机制</span></li><li><span>乱序执行机制</span></li></ul><h2 id='63-多核和其他共享内存的多处理器'><span>6.3 多核和其他共享内存的多处理器</span></h2><p><img src="./img/2022-05-22 15-04-31 的屏幕截图.png" style="zoom: 67%;" /></p><p><span>不是很懂啊。反正SMP的symmetric指所有核访问主存的延迟一样，SMP也称作shared memory multiprocessor。然后DSM每个核有自己较近的一块内存，可以通过网络访问其他核的内存。</span></p><h2 id='64-openmp'><span>6.4 OpenMP</span></h2><p><span>OpenMP提供了并行编程的一些API，比调用pthread库更简洁。课程要求看懂，不要求会写。在开始前，先提及一下我们常用的编程模型</span><strong><span>SPMD（single program multiple data）</span></strong><span>，也就是说在一个程序里实现多组数据流的并行处理。我们就看四个例子吧。</span></p><p><strong><span>例一</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//将arr第i个元素的值设置为I; Set element i of arr to i</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#pragma omp parallel {</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">n</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) <span class="cm-variable">arr</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">i</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="display: none; height: 91px;"></div></div></div></pre><p><span>结果正确，但是每个线程做了一样的工作。没有任何效率提升，纯属于无用功。</span></p><p><strong><span>例二</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//将arr数组元素设置为斐波那契数列：Set arr to be an array of Fibonacci numbers.</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">arr</span>[<span class="cm-number">0</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">arr</span>[<span class="cm-number">1</span>] <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#pragma omp parallel for</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">n</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">arr</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-variable">arr</span>[<span class="cm-variable">i</span><span class="cm-operator">-</span><span class="cm-number">1</span>] <span class="cm-operator">+</span> <span class="cm-variable">arr</span>[<span class="cm-variable">i</span> <span class="cm-operator">-</span> <span class="cm-number">2</span>];</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 136px;"></div><div class="CodeMirror-gutters" style="display: none; height: 136px;"></div></div></div></pre><p><span>当我们看到</span><code>#pragma omp parallel</code><span>后面有个for的话，下面的内容将被编译器自动分配到多个线程中。这里结果错误，因为后面的项可能会先算。</span></p><p><strong><span>例三</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 将arr所有元素设置为0； Set all elements in arr to 0;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">i</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#pragma omp parallel for</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">n</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) <span class="cm-variable">arr</span>[<span class="cm-variable">i</span>] <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 91px;"></div><div class="CodeMirror-gutters" style="display: none; height: 91px;"></div></div></div></pre><p><span>结果正确，且运行快。</span></p><p><strong><span>例四</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.33333px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//将arr数组的每一个元素减去其数组下标值，</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//Decrements element i of arr. n is a multiple of omp_get_num_threads()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#pragma omp parallel {</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">threadCount</span> <span class="cm-operator">=</span> <span class="cm-variable">omp_get_num_threads</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">myThread</span> <span class="cm-operator">=</span> <span class="cm-variable">omp_get_thread_num</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">n</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">i</span> <span class="cm-operator">%</span> <span class="cm-variable">threadCount</span> <span class="cm-operator">==</span> <span class="cm-variable">myThread</span>) <span class="cm-variable">arr</span>[<span class="cm-variable">i</span>] <span class="cm-operator">-=</span><span class="cm-variable">i</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 181px;"></div><div class="CodeMirror-gutters" style="display: none; height: 181px;"></div></div></div></pre><p><span>结果正确。有假共享问题。线程不应该处理相近的数组元素。</span></p><h2 id='65-gpu'><span>6.5 GPU</span></h2><p><span>简单理解如下：</span></p><p><span>从硬件上来看，SP（streaming processor）是GPU最基本的处理单元，也称做CUDA core；多个CUDA core组成一个SM（streaming multiprocessor）；多个SM组成了GPU。</span></p><p><span>从软件上来看，数个thread组成一个block，多个block组成grid。CPU发送整个grid到GPU。</span></p><p><span>warp包含32个线程，是调度单位。在同一个warp的线程，以不同数据资源执行相同的指令。</span></p><p><span>编程模型还是SPMD，GPU可以看作是SIMD+MIMD。GPU使用 SIMT模型, 每个CUDA线程的标量指令流</span>
<span>汇聚在一起在硬件上以SIMD方式执行。</span></p><p><em><span>很不清楚，只是给个概念</span></em></p></div></div>
</body>
</html>